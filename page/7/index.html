<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 7 页 | Jeck_Zhang</title>
  <meta name="author" content="Jeck Zhang">
  
  <meta name="description" content="zxc&#39;s blog | java | ruby | perl | linux">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Jeck_Zhang"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link type="image/x-icon" href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Jeck_Zhang" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45019001-1', 'topdna.org');
  ga('send', 'pageview');

</script>


</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Jeck_Zhang</a></h1>
  <h2><a href="/">Write the Code. Change the World.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="http://weibo.com/zxc337">weibo</a></li>
    
      <li><a href="/2014/10/01/aboutMe/">关于</a></li>
    
      <li><a href="/tags/随感/">随感</a></li>
    
      <li><a href="/tags/技术/">技术</a></li>
    
      <li><a href="/tags/理财/">理财</a></li>
    
      <li><a href="/tags/生活/">生活</a></li>
    
      <li><a href="/archives">归档</a></li>
    
    <li><a href="/atom.xml">RSS</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-11-10T08:50:10.000Z"><a href="/2011/11/10/my-java-dev-tools/">11月 10 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/11/10/my-java-dev-tools/">我的Java程序员开发常用工具集</a></h1>
  

    </header>
    <div class="entry">
      
        <p>我发现很多人没办法高效地解决问题的关键原因是不熟悉工具，不熟悉工具也还罢了，甚至还不知道怎么去找工具，这个问题就大条了。我想列下我能想到的一个Java程序员会用到的常用工具。</p>
<p>一、编码工具</p>
<p> 1.IDE：<a href="http://www.eclipse.org/" target="_blank" rel="external">Eclipse</a>或者<a href="http://www.jetbrains.com/idea/" target="_blank" rel="external">IDEA</a>，熟悉尽可能多的快捷键，《<a href="https://www.google.com/#hl=zh-CN&amp;site=&amp;source=hp&amp;q=Eclipse+%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE&amp;oq=Eclipse+%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE&amp;aq=f&amp;aqi=g-l1&amp;aql=&amp;gs_l=hp.3..0i13.449l7739l0l7948l53l49l9l4l4l9l278l4511l14j15j7l36l0.&amp;bav=on.2,or.r_gc.r_pw.r_cp.,cf.osb&amp;fp=eef1a08d3fa904e4&amp;biw=1594&amp;bih=858" target="_blank" rel="external">Eclipse常见快捷键列表</a>》</p>
<p> 2.插件：<br> (1) <a href="http://findbugs.sourceforge.net/" target="_blank" rel="external">Findbugs</a>，在release之前进行一次静态代码检查是必须的<br> (2) <a href="http://www.atlassian.com/software/clover/overview" target="_blank" rel="external">Clover</a>，关心你的单元测试覆盖率<br> (3) <a href="http://checkstyle.sourceforge.net/" target="_blank" rel="external">Checkstyle</a> 代码风格检查</p>
<p> 3.构建和部署工具:ant或者maven，现在主流都是maven了吧，使用<a href="http://www.sonatype.org/nexus/" target="_blank" rel="external">nexus搭建maven私服</a>，再加上持续集成<a href="http://jenkins-ci.org/" target="_blank" rel="external">jenkins</a>。代码质量不用愁。</p>
<p> 4.版本管理工具： svn或者git</p>
<p> 5.<a href="http://www.linuxsky.org/doc/admin/200712/213.html" target="_blank" rel="external">diff</a>和<a href="http://www.linuxsky.org/doc/admin/200712/213.html" target="_blank" rel="external">patch</a></p>
<p> 6.设置你的eclipse或者IDEA，如formatter,save actions以及code template等。代码风格，直接用google的也可以啊。《<a href="http://code.google.com/p/google-styleguide/" target="_blank" rel="external">Google style guide</a>》</p>
<p> 7.掌握一个文本编辑器，Emacs或者VIM，熟悉常用快捷键。这在你需要在线编辑代码，或者编写其他语言代码时候特别有用。《<a href="http://linuxtoy.org/archives/why-emacs-vim-good.html" target="_blank" rel="external">神器圣战</a>》</p>
<p>二、JDK相关</p>
<p>1.jstat : 观察GC情况，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jstat -gcutil pid <span class="number">3078</span></div></pre></td></tr></table></figure>

<p>2.jmap，查看heap情况，如查看存活对象列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jmap -histo:live pid |grep com.company |less</div></pre></td></tr></table></figure>

<p>或者dump内存用来分析：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jmap -dump:file=test.bin pid</div></pre></td></tr></table></figure>

<p>3.分析dump的堆文件，可以用jhat:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jhat test.bin</div></pre></td></tr></table></figure>

<p>  分析完成后可以用浏览器查看堆的情况。这个工具的分析结果还比较原始，你还可以用Eclipse MAT插件进行图形化分析，或者IBM的<a href="https://www.ibm.com/developerworks/community/groups/service/html/communityview?communityUuid=4544bafe-c7a2-455f-9d43-eb866ea60091" target="_blank" rel="external">Heap Analyzer</a>.</p>
<p>4.jvisualvm和jconsole： JVM自带的性能分析和监控工具，怎么用？请自己看<a href="http://docs.oracle.com/javase/6/docs/technotes/guides/visualvm/index.html" target="_blank" rel="external">文档</a>。</p>
<p>5.jstack：分析线程堆栈，如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jstack pid &gt; thread_dump</div></pre></td></tr></table></figure>

<p>查看CPU最高的线程在干什么的方法结合top和jstack：<a href="http://www.iteye.com/topic/1114219" target="_blank" rel="external">http://www.iteye.com/topic/1114219</a></p>
<p>6.更多JVM工具，参见官方文档：<a href="http://docs.oracle.com/javase/6/docs/technotes/tools/" target="_blank" rel="external">http://docs.oracle.com/javase/6/docs/technotes/tools/</a></p>
<p>7.学习使用btrace分析java运行时问题。《(Btrace使用简介)[<a href="http://rdc.taobao.com/team/jm/archives/509]》" target="_blank" rel="external">http://rdc.taobao.com/team/jm/archives/509]》</a></p>
<p>8.GC日志分析工具：GC viewer、GC-console或者自己挑<a href="http://stackoverflow.com/questions/1839599/analyze-gc-logs-for-sun-hotspots-jvm-6" target="_blank" rel="external">这里</a>。</p>
<p>9.性能分析工具，除了自带的jvisualvm外，还可以用商业的jprofiler。</p>
<p>10.<a href="http://kenwublog.com/docs/java6-jvm-options-chinese-edition.htm" target="_blank" rel="external">JVM参数大全</a></p>
<p>11.《<a href="http://hllvm.group.iteye.com/group/topic/27945" target="_blank" rel="external">JVM调优标准参数陷阱</a>》，iteye神贴。</p>
<p>三、Linux工具</p>
<p>1.熟悉<a href="http://www.commandlinefu.com/commands/browse/sort-by-votes" target="_blank" rel="external">常用的shell命令</a>，</p>
<p>2.设置<a href="http://paulkeck.com/ssh/" target="_blank" rel="external">ssh免登陆</a></p>
<p>3.使用htop替换top。</p>
<p>4.熟悉下strace,gdb甚至systemtap来分析问题。</p>
<p>5.熟悉vmstat,iostat,sar等性能统计工具。</p>
<p>5.自动化部署脚本，<a href="http://docs.fabfile.org/en/1.4.1/index.html" target="_blank" rel="external">py-fabric</a>或者自荐下这个<a href="https://github.com/killme2008/clojure-control" target="_blank" rel="external">clojure-control</a>。</p>
<p>四、其他</p>
<p>1.掌握一门脚本语言，<a href="http://python.org/" target="_blank" rel="external">Python</a>或者<a href="http://www.ruby-lang.org/" target="_blank" rel="external">Ruby</a>，高效解决一些需要quick and dirty的任务：比如读写文件、导入导出数据库、网页爬虫等。注意不是python.com，咔咔。</p>
<p><code>Python</code>推荐<a href="http://woodpecker.org.cn/" target="_blank" rel="external">啄木鸟社区</a>,<code>Ruby</code>推荐<a href="https://ruby-china.org/" target="_blank" rel="external">Ruby China</a></p>
<p>2.使用Linux或者Mac os系统作为你的开发环境。</p>
<p>3.升级你的“硬件工具”，双屏大屏显示器、SSD、8G内存甚至更多。</p>
<p>4.你懂的：<a href="https://code.google.com/p/goagent/" target="_blank" rel="external">https://code.google.com/p/goagent/</a> ; <a href="https://github.com/justjavac/Google-IPs/blob/master/README.md" target="_blank" rel="external">https://github.com/justjavac/Google-IPs/blob/master/README.md</a></p>
<p>五、如何查找工具？</p>
<p>1.搜索引擎，google或者baidu，《<a href="http://www.williamlong.info/archives/728.html" target="_blank" rel="external">搜索技巧</a>》</p>
<p>2.万能的stack overflow：<a href="http://stackoverflow.com/" target="_blank" rel="external">http://stackoverflow.com/</a></p>
<p>3.虚心问牛人。</p>
<p>六、最重要的是⋯⋯</p>
<p>一颗永不停止学习的心。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-07-10T08:53:58.000Z"><a href="/2011/07/10/sed-awk/">7月 10 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/07/10/sed-awk/">sed和awk学习总结</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="一些说明">一些说明</h3>
<p>我测试例子都是在mac os x下,freebsd的sed和awk和gnu的都略有不同,甚至osx下得版本都不能使用,我会在注释中说明;</p>
<ul>
<li><p>sed<br>   sed 通用<br>  /usr/local/bin/sed osx下编译的gnu sed</p>
</li>
<li><p>awk<br>  awk 通用<br>  gawk osx编译的gnu awk</p>
</li>
</ul>
<h2 id="SED基础">SED基础</h2>
<h3 id="常用语法">常用语法</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 语法1</span></div><div class="line">sed [options] {sed-commands} {input-file}</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 例子</span></div><div class="line"><span class="comment"># -n表示取消默认输出,p表示打印行</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'p'</span> /etc/passwd</div><div class="line"><span class="comment"># 只打印第三行</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'3p'</span> /etc/passwd</div><div class="line"><span class="comment"># 打印1，3行</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'1,3p'</span> /etc/passwd</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 语法2</span></div><div class="line">sed [options] <span class="operator">-f</span> {sed-commands-in<span class="operator">-a</span>-file} {input-file}</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 例子</span></div><div class="line"><span class="comment"># 打印以root开头或者nobody开头的行</span></div><div class="line">cat sed_example_1.sed</div><div class="line">/^root/ p</div><div class="line">/^nobody/ p</div><div class="line"><span class="comment">#</span></div><div class="line">sed -n <span class="operator">-f</span> sed_example_1.sed /etc/passwd</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 语法3</span></div><div class="line">sed [options] <span class="operator">-e</span> {sed-command-<span class="number">1</span>} <span class="operator">-e</span> {sed-command-<span class="number">2</span>} {input-file}</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 例子</span></div><div class="line"><span class="comment"># 打印以root开头或者nobody开头的行</span></div><div class="line"><span class="variable">$sed</span> -n <span class="operator">-e</span> <span class="string">'/^root/ p'</span> <span class="operator">-e</span> <span class="string">'/^nobody/ p'</span> /etc/passwd</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># 或者</span></div><div class="line"><span class="variable">$sed</span> -n \</div><div class="line"><span class="operator">-e</span> <span class="string">'/^root/ p'</span> \</div><div class="line"><span class="operator">-e</span> <span class="string">'/^nobody/ p'</span> \</div><div class="line">/etc/passwd</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 语法4</span></div><div class="line">sed [options] <span class="string">'{</span></div><div class="line">sed-command-1</div><div class="line">sed-command-2</div><div class="line">}' input-file</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 例子</span></div><div class="line"><span class="comment"># 打印以root开头或者nobody结尾的行</span></div><div class="line">sed -n <span class="string">'{</span></div><div class="line">/^root/ p</div><div class="line">/nobody$/ p</div><div class="line">}' /etc/passwd</div></pre></td></tr></table></figure>



<h3 id="SED流">SED流</h3>
<ul>
<li>1.读</li>
<li>2.执行</li>
<li>3.打印</li>
<li>4.重复</li>
</ul>
<p>源文件</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">101,Ian Bicking,Mozilla</div><div class="line">102,Hakim El Hattab,Whim</div><div class="line">103,Paul Irish,Google</div><div class="line">104,Addy Osmani,Google</div><div class="line">105,Chris Wanstrath,Github</div><div class="line">106,Mattt Thompson,Heroku</div><div class="line">107,Ask Solem Hoel,VMware</div></pre></td></tr></table></figure>



<p>范围</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 在freebsd版sed不能用</span></div><div class="line">$/usr/local/bin/sed -n <span class="string">'1~2 p'</span> source.txt </div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># 在freebsd版sed不能用</span></div><div class="line">$/usr/local/bin/sed -n <span class="string">'2~3 p'</span> source.txt </div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div></pre></td></tr></table></figure>

<p>模式匹配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 寻找包含Paul的行</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/Paul/ p'</span> source.txt</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="comment"># 从第一行开始到第五行, 从找到开始打印到第五行</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/Paul/,5 p'</span> source.txt</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># 从匹配Paul行打印达匹配Addy的行</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/Paul/,/Addy/ p'</span> source.txt</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="comment"># 在freebsd版sed不能用 匹配Paul行再多输出2行</span></div><div class="line">$/usr/local/bin/sed -n <span class="string">'/Paul/,+2 p'</span> source.txt</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div></pre></td></tr></table></figure>

<p>删除行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 删除所有行</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'d'</span> source.txt </div><div class="line"><span class="comment"># 只删除第二行</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'2 d'</span> source.txt </div><div class="line">...</div><div class="line"><span class="comment"># 删除第一到第四行</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'1,4 d'</span> source.txt</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div><div class="line"><span class="comment"># 删除奇数行</span></div><div class="line">$/usr/local/bin/sed <span class="string">'1~2 d'</span> source.txt</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="comment"># 删除符合Paul到Addy的行</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'/Paul/,/Addy/d'</span> source.txt</div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div><div class="line"><span class="comment"># 删除空行</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'/^$/ d'</span> source.txt</div><div class="line"><span class="comment"># 删除评论行</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'/^#/ d'</span> source.txt</div></pre></td></tr></table></figure>

<p>重定向</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 将source.txt内容重定向写到output.txt</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'w output.txt'</span> source.txt</div><div class="line"><span class="comment"># 和上面一样,但是没有在终端显示</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'w output.txt'</span> source.txt</div><div class="line"><span class="comment"># 只写第二行</span></div><div class="line">$ sed -n <span class="string">'2 w output.txt'</span> source.txt</div><div class="line"><span class="comment"># 写一到四行到output.txt</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'1,4 w output.txt'</span></div><div class="line"><span class="comment"># 写匹配Ask的行到结尾行到output.txt</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/Ask/,$ w output.txt'</span></div></pre></td></tr></table></figure>

<p>替换语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'[address-range|pattern-range] s/original-</span></div><div class="line">string/replacement-string/[substitute-flags]' inputfile</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="comment"># 替换Google为Github</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'s/Google/Github/'</span> source.txt</div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">103</span>,Paul Irish,Github</div><div class="line"><span class="number">104</span>,Addy Osmani,Github</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div><div class="line"><span class="comment"># 替换匹配Addy的行里面的Google为Github</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'/Addy/s/Google/Github/'</span> source.txt</div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">104</span>,Addy Osmani,Github</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div><div class="line"><span class="comment"># 默认s只会替换一行中的第一个匹配项</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'1s/a/A/'</span>  source.txt|head -<span class="number">1</span></div><div class="line"><span class="number">101</span>,IAn Bicking,Mozilla</div><div class="line"><span class="comment"># g可以替换每行的全部符合</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'1s/a/A/g'</span>  source.txt|head -<span class="number">1</span></div><div class="line"><span class="number">101</span>,IAn Bicking,MozillA</div><div class="line"><span class="comment"># 可以直接指定想要替换的第N个匹配项,这里是第二个</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'1s/a/A/2'</span>  source.txt|head -<span class="number">1</span></div><div class="line"><span class="number">101</span>,Ian Bicking,MozillA</div><div class="line"><span class="comment"># 使用w将能够替换的行重定向写到output.txt</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'s/Mozilla/Github/w output.txt'</span> source.txt</div><div class="line"><span class="variable">$cat</span> output.txt </div><div class="line"><span class="number">101</span>,Ian Bicking,Github</div><div class="line"><span class="comment"># 还可以使用i忽略匹配的大小写,看来freebsd的不能用</span></div><div class="line">$/usr/local/bin/sed <span class="string">'1s/ian/IAN/i'</span>  source.txt|head -<span class="number">1</span></div><div class="line"><span class="number">101</span>,IAN Bicking,Mozilla</div><div class="line"><span class="comment"># 这里有个新的文件</span></div><div class="line"><span class="variable">$cat</span> files.txt </div><div class="line">/etc/passwd</div><div class="line">/etc/group</div><div class="line"><span class="comment"># 给每行前和后都添加点字符</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'s/\(.*\)/ls -l \1|head -1/'</span> files.txt</div><div class="line">ls <span class="operator">-l</span> /etc/passwd|head -<span class="number">1</span></div><div class="line">ls <span class="operator">-l</span> /etc/group|head -<span class="number">1</span></div><div class="line"><span class="comment"># 我要用sed执行这个字符串命令了 无奈..mac上得sed都不行</span></div><div class="line">dongwm@bj-<span class="number">1</span>:~$ sed <span class="string">'s/^/ls -l /e'</span> files.txt</div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1627</span> Oct <span class="number">14</span> <span class="number">14</span>:<span class="number">30</span> /etc/passwd</div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">807</span> Oct <span class="number">14</span> <span class="number">14</span>:<span class="number">30</span> /etc/group</div><div class="line"><span class="comment"># sed分隔符不只可以使用'/'</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'s|/usr/local/bin|/usr/bin|'</span> path.txt</div><div class="line"><span class="variable">$sed</span> <span class="string">'s^/usr/local/bin^/usr/bin^'</span> path.txt</div><div class="line"><span class="variable">$sed</span> <span class="string">'s@/usr/local/bin@/usr/bin@'</span> path.txt</div><div class="line"><span class="variable">$sed</span> <span class="string">'s!/usr/local/bin!/usr/bin!'</span> path.txt</div></pre></td></tr></table></figure>

<p>替换覆盖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'{</span></div><div class="line">s/Google/Github/</div><div class="line">s/Git/git/ </div><div class="line">}' source.txt </div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">103</span>,Paul Irish,github</div><div class="line"><span class="number">104</span>,Addy Osmani,github</div><div class="line"><span class="number">105</span>,Chris Wanstrath,github</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div></pre></td></tr></table></figure>

<p>神奇的&amp;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$sed</span> <span class="string">'s/^[0-9][0-9][0-9]/[&]/g'</span></div><div class="line">[<span class="number">101</span>],Ian Bicking,Mozilla</div><div class="line">[<span class="number">102</span>],Hakim El Hattab,Whim</div><div class="line">[<span class="number">103</span>],Paul Irish,Google</div><div class="line">[<span class="number">104</span>],Addy Osmani,Google</div><div class="line">[<span class="number">105</span>],Chris Wanstrath,Github</div><div class="line">[<span class="number">106</span>],Mattt Thompson,Heroku</div><div class="line">[<span class="number">107</span>],Ask Solem Hoel,VMware</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'s/^.*/&lt;\&&gt;/'</span> source.txt </div><div class="line">&lt;<span class="number">101</span>,Ian Bicking,Mozilla&gt;</div><div class="line">&lt;<span class="number">102</span>,Hakim El Hattab,Whim&gt;</div><div class="line">&lt;<span class="number">103</span>,Paul Irish,Google&gt;</div><div class="line">&lt;<span class="number">104</span>,Addy Osmani,Google&gt;</div><div class="line">&lt;<span class="number">105</span>,Chris Wanstrath,Github&gt;</div><div class="line">&lt;<span class="number">106</span>,Mattt Thompson,Heroku&gt;</div><div class="line">&lt;<span class="number">107</span>,Ask Solem Hoel,VMware&gt;</div></pre></td></tr></table></figure>



<p>正则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ^表示匹配以什么开头</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/^101/ p'</span> source.txt      </div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="comment"># $表示匹配以什么结尾</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/Github$/ p'</span> source.txt </div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="comment"># .表示单个字符,下面的匹配一个逗号然后I然后2个单字符</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/,I../ p'</span> source.txt</div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="comment"># *表示匹配0个或者多个, \+表示匹配一个或者多个, \?表示匹配0个或者1个</span></div><div class="line"><span class="comment"># [0-9]表示匹配数字,下面匹配包含3或者4的行</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/[34]/ p '</span> source.txt      </div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="comment"># -表示范围,这里匹配3,4,5</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/[3-5]/ p '</span> source.txt</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="comment"># |表示或者的关系</span></div><div class="line">$/usr/local/bin/sed -n <span class="string">'/102\|103/ p '</span> source.txt</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="comment"># 看一个文件</span></div><div class="line"><span class="variable">$cat</span> numbers.txt </div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">12</span></div><div class="line"><span class="number">123</span></div><div class="line"><span class="number">1234</span></div><div class="line"><span class="number">12345</span></div><div class="line"><span class="number">123456</span></div><div class="line"><span class="comment"># {m} 表示前面的匹配的重复次数</span></div><div class="line"><span class="variable">$sed</span> -n <span class="string">'/^[0-9]\{5\}$/ p'</span> numbers.txt</div><div class="line"><span class="number">12345</span></div><div class="line"><span class="comment">#{m,n } 表示匹配m-n的次数都算</span></div><div class="line">sed -n <span class="string">'/^[0-9]\{3,5\}$/ p'</span> numbers.txt</div><div class="line"><span class="number">123</span></div><div class="line"><span class="number">1234</span></div><div class="line"><span class="number">12345</span></div><div class="line"><span class="comment"># 删除所有注释行和空行</span></div><div class="line"><span class="variable">$sed</span> <span class="operator">-e</span> <span class="string">'s/#.*//'</span> <span class="operator">-e</span> <span class="string">'/^$/ d'</span> /etc/profile							</div><div class="line"><span class="comment"># 转化windows文件到unix格式</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'s/.$//'</span> filename								</div><div class="line"><span class="comment">#							</span></div><div class="line"><span class="comment">#\1表示第一个正则匹配到的数据</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'s/\([^,]*\).*/\1/g'</span> source.txt |head -<span class="number">1</span></div><div class="line"><span class="number">101</span></div><div class="line"><span class="comment">#给每个单词第一个字母加括号</span></div><div class="line"><span class="variable">$echo</span> <span class="string">"Dong Wei Ming"</span> | /usr/local/bin/sed <span class="string">'s/\(\b[A-Z]\)/\(\1\)/g'</span></div><div class="line">(D)ong (W)ei (M)ing</div><div class="line">$/usr/local/bin/sed <span class="string">'s/\(^\|[^0-9.]\)\([0-9]\+\)\([0-9]\{3\}\)/\1\2,\3/g'</span> numbers.txt</div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">12</span></div><div class="line"><span class="number">123</span></div><div class="line"><span class="number">1</span>,<span class="number">234</span></div><div class="line"><span class="number">12</span>,<span class="number">345</span></div><div class="line"><span class="number">123</span>,<span class="number">456</span></div><div class="line"><span class="comment"># 只取第一和第三列,并且换了他们的位置</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'s/\([^,]*\),\([^,]*\),\([^,]*\).*/\3,\1/g'</span> source.txt</div><div class="line">Mozilla,<span class="number">101</span></div><div class="line">Whim,<span class="number">102</span></div><div class="line">Google,<span class="number">103</span></div><div class="line">Google,<span class="number">104</span></div><div class="line">Github,<span class="number">105</span></div><div class="line">Heroku,<span class="number">106</span></div><div class="line">VMware,<span class="number">107</span></div></pre></td></tr></table></figure>

<h3 id="GNU_SED">GNU SED</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># \l能将后面的一个字符变成小写</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'s/Ian/IAN/'</span> source.txt|head -<span class="number">1</span>               </div><div class="line"><span class="number">101</span>,IAN Bicking,Mozilla</div><div class="line">$/usr/local/bin/sed <span class="string">'s/Ian/IA\lN/'</span> source.txt|head -<span class="number">1</span> </div><div class="line"><span class="number">101</span>,IAn Bicking,Mozilla</div><div class="line"><span class="comment"># \L能将后面的字符都变成小写</span></div><div class="line">$/usr/local/bin/sed <span class="string">'s/Ian/I\LAN/'</span> source.txt|head -<span class="number">1</span></div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="comment"># \u能将后面的一个字符变成大写</span></div><div class="line">$/usr/local/bin/sed <span class="string">'s/Ian/IA\un/'</span> source.txt|head -<span class="number">1</span></div><div class="line"><span class="number">101</span>,IAN Bicking,Mozilla</div><div class="line"><span class="comment"># \U能将后面的字都变成大写</span></div><div class="line">$/usr/local/bin/sed <span class="string">'s/Ian/\Uian/'</span> source.txt|head -<span class="number">1</span> </div><div class="line"><span class="number">101</span>,IAN Bicking,Mozilla</div><div class="line"><span class="comment"># \E能打断\L或者\U改变大小写</span></div><div class="line">$/usr/local/bin/sed <span class="string">'s/Ian/\Uia\En/'</span> source.txt|head -<span class="number">1</span></div><div class="line"><span class="number">101</span>,IAn Bicking,Mozilla</div><div class="line"><span class="comment"># 使用以上功能:调换前2列,把名字列全部大写,公司列全部小写</span></div><div class="line">$/usr/local/bin/sed <span class="string">'s/\([^,]*\),\([^,]*\),\(.*\).*/\U\2\E,\1,\L\3/g'</span> source.txt</div><div class="line">IAN BICKING,<span class="number">101</span>,mozilla</div><div class="line">HAKIM EL HATTAB,<span class="number">102</span>,whim</div><div class="line">PAUL IRISH,<span class="number">103</span>,google</div><div class="line">ADDY OSMANI,<span class="number">104</span>,google</div><div class="line">CHRIS WANSTRATH,<span class="number">105</span>,github</div><div class="line">MATTT THOMPSON,<span class="number">106</span>,heroku</div><div class="line">ASK SOLEM HOEL,<span class="number">107</span>,vmware</div></pre></td></tr></table></figure>

<h3 id="sed使用示例">sed使用示例</h3>
<p>SED可执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cat</span> testscript.sed</div><div class="line"><span class="comment">#!/usr/bin/sed -nf</span></div><div class="line">/root/ p</div><div class="line">/nobody/ p</div><div class="line"><span class="variable">$chmod</span> u+x testscript.sed</div><div class="line">$./testscript.sed /etc/passwd </div><div class="line">nobody:*:-<span class="number">2</span>:-<span class="number">2</span>:Unprivileged User:/var/empty:/usr/bin/<span class="literal">false</span></div><div class="line">root:*:<span class="number">0</span>:<span class="number">0</span>:System Administrator:/var/root:/bin/sh</div><div class="line">daemon:*:<span class="number">1</span>:<span class="number">1</span>:System Services:/var/root:/usr/bin/<span class="literal">false</span></div><div class="line">_cvmsroot:*:<span class="number">212</span>:<span class="number">212</span>:CVMS Root:/var/empty:/usr/bin/<span class="literal">false</span></div></pre></td></tr></table></figure>



<p>SED修改源文件和备份</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-i会修改源文件,但是可以同时使用bak备份</span></div><div class="line"><span class="variable">$sed</span> -ibak <span class="string">'s/Ian/IAN/'</span> source.txt </div><div class="line"><span class="comment"># or</span></div><div class="line">sed --in-place=bak <span class="string">'s/Ian/IAN/'</span> source.txt </div><div class="line"><span class="comment"># 这样会存在一个文件source.txtbak</span></div></pre></td></tr></table></figure>

<p>行后增加语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'[address] a the-line-to-append'</span> input-file</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line">$/usr/local/bin/sed <span class="string">'2 a 108,Donald Stufft, Nebula'</span> source.txt</div><div class="line"><span class="number">101</span>,IAN Bicking,Mozilla</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">108</span>,Donald Stufft, Nebula</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div></pre></td></tr></table></figure>

<p>行前插入语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'[address] i the-line-to-insert'</span> input-file</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line">$/usr/local/bin/sed <span class="string">'2 i 108,Donald Stufft, Nebula'</span> source.txt</div><div class="line"><span class="number">101</span>,IAN Bicking,Mozilla</div><div class="line"><span class="number">108</span>,Donald Stufft, Nebula</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div></pre></td></tr></table></figure>


<p>修改行语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'[address] c the-line-to-insert'</span> input-file</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="comment"># 修改符合Paul行为...</span></div><div class="line">$/usr/local/bin/sed <span class="string">'/Paul/ c 108,Donald Stufft, Nebula'</span> source.txt</div><div class="line"><span class="number">101</span>,IAN Bicking,Mozilla</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">108</span>,Donald Stufft, Nebula</div><div class="line"><span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div></pre></td></tr></table></figure>

<p>SED其他</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -l会显示隐藏字符比如'\t', = 可以显示行号</span></div><div class="line"><span class="variable">$sed</span> <span class="operator">-l</span> = source.txt</div><div class="line"><span class="comment"># y或翻译你要转换的字符,这里I会转化成i，B转换成b</span></div><div class="line"><span class="variable">$sed</span> <span class="string">'y/IB/ib/'</span> source.txt |head -<span class="number">1</span></div><div class="line"><span class="number">101</span>,iAN bicking,Mozilla</div></pre></td></tr></table></figure>

<h3 id="sed练习">sed练习</h3>
<ul>
<li>1.把123变成[123](不要sed “s/([0-9]{3})/[\1]/“)</li>
<li>2.这是什么意思: echo “1\n2\n3\n4”|sed -n “/2/, +2p”(gnu sed)</li>
<li>3.这是什么意思: echo “1\n2\n3”|sed ‘2 c 4’ (gnu sed)</li>
<li>4.把This is UPPER变成IS,This,upper(gnu sed)</li>
<li>5.这是什么意思: sed ‘H;x;s/^(.<em>)\n(.</em>)/\2\1/‘</li>
<li>6.实现tac命令的功能</li>
</ul>
<h2 id="SED高级话题(保持空间和模式空间)">SED高级话题(保持空间和模式空间)</h2>
<p>源码</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#先看一个文件</span></div><div class="line"><span class="variable">$cat</span> <span class="built_in">source</span>2.txt </div><div class="line">Ian Bicking</div><div class="line">Mozilla</div><div class="line">Hakim El Hattab</div><div class="line">Whim</div><div class="line">Paul Irish</div><div class="line">Google</div><div class="line">Chris Wanstrath</div><div class="line">Github</div><div class="line">Mattt Thompson</div><div class="line">Heroku</div></pre></td></tr></table></figure>


<p>交换模式空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 通过公司找到这个人, x命令交换当前行到保持空间,</span></div><div class="line"><span class="comment"># n读取下一行到模式空间; 匹配这个模式空间, 假如符合,再交换模式空间，打印</span></div><div class="line">$/usr/local/bin/sed  -n <span class="operator">-e</span> <span class="string">'x;n'</span> <span class="operator">-e</span> <span class="string">'/Whim/{x;p}'</span> <span class="built_in">source</span>2.txt  </div><div class="line">Hakim El Hattab</div></pre></td></tr></table></figure>

<p>拷贝模式空间到保持空间</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 还是前面的需求.h拷贝模式空间到保持空间, </span></div><div class="line"><span class="comment"># 如果当前模式空间不匹配, 就拷贝空间到保持空间. 他们会一样</span></div><div class="line"><span class="comment"># 但是当Whim匹配保持空间还是上面一行关于名字的缓存</span></div><div class="line">$/usr/local/bin/sed  -n <span class="operator">-e</span> <span class="string">'/Whim/!h'</span> <span class="operator">-e</span> <span class="string">'/Whim/{x;p}'</span> <span class="built_in">source</span>2.txt  </div><div class="line">Hakim El Hattab</div></pre></td></tr></table></figure>



<p>增加模式空间到保持空间</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 当我根据Whim想显示他的名字和公司名字呢？ - 给保持空间多加一个</span></div><div class="line"><span class="comment"># H表示增加模式空间到保持空间</span></div><div class="line">$/usr/local/bin/sed -n <span class="operator">-e</span> <span class="string">'/Whim/!h'</span> <span class="operator">-e</span> <span class="string">'/Whim/{H;x;p}'</span> <span class="built_in">source</span>2.txt </div><div class="line">Hakim El Hattab</div><div class="line">Whim</div><div class="line"><span class="comment"># 显示的好看一点</span></div><div class="line">$/usr/local/bin/sed -n <span class="operator">-e</span> <span class="string">'/Whim/!h'</span> <span class="operator">-e</span> <span class="string">'/Whim/{H;x;s/\n/:/;p}'</span> <span class="built_in">source</span>2.txt </div><div class="line">Hakim El Hattab:Whim</div></pre></td></tr></table></figure>

<p>拷贝保持空间到模式空间</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 还是前面的需求.g拷贝保持空间到模式空间</span></div><div class="line">$/usr/local/bin/sed  -n <span class="operator">-e</span> <span class="string">'/Whim/!h'</span> <span class="operator">-e</span> <span class="string">'/Whim/{g;p}'</span> <span class="built_in">source</span>2.txt   </div><div class="line">Hakim El Hattab</div></pre></td></tr></table></figure>

<p>增加保持空间到模式空间</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 前面的前面, 输出是Hakim El Hattab:Whim 怎么样翻转呢？</span></div><div class="line"><span class="comment"># G就是反向的</span></div><div class="line">$/usr/local/bin/sed -n <span class="operator">-e</span> <span class="string">'/Whim/!h'</span> <span class="operator">-e</span> <span class="string">'/Whim/{G;s/\n/:/;p}'</span> <span class="built_in">source</span>2.txt  </div><div class="line">Whim:Hakim El Hattab</div></pre></td></tr></table></figure>

<p>增加下一行到模式空间</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$/</span>usr/local/bin/sed -e <span class="string">'{N;s/\n/:/}'</span> source2.txt</div><div class="line"><span class="constant">Ian</span> <span class="constant">Bicking</span><span class="symbol">:Mozilla</span></div><div class="line"><span class="constant">Hakim</span> <span class="constant">El</span> <span class="constant">Hattab</span><span class="symbol">:Whim</span></div><div class="line"><span class="constant">Paul</span> <span class="constant">Irish</span><span class="symbol">:Google</span></div><div class="line"><span class="constant">Chris</span> <span class="constant">Wanstrath</span><span class="symbol">:Github</span></div><div class="line"><span class="constant">Mattt</span> <span class="constant">Thompson</span><span class="symbol">:Heroku</span></div></pre></td></tr></table></figure>

<p>LABEL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 给匹配Github的行,在使用名字:公司的前面加一个*, </span></div><div class="line"><span class="comment">#只有匹配Github的模式空间和保持空间才会执行s/^/*/</span></div><div class="line"><span class="variable">$cat</span> label.sed </div><div class="line"><span class="comment">#!/usr/local/bin/sed -nf</span></div><div class="line">h;n;H;x</div><div class="line">s/\n/:/</div><div class="line">/Github/!b end</div><div class="line">s/^/*/</div><div class="line">:end p</div><div class="line"><span class="variable">$chmod</span> u+x label.sed</div><div class="line">./label.sed <span class="built_in">source</span>2.txt</div><div class="line">Ian Bicking:Mozilla</div><div class="line">Hakim El Hattab:Whim</div><div class="line">Paul Irish:Google</div><div class="line">*Chris Wanstrath:Github</div><div class="line">Mattt Thompson:Heroku</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="comment"># 把mac地址的冒号替换掉</span></div><div class="line"><span class="string">"130531170341903612"</span>,<span class="string">"259594"</span>,<span class="number">2013</span>-<span class="number">05</span>-<span class="number">31</span>T09:<span class="number">04</span>:<span class="number">25</span>Z,<span class="string">"1c:b0:94:b2:85:bd"</span></div><div class="line"><span class="comment">#						</span></div><div class="line"><span class="number">1</span>. sed <span class="string">"s/\([0-9a-zA-Z]\{2\}\):\([0-9a-zA-Z]\{2\}\):\([0-9a-zA-Z]\{2\}\):\([0-9a-zA-Z]\{2\}\):\([0-9a-zA-Z]\{2\}\):\([0-9a-zA-Z]\{2\}\)/\1\2\3\4\5\6/"</span></div><div class="line"><span class="number">2</span>. sed <span class="string">"s/\(.*\):\(.*\):\(.*\):\(.*\):\(.*\):\(.*\)/\1\2\3\4\5\6/"</span></div><div class="line"><span class="number">3</span>. sed <span class="operator">-e</span> <span class="string">"s/T\(.*\):\(.*\):\(.*\)Z/\1#\2#\3/"</span> <span class="operator">-e</span> <span class="string">"s/://g"</span> <span class="operator">-e</span> <span class="string">"s/#/:/g"</span></div></pre></td></tr></table></figure>

<h2 id="AWK">AWK</h2>
<h3 id="AWK基本语法">AWK基本语法</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#语法1</span></div><div class="line">awk -Fs <span class="string">'/pattern/ {action}'</span> input-file</div><div class="line"><span class="comment">#or</span></div><div class="line">awk -Fs <span class="string">'{action}'</span> intput-file</div><div class="line"><span class="comment"># -F表示设置分隔符,不指定就是默认为空字符</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="comment"># 用:分割，查找匹配mail的行并且打印冒号分割后的第一部分</span></div><div class="line">awk -F: <span class="string">'/mail/ {print $1}'</span> /etc/passwd</div><div class="line">_mailman</div><div class="line">_clamav</div><div class="line">_amavisd</div></pre></td></tr></table></figure>

<h3 id="AWK数据结构">AWK数据结构</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 1 BEGIN { awk-commands } 在执行awk body之前执行这个awk-commands,而且只一次</span></div><div class="line"><span class="comment"># 2 /pattern/ {action} body部分，也就是awk要执行的主体,比如十行,那么这个主体就调用10次</span></div><div class="line"><span class="comment"># 3 END { awk-commands } 在执行完body之后执行,也是只一次</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN { FS=":";print "---header---" } /mail/ {print $1} \</span></div><div class="line">END { print "---footer---"}' /etc/passwd</div><div class="line">---header---</div><div class="line">_mailman</div><div class="line">_clamav</div><div class="line">_amavisd</div><div class="line">---footer---</div><div class="line"><span class="comment"># 当然可以只有其中一种或者集中数据结构</span></div><div class="line">awk -F: <span class="string">'BEGIN { print "UID"} { print $3 }'</span> /etc/passwd |\</div><div class="line">sed <span class="operator">-e</span> <span class="string">'/^$/ d'</span>|head -<span class="number">2</span></div><div class="line">UID</div><div class="line">-<span class="number">2</span></div><div class="line">$ awk <span class="string">'BEGIN { print "Hello World!" }'</span></div><div class="line">Hello World!</div></pre></td></tr></table></figure>



<p>源码2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这是一个文件,分别是id, 描述, 价钱和库存</span></div><div class="line"><span class="variable">$cat</span> items.txt </div><div class="line"><span class="number">101</span>,HD Camcorder,Video,<span class="number">210</span>,<span class="number">10</span></div><div class="line"><span class="number">102</span>,Refrigerator,Appliance,<span class="number">850</span>,<span class="number">2</span></div><div class="line"><span class="number">103</span>,MP3 Player,Audio,<span class="number">270</span>,<span class="number">15</span></div><div class="line"><span class="number">104</span>,Tennis Racket,Sports,<span class="number">190</span>,<span class="number">20</span></div><div class="line"><span class="number">105</span>,Laser Printer,Office,<span class="number">475</span>,<span class="number">5</span></div></pre></td></tr></table></figure>

<p>源码3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这是一个销售数据,分别是id和1-6月的销售情况</span></div><div class="line"><span class="variable">$cat</span> items-sold.txt</div><div class="line"><span class="number">101</span> <span class="number">2</span> <span class="number">10</span> <span class="number">5</span> <span class="number">8</span> <span class="number">10</span> <span class="number">12</span></div><div class="line"><span class="number">102</span> <span class="number">0</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">0</span> <span class="number">2</span></div><div class="line"><span class="number">103</span> <span class="number">10</span> <span class="number">6</span> <span class="number">11</span> <span class="number">20</span> <span class="number">5</span> <span class="number">13</span></div><div class="line"><span class="number">104</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">0</span> <span class="number">6</span> <span class="number">5</span></div><div class="line"><span class="number">105</span> <span class="number">10</span> <span class="number">2</span> <span class="number">5</span> <span class="number">7</span> <span class="number">12</span> <span class="number">6</span></div></pre></td></tr></table></figure>

<p>PRINT</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 默认print就是打印文件全文到终端</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'{print}'</span> source.txt</div><div class="line"><span class="comment"># 下面是通过,分割,输出第二段。$0表示全行,类似shell用法</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">','</span> <span class="string">'{print $2}'</span> source.txt</div><div class="line">Ian Bicking</div><div class="line">Hakim El Hattab</div><div class="line">Paul Irish</div><div class="line">Addy Osmani</div><div class="line">Chris Wanstrath</div><div class="line">Mattt Thompson</div><div class="line">Ask Solem Hoel</div><div class="line"><span class="comment"># or</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">","</span> <span class="string">'{print $2}'</span> source.txt</div><div class="line"><span class="variable">$awk</span> -F, <span class="string">'{print $2}'</span> source.txt</div><div class="line"><span class="comment"># 一个格式化更好看些的效果</span></div><div class="line">awk -F <span class="string">','</span> <span class="string">'BEGIN \                         </span></div><div class="line">{ print "-------------\nName\tComp\n-------------"} \</div><div class="line">{ print $2,"\t",$3;} \  </div><div class="line">END { print "-------------"; }' source.txt </div><div class="line">-------------</div><div class="line">Name	Comp</div><div class="line">-------------</div><div class="line">Ian Bicking 	 Mozilla</div><div class="line">Hakim El Hattab 	 Whim</div><div class="line">Paul Irish 	 Google</div><div class="line">Addy Osmani 	 Google</div><div class="line">Chris Wanstrath 	 Github</div><div class="line">Mattt Thompson 	 Heroku</div><div class="line">Ask Solem Hoel 	 VMware</div><div class="line">-------------</div></pre></td></tr></table></figure>

<p>模式匹配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 用逗号做分隔符, 打印第二和第三列</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">','</span> <span class="string">'/Whim/ {print $2, $3}'</span> source.txt</div><div class="line">Hakim El Hattab Whim</div><div class="line"><span class="comment"># 可以加点格式化语句</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">','</span> <span class="string">'/Whim/ {print "Whim\"s name:", $2}'</span> source.txt</div><div class="line">Whim<span class="string">"s name: Hakim El Hattab</span></div></pre></td></tr></table></figure>



<p>AWK内置变量 - FS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$awk</span> -F <span class="string">','</span> <span class="string">'{print $2, $3}'</span> source.txt  </div><div class="line">Ian Bicking Mozilla</div><div class="line">Hakim El Hattab Whim</div><div class="line">Paul Irish Google</div><div class="line">Addy Osmani Google</div><div class="line">Chris Wanstrath Github</div><div class="line">Mattt Thompson Heroku</div><div class="line">Ask Solem Hoel VMware</div><div class="line"><span class="comment"># 可以使用内置的FS - 输入字段分隔符 实现相同的功能</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN {FS=","} {print $2, $3}'</span> source.txt</div><div class="line"><span class="comment"># 先看一个文件</span></div><div class="line"><span class="variable">$cat</span> <span class="built_in">source</span>-multiple-fs.txt </div><div class="line"><span class="number">101</span>,Ian Bicking:Mozilla%</div><div class="line"><span class="number">102</span>,Hakim El Hattab:Whim%</div><div class="line"><span class="number">103</span>,Paul Irish:Google%</div><div class="line"><span class="number">104</span>,Addy Osmani:Google%</div><div class="line"><span class="number">105</span>,Chris Wanstrath:Github%</div><div class="line"><span class="number">106</span>,Mattt Thompson:Heroku%</div><div class="line"><span class="number">107</span>,Ask Solem Hoel:VMware%</div><div class="line"><span class="comment"># 发现上面的分隔符有三种:逗号分号和百分号,这样就可以这样使用</span></div><div class="line"><span class="comment"># awk 'BEGIN {FS="[,:%]"} {print $2, $3}' source-multiple-fs.txt</span></div></pre></td></tr></table></figure>

<p>AWK内置变量 - OFS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$awk</span> -F <span class="string">','</span> <span class="string">'{print $2, ":", $3}'</span> source.txt </div><div class="line">Ian Bicking : Mozilla</div><div class="line">Hakim El Hattab : Whim</div><div class="line">Paul Irish : Google</div><div class="line">Addy Osmani : Google</div><div class="line">Chris Wanstrath : Github</div><div class="line">Mattt Thompson : Heroku</div><div class="line">Ask Solem Hoel : VMware</div><div class="line"><span class="comment"># 其实可以用内置的OFS - 输出字段分隔符</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">','</span> <span class="string">'BEGIN { OFS=":" } { print $2, $3 }'</span> source.txt</div></pre></td></tr></table></figure>

<p>AWK内置变量 - RS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cat</span> <span class="built_in">source</span>-one-line.txt </div><div class="line"><span class="number">1</span>,one:<span class="number">2</span>,two:<span class="number">3</span>,three:<span class="number">4</span>,four</div><div class="line"><span class="comment"># 现在我想分割成(1，one),(2, two)这样的效果</span></div><div class="line"><span class="variable">$awk</span> -F, <span class="string">'{print $2}'</span> <span class="built_in">source</span>-one-line.txt </div><div class="line">one:<span class="number">2</span></div><div class="line"><span class="comment"># 这个没有实现我想要的效果</span></div><div class="line"><span class="comment"># 使用RS - 记录分隔符, 他能帮你把单行内容先分割然后再按-F分割</span></div><div class="line"><span class="variable">$awk</span> -F, <span class="string">'BEGIN { RS=":" } { print $2 }'</span> <span class="built_in">source</span>-one-line.txt</div><div class="line">one</div><div class="line">two</div><div class="line">three</div><div class="line">four</div></pre></td></tr></table></figure>

<p>AWK内置变量 - ORS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># RS是输入, ORS就是输出</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN { FS=","; OFS="\n";ORS="\n---\n" } \</span></div><div class="line">{print $1,$2,$3}' source.txt|head -<span class="number">8</span></div><div class="line"><span class="number">101</span></div><div class="line">Ian Bicking</div><div class="line">Mozilla</div><div class="line">---</div><div class="line"><span class="number">102</span></div><div class="line">Hakim El Hattab</div><div class="line">Whim</div><div class="line">---</div></pre></td></tr></table></figure>



<p>AWK内置变量 - NR</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># NR是记录的数目</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN {FS=","} \</span></div><div class="line">{print "Emp Id of record number",NR,"is",$1;} \</div><div class="line">END {print "Total number of records:",NR}' source.txt</div><div class="line">Emp Id of record number <span class="number">1</span> is <span class="number">101</span></div><div class="line">Emp Id of record number <span class="number">2</span> is <span class="number">102</span></div><div class="line">Emp Id of record number <span class="number">3</span> is <span class="number">103</span></div><div class="line">Emp Id of record number <span class="number">4</span> is <span class="number">104</span></div><div class="line">Emp Id of record number <span class="number">5</span> is <span class="number">105</span></div><div class="line">Emp Id of record number <span class="number">6</span> is <span class="number">106</span></div><div class="line">Emp Id of record number <span class="number">7</span> is <span class="number">107</span></div><div class="line">Total number of records: <span class="number">7</span></div></pre></td></tr></table></figure>



<p>AWK内置变量 - FILENAME,FNR</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># FILENAME显示了当前文件, FNR关联到当前文件的记录数</span></div><div class="line">awk <span class="string">'BEGIN {FS=","} \</span></div><div class="line">{print FILENAME ": record number",FNR,"is",$1;} \</div><div class="line">END {print "Total number of records:",NR}' \</div><div class="line">source.txt <span class="built_in">source</span>-multiple-fs.txt</div><div class="line">source.txt: record number <span class="number">1</span> is <span class="number">101</span></div><div class="line">source.txt: record number <span class="number">2</span> is <span class="number">102</span></div><div class="line">source.txt: record number <span class="number">3</span> is <span class="number">103</span></div><div class="line">source.txt: record number <span class="number">4</span> is <span class="number">104</span></div><div class="line">source.txt: record number <span class="number">5</span> is <span class="number">105</span></div><div class="line">source.txt: record number <span class="number">6</span> is <span class="number">106</span></div><div class="line">source.txt: record number <span class="number">7</span> is <span class="number">107</span></div><div class="line"><span class="built_in">source</span>-multiple-fs.txt: record number <span class="number">1</span> is <span class="number">101</span></div><div class="line"><span class="built_in">source</span>-multiple-fs.txt: record number <span class="number">2</span> is <span class="number">102</span></div><div class="line"><span class="built_in">source</span>-multiple-fs.txt: record number <span class="number">3</span> is <span class="number">103</span></div><div class="line"><span class="built_in">source</span>-multiple-fs.txt: record number <span class="number">4</span> is <span class="number">104</span></div><div class="line"><span class="built_in">source</span>-multiple-fs.txt: record number <span class="number">5</span> is <span class="number">105</span></div><div class="line"><span class="built_in">source</span>-multiple-fs.txt: record number <span class="number">6</span> is <span class="number">106</span></div><div class="line"><span class="built_in">source</span>-multiple-fs.txt: record number <span class="number">7</span> is <span class="number">107</span></div><div class="line">Total number of records: <span class="number">14</span></div></pre></td></tr></table></figure>


<p>AWK变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 变量支持数字,字符和下划线</span></div><div class="line"><span class="comment"># 这个文件多加了一列star数, 现在我想统计整个文件的star</span></div><div class="line"><span class="variable">$cat</span> <span class="built_in">source</span>-star.txt</div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla,<span class="number">1204</span></div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim,<span class="number">4029</span></div><div class="line"><span class="number">103</span>,Paul Irish,Google,<span class="number">7200</span></div><div class="line"><span class="number">104</span>,Addy Osmani,Google,<span class="number">2201</span></div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github,<span class="number">1002</span></div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku,<span class="number">890</span></div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware,<span class="number">2109</span></div><div class="line"><span class="comment"># 使用awk的变量,在begin的时候声明total,在body体里面</span></div><div class="line"><span class="comment"># 累加total值，在end里面打印</span></div><div class="line"><span class="variable">$cat</span> total-star.awk </div><div class="line">BEGIN {</div><div class="line">    FS=<span class="string">","</span>;</div><div class="line">    total=<span class="number">0</span>; }</div><div class="line">{</div><div class="line"> print <span class="variable">$2</span> <span class="string">"'s star is: "</span> <span class="variable">$4</span>;</div><div class="line"> total=total+<span class="variable">$4</span></div><div class="line">} END {</div><div class="line">    print <span class="string">"---\nTotal star = *"</span>total;</div><div class="line">}</div><div class="line">awk <span class="operator">-f</span> total-star.awk <span class="built_in">source</span>-star.txt</div><div class="line">Ian Bicking<span class="string">'s star is: 1204</span></div><div class="line">Hakim El Hattab's star is: <span class="number">4029</span></div><div class="line">Paul Irish<span class="string">'s star is: 7200</span></div><div class="line">Addy Osmani's star is: <span class="number">2201</span></div><div class="line">Chris Wanstrath<span class="string">'s star is: 1002</span></div><div class="line">Mattt Thompson's star is: <span class="number">890</span></div><div class="line">Ask Solem Hoel<span class="string">'s star is: 2109</span></div><div class="line">---</div><div class="line">Total star = *18635</div></pre></td></tr></table></figure>



<p>自增长/减少</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 可以使用++或者--,但是注意前后</span></div><div class="line"><span class="variable">$awk</span> -F, <span class="string">'{print --$4}'</span> <span class="built_in">source</span>-star.txt</div><div class="line"><span class="number">1203</span></div><div class="line"><span class="number">4028</span></div><div class="line"><span class="number">7199</span></div><div class="line"><span class="number">2200</span></div><div class="line"><span class="number">1001</span></div><div class="line"><span class="number">889</span></div><div class="line"><span class="number">2108</span></div><div class="line"><span class="variable">$awk</span> -F, <span class="string">'{print $4--}'</span> <span class="built_in">source</span>-star.txt </div><div class="line"><span class="comment"># 咦 竟然没有变</span></div><div class="line"><span class="number">1204</span></div><div class="line"><span class="number">4029</span></div><div class="line"><span class="number">7200</span></div><div class="line"><span class="number">2201</span></div><div class="line"><span class="number">1002</span></div><div class="line"><span class="number">890</span></div><div class="line"><span class="number">2109</span></div><div class="line"><span class="comment"># 想达到--$4的目的就得这样</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">','</span> <span class="string">'{$4--; print $4}'</span> <span class="built_in">source</span>-star.txt</div><div class="line"><span class="number">1203</span></div><div class="line"><span class="number">4028</span></div><div class="line"><span class="number">7199</span></div><div class="line"><span class="number">2200</span></div><div class="line"><span class="number">1001</span></div><div class="line"><span class="number">889</span></div><div class="line"><span class="number">2108</span></div></pre></td></tr></table></figure>



<p>字符串操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cat</span> string.awk</div><div class="line">BEGIN {</div><div class="line">    FS=<span class="string">","</span>;</div><div class="line">    OFS=<span class="string">","</span>;</div><div class="line">    string1=<span class="string">"GO"</span>;</div><div class="line">    string2=<span class="string">"OGLE"</span>;</div><div class="line">    numberstring=<span class="string">"100"</span>;</div><div class="line">    string3=string1 string2;</div><div class="line">    print <span class="string">"Concatenate string is:"</span> string3;</div><div class="line">    numberstring=numberstring+<span class="number">1</span>;</div><div class="line">    print <span class="string">"String to number:"</span> numberstring;</div><div class="line">}</div><div class="line"><span class="comment"># 字符串会直接相连, 字符串相加会自动转化成数字相加</span></div><div class="line"><span class="variable">$awk</span> <span class="operator">-f</span> string.awk </div><div class="line">Concatenate string is:GOOGLE</div><div class="line">String to number:<span class="number">101</span></div></pre></td></tr></table></figure>



<p>复合运算</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cat</span> assignment.awk</div><div class="line">BEGIN {</div><div class="line"> FS=<span class="string">","</span>;</div><div class="line"> OFS=<span class="string">","</span>;</div><div class="line"> total1 = total2 = total3 = total4 = total5 = <span class="number">10</span>;</div><div class="line"> total1 += <span class="number">5</span>; print total1;</div><div class="line"> total2 -= <span class="number">5</span>; print total2;</div><div class="line"> total3 *= <span class="number">5</span>; print total3;</div><div class="line"> total4 /= <span class="number">5</span>; print total4;</div><div class="line"> total5 %= <span class="number">5</span>; print total5;</div><div class="line">}</div><div class="line"><span class="variable">$awk</span> <span class="operator">-f</span> assignment.awk</div><div class="line"><span class="number">15</span></div><div class="line"><span class="number">5</span></div><div class="line"><span class="number">50</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">0</span></div></pre></td></tr></table></figure>



<p>比较操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 只会显示小于1005的行</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">","</span> <span class="string">'$4 &lt;= 1005'</span> <span class="built_in">source</span>-star.txt</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github,<span class="number">1002</span></div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku,<span class="number">890</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">","</span> <span class="string">'$1 == 103 {print $2}'</span> <span class="built_in">source</span>-star.txt </div><div class="line">Paul Irish</div><div class="line"><span class="comment"># 你也可以加多个条件 这里||表示或者  && 表示和</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">","</span> <span class="string">'$4 &gt; 3000 || $4 &lt;= 880 {print $2}'</span> <span class="built_in">source</span>-star.txt</div><div class="line">Hakim El Hattab</div><div class="line">Paul Irish</div></pre></td></tr></table></figure>



<p>正则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ~ 表示匹配, ！~ 表示不匹配</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">","</span> <span class="string">'$3 ~ "Github"'</span> source.txt</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="variable">$awk</span> -F <span class="string">","</span> <span class="string">'$3 !~ "Google"'</span> source.txt</div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div><div class="line"><span class="comment"># NF是分割项数目, $NF表示最后一个分割项, 这里是找最后一个分割项是/bin/sh的就会累加n</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">':'</span> <span class="string">'$NF ~ /\/bin\/sh/ { n++ }; END { print n \</span></div><div class="line">}' /etc/passwd</div></pre></td></tr></table></figure>



<p>IF语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (conditional-expression)</div><div class="line">    action</div><div class="line">	</div><div class="line"><span class="keyword">if</span> (conditional-expression)</div><div class="line">{</div><div class="line">    action1;</div><div class="line">    action2; </div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="comment"># 和上面的一个例子一样</span></div><div class="line"><span class="variable">$awk</span> -F <span class="string">","</span> <span class="string">'{ if ($3 ~ "Github") print $0}'</span> source.txt</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div></pre></td></tr></table></figure>



<p>IF ELSE语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (conditional-expression)</div><div class="line">    action1</div><div class="line"><span class="keyword">else</span></div><div class="line">    action2</div><div class="line"><span class="comment"># or</span></div><div class="line">conditional-expression ? action1 : action2 ;</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="comment"># 打印单行因为%2,奇数取余</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'ORS=NR%2?",":"\n"'</span> source.txt                    </div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla,<span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="number">103</span>,Paul Irish,Google,<span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github,<span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware,</div></pre></td></tr></table></figure>


<p>WHILE语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span>(condition)</div><div class="line">    actions</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="comment"># 把第二列和其之后的每列加起来</span></div><div class="line"><span class="variable">$cat</span> while.awk </div><div class="line">{</div><div class="line">    i=<span class="number">2</span>; total=<span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (i &lt;= NF) {</div><div class="line">        total = total + <span class="variable">$i</span>;</div><div class="line">        i++;</div><div class="line"> }</div><div class="line">    print <span class="string">"Item"</span>, <span class="variable">$1</span>, <span class="string">":"</span>, total, <span class="string">"quantities sold"</span>;</div><div class="line">}</div><div class="line"><span class="variable">$awk</span> <span class="operator">-f</span> while.awk items-sold.txt</div><div class="line">Item <span class="number">101</span> : <span class="number">47</span> quantities sold</div><div class="line">Item <span class="number">102</span> : <span class="number">10</span> quantities sold</div><div class="line">Item <span class="number">103</span> : <span class="number">65</span> quantities sold</div><div class="line">Item <span class="number">104</span> : <span class="number">20</span> quantities sold</div><div class="line">Item <span class="number">105</span> : <span class="number">42</span> quantities sold</div></pre></td></tr></table></figure>



<p>DO WHILE语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># do while至少会执行一次</span></div><div class="line"><span class="keyword">do</span></div><div class="line">action</div><div class="line"><span class="keyword">while</span>(condition)</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="comment"># 用do-while方法实现上一次的例子</span></div><div class="line"><span class="variable">$cat</span> dowhile.awk </div><div class="line">{</div><div class="line">    i=<span class="number">2</span>; total=<span class="number">0</span>;</div><div class="line"> <span class="keyword">do</span></div><div class="line"> {</div><div class="line">     total = total + <span class="variable">$i</span>;</div><div class="line">     i++;</div><div class="line"> } <span class="keyword">while</span> (i &lt;= NF)</div><div class="line"> print <span class="string">"Item"</span>, <span class="variable">$1</span>, <span class="string">":"</span>, total, <span class="string">"quantities sold"</span>;</div><div class="line">}</div><div class="line"><span class="variable">$awk</span> <span class="operator">-f</span> dowhile.awk items-sold.txt</div><div class="line">Item <span class="number">101</span> : <span class="number">47</span> quantities sold</div><div class="line">Item <span class="number">102</span> : <span class="number">10</span> quantities sold</div><div class="line">Item <span class="number">103</span> : <span class="number">65</span> quantities sold</div><div class="line">Item <span class="number">104</span> : <span class="number">20</span> quantities sold</div><div class="line">Item <span class="number">105</span> : <span class="number">42</span> quantities sold</div></pre></td></tr></table></figure>



<p>FOR语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>(initialization;condition;increment/decrement)</div><div class="line">actions</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="variable">$echo</span> <span class="string">"1 2 3 4"</span> | awk <span class="string">'{ for (i = 1; i &lt;= NF; i++) total = total+$i }; \</span></div><div class="line">END { print total }'  </div><div class="line"><span class="number">10</span></div><div class="line"><span class="comment"># 再来个for版本的例子</span></div><div class="line"><span class="variable">$cat</span> for.awk </div><div class="line">{</div><div class="line">    total=<span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (i=<span class="number">2</span>; i &lt;= NF; i++)</div><div class="line">        total = total + <span class="variable">$i</span>;</div><div class="line">    print <span class="string">"Item"</span>, <span class="variable">$1</span>, <span class="string">":"</span>, total, <span class="string">"quantities sold"</span>;</div><div class="line">}</div><div class="line"><span class="variable">$awk</span> <span class="operator">-f</span> for.awk items-sold.txt</div><div class="line">Item <span class="number">101</span> : <span class="number">47</span> quantities sold</div><div class="line">Item <span class="number">102</span> : <span class="number">10</span> quantities sold</div><div class="line">Item <span class="number">103</span> : <span class="number">65</span> quantities sold</div><div class="line">Item <span class="number">104</span> : <span class="number">20</span> quantities sold</div><div class="line">Item <span class="number">105</span> : <span class="number">42</span> quantities sold</div></pre></td></tr></table></figure>


<p>BREAK,CONTINUE,EXIT</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 程序一直运行打印Iteration,并且累加x,直到x等于10停止程序-break</span></div><div class="line">$ awk <span class="string">'BEGIN{</span></div><div class="line">x=1;</div><div class="line">while(1)</div><div class="line">{</div><div class="line">print "Iteration";</div><div class="line">if ( x==10 )</div><div class="line">break;</div><div class="line">x++;</div><div class="line">}}'</div><div class="line"><span class="comment"># x从1到10, 如果x等于5 直接直接累加x而不打印</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN{</span></div><div class="line">x=1;</div><div class="line">while(x&lt;=10)</div><div class="line">{</div><div class="line">if(x==5){</div><div class="line">x++;</div><div class="line">continue;</div><div class="line">}</div><div class="line">print "Value of x",x;x++;</div><div class="line">}</div><div class="line">}'</div><div class="line"><span class="comment"># x从1到10,当x等于5的时候程序直接退出</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN{</span></div><div class="line">x=1;</div><div class="line">while(x&lt;=10)</div><div class="line">{</div><div class="line">if(x==5){</div><div class="line">exit;}</div><div class="line">print "Value of x",x;x++;</div><div class="line">}</div><div class="line">}'</div></pre></td></tr></table></figure>

<p>关联数组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># awk 的关联数组中item[101]和item["101"]意义一样</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN { item[101]="Github"; print item["101"]}'</span> </div><div class="line">Github</div><div class="line"><span class="comment"># 可以用in检验是否包含本项</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN { item[101]="a"; if ( 101 in item ) print "Has 101"}'</span></div><div class="line">Has <span class="number">101</span></div><div class="line"><span class="comment"># 还可以使用for循环读取列表</span></div><div class="line"><span class="variable">$cat</span> array-for-loop.awk</div><div class="line">BEGIN {</div><div class="line">    item[<span class="number">101</span>]=<span class="string">"Github"</span>;</div><div class="line">    item[<span class="number">21</span>]=<span class="string">"Google"</span>;</div><div class="line">    <span class="keyword">for</span> (x <span class="keyword">in</span> item)</div><div class="line">        print item[x];</div><div class="line">}</div><div class="line"><span class="variable">$awk</span> <span class="operator">-f</span> array-for-loop.awk</div><div class="line">Github</div><div class="line">Google</div><div class="line"><span class="comment"># 多维数组, delete可以删除元素.PS item[2,1]这样的格式有问题</span></div><div class="line"><span class="comment"># 因为会被翻译成2#2("2\0342"),假设要设置分隔符可以使用SUBSEP=",";</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN { item["1,1"]="Github"; item["1,2"]="Google"; \</span></div><div class="line">item["2,1"]="Whim"; delete item["2,1"];</div><div class="line">for (x in item)</div><div class="line">print "Index",x,"contains",item[x];}'</div><div class="line">Index <span class="number">1</span>,<span class="number">1</span> contains Github</div><div class="line">Index <span class="number">1</span>,<span class="number">2</span> contains Google</div></pre></td></tr></table></figure>


<p>数组排序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这里需要gnu awk了 使用了asort排序</span></div><div class="line"><span class="variable">$cat</span> asort.awk </div><div class="line">BEGIN {</div><div class="line"> item[<span class="number">101</span>]=<span class="string">"Github"</span>;</div><div class="line"> item[<span class="number">22</span>]=<span class="string">"Whim"</span>;</div><div class="line"> item[<span class="number">50</span>]=<span class="string">"Google"</span>;</div><div class="line"> print <span class="string">"------Before asort------"</span></div><div class="line"> <span class="keyword">for</span> (x <span class="keyword">in</span> item)</div><div class="line">     print <span class="string">"Index"</span>,x,<span class="string">"contains"</span>,item[x];</div><div class="line"> total = asort(item);</div><div class="line"> print <span class="string">"------After asort------"</span></div><div class="line"> <span class="keyword">for</span> (x <span class="keyword">in</span> item)</div><div class="line">     print <span class="string">"Index"</span>,x,<span class="string">"contains"</span>,item[x];</div><div class="line">}</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="variable">$gawk</span> <span class="operator">-f</span> asort.awk</div><div class="line">------Before asort------</div><div class="line">Index <span class="number">22</span> contains Whim</div><div class="line">Index <span class="number">50</span> contains Google</div><div class="line">Index <span class="number">101</span> contains Github</div><div class="line">------After asort------</div><div class="line">Index <span class="number">1</span> contains Github</div><div class="line">Index <span class="number">2</span> contains Google</div><div class="line">Index <span class="number">3</span> contains Whim</div><div class="line"><span class="comment"># 大家请注意上面的例子,排序后已经忘记了原来item的index位置</span></div><div class="line"><span class="comment"># 而asorti可以帮助你记录这个位置</span></div><div class="line"><span class="variable">$cat</span> asorti.awk</div><div class="line">BEGIN {</div><div class="line"> item[<span class="number">101</span>]=<span class="string">"Github"</span>;</div><div class="line"> item[<span class="number">22</span>]=<span class="string">"Whim"</span>;</div><div class="line"> item[<span class="number">50</span>]=<span class="string">"Google"</span>;</div><div class="line"> print <span class="string">"----- Function: asort -----"</span></div><div class="line"> total = asort(item,itemdesc);</div><div class="line"> <span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;= total; i++)</div><div class="line">    print <span class="string">"Index"</span>,i,<span class="string">"contains"</span>,itemdesc[i];</div><div class="line"> print <span class="string">"----- Function: asorti -----"</span></div><div class="line"> total = asorti(item,itemabbr);</div><div class="line"> <span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;= total; i++)</div><div class="line">     print <span class="string">"Index"</span>,i,<span class="string">"contains"</span>,itemabbr[i];</div><div class="line">}</div><div class="line"><span class="variable">$gawk</span> <span class="operator">-f</span> asorti.awk</div><div class="line">----- Function: asort -----</div><div class="line">Index <span class="number">1</span> contains Github</div><div class="line">Index <span class="number">2</span> contains Google</div><div class="line">Index <span class="number">3</span> contains Whim</div><div class="line">----- Function: asorti -----</div><div class="line">Index <span class="number">1</span> contains <span class="number">101</span></div><div class="line">Index <span class="number">2</span> contains <span class="number">22</span></div><div class="line">Index <span class="number">3</span> contains <span class="number">50</span></div></pre></td></tr></table></figure>



<p>格式化打印</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># \n是换行</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN { printf "Line 1\nLine 2\n" }'</span></div><div class="line">Line <span class="number">1</span></div><div class="line">Line <span class="number">2</span></div><div class="line"><span class="comment"># \t是tab</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN \</span></div><div class="line">{ printf "Field 1\t\tField 2\tField 3\tField 4\n" }'</div><div class="line">Field <span class="number">1</span>		Field <span class="number">2</span>	Field <span class="number">3</span>	Field <span class="number">4</span></div><div class="line"><span class="comment"># \v是垂直tab</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN \</span></div><div class="line">{ printf "Field 1\vField 2\vField 3\vField 4\n" }'</div><div class="line">Field <span class="number">1</span></div><div class="line">    Field <span class="number">2</span></div><div class="line">       Field <span class="number">3</span></div><div class="line">	  Field <span class="number">4</span></div><div class="line"><span class="comment"># %s字符串; %c单个字符; %d数字; %f浮点数......</span></div><div class="line"><span class="variable">$cat</span> <span class="built_in">printf</span>-width.awk </div><div class="line">BEGIN {</div><div class="line">FS=<span class="string">","</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"%3s\t%10s\t%10s\t%5s\t%3s\n"</span>,</div><div class="line">    <span class="string">"Num"</span>,<span class="string">"Description"</span>,<span class="string">"Type"</span>,<span class="string">"Price"</span>,<span class="string">"Qty"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"-----------------------------------------------------\n"</span></div><div class="line">}</div><div class="line">{</div><div class="line">    <span class="built_in">printf</span> <span class="string">"%3d\t%10s\t%10s\t%g\t%d\n"</span>, <span class="variable">$1</span>,<span class="variable">$2</span>,<span class="variable">$3</span>,<span class="variable">$4</span>,<span class="variable">$5</span></div><div class="line">}</div><div class="line">awk <span class="operator">-f</span> <span class="built_in">printf</span>-width.awk items.txt </div><div class="line">Num	Description	      Type	Price	Qty</div><div class="line">-----------------------------------------------------</div><div class="line"><span class="number">101</span>	HD Camcorder	     Video	<span class="number">210</span>	<span class="number">10</span></div><div class="line"><span class="number">102</span>	Refrigerator	 Appliance	<span class="number">850</span>	<span class="number">2</span></div><div class="line"><span class="number">103</span>	MP3 Player	     Audio	<span class="number">270</span>	<span class="number">15</span></div><div class="line"><span class="number">104</span>	Tennis Racket	    Sports	<span class="number">190</span>	<span class="number">20</span></div><div class="line"><span class="number">105</span>	Laser Printer	    Office	<span class="number">475</span>	<span class="number">5</span></div></pre></td></tr></table></figure>



<p>内置函数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># int - 将数字转换成整形, 类似的函数还有sqrt, sin, cos...</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN {print int(4.1);print int(-6.22);print int(strings)}'</span></div><div class="line"><span class="number">4</span></div><div class="line">-<span class="number">6</span></div><div class="line"><span class="number">0</span></div><div class="line"><span class="comment"># rand - 随机0-1的数字; srand -初始化随机数的初始值</span></div><div class="line"><span class="variable">$cat</span> srand.awk </div><div class="line">BEGIN {</div><div class="line">    srand(<span class="number">5</span>);</div><div class="line">    count=<span class="number">0</span>;</div><div class="line">    max=<span class="number">30</span>;</div><div class="line">    <span class="keyword">while</span> (count &lt; <span class="number">5</span>) {</div><div class="line">        <span class="comment"># 随机数范围为5-30</span></div><div class="line">        rnd = int(rand() * max);</div><div class="line">        print rnd;</div><div class="line">        count++;</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment"># 使用osx的awk随机范围不对</span></div><div class="line"><span class="variable">$gawk</span> <span class="operator">-f</span> srand.awk</div><div class="line"><span class="number">19</span></div><div class="line"><span class="number">9</span></div><div class="line"><span class="number">21</span></div><div class="line"><span class="number">8</span></div><div class="line"><span class="number">13</span></div><div class="line"><span class="comment"># index - 所查字符在字符串中的位置,没找到会返回0</span></div><div class="line">awk <span class="string">'BEGIN{str="This is a test"; print index(str, "a"); print index(str, "y")}'</span></div><div class="line"><span class="number">9</span></div><div class="line"><span class="number">0</span></div><div class="line"><span class="comment"># length - 字符串的长度</span></div><div class="line"><span class="variable">$awk</span> -F, <span class="string">'{print length($0)}'</span> source.txt</div><div class="line"><span class="number">23</span></div><div class="line"><span class="number">24</span></div><div class="line"><span class="number">21</span></div><div class="line"><span class="number">22</span></div><div class="line"><span class="number">26</span></div><div class="line"><span class="number">25</span></div><div class="line"><span class="number">25</span></div><div class="line"><span class="comment"># split - 分片 PS:使用awk分片的顺序有问题;</span></div><div class="line"><span class="comment"># split第一个参数是要分割的内容,第二个是分割后的结果保存的数组,第三个是使用的分隔符</span></div><div class="line"><span class="variable">$echo</span> <span class="string">"101 arg1:arg2:arg3"</span>|gawk <span class="string">'{split($2,out,":"); for (x in out) print out[x];}'</span></div><div class="line">arg1</div><div class="line">arg2</div><div class="line">arg3</div><div class="line"><span class="comment"># substr - 取字符串范围内容;</span></div><div class="line"><span class="comment"># 第一个参数是要取的内容, 第二个是开始位置(从1开始),第三个是要取的长度</span></div><div class="line"><span class="variable">$echo</span> <span class="string">"This is test"</span>|awk <span class="string">'{print substr($3,2,2);}'</span></div><div class="line">es</div><div class="line"><span class="comment"># sub - 替换原来的字符串,但是只替换第一个符合项; gsub - 替换全部选择项</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN{str="ThIs is test"; sub("[Ii]s","e", str); print str;}'</span></div><div class="line">The is test</div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN{str="ThIs is test"; gsub("[Ii]s","e", str); print str;}'</span></div><div class="line">The e test</div><div class="line"><span class="comment"># match - 返回某子字符串是否匹配了某字符串;</span></div><div class="line"><span class="comment"># RSTART - awk 自带变量返回匹配的开始位置</span></div><div class="line"><span class="comment"># RLENGTH - awk 自带变量返回匹配串的长度</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN{str="This is test"; if (match(str, "test")) {print substr(str,RSTART,RLENGTH)}}'</span>  </div><div class="line"><span class="comment"># tolower/toupper - 把字符串都变成小写/大写</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN{str="This is test"; print tolower(str); print toupper(str);}'</span></div><div class="line">this is test</div><div class="line">THIS IS TEST</div><div class="line"><span class="comment"># ARGC - 参数的数量; ARGV参数的数组</span></div><div class="line"><span class="variable">$cat</span> arguments.awk</div><div class="line">BEGIN {</div><div class="line">    print <span class="string">"ARGC="</span>,ARGC</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARGC; i++)</div><div class="line">  print ARGV[i]</div><div class="line">}</div></pre></td></tr></table></figure>



<p>内置变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ENVIRON - 系统环境变量</span></div><div class="line"><span class="variable">$cat</span> environ.awk</div><div class="line">BEGIN {</div><div class="line"> OFS=<span class="string">"="</span></div><div class="line"> <span class="keyword">for</span>(x <span class="keyword">in</span> ENVIRON)</div><div class="line">     print x,ENVIRON[x];</div><div class="line">}</div><div class="line"><span class="comment"># IGNORECASE - 设置为1 忽略大小写</span></div><div class="line"><span class="variable">$gawk</span> <span class="string">'BEGIN{IGNORECASE=1} /github/{print}'</span> source.txt</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div></pre></td></tr></table></figure>



<p>位运算</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cat</span> bits.awk</div><div class="line">BEGIN {</div><div class="line"> number1=<span class="number">15</span></div><div class="line"> number2=<span class="number">25</span></div><div class="line"> print <span class="string">"AND: "</span> and(number1,number2);</div><div class="line"> print <span class="string">"OR: "</span> or(number1,number2)</div><div class="line"> print <span class="string">"XOR: "</span> xor(number1,number2)</div><div class="line"> print <span class="string">"LSHIFT: "</span> lshift(number1,<span class="number">2</span>)</div><div class="line"> print <span class="string">"RSHIFT: "</span> rshift(number1,<span class="number">2</span>)</div><div class="line">}</div><div class="line"><span class="variable">$gawk</span> <span class="operator">-f</span> bits.awk</div><div class="line">AND: <span class="number">9</span></div><div class="line">OR: <span class="number">31</span></div><div class="line">XOR: <span class="number">22</span></div><div class="line">LSHIFT: <span class="number">60</span></div><div class="line">RSHIFT: <span class="number">3</span></div></pre></td></tr></table></figure>



<p>自定义函数语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">function fn-name(parameters)</div><div class="line">{</div><div class="line"> function-body</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#例子</span></div><div class="line"><span class="comment"># 函数的位置不重要</span></div><div class="line"><span class="variable">$cat</span> function-debug.awk </div><div class="line">function mydebug (message) {</div><div class="line">    print (<span class="string">"Debug Time:"</span> strftime(<span class="string">"%a %b %d %H:%M:%S %Z %Y"</span>, systime()))</div><div class="line">    print (message)</div><div class="line">}</div><div class="line">{</div><div class="line">    mydebug(<span class="variable">$NF</span>)</div><div class="line">}</div><div class="line"><span class="variable">$gawk</span> <span class="operator">-f</span> function-debug.awk source.txt</div><div class="line">Debug Time:Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">43</span> CST <span class="number">2013</span></div><div class="line">Bicking,Mozilla</div><div class="line">Debug Time:Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">43</span> CST <span class="number">2013</span></div><div class="line">Hattab,Whim</div><div class="line">Debug Time:Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">43</span> CST <span class="number">2013</span></div><div class="line">Irish,Google</div><div class="line">Debug Time:Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">43</span> CST <span class="number">2013</span></div><div class="line">Osmani,Google</div><div class="line">Debug Time:Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">43</span> CST <span class="number">2013</span></div><div class="line">Wanstrath,Github</div><div class="line">Debug Time:Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">43</span> CST <span class="number">2013</span></div><div class="line">Thompson,Heroku</div><div class="line">Debug Time:Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">43</span> CST <span class="number">2013</span></div><div class="line">Hoel,VMware</div></pre></td></tr></table></figure>



<p>系统调用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 使用system函数可以调用shell命令</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN { system("date") }'</span></div><div class="line">Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">24</span>:<span class="number">27</span> CST <span class="number">2013</span></div><div class="line"><span class="comment"># systime 和 strftime上面见过了.处理时间和格式化时间</span></div><div class="line"><span class="variable">$gawk</span> <span class="string">'BEGIN { print strftime("%c",systime()) }'</span></div><div class="line">Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">32</span> <span class="number">2013</span></div></pre></td></tr></table></figure>

<h3 id="学完本章的练习">学完本章的练习</h3>
<ul>
<li>1.获取来连接mongodb的各服务器产生的连接数</li>
<li>2.获取nginx日志ip访问数在一个小时里面,从多到少的总次数排行(排行用到了sort)</li>
<li>3.打印question_awk3.txt包含Addy和Mattt之间的行</li>
<li>4.不使用sort过滤重复行</li>
<li>5.将2个文件合并成一行,但username不一定在2个文件同一行</li>
<li>6.输出2个文件1中有,2中没有的行</li>
<li>7.这是什么意思: gawk -vcmd=’ls -l’ ‘BEGIN{while ( (cmd | getline var) &gt; 0) {print var} close(cmd)}’                        </li>
</ul>
<h2 id="AWK高级话题">AWK高级话题</h2>
<p>GETLINE</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># awk首先读入一行，接着处理getline函数再获得一行....下面显示的就是奇数行</span></div><div class="line"><span class="variable">$awk</span> -F<span class="string">","</span> <span class="string">'{print $0;getline;}'</span> source.txt </div><div class="line"><span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line"><span class="number">103</span>,Paul Irish,Google</div><div class="line"><span class="number">105</span>,Chris Wanstrath,Github</div><div class="line"><span class="number">107</span>,Ask Solem Hoel,VMware</div><div class="line"><span class="comment"># 我们使用getline 并把这行变量赋值给tmp</span></div><div class="line"><span class="variable">$awk</span> -F, <span class="string">'{getline tmp; print "$0-&gt;", $0; print "tmp-&gt;", tmp;}'</span> source.txt</div><div class="line"><span class="variable">$0</span>-&gt; <span class="number">101</span>,Ian Bicking,Mozilla</div><div class="line">tmp-&gt; <span class="number">102</span>,Hakim El Hattab,Whim</div><div class="line"><span class="variable">$0</span>-&gt; <span class="number">103</span>,Paul Irish,Google</div><div class="line">tmp-&gt; <span class="number">104</span>,Addy Osmani,Google</div><div class="line"><span class="variable">$0</span>-&gt; <span class="number">105</span>,Chris Wanstrath,Github</div><div class="line">tmp-&gt; <span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="variable">$0</span>-&gt; <span class="number">107</span>,Ask Solem Hoel,VMware</div><div class="line">tmp-&gt; <span class="number">106</span>,Mattt Thompson,Heroku</div><div class="line"><span class="comment"># 执行外部程序, close可关闭管道,比如这里必须是`|getline`之前的命令</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN{"date"| getline;close("date");print "Timestamp:" $0}'</span></div><div class="line">Timestamp:Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">41</span>:<span class="number">52</span> CST <span class="number">2013</span></div><div class="line"><span class="comment"># or</span></div><div class="line"><span class="variable">$awk</span> <span class="string">'BEGIN{"date"| getline timestamp;close("date");print "Timestamp:" timestamp}'</span></div><div class="line">Timestamp:Wed Dec <span class="number">11</span> <span class="number">22</span>:<span class="number">44</span>:<span class="number">08</span> CST <span class="number">2013</span></div></pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-06-22T07:22:16.000Z"><a href="/2011/06/22/mongodb-commond/">6月 22 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/06/22/mongodb-commond/">MongoDB常见操作命令整理</a></h1>
  

    </header>
    <div class="entry">
      
        <p>近期学习了一些Nosql技术,主要是在看Mongodb相关知识,整理了一份mongodb的命令行操作指令,用的时候方便找</p>
<p>数据库操作语法<br><code>mongo --path</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">db.AddUser(username,password)  <span class="comment">#添加用户</span></div><div class="line">db.auth(usrename,password)     <span class="comment">#设置数据库连接验证</span></div><div class="line">db.cloneDataBase(fromhost)     <span class="comment">#从目标服务器克隆一个数据库</span></div><div class="line">db.commandHelp(name)           <span class="comment">#returns the help for the command</span></div><div class="line">db.copyDatabase(fromdb,todb,fromhost)  <span class="comment">#复制数据库fromdb---源数据库名称，todb---目标数据库名称，fromhost---源数据库服务器地址</span></div><div class="line">db.createCollection(name,{size:<span class="number">3333</span>,capped:<span class="number">333</span>,max:<span class="number">88888</span>})  <span class="comment">#创建一个数据集，相当于一个表</span></div><div class="line">db.currentOp()                 <span class="comment">#取消当前库的当前操作</span></div><div class="line">db.dropDataBase()              <span class="comment">#删除当前数据库</span></div><div class="line">db.eval(func,args)             <span class="comment">#run code server-side</span></div><div class="line">db.getCollection(cname)        <span class="comment">#取得一个数据集合，同用法：db['cname'] or db.cname</span></div><div class="line">db.getCollenctionNames()       <span class="comment">#取得所有数据集合的名称列表</span></div><div class="line">db.getLastError()              <span class="comment">#返回最后一个错误的提示消息</span></div><div class="line">db.getLastErrorObj()           <span class="comment">#返回最后一个错误的对象</span></div><div class="line">db.getMongo()                  <span class="comment">#取得当前服务器的连接对象get the server connection object</span></div><div class="line">db.getMondo().setSlaveOk()     <span class="comment">#allow this connection to read from then nonmaster membr of a replica pair</span></div><div class="line">db.getName()                   <span class="comment">#返回当操作数据库的名称</span></div><div class="line">db.getPrevError()              <span class="comment">#返回上一个错误对象</span></div><div class="line">db.getProfilingLevel()         <span class="comment">#获取分析等级</span></div><div class="line">db.getReplicationInfo()        <span class="comment">#获取复制信息</span></div><div class="line">db.getSisterDB(name)           <span class="comment">#get the db at the same server as this onew</span></div><div class="line">db.killOp()                    <span class="comment">#停止（杀死）在当前库的当前操作</span></div><div class="line">db.printCollectionStats()      <span class="comment">#返回当前库的数据集状态</span></div><div class="line">db.printReplicationInfo()</div><div class="line">db.printSlaveReplicationInfo()</div><div class="line">db.printShardingStatus()       <span class="comment">#返回当前数据库是否为共享数据库</span></div><div class="line">db.removeUser(username)        <span class="comment">#删除用户</span></div><div class="line">db.repairDatabase()            <span class="comment">#修复当前数据库</span></div><div class="line">db.resetError()                </div><div class="line">db.runCommand(cmdObj)          <span class="comment">#run a database command. if cmdObj is a string, turns it into {cmdObj:1}</span></div><div class="line">db.setProfilingLevel(level)    <span class="comment">#0=off,1=slow,2=all</span></div><div class="line">db.shutdownServer()            <span class="comment">#关闭当前服务程序</span></div><div class="line">db.version()                   <span class="comment">#返回当前程序的版本信息</span></div></pre></td></tr></table></figure>

<p>数据集(表)操作语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">db.linlin.find({id:<span class="number">10</span>})          <span class="comment">#返回linlin数据集ID=10的数据集</span></div><div class="line">db.linlin.find({id:<span class="number">10</span>}).count()  <span class="comment">#返回linlin数据集ID=10的数据总数</span></div><div class="line">db.linlin.find({id:<span class="number">10</span>}).limit(<span class="number">2</span>) <span class="comment">#返回linlin数据集ID=10的数据集从第二条开始的数据集</span></div><div class="line">db.linlin.find({id:<span class="number">10</span>}).skip(<span class="number">8</span>)  <span class="comment">#返回linlin数据集ID=10的数据集从0到第八条的数据集</span></div><div class="line">db.linlin.find({id:<span class="number">10</span>}).limit(<span class="number">2</span>).skip(<span class="number">8</span>)  <span class="comment">#返回linlin数据集ID=1=的数据集从第二条到第八条的数据</span></div><div class="line">db.linlin.find({id:<span class="number">10</span>}).sort()   <span class="comment">#返回linlin数据集ID=10的排序数据集</span></div><div class="line">db.linlin.findOne([query])       <span class="comment">#返回符合条件的一条数据</span></div><div class="line">db.linlin.getDB()                <span class="comment">#返回此数据集所属的数据库名称</span></div><div class="line">db.linlin.getIndexes()           <span class="comment">#返回些数据集的索引信息</span></div><div class="line">db.linlin.group({key:...,initial:...,reduce:...[,cond:...]})</div><div class="line">db.linlin.mapReduce(mayFunction,reduceFunction,&lt;optional params&gt;)</div><div class="line">db.linlin.remove(query)                      <span class="comment">#在数据集中删除一条数据</span></div><div class="line">db.linlin.renameCollection(newName)          <span class="comment">#重命名些数据集名称</span></div><div class="line">db.linlin.save(obj)                          <span class="comment">#往数据集中插入一条数据</span></div><div class="line">db.linlin.stats()                            <span class="comment">#返回此数据集的状态</span></div><div class="line">db.linlin.storageSize()                      <span class="comment">#返回此数据集的存储大小</span></div><div class="line">db.linlin.totalIndexSize()                   <span class="comment">#返回此数据集的索引文件大小</span></div><div class="line">db.linlin.totalSize()                        <span class="comment">#返回些数据集的总大小</span></div><div class="line">db.linlin.update(query,object[,upsert_bool]) <span class="comment">#在此数据集中更新一条数据                         </span></div><div class="line">db.linlin.validate()                         <span class="comment">#验证此数据集                                        </span></div><div class="line">db.linlin.getShardVersion()                  <span class="comment">#返回数据集共享版本号</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">db.linlin.find({<span class="string">'name'</span>:<span class="string">'foobar'</span>})    <span class="comment">#select * from linlin where name='foobar'</span></div><div class="line">db.linlin.find()                     <span class="comment">#select * from linlin</span></div><div class="line">db.linlin.find({<span class="string">'ID'</span>:<span class="number">10</span>}).count()    <span class="comment">#select count(*) from linlin where ID=10</span></div><div class="line">db.linlin.find().skip(<span class="number">10</span>).limit(<span class="number">20</span>)  <span class="comment">#从查询结果的第十条开始读20条数据  select * from linlin limit 10,20  ----------mysql</span></div><div class="line">db.linlin.find({<span class="string">'ID'</span>:{<span class="variable">$in</span>:[<span class="number">25</span>,<span class="number">35</span>,<span class="number">45</span>]}})  <span class="comment">#select * from linlin where ID in (25,35,45)</span></div><div class="line">db.linlin.find().sort({<span class="string">'ID'</span>:-<span class="number">1</span>})      <span class="comment">#select * from linlin order by ID desc</span></div><div class="line">db.linlin.distinct(<span class="string">'name'</span>,{<span class="string">'ID'</span>:{<span class="variable">$lt</span>:<span class="number">20</span>}})   <span class="comment">#select distinct(name) from linlin where ID&lt;20</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">db.linlin.group({key:{<span class="string">'name'</span>:<span class="literal">true</span>},cond:{<span class="string">'name'</span>:<span class="string">'foo'</span>},reduce:function(obj,prev){prev.msum+=obj.marks;},initial:{msum:<span class="number">0</span>}}) <span class="comment">#select name,sum(marks) from linlin group by name</span></div><div class="line">db.linlin.find(<span class="string">'this.ID&lt;20'</span>,{name:<span class="number">1</span>})     <span class="comment">#select name from linlin where ID&lt;20</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">db.linlin.insert({<span class="string">'name'</span>:<span class="string">'foobar'</span>,<span class="string">'age'</span>:<span class="number">25</span>})  <span class="comment">#insert into linlin ('name','age') values('foobar',25)</span></div><div class="line">db.linlin.insert({<span class="string">'name'</span>:<span class="string">'foobar'</span>,<span class="string">'age'</span>:<span class="number">25</span>,<span class="string">'email'</span>:<span class="string">'cclove2@163.com'</span>})</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">db.linlin.remove({})                   <span class="comment">#相当于sql中的 delete * from linlin</span></div><div class="line">db.linlin.remove({<span class="string">'age'</span>:<span class="number">20</span>})           <span class="comment">#delete linlin where age=20</span></div><div class="line">db.linlin.remove({<span class="string">'age'</span>:{<span class="variable">$lt</span>:<span class="number">20</span>}})     <span class="comment">#delete linlin where age&lt;20</span></div><div class="line">db.linlin.remove({<span class="string">'age'</span>:{<span class="variable">$lte</span>:<span class="number">20</span>}})    <span class="comment">#delete linlin where age&lt;=20</span></div><div class="line">db.linlin.remove({<span class="string">'age'</span>:{<span class="variable">$gt</span>:<span class="number">20</span>}})     <span class="comment">#delete linlin where age&gt;20</span></div><div class="line">db.linlin.remove({<span class="string">'age'</span>:{<span class="variable">$gte</span>:<span class="number">20</span>}})    <span class="comment">#delete linlin where age&gt;=20</span></div><div class="line">db.linlin.remove({<span class="string">'age'</span>:{<span class="variable">$ne</span>:<span class="number">20</span>}})     <span class="comment">#delete linlin where age!=20</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">db.linlin.update({<span class="string">'name'</span>:<span class="string">'foobar'</span>},{<span class="variable">$set</span>:{<span class="string">'age'</span>:<span class="number">36</span>}})  <span class="comment">#update linlin set age=36 where name='foobar'</span></div><div class="line">db.linlin.update({<span class="string">'name'</span>:<span class="string">'foobar'</span>},{<span class="variable">$inc</span>:{<span class="string">'age'</span>:<span class="number">3</span>}})   <span class="comment">#update linlin set age=age+3 where name='foobar'</span></div></pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-03-19T15:01:00.000Z"><a href="/2011/03/19/thread-lock/">3月 19 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/03/19/thread-lock/">并发锁机制和Lock-Free算法</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="原子类型">原子类型</h3>
<p>这是由硬件提供原子操作指令实现的。在非激烈竞争的情况下,开销更小,速度更快。<br>java.util.concurrent中实现的原子操作类包括: <code>AtomicBoolean</code>、<code>AtomicInteger</code>、<code>AtomicLong</code>、<code>AtomicReference</code></p>
<p>不使用AtomicInteger</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">	<span class="comment">//若要线程安全执行执行count++,需要加锁</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment</span>() { </div><div class="line">		count++;</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span>() {</div><div class="line">		<span class="keyword">return</span> count;</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用AtomicInteger</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span>() { </div><div class="line">		<span class="comment">//￼使用AtomicInteger之后,不需要加锁,也可以实现线程安全</span></div><div class="line">		count.incrementAndGet();</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span>() {</div><div class="line">		<span class="keyword">return</span> count.get();</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="非阻塞型同步(Non-blocking_Synchronization)">非阻塞型同步(Non-blocking Synchronization)</h3>
<p>如何正确有效的保护共享数据是编写并行程序必须面临的一个难题,通常的手段就是同步;同步可分为阻塞型同步(Blocking Synchronization)和非阻塞型同步( Non-blocking Synchronization).</p>
<p>阻塞型同步是指当一个线程到达临界区时,因另外一个线程已经持有访问该共享数据的锁, 从而不能获取锁资源而阻塞,直到另外一个线程释放锁。常见的同步原语有 mutex、 semaphore 等。如果同步方案采用不当,就会造成死锁(deadlock),活锁(livelock)和 优先级反转(priority inversion),以及效率低下等现象。</p>
<p><img src="/img/threadLock.jpg"></p>
<p>为了降低风险程度和提高程序运行效率,业界提出了不采用锁的同步方案,依照这种设计思路设计的算法称为非阻塞型算法,其本质特征就是停止一个线程的执行不会阻碍系统中其他执行实体的运行。<br>当今比较流行的 Non-blocking Synchronization 实现方案有三种: </p>
<ul>
<li><p>Wait-free<br>Wait-free是指任意线程的任何操作都可以在有限步之内结束,而不用关心其它线程的执行速度。Wait-free是基于 per-thread 的,可以认为是 starvation-free 的。非常遗憾的是实际情况并非如此,采用 Wait-free 的程序并不能保证 starvation-free,同时内存消耗也随线程数量而线性增长。目前只有极少数的非阻塞算法实现了这一点。</p>
</li>
<li><p>Lock-Free<br>Lock-Free是指能够确保执行它的所有线程中至少有一个能够继续往下执行。由于每个线程不是 starvation-free 的,即有些线程可能会被任意地延迟,然而在每一步都至少有一 个线程能够往下执行,因此系统作为一个整体是在持续执行的,可以认为是 system-wide 的。所有 Wait-free 的算法都是 Lock-Free 的。</p>
</li>
<li><p>Obstruction-free<br>Obstruction-free是指在任何时间点,一个孤立运行线程的每一个操作可以在有限步之内结束。只要没有竞争,线程就可以持续运行。一旦共享数据被修改,Obstruction-free 要 求中止已经完成的部分操作,并进行回滚。 所有 Lock-Free 的算法都是 Obstruction-free 的。</p>
</li>
</ul>
<h3 id="使用Lock-Free算法">使用Lock-Free算法</h3>
<p>不使用Lock-Free算法示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> max = <span class="number">0</span>;</div><div class="line">	<span class="comment">//若要线程安全,需要加锁</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">set</span>(<span class="keyword">int</span> value) { </div><div class="line">		<span class="keyword">if</span> (value &gt; max) {</div><div class="line">			max = value; </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMax</span>() {</div><div class="line">		<span class="keyword">return</span> max;</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用Lock-Free算法代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> AtomicInteger max = <span class="keyword">new</span> AtomicInteger();</div><div class="line">	<span class="comment">//LockFree算法,不需要加锁。</span></div><div class="line">	<span class="comment">//通常都是三个部分组成: 1.循环 2.CAS (CompareAndSet) 3.回退</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span>(<span class="keyword">int</span> value) { </div><div class="line">		<span class="comment">//第一步循环</span></div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			<span class="keyword">int</span> current = max.get(); </div><div class="line">			<span class="keyword">if</span> (value &gt; current) {</div><div class="line">				<span class="comment">//第二步CAS</span></div><div class="line">				<span class="keyword">if</span> (max.compareAndSet(current, value)) { </div><div class="line">					<span class="comment">//第三步回退</span></div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				} <span class="keyword">else</span> {</div><div class="line">					<span class="keyword">continue</span>;</div><div class="line">				}</div><div class="line">			} <span class="keyword">else</span> { </div><div class="line">				<span class="keyword">break</span>; </div><div class="line">			}</div><div class="line">	￼￼	} </div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMax</span>() {</div><div class="line">		<span class="keyword">return</span> max.get();</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>同样地实现,把for(;;)改成do…while循环</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> AtomicInteger max = <span class="keyword">new</span> AtomicInteger();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span>(<span class="keyword">int</span> value) { </div><div class="line">		<span class="keyword">int</span> current;</div><div class="line">		do {</div><div class="line">			current = max.get();</div><div class="line">			<span class="keyword">if</span> (value &lt;= current) { </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			}</div><div class="line">		} <span class="keyword">while</span> (!max.compareAndSet(current, value));</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMax</span>() { </div><div class="line">		<span class="keyword">return</span> max.get();</div><div class="line">	} </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="使用Lock-Free数据结构">使用Lock-Free数据结构</h3>
<p>使用HashMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">class BeanManager {</div><div class="line">	<span class="keyword">private</span> Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">getBean</span>(String key) { </div><div class="line">		<span class="keyword">synchronized</span> (map) {</div><div class="line">			Object bean = map.get(key); </div><div class="line">			<span class="keyword">if</span> (bean == <span class="keyword">null</span>) {</div><div class="line">				map.put(key, createBean());</div><div class="line">				bean = map.get(key); </div><div class="line">			}</div><div class="line">			<span class="keyword">return</span> bean; </div><div class="line">		} </div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用ConcurrentHashMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class BeanManager {</div><div class="line">	<span class="keyword">private</span> ConcurrentMap&lt;String, Object&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">getBean</span>(String key) { </div><div class="line">		Object bean = map.get(key);</div><div class="line">		<span class="keyword">if</span> (bean == <span class="keyword">null</span>) {</div><div class="line">			<span class="comment">//使用ConcurrentMap,避免直接使用锁,锁由数据结构来管理。</span></div><div class="line">			map.putIfAbsent(key, createBean()); </div><div class="line">			bean = map.get(key);</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> bean; </div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ConcurrentHashMap并没有实现Lock-Free,只是使用了分离锁的办法使得能够支持多个Writer并发。 ConcurrentHashMap需要使用更多的内存。</p>
<h3 id="同样的思路用于更新数据库">同样的思路用于更新数据库</h3>
<p>乐观锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SequenceDao</span> <span class="keyword">extends</span> <span class="title">SqlMapClientDaoSupport</span> </span>{</div><div class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span>(String name, <span class="keyword">int</span> value, <span class="keyword">int</span> expect) {</div><div class="line">		Map&lt;String, Object&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(); parameters.put(<span class="string">"name"</span>, name);</div><div class="line">		parameters.put(<span class="string">"value"</span>, value);</div><div class="line">		parameters.put(<span class="string">"expect"</span>, expect);</div><div class="line">		<span class="comment">// UPDATE t_sequence SET value = #value# WHERE name = #name# AND value = #expect#</span></div><div class="line">		<span class="keyword">int</span> updateCount = getSqlMapClientTemplate().update(<span class="string">"Sequence.compareAndSet"</span>, parameters); <span class="comment">//通过UpdateCount来实现 CompareAndSet</span></div><div class="line">		<span class="keyword">return</span> updateCount == <span class="number">1</span>;</div><div class="line">	}</div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SequenceService</span> </span>{</div><div class="line">	<span class="annotation">@Transactional</span>(propagation = Propagation.NOT_SUPPORTED) </div><div class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment</span>(String sequenceName) {</div><div class="line">		<span class="comment">//三个部分:1.循环 2.CAS (CompareAndSet) 3.回退</span></div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			<span class="keyword">int</span> value = dao.getValue(sequenceName);</div><div class="line">			<span class="keyword">if</span> (dao.compareAndSet(sequenceName, value + <span class="number">1</span>, value)) {</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>注意,乐观锁时必须使用:@Transactional(propagation = Propagation.NOT_SUPPORTED)</p>
<p>对比,使用悲观锁版本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SequenceDao</span> <span class="keyword">extends</span> <span class="title">SqlMapClientDaoSupport</span> </span>{ </div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValueForUpdate</span>(String name) {</div><div class="line">		<span class="comment">// SELECT value FROM t_sequence WHERE name = #name# FOR UPDATE</span></div><div class="line">		<span class="keyword">return</span> (Integer) getSqlMapClientTemplate().queryForObject(<span class="string">"Sequence.getValueForUpdate"</span>, name); </div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span>(String name, <span class="keyword">int</span> value) {</div><div class="line">		Map&lt;String, Object&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(); parameters.put(<span class="string">"name"</span>, name);</div><div class="line">		parameters.put(<span class="string">"value"</span>, value);</div><div class="line">		<span class="comment">// UPDATE t_sequence SET value = #value# WHERE name = #name#</span></div><div class="line">		getSqlMapClientTemplate().update(<span class="string">"Sequence.set"</span>, parameters); </div><div class="line">	}</div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SequenceService</span> </span>{</div><div class="line">	<span class="annotation">@Transactional</span>(propagation = Propagation.REQUIRED) </div><div class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment2</span>(String sequenceName) {</div><div class="line">		<span class="comment">//￼读取时,就开始加锁</span></div><div class="line">		<span class="keyword">int</span> value = dao.getValueForUpdate(sequenceName);</div><div class="line">		dao.set(sequenceName, value + <span class="number">1</span>); </div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Lock-Free算法,可以说是乐观锁,如果非激烈竞争的时候,不需要使用锁,从而开销更小,速度更快。</p>
<h3 id="使用CopyOnWriteArrayList">使用CopyOnWriteArrayList</h3>
<p>COW(CopyOnWrite)是一种很古老的技术,类似的并发数据结构有:<code>ConcurrentSkipListMap</code>,<code>ConcurrentSkipListSet</code>,<code>CopyOnWriteArrayList</code>,<code>CopyOnWriteArraySet</code></p>
<p>不使用COW,使用ArrayList示例代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">class Engine {</div><div class="line">	<span class="keyword">private</span> List&lt;Listener&gt; listeners = <span class="keyword">new</span> ArrayList&lt;Listener&gt;();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addListener</span>(Listener listener) { </div><div class="line">		<span class="keyword">synchronized</span> (listeners) {</div><div class="line">			<span class="keyword">return</span> listeners.add(listener); </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doXXX</span>() { </div><div class="line">		<span class="keyword">synchronized</span> (listeners) {</div><div class="line">		<span class="keyword">for</span> (Listener listener : listeners) { </div><div class="line">			listener.handle();	</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用CopyOnWriteArrayList</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class Engine {</div><div class="line">	<span class="keyword">private</span> List&lt;Listener&gt; listeners = <span class="keyword">new</span> CopyOnWriteArrayList &lt;Listener&gt;();</div><div class="line">	<span class="comment">//￼适当使用CopyOnWriteArrayList,能够提高读操作效率</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addListener</span>(Listener listener) { </div><div class="line">		<span class="keyword">return</span> listeners.add(listener);</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doXXX</span>() {</div><div class="line">		<span class="keyword">for</span> (Listener listener : listeners) {</div><div class="line">			listeners.handle();</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="锁的使用">锁的使用</h3>
<ul>
<li><p>使用支持CAS的数据结构,避免使用锁,如: AtomicXXX、ConcurrentMap、CopyOnWriteList、ConcurrentLinkedQueue</p>
</li>
<li><p>一定要使用锁的时候,注意获得锁的顺序,相反顺序获得锁,就容易产生死锁。</p>
</li>
<li><p>死锁经常是无法完全避免的,鸵鸟策略被很多基础框架所采用。</p>
</li>
<li><p>通过Dump线程的StackTrace,例如linux下执行命令 <code>kill -3 &lt;pid&gt;</code>,或者<code>jstack –l &lt;pid&gt;</code>,或 者使用<code>Jconsole</code>连接上去查看线程的<code>StackTrace</code>,由此来诊断死锁问题。</p>
</li>
<li><p>外部锁常被忽视而导致死锁,例如数据库的锁</p>
</li>
<li><p>存在检测死锁的办法</p>
</li>
<li><p>存在一些预防死锁的手段,比如Lock的tryLock,JDK 7中引入的<code>Phaser</code>等。</p>
</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-03-14T13:45:57.000Z"><a href="/2011/03/14/thread-blocking/">3月 14 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/03/14/thread-blocking/">Java并发阻塞队列(put和take、offer和poll、drainTo)的使用</a></h1>
  

    </header>
    <div class="entry">
      
        <p>阻塞队列,是一种常用的并发数据结构,常用于生产者-消费者模式。 </p>
<h3 id="阻塞队列基础概念">阻塞队列基础概念</h3>
<p>在Java中,有很多种阻塞队列:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ArrayBlockingQueue  	<span class="comment">//最常用</span></div><div class="line">LinkedBlockingQueue  	<span class="comment">//不会满的</span></div><div class="line">SynchronousQueue    	<span class="comment">//size为0</span></div><div class="line">PriorityBlockingQueue</div><div class="line">CompletionService 		<span class="comment">//BlockingQueue + Executor</span></div><div class="line">TransferQueue 			<span class="comment">//JDK 7中更快的SynchronousQueue</span></div></pre></td></tr></table></figure>

<p>生产者消费者模型</p>
<pre><code>        producer    <span class="comment">------------------------&gt;    consumer</span>
                    +<span class="comment">----+----+----+----+----+</span>
                    +    +      +    +    +    +
                    +<span class="comment">----+----+----+----+----+</span>
                  /                            \ <span class="keyword">for</span> (;;) {
   <span class="comment"> // 如果队列满则阻塞                                blockingQ.take(); // 如果队列空则阻塞</span>
    blockingQ.<span class="built_in">put</span>(object);                        }
</code></pre><h3 id="使用阻塞队列">使用阻塞队列</h3>
<pre><code><span class="code">        +--------------+-------------+</span>
<span class="code">        |          Queue&lt;T&gt;          |</span>
<span class="code">        +--------------+-------------+</span>
<span class="code">        +--------------+-------------+</span>
<span class="code">        | add(E) : boolean           |</span>
<span class="code">        | remove() : E               |</span>
<span class="code">        | offer() : boolean          |</span>
<span class="code">        | poll() : E                 | </span>
<span class="code">        | element() : E              |</span>
<span class="code">        | peek() : E                 |</span>
<span class="code">        +--------------+-------------+</span>
<span class="code">                       ^</span>
<span class="code">                      /|\</span>
<span class="code">                继承自  |     </span>
<span class="header">                       |
+----------------------+---------------------+</span>
<span class="header">|             BlockingQueue&lt;T&gt;               |
+----------------------+---------------------+</span>
<span class="code">+----------------------+</span>---------------------+
| put(E)                                     |
| take() : E                                 |
| offer(E, long, TimeUnit) : boolean         |
| poll(long, TimeUnit) : E                   |
| remainingCapacity()                        |
| drainTo(Collection&lt;? super E&gt;) : int       |
<span class="header">| drainTo(Collection&lt;? super E&gt;, int ) : int |
+----------------------+---------------------+</span>
</code></pre><p>BlockingQueue使用注意:</p>
<ul>
<li>使用BlockingQueue的时候,尽量不要使用从Queue继承下来的方法,否则就失去了Blocking的特性了。</li>
<li>在BlockingQueue中,要使用put和take,而非offer和poll。如果 要使用offer和poll,也是要使用带等待时间参数的offer和poll。</li>
<li>使用drainTo批量获得其中的内容,能够减少锁的次数。</li>
</ul>
<p>代码片段一(错误)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> BlockingQueue&lt;Object&gt; blockingQ = <span class="keyword">new</span> ArrayBlockingQueue&lt;Object&gt;(<span class="number">10</span>); </div><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="string">"consumer thread"</span>) {</div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() { </div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			Object object = blockingQ.poll();<span class="comment">//错误,不等待就会直接返回</span></div><div class="line">			handle(object);</div><div class="line">		} </div><div class="line">	}</div><div class="line">};</div></pre></td></tr></table></figure>

<p>代码片段二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> BlockingQueue&lt;Object&gt; blockingQ = <span class="keyword">new</span> ArrayBlockingQueue&lt;Object&gt;(<span class="number">10</span>); </div><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="string">"consumer thread"</span>) {</div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() { </div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			<span class="keyword">try</span> {</div><div class="line">				<span class="comment">//注意此处</span></div><div class="line">				Object object = blockingQ.take(); <span class="comment">// 等到有数据才继续 </span></div><div class="line">				handle(object);</div><div class="line">			} <span class="keyword">catch</span> (InterruptedException e) { </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			} <span class="keyword">catch</span> (Exception e) {</div><div class="line">				<span class="comment">// handle exception</span></div><div class="line">			} </div><div class="line">		}</div><div class="line">	}</div><div class="line">};</div></pre></td></tr></table></figure>

<p>代码片段三</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> BlockingQueue&lt;Object&gt; blockingQ = <span class="keyword">new</span> ArrayBlockingQueue&lt;Object&gt;(<span class="number">10</span>); </div><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="string">"consumer thread"</span>) {</div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() { </div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			<span class="keyword">try</span> {</div><div class="line">				<span class="comment">//注意此处</span></div><div class="line">				Object object = blockingQ.poll(<span class="number">1</span>, TimeUnit.SECONDS); <span class="comment">//防止死等 </span></div><div class="line">				<span class="keyword">if</span> (object == <span class="keyword">null</span>) {</div><div class="line">					<span class="keyword">continue</span>; <span class="comment">//或者做其他处理 </span></div><div class="line">				}</div><div class="line">			} <span class="keyword">catch</span> (InterruptedException e) { </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			} <span class="keyword">catch</span> (Exception e) {</div><div class="line">				<span class="comment">// handle exception</span></div><div class="line">			} </div><div class="line">		}</div><div class="line">	}</div><div class="line">};</div></pre></td></tr></table></figure>

<h3 id="实现一个简单的阻塞队列">实现一个简单的阻塞队列</h3>
<p>未取得锁就直接执行wait、notfiy、notifyAll会抛异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">class BlockingQ {</div><div class="line">	<span class="keyword">private</span> Object notEmpty = <span class="keyword">new</span> Object();</div><div class="line">	<span class="keyword">private</span> Queue&lt;Object&gt; linkedList = <span class="keyword">new</span> LinkedList&lt;Object&gt;();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">take</span>() <span class="keyword">throws</span> InterruptedException { </div><div class="line">		<span class="keyword">synchronized</span> (notEmpty) {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				<span class="comment">//要执行wait操作,必须先取得该对象的锁</span></div><div class="line">				<span class="comment">//执行wait操作之后,锁会释放</span></div><div class="line">				<span class="comment">//被唤醒之前,需要先获得锁</span></div><div class="line">				notEmpty.wait();</div><div class="line">			}</div><div class="line">			<span class="keyword">return</span> linkedList.poll(); </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span>(Object object) { </div><div class="line">		<span class="keyword">synchronized</span> (notEmpty) {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				<span class="comment">//要执行notify和notifyAll操作,都必须先取得该对象的锁</span></div><div class="line">				notEmpty.notifyAll();</div><div class="line">			}</div><div class="line">			linkedList.add(object); </div><div class="line">		} </div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">class BlockingQ {</div><div class="line">	<span class="keyword">private</span> Object notEmpty = <span class="keyword">new</span> Object();</div><div class="line">	<span class="keyword">private</span> Object notFull = <span class="keyword">new</span> Object();</div><div class="line">	<span class="keyword">private</span> Queue&lt;Object&gt; linkedList = <span class="keyword">new</span> LinkedList&lt;Object&gt;(); </div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxLength = <span class="number">10</span>;</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">take</span>() <span class="keyword">throws</span> InterruptedException { </div><div class="line">		<span class="comment">//分别需要对notEmpty和notFull加锁</span></div><div class="line">		<span class="keyword">synchronized</span> (notEmpty) {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				notEmpty.wait();</div><div class="line">			}</div><div class="line">			<span class="comment">//分别需要对notEmpty和notFull加锁</span></div><div class="line">			<span class="keyword">synchronized</span> (notFull) {</div><div class="line">				<span class="keyword">if</span> (linkedList.size() == maxLength) { </div><div class="line">					notFull.notifyAll();</div><div class="line">				}</div><div class="line">			<span class="keyword">return</span> linkedList.poll(); </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span>(Object object) <span class="keyword">throws</span> InterruptedException { </div><div class="line">		<span class="comment">//分别需要对notEmpty和notFull加锁</span></div><div class="line">		<span class="keyword">synchronized</span> (notEmpty) {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				notEmpty.notifyAll();</div><div class="line">			}</div><div class="line">			<span class="comment">//分别需要对notEmpty和notFull加锁</span></div><div class="line">			<span class="keyword">synchronized</span> (notFull) {</div><div class="line">				<span class="keyword">if</span> (linkedList.size() == maxLength) { </div><div class="line">					notFull.wait();</div><div class="line">				}</div><div class="line">				linkedList.add(object); </div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">class BlockingQ {</div><div class="line">	<span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">	<span class="comment">// 一个锁可以创建多个Condition</span></div><div class="line">	<span class="keyword">private</span> Condition notEmpty = lock.newCondition();</div><div class="line">	<span class="keyword">private</span> Condition notFull = lock.newCondition();</div><div class="line">	<span class="keyword">private</span> Queue&lt;Object&gt; linkedList = <span class="keyword">new</span> LinkedList&lt;Object&gt;(); </div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxLength = <span class="number">10</span>;</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">take</span>() <span class="keyword">throws</span> InterruptedException {</div><div class="line">		lock.lock(); </div><div class="line">		<span class="keyword">try</span> {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				<span class="comment">// 要执行await操作,必须先取得该Condition的锁。 </span></div><div class="line">				<span class="comment">// 执行await操作之后,锁会释放。 </span></div><div class="line">				<span class="comment">// 被唤醒之前,需要先获得锁。</span></div><div class="line">				notEmpty.await();</div><div class="line">			}</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == maxLength) {</div><div class="line">				notFull.signalAll(); </div><div class="line">			}</div><div class="line">			<span class="keyword">return</span> linkedList.poll(); </div><div class="line">		} <span class="keyword">finally</span> {</div><div class="line">			lock.unlock(); </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span>(Object object) <span class="keyword">throws</span> InterruptedException {</div><div class="line">		lock.lock(); </div><div class="line">		<span class="keyword">try</span> {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				<span class="comment">//￼要执行signal和signalAll操作,都必须先取 得该对象</span></div><div class="line">				notEmpty.signalAll();</div><div class="line">			}</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == maxLength) {</div><div class="line">				notFull.await(); </div><div class="line">			}</div><div class="line">			linkedList.add(object); </div><div class="line">		} <span class="keyword">finally</span> {</div><div class="line">			lock.unlock(); </div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>注意:未锁就直接执行await、signal、siganlAll会抛异常</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-02-12T07:49:30.000Z"><a href="/2011/02/12/git-pro/">2月 12 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/02/12/git-pro/">Git配置和常用命令</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Git是一个分布式版本控制／软件配置管理软件，原来是linux内核开发者林纳斯·托瓦兹（Linus Torvalds）为了更好地管理linux内核开发而创立的。</p>
<h3 id="Git配置">Git配置</h3>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">git config --<span class="keyword">global</span> user.name <span class="string">"Lawrence-zxc"</span></div><div class="line">git config --<span class="keyword">global</span> user.email <span class="string">"zhangxiongcai337@gmail.com"</span></div><div class="line">git config --<span class="keyword">global</span> color.ui <span class="literal">true</span></div><div class="line">git config --<span class="keyword">global</span> <span class="keyword">alias</span>.co checkout</div><div class="line">git config --<span class="keyword">global</span> <span class="keyword">alias</span>.ci commit</div><div class="line">git config --<span class="keyword">global</span> <span class="keyword">alias</span>.st status</div><div class="line">git config --<span class="keyword">global</span> <span class="keyword">alias</span>.br branch</div><div class="line">git config -l  <span class="preprocessor"># 列举所有配置</span></div></pre></td></tr></table></figure>

<p>用户的git配置文件在<code>~/.gitconfig</code>，我的配置：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">  /Users/zxc/workspace/blog  ❤  cat ~/.gitconfig </div><div class="line">[user]</div><div class="line">    <span class="variable">email =</span> zhangxiongcai337@gmail.com</div><div class="line">    <span class="variable">name =</span> Lawrence-zxc</div><div class="line">[color]</div><div class="line">    <span class="variable">ui =</span> auto</div><div class="line">[color <span class="string">"branch"</span>]</div><div class="line">    <span class="variable">current =</span> yellow reverse</div><div class="line">    <span class="variable">local =</span> yellow</div><div class="line">    <span class="variable">remote =</span> green</div><div class="line">[color <span class="string">"diff"</span>]</div><div class="line">    <span class="variable">meta =</span> yellow bold</div><div class="line">    <span class="variable">frag =</span> magenta bold</div><div class="line">    <span class="variable">old =</span> red bold</div><div class="line">    <span class="variable">new =</span> green bold</div><div class="line">[color <span class="string">"status"</span>]</div><div class="line">    <span class="variable">added =</span> yellow</div><div class="line">    <span class="variable">changed =</span> green</div><div class="line">    <span class="variable">untracked =</span> cyan</div><div class="line">[alias]</div><div class="line">    <span class="variable">st =</span> <span class="string">"status"</span></div><div class="line">    <span class="variable">co =</span> checkout</div><div class="line">    <span class="variable">ls =</span> <span class="string">"ls-files"</span></div><div class="line">    <span class="variable">ci =</span> commit</div><div class="line">    <span class="variable">br =</span> branch</div><div class="line">    <span class="variable">rt =</span> reset --hard</div><div class="line">    <span class="variable">unstage =</span> reset HEAD</div><div class="line">    <span class="variable">uncommit =</span> reset --soft HEAD^</div><div class="line">    <span class="variable">l =</span> log <span class="variable">--pretty=</span>oneline --abbrev-commit --graph --decorate</div><div class="line">    <span class="variable">amend =</span> commit --amend </div><div class="line">    <span class="variable">who =</span> shortlog -n -s --no-merges </div><div class="line">    <span class="variable">g =</span> grep -n --color -E </div><div class="line">    <span class="variable">cp =</span> cherry-pick -x </div><div class="line">    <span class="variable">cb =</span> checkout -b </div><div class="line">[core]</div><div class="line">    <span class="variable">filemode =</span> <span class="constant">true</span></div></pre></td></tr></table></figure>

<h3 id="Git常用命令">Git常用命令</h3>
<p>查看、帮助命令</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git help &lt;command&gt;</span>  <span class="comment"># 显示command的help</span></span></div><div class="line">git show            <span class="comment"># 显示某次提交的内容</span></div><div class="line">git show <span class="variable">$id</span></div></pre></td></tr></table></figure>

<p>查看提交记录</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">git <span class="keyword">log</span></div><div class="line">git <span class="keyword">log</span> &lt;file&gt;      <span class="comment"># 查看该文件每次提交记录</span></div><div class="line">git <span class="keyword">log</span> -p &lt;file&gt;   <span class="comment"># 显示版本历史，以及版本间的内容差异</span></div><div class="line">git <span class="keyword">log</span> -p -<span class="number">2</span>       <span class="comment"># 查看最近两次详细修改内容的diff</span></div><div class="line">git <span class="keyword">log</span> --<span class="keyword">stat</span>      <span class="comment"># 查看提交统计信息</span></div><div class="line">git <span class="keyword">log</span> --since=<span class="string">"6 hours"</span>  <span class="comment"># 显示最近6小时提交</span></div><div class="line">git <span class="keyword">log</span> --before=<span class="string">"2 days"</span>  <span class="comment"># 显示2天前提交</span></div><div class="line">git <span class="keyword">log</span> -<span class="number">1</span> HEAD~<span class="number">3</span>          <span class="comment"># 显示比HEAD早3个提交的那个提交</span></div><div class="line">git <span class="keyword">log</span> -<span class="number">1</span> HEAD^^^</div><div class="line">git reflog                 <span class="comment"># 查看操作记录</span></div></pre></td></tr></table></figure>

<p>添加、提交、删除、找回，重置修改文件</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git co  -- &lt;file&gt;</span>   <span class="comment"># 抛弃工作区修改</span></span></div><div class="line"><span class="input"><span class="prompt">git co  .           # 抛弃工作区修改</span></span></div><div class="line">git co HEAD &lt;file&gt;  <span class="comment"># 抛弃工作目录区中文件的修改</span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git add &lt;file&gt;</span>      <span class="comment"># 将工作文件修改提交到本地暂存区</span></span></div><div class="line">git add .           <span class="comment"># 将所有修改过的工作文件提交暂存区</span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git rm &lt;file&gt;</span>       <span class="comment"># 从版本库中删除文件</span></span></div><div class="line"><span class="input"><span class="prompt">git rm &lt;file&gt;</span> --cached  <span class="comment"># 从版本库中删除文件，但不删除文件</span></span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git reset &lt;file&gt;</span>    <span class="comment"># 从暂存区恢复到工作文件</span></span></div><div class="line"><span class="input"><span class="prompt">git reset -- .      # 从暂存区恢复到工作文件</span></span></div><div class="line">git reset --hard  HEAD^ # 恢复最近一次提交过的状态，即放弃上次提交后的所有本次修改</div><div class="line">git reset --hard &lt;commit id&gt;  <span class="comment"># 恢复到某一次提交的状态</span></div><div class="line"><span class="input"><span class="prompt">git reset HEAD &lt;file&gt;</span> <span class="comment"># 抛弃暂存区中文件的修改</span></span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">git ci &lt;<span class="built_in">file</span>&gt;</div><div class="line">git ci .</div><div class="line">git ci -<span class="operator">a</span>           <span class="comment"># 将git add, git rm和git ci等操作都合并在一起做</span></div><div class="line">git ci -am <span class="string">"some comments"</span></div><div class="line">git ci <span class="comment">--amend      # 修改最后一次提交记录</span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git revert &lt;$id&gt;</span>    <span class="comment"># 恢复某次提交的状态，恢复动作本身也创建了一次提交对象</span></span></div><div class="line">git revert <span class="constant">HEAD</span>     <span class="comment"># 恢复最后一次提交的状态</span></div></pre></td></tr></table></figure>

<p>查看文件diff</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git diff &lt;file&gt;</span>     <span class="comment"># 比较当前文件和暂存区文件差异</span></span></div><div class="line"><span class="input"><span class="prompt">git diff</span></span></div><div class="line">git diff &lt;$id1&gt; &lt;<span class="variable">$id2</span>&gt;      <span class="comment"># 比较两次提交之间的差异</span></div><div class="line">git diff &lt;branch1&gt;..&lt;branch2&gt;   <span class="comment"># 在两个分支之间比较 </span></div><div class="line">git diff --staged   <span class="comment"># 比较暂存区和版本库差异</span></div><div class="line">git diff --cached   <span class="comment"># 比较暂存区和版本库差异</span></div><div class="line">git diff --stat     <span class="comment"># 仅仅比较统计信息</span></div></pre></td></tr></table></figure>

<h3 id="Git_本地分支管理">Git 本地分支管理</h3>
<p>查看、切换、创建和删除分支</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git br -r           # 查看远程分支</span></span></div><div class="line">git br -v           # 查看各个分支最后提交信息</div><div class="line">git br -a           # 列出所有分支</div><div class="line">git br --merged     # 查看已经被合并到当前分支的分支</div><div class="line">git br --no-merged  # 查看尚未被合并到当前分支的分支</div><div class="line">git br &lt;new_branch&gt; <span class="comment"># 基于当前分支创建新的分支</span></div><div class="line"><span class="input"><span class="prompt">git br &lt;new_branch&gt;</span>  &lt;start_point&gt;      <span class="comment"># 基于另一个起点（分支名称，提交名称或则标签名称），创建新的分支</span></span></div><div class="line"><span class="input"><span class="prompt">git br -f &lt;existing_branch&gt;</span>  &lt;start_point&gt;  <span class="comment"># 创建同名新分支，覆盖已有分支</span></span></div><div class="line"><span class="input"><span class="prompt">git br -d &lt;branch&gt;</span>  <span class="comment"># 删除某个分支</span></span></div><div class="line"><span class="input"><span class="prompt">git br -D &lt;branch&gt;</span>  <span class="comment"># 强制删除某个分支 (未被合并的分支被删除的时候需要强制)</span></span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git co &lt;branch&gt;</span>         <span class="comment"># 切换到某个分支</span></span></div><div class="line"><span class="input"><span class="prompt">git co -b &lt;new_branch&gt;</span>  <span class="comment"># 创建新的分支，并且切换过去</span></span></div><div class="line"><span class="input"><span class="prompt">git co -b &lt;new_branch&gt;</span> &lt;branch&gt;       <span class="comment"># 基于branch创建新的new_branch</span></span></div><div class="line"><span class="input"><span class="prompt">git co -m &lt;existing_branch&gt;</span> &lt;new_branch&gt;  <span class="comment"># 移动或重命名分支，当新分支不存在时</span></span></div><div class="line"><span class="input"><span class="prompt">git co -M &lt;existing_branch&gt;</span> &lt;new_branch&gt;  <span class="comment"># 移动或重命名分支，当新分支存在时就覆盖</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">git co $id               # 把某次历史提交记录checkout出来，但无分支信息，切换到其他分支会自动删除</div><div class="line">git co $id -b &lt;new_branch&gt;       <span class="comment"># 把某次历史提交记录checkout出来，创建成一个分支</span></div></pre></td></tr></table></figure>

<p>分支合并和rebase</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git merge &lt;branch&gt;</span>                  <span class="comment"># 将branch分支合并到当前分支</span></span></div><div class="line"><span class="input"><span class="prompt">git merge origin/master --no-ff     # 不要Fast-Foward合并，这样可以生成merge提交</span></span></div><div class="line">git merge --no-commit &lt;branch&gt;      <span class="comment"># 合并但不提交</span></div><div class="line"><span class="input"><span class="prompt">git merge --squash &lt;branch&gt;</span>         <span class="comment"># 把一条分支上的内容合并到另一个分支上的一个提交</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">git rebase master &lt;branch&gt;          <span class="comment"># 将master rebase到branch，相当于：</span></div><div class="line"><span class="input"><span class="prompt">git co &lt;branch&gt;</span> && git rebase master && git co master && git merge &lt;branch&gt;</span></div></pre></td></tr></table></figure>

<p>Git补丁管理</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git diff &gt; ../sync.<span class="keyword">patch</span>         <span class="preprocessor"># 生成补丁</span></div><div class="line">git apply ../sync.<span class="keyword">patch</span>          <span class="preprocessor"># 打补丁</span></div><div class="line">git apply --check ../sync.<span class="keyword">patch</span>  <span class="preprocessor"># 测试补丁能否成功</span></div><div class="line">git format-<span class="keyword">patch</span> -X              <span class="preprocessor"># 根据提交的log生成patch，X为数字，表示最近的几个日志</span></div></pre></td></tr></table></figure>

<p>Git暂存管理</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git stash                        <span class="comment"># 暂存</span></div><div class="line">git stash <span class="keyword">list</span>                   <span class="comment"># 列所有stash</span></div><div class="line">git stash apply                  <span class="comment"># 恢复暂存的内容</span></div><div class="line">git stash drop                   <span class="comment"># 删除暂存区</span></div></pre></td></tr></table></figure>

<p>Git远程分支管理</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">git pull                         <span class="comment"># 抓取远程仓库所有分支更新并合并到本地</span></div><div class="line">git pull --no-ff                 <span class="comment"># 抓取远程仓库所有分支更新并合并到本地，不要快进合并</span></div><div class="line">git fetch origin                 <span class="comment"># 抓取远程仓库所有更新</span></div><div class="line">git fetch origin remote-branch:local-branch <span class="comment">#抓取remote-branch分支的更新</span></div><div class="line">git fetch origin --tags          <span class="comment"># 抓取远程上的所有分支</span></div><div class="line">git checkout -b <span class="variable">&lt;new-branch&gt;</span> <span class="variable">&lt;remote_tag&gt;</span> <span class="comment"># 抓取远程上的分支</span></div><div class="line">git merge origin/master          <span class="comment"># 将远程主分支合并到本地当前分支</span></div><div class="line">git co --track origin/branch     <span class="comment"># 跟踪某个远程分支创建相应的本地分支</span></div><div class="line">git co -b <span class="variable">&lt;local_branch&gt;</span> origin/<span class="variable">&lt;remote_branch&gt;</span>  <span class="comment"># 基于远程分支创建本地分支，功能同上</span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git push                         # push所有分支</span></span></div><div class="line">git push origin master           # 将本地主分支推到远程主分支</div><div class="line">git push -u origin master        # 将本地主分支推到远程(如无远程主分支则创建，用于初始化远程仓库)</div><div class="line">git push origin &lt;local_branch&gt;   <span class="comment"># 创建远程分支， origin是远程仓库名</span></div><div class="line">git push origin &lt;local_branch&gt;<span class="symbol">:&lt;remote_branch&gt;</span>  <span class="comment"># 创建远程分支</span></div><div class="line"><span class="input"><span class="prompt">git push origin :&lt;remote_branch&gt;</span>  <span class="comment">#先删除本地分支(git br -d &lt;branch&gt;)，然后再push删除远程分支</span></span></div></pre></td></tr></table></figure>

<p>Git远程仓库管理</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">git remote -v                    <span class="comment"># 查看远程服务器地址和仓库名称</span></div><div class="line">git remote show origin           <span class="comment"># 查看远程服务器仓库状态</span></div><div class="line">git remote <span class="built_in">add</span> origin git@github:XXX/test.git         <span class="comment"># 添加远程仓库地址</span></div><div class="line">git remote <span class="built_in">set</span>-url origin git@github.com:XXX/test.git <span class="comment"># 设置远程仓库地址(用于修改远程仓库地址)</span></div><div class="line">git remote rm &lt;repository&gt;       <span class="comment"># 删除远程仓库</span></div><div class="line">git remote <span class="built_in">set</span>-head origin master   <span class="comment"># 设置远程仓库的HEAD指向master分支</span></div><div class="line"></div><div class="line">git branch <span class="comment">--set-upstream master origin/master</span></div><div class="line">git branch <span class="comment">--set-upstream develop origin/develop</span></div></pre></td></tr></table></figure>

<h3 id="实例">实例</h3>
<p>打patch过程</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">add</span> .</div><div class="line">git status</div><div class="line">git diff <span class="comment">--cached &gt;XXX.patch</span></div><div class="line">git ci -m <span class="string">'add patch'</span></div></pre></td></tr></table></figure>

<h3 id="分支策略">分支策略</h3>
<p>在实际开发中，我们应该按照几个基本原则进行分支管理：</p>
<p>首先，master分支应该是非常稳定的，也就是仅用来发布新版本，平时不能在上面干活；</p>
<p>那在哪干活呢？干活都在dev分支上，也就是说，dev分支是不稳定的，到某个时候，比如1.0版本发布时，再把dev分支合并到master上，在master分支发布1.0版本；</p>
<p>你和你的小伙伴们每个人都在dev分支上干活，每个人都有自己的分支，时不时地往dev分支上合并就可以了。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-02-11T08:09:32.000Z"><a href="/2011/02/11/git-help/">2月 11 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/02/11/git-help/">Git使用帮助</a></h1>
  

    </header>
    <div class="entry">
      
        <p><br></p>
<h3 id="使用http协议">使用http协议</h3>
<p>对于较新版本的git，比如1.7.9以上，我们推荐使用http协议来访问git仓库，不需配置ssh key，使用注册用户名和密码就可以访问。</p>
<p>使用git credential-cache来记住用户名和密码：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config <span class="subst">--</span><span class="built_in">global</span> credential<span class="built_in">.</span>helper <span class="keyword">cache</span></div></pre></td></tr></table></figure>

<p>git<br>如果需要设置cache的时间，设置记住用户名和密码的时间(秒为单位)：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --<span class="keyword">global</span> credential.helper <span class="string">'cache --timeout=10000000'</span></div></pre></td></tr></table></figure>

<p>git默认的postbuffer是比较小的，在push一个大的commit会出现错误，设置postbuffer，相关链接看<a href="http://stackoverflow.com/questions/2702731/git-fails-when-pushing-commit-to-github" target="_blank" rel="external">这里</a>：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --<span class="keyword">global</span> http.postBuffer <span class="number">524288000</span></div></pre></td></tr></table></figure>

<p>在使用多个账户的情况下，为了避免混淆用户，可以使用@yourname来强制指定，比如：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone http<span class="variable">s:</span>//Lawrence-zxc@github.<span class="keyword">com</span>/Lawrence-zxc/github.git</div></pre></td></tr></table></figure>

<h3 id="管理ssh_key">管理ssh key</h3>
<p>ssh 公钥密钥对是一切安全的基础，就像第一道防盗门。Github出于安全的考虑，一概通过ssh协议交换数据，保护好ssh密钥是一个程序员应该有的安全意识，希望您通过<code>1password</code>之类的工具妥善保存，此外最好能定期的更新密钥。</p>
<p>多人共用密钥是严格不支持的！</p>
<p>如果您第一次使用，按照以下的方式配置ssh密码：</p>
<p>快速入门：</p>
<p>如果您使用任何类unix系统，第一次配置 ssh 公钥密钥，请按照步骤，复制灰色背景字符，在终端执行命令，和编辑文件</p>
<p>如果不存在<code>~/.ssh/id_rsa</code>，执行以下命令，生成 ssh 密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa  -N <span class="string">''</span></div><div class="line">cat ~/.ssh/id_rsa.pub</div></pre></td></tr></table></figure>

<p>点击ssh public key 管理，输入标识保存公钥</p>
<p>[可选]如果你要生成特定 ssh 密钥只用于github（是第一步的另外可选方案）</p>
<p>执行以下命令，生成 ssh 密钥, 保存在 <code>~/.ssh/github.com_rsa</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa  -N <span class="string">''</span> <span class="operator">-f</span> ~/.ssh/github.com_rsa;</div></pre></td></tr></table></figure>

<p>编辑 ssh 客户端配置文件 <code>~/.ssh/config</code>，使用您熟悉的编辑器，在后面添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Host github.com</div><div class="line"> User </div><div class="line"> IdentityFile ~/.ssh/github.com_rsa</div><div class="line"> PreferredAuthentications publickey</div></pre></td></tr></table></figure>


<p>查看 ssh 公钥，使用 cat 命令，或者用编辑器打开，请复制 ssh 公钥的文本内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat ~/.ssh/github.com_rsa.pub</div></pre></td></tr></table></figure>

<p>点击ssh public key 管理，输入标识保存公钥</p>
<p>ssh 公钥配置之后就可以长期使用了，请保护好密钥。点击创建仓库，详细仓库说明有助于推广</p>
<p>你已经可以使用 github 来托管代码了，以下是示范的操作，详细信息请开始git的学习</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>git clone git<span class="variable">@github</span>.<span class="symbol">com:</span>your_name/repo_name</div><div class="line"><span class="variable">$ </span>cd repo_name;</div><div class="line"><span class="variable">$ </span>vim <span class="constant">README</span>.md</div><div class="line"><span class="variable">$ </span>git add <span class="constant">README</span>.md</div><div class="line"><span class="variable">$ </span>git commit -m <span class="string">"init README.md"</span> .</div><div class="line"><span class="variable">$ </span>git push -u origin master</div></pre></td></tr></table></figure>


<p>配置 user.name, user.mail ，两者对后台统计，信息push有重要的作用，选择您注册的用户名和email按照下面配置</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git config --global <span class="literal">user</span>.name <span class="string">"your_name"</span></div><div class="line">$ git config --global <span class="literal">user</span>.email <span class="string">"your_email"</span></div></pre></td></tr></table></figure>


<p>如果不想 global，在每个仓库里面执行 git config ，去掉 —global 参数</p>
<h3 id="管理仓库">管理仓库</h3>
<p>仓库是开发的基础容器，一切活动都源于仓库。如果您想让别人知道您的仓库，最好是<br>良好的命名，简单概要。<br>适当的注释，让人知道您的仓库做什么的，解决什么问题。<br>最重要的当然是不断的开发成为优秀的项目。<br>仓库除了代码之外，其他的数据都是被严格限制的，您务必理解这一点。</p>
<p>clone·push·pull代码</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>git clone git<span class="variable">@github</span>.<span class="symbol">com:</span>your/repo</div><div class="line"><span class="variable">$ </span>cd repo; vim <span class="constant">README</span>.md</div><div class="line"><span class="variable">$ </span>git add <span class="constant">README</span>.md</div><div class="line"><span class="variable">$ </span>git commit -m <span class="string">"init README.md"</span></div><div class="line"><span class="variable">$ </span>git push -u origin master</div><div class="line"><span class="variable">$ </span>git pull</div></pre></td></tr></table></figure>

<h3 id="git外部学习资源">git外部学习资源</h3>
<ul>
<li>Git Official Site<a href="http://book.git-scm.com/" target="_blank" rel="external">http://book.git-scm.com/</a></li>
<li>Git Community Book 中文版<a href="http://gitbook.liuhui998.com/index.html" target="_blank" rel="external">http://gitbook.liuhui998.com/index.html</a></li>
<li>Pro Git 简体中文版<a href="http://git.oschina.net/progit/" target="_blank" rel="external">http://git.oschina.net/progit/</a></li>
<li>Git权威指南 相关blog<a href="http://www.worldhello.net/" target="_blank" rel="external">http://www.worldhello.net/</a></li>
<li>Markdown 语法<a href="http://qingbo.net/picky/502-markdown-syntax.html" target="_blank" rel="external">http://qingbo.net/picky/502-markdown-syntax.html</a></li>
<li>假如你没什么事情可以做了，还可以看看<a href="http://blog.gitshell.com/" target="_blank" rel="external">http://blog.gitshell.com/</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-01-12T03:13:23.000Z"><a href="/2011/01/12/spring-mvc-1/">1月 12 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/01/12/spring-mvc-1/">SpringMVC中约定优于配置</a></h1>
  

    </header>
    <div class="entry">
      
        <p>所谓的约定优于配置就是指在程序开发过程中我们约定好一些规则可以使我们更少的进行配置和代码编写。就这么简单的一句话可能你还不是很懂什么是约定优于配置，没关系，看完后面对SpringMVC的约定优于配置的介绍之后你就会明白了。</p>
<p>SpringMVC对约定优于配置的支持主要表现在三个方面，<em>Model</em>、<em>View</em>和<em>Controller</em>。</p>
<h3 id="Model：">Model：</h3>
<p>SpringMVC对Model的约定优于配置的支持是基于ModelMap的，由于ModelAndView中的Model就是一个ModelMap，所以ModelAndView也是支持的。约定优于配置在Model上的表现是通过ModelMap的addObject方法实现的，当我们需要往ModelMap中添加一个对象的时候，我们可以只添加一个对象，而不指定其对应的属性名称，即调用addObject(Object obj)方法，而不是调用addObject(String attrName, Object obj)方法。这个时候Spring就会根据它自身约定的一套机制给我们一个默认的属性名称。</p>
<p>Spring的约定是这样的：</p>
<ul>
<li>采用这种方式添加的对象不能为null，所以如果添加的对象有可能为null时就不应该使用这种方式，还是使用addObject(String attrName,Object obj)方法指定一个属性名称比较好。</li>
<li>采用这种方式添加的集合Collection不能为empty，同样如果该Collection有可能为empty的时候就不应该使用这种方式。</li>
<li>简单对象，当是一个简单对象的时候取该对象的类名称，不包括包名，然后采用JavaBean的属性命名规则来确定属性名称，如添加com.host.app.model.User对象时取的属性名称就是user，添加com.host.app.model.HelloWorld对象时取的属性名称就是helloWorld，添加com.host.app.model.ABCdef对象时取的属性名称就是ABCdef。</li>
<li>数组，当添加的是一个数组的时候，Spring会取该数组的类型按照规则3取到一个名称作为基名称，之后再加上List后缀作为约定的属性名称。如添加一个Object数组时，Spring约定的属性名称就是objectList，添加一个com.host.app.model.ABCdef数组时，Spring取的属性名称就是ABCdefList。</li>
<li>集合Collection，当添加的是一个集合的时候，Spring会采用Iterator的方式取该集合的第一个元素类型按照规则3取到一个名称作为基名称，之后再加上List后缀作为约定的名称。如添加一个List时，如果取出的该List的第一个元素是java.lang.Object对象，那么Spring取的属性名称就是objectList；添加一个包含的都是com.host.app.model.User的Set时，Spring取的属性名称就是userList；如果添加的HashSet中同时包含多种类型的对象时就应该使用addObject(String attrName, Object obj)方法指定自己的属性名称，因为HashSet内部的元素是无序的，每次取的第一个元素可能不一样，这也就会导致Spring取的属性名称会不一样。</li>
</ul>
<p>看下面一个示例，当我们访问控制器处理方法testModel时，往返回的模型中添加了一个包含User的List对象，这样在ModelAndView内部内置的ModelMap中就会采用约定好的方式取userList为该对象在模型中的属性名称。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> ModelAndView <span class="title">testModel</span>() {  </div><div class="line">   ModelAndView mav = <span class="keyword">new</span> ModelAndView(<span class="string">"modelTest"</span>);  </div><div class="line">   User user = <span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">"zhangsan"</span>);  </div><div class="line">   List&lt;User&gt; list = <span class="keyword">new</span> ArrayList&lt;User&gt;();  </div><div class="line">   list.add(user);  </div><div class="line">   mav.addObject(list);  </div><div class="line">   <span class="keyword">return</span> mav;  </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="View：">View：</h3>
<p>当Controller处理器方法没有返回一个View对象或逻辑视图名称，并且在该方法中没有直接往response的输出流里面写数据的时候，Spring就会采用约定好的方式提供一个逻辑视图名称。这个逻辑视图名称是通过Spring定义的org.springframework.web.servlet.RequestToViewNameTranslator接口的getViewName方法来实现的，我们可以实现自己的RequestToViewNameTranslator接口来约定好没有返回视图名称的时候如何确定视图名称。Spring已经给我们提供了一个它自己的实现，那就是org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator。<br>在介绍DefaultRequestToViewNameTranslator是如何约定视图名称之前我们先来看一下它支持用户定义的属性：</p>
<ul>
<li>prefix：前缀，表示约定好的视图名称需要加上的前缀，默认是空串。</li>
<li>suffix：后缀，表示约定好的视图名称需要加上的后缀，默认是空串。</li>
<li>separator：分隔符，默认是斜杠“/”。</li>
<li>stripLeadingSlash：如果首字符是分隔符，是否要去除，默认是true。</li>
<li>stripTrailingSlash：如果最后一个字符是分隔符，是否要去除，默认是true。</li>
<li>stripExtension：如果请求路径包含扩展名是否要去除，默认是true。</li>
<li>urlDecode：是否需要对URL解码，默认是true。它会采用request指定的编码或者ISO-8859-1编码对URL进行解码。</li>
</ul>
<p>当我们没有在SpringMVC的配置文件中手动的定义一个名为viewNameTranlator的bean的时候，Spring就会为我们提供一个默认的viewNameTranslator，即DefaultRequestToViewNameTranslator。</p>
<p>接下来看一下，当Controller处理器方法没有返回逻辑视图名称的时候，DefaultRequestToViewNameTranslator是如何约定视图名称的。DefaultRequestToViewNameTranslator会获取到请求的URI，然后根据提供的属性做一些改造，把改造之后的结果作为视图名称返回。我们以请求路径<em><a href="http://localhost/app/product/index.html" target="_blank" rel="external">http://localhost/app/product/index.html</a></em>为例来说明DefaultRequestToViewNameTranslator是如何工作的。该请求路径对应的请求URI为/product/index.html,我们来看以下几种情况，它分别对应的逻辑视图名称是什么。</p>
<ul>
<li>prefix和suffix都存在，其他为默认值是对应返回的逻辑视图名称应该是prefixproduct/indexsuffix。</li>
<li>stripLeadingSlash和stripExtension都为false，其他默认，这时候对应的逻辑视图名称是/product/index.html。</li>
<li>都采用默认配置时，返回的逻辑视图名称应该是product/index。</li>
</ul>
<p>如果我们的逻辑视图名称都跟请求路径相同或者相关关系是一样的,我们就可以采用Spring为我们事先约定好的逻辑视图名称返回,这可以大大简化我们的开发工作。</p>
<p>下面是一个在SpringMVC配置文件中配置一个<code>RequestToViewNameTranslator bean</code>的示例,记住,该bean的名称只能为viewNameTranslator,如果不为viewNameTranslator时,Spring还是会使用默认配置的DefaultRequestToViewNameTranslator来约定逻辑视图名称</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"viewNameTranslator"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator"</span>&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"prefix"</span> <span class="attribute">value</span>=<span class="value">"prefix"</span>/&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"suffix"</span> <span class="attribute">value</span>=<span class="value">"suffix"</span>/&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"stripLeadingSlash"</span> <span class="attribute">value</span>=<span class="value">"false"</span>/&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"stripExtension"</span> <span class="attribute">value</span>=<span class="value">"false"</span>/&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="title">bean</span>&gt;</span></div></pre></td></tr></table></figure>



<h3 id="Controller：">Controller：</h3>
<p>此处讲SpringMVC对约定优于配置的支持是基于注解配置Controller的情况。考虑这样一种情况：定义了一个Controller，名为MyController，然后在MyController类上使用了@Controller注解进行标记，没有类级别的@RequestMapping。MyController中定义了一个处理器方法add，该方法使用了@RequestMapping注解标记。大概就是下面这个样子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>{  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"add"</span>)  </div><div class="line">    <span class="keyword">public</span> String <span class="title">add</span>() {  </div><div class="line">       <span class="keyword">return</span> <span class="string">"add"</span>;  </div><div class="line">    }     </div><div class="line">}</div></pre></td></tr></table></figure>



<p>这个时候如果我们需要访问到处理器方法add的话，我们需要请求/add.do，然后有另外一个AnotherController，里面也有一个add方法对应/add.do请求，这个时候如果你再请求/add.do的时候Spring就不知道到底该访问那个方法，然后就会抛出异常，这个时候我们最简单的解决办法就是在MyController上加上类级别的@RequestMapping用以区别，表示请求的路径到底是哪个Controller下面的，类似的情况还有我们会把相关的处理器方法放在一个Controller中，比如UserController下面会有user的add方法，user的del方法等。Spring为我们提供了一种机制可以自动根据我们的Controller类名称来进行请求映射，这是通过在SpringMVC的配置文件中定义一个org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping bean来实现的。通过它的名称我们可以知道ControllerClassNameHandlerMapping就是通过Controller的类名称来进行类级别的请求映射的。使用ControllerClassNameHandlerMapping的默认属性配置的时候Spring是这样来进行请求映射的：</p>
<ul>
<li>首先取得去掉包名称的Controller类名称。</li>
<li>如果该类名称是以Controller结尾，则只取Controller前面的部分，如MyController取My。</li>
<li>将取到的名称取全部小写，如MyHome取myhome。</li>
<li>然后将上面取到的名称映射为/name/<em>，如上面取到的名称是myhome，则映射为/myhome/</em>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>{  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"add"</span>)  </div><div class="line">    <span class="keyword">public</span> String <span class="title">add</span>() {  </div><div class="line">       <span class="keyword">return</span> <span class="string">"add"</span>;  </div><div class="line">    }    </div><div class="line">}</div></pre></td></tr></table></figure>


<p>还是这一段代码，当我们使用ControllerClassNameHandlerMapping来进行映射的时候，我们需要访问MyController的处理器方法add的时候就需要请求/my/add.do。<br>ControllerClassNameHandlerMapping支持用户定义如下属性：</p>
<ul>
<li>caseSensitive：大小写是否敏感，默认是false，该属性主要是用来生成映射路径的时候匹配大小写是否敏感，如果为true，则只把Controller类名称的首字母小写，其他的保持原样进行请求路径映射，如果为false，则全部小写。basePackage也使用同样的规则，只是basePackage在caseSensitive为true的时候不需要首字母小写。</li>
<li>basePackage：表示要用于生成路径映射的基包，默认是null，这个时候就采用Controller不包含包名称的类名称来映射，映射规则跟之前介绍的映射规则相同。如果定义了basePackage，假设为com.host.app，这个时候如果Controller类的全名称是com.host.app.abc.edf.MyController，那么映射的路径就是/abc/edf/my/*。</li>
<li>pathPrefix：表示映射路径的前缀，默认是空串。假设pathPrefix为prefix，basePackage为com.host.app，那么com.host.app.abc.MyController的映射路径就是/prefix/abc/my/*。</li>
<li>excludedPackages：是数组形式，表示需要把哪些包排除在ControllerClassNameHandlerMapping的映射范围之内。</li>
<li>excludedClasses：是数组形式，表示需要把哪些类排除在ControllerClassNameHandlerMapping的映射范围之内。</li>
</ul>
<p>在下面一个例子就排除了com.host.app.web.mymodule包、com.host.app.web.modulea.MyController和com.host.app.web.moduleb.UserController。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;bean class="org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping"&gt;  </div><div class="line">   &lt;property name="order" value="1"/&gt;  </div><div class="line">   &lt;property name="excludedPackages"&gt;  </div><div class="line">       &lt;array&gt;  </div><div class="line">          &lt;value&gt;com.host.app.web.mymodule &lt;/value&gt;  </div><div class="line">       &lt;/array&gt;  </div><div class="line">   &lt;/property&gt;  </div><div class="line">   &lt;property name="excludedClasses"&gt;  </div><div class="line">       &lt;array&gt;  </div><div class="line">          &lt;value&gt;com.host.app.web.modulea.MyController&lt;/value&gt;  </div><div class="line">          &lt;value&gt;com.host.app.web.moduleb.UserController&lt;/value&gt;  </div><div class="line">       &lt;/array&gt;  </div><div class="line">   &lt;/property&gt;  </div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>



<p>使用ControllerClassNameHandlerMapping需要注意的地方：</p>
<ul>
<li>需要使用ControllerClassNameHandlerMapping来映射的Controller类上如果加了@RequestMapping注解ControllerClassNameHandlerMapping也是可以进行URL路径映射的。</li>
<li>使用ControllerClassNameHandlerMapping映射的是类似于<code>/controllerName/*</code>这样的形式，这也就是说只有在处理器方法映射不存在斜杠的时候才可以使用这种形式访问到。看下面一个例子，在下面代码中MyController类能够映射的请求路径是<code>/my/*</code>，这也意味着只有满足/my/*的请求路径才能映射到MyController，才能访问到它里面的处理器方法，所以当请求/my/test1.do的时候毫无疑问可以访问到处理器方法test1，但是当想访问MyController的test2方法，请求/my/test/test2.do的时候由于它不能映射到MyController，所以不能如愿的访问到MyController的test2方法。这也是ControllerClassNameHandlerMapping 一个缺陷。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>{  </div><div class="line">   </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"test1"</span>)  </div><div class="line">    <span class="keyword">public</span> String <span class="title">test1</span>() {  </div><div class="line">       <span class="keyword">return</span> <span class="string">"test"</span>;  </div><div class="line">    }  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"test/test2"</span>)  </div><div class="line">    <span class="keyword">public</span> String <span class="title">test2</span>() {  </div><div class="line">       <span class="keyword">return</span> <span class="string">"test"</span>;  </div><div class="line">    }      </div><div class="line">}</div></pre></td></tr></table></figure>


<ul>
<li>由于在SpringMVC应用中可以同时定义多个HandlerMapping，这就涉及到一个映射的优先级问题。HandlerMapping都实现了Ordered接口，所以我们可以通过HandlerMapping的order属性来指定匹配映射的先后顺序。我们知道在ViewResolver链中，如果一个逻辑视图被一个ViewResolver解析了之后，该次视图解析就结束了，其他的视图解析器就不能再解析这个视图了，它的order属性是用来定义ViewResolver进行视图解析的先后顺序的。但是HandlerMapping不一样，它是在SpringMVC的配置文件中定义的所有的HandlerMapping都可以进行URL映射，它的order属性是用于指定映射匹配的先后顺序的。看一个例子：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping"</span>&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"order"</span> <span class="attribute">value</span>=<span class="value">"1"</span>/&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="title">bean</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping"</span>&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"order"</span> <span class="attribute">value</span>=<span class="value">"10"</span>/&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="title">bean</span>&gt;</span></div></pre></td></tr></table></figure>



<p>我们在SpringMVC的配置文件里面定义了两个HandlerMapping，代码如上所示，由它们的order属性我们知道ControllerClassNameHandlerMapping会先于DefaultAnnotationHandlerMapping进行映射匹配。定义了一个MyTestController，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTestController</span> </span>{  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"mytest/test"</span>)  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span>() {  </div><div class="line">       System.out.println(<span class="string">"--------hello test---------"</span>);  </div><div class="line">    }  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"test"</span>)  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span>() {  </div><div class="line">       System.out.println(<span class="string">"--------hello test2---------"</span>);  </div><div class="line">    }  </div><div class="line">}</div></pre></td></tr></table></figure>

<p>我们知道<code>ControllerClassNameHandlerMapping</code>会把<code>MyTestController</code>映射为<code>“/mytest/*”</code>,按照这种方式我们只能利用<code>/mytest/test.do</code>请求到MyTestController的test2方法,而没法利用<code>/mytest/mytest/test.do</code>请求到test方法。</p>
<p>而<code>DefaultAnnotationHandlerMapping</code>会把<code>MyTestController</code>的test2方法映射为<code>“/test.do”</code>,把test方法映射为“/mytest/test.do”。而根据Spring定义了多个HandlerMapping就会有多个映射机制存在的这么一个机制我们知道上述几种映射关系都是会存在的。那么这个时候如果我请求/mytest/test.do会请求哪个方法呢?</p>
<p>我们知道,如果是按照<code>ControllerClassNameHandlerMapping</code>的映射机制会访问MyTestController的test2方法,而按照<code>DefaultAnnotationHandlerMapping</code>的映射机制就会访问MyTestController的test方法;这个时候HandlerMapping的order属性就起作用了,order属性越小的就会先匹配,由上面的配置我们知道<code>ControllerClassNameHandlerMapping</code>的order属性相对较小,所以将使用它的映射URL来匹配这次请求,所以处理的是MyTestController的test2方法。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2010-12-05T09:10:34.000Z"><a href="/2010/12/05/rizhi/">12月 5 2010</a></time>
      
      
  
    <h1 class="title"><a href="/2010/12/05/rizhi/">琐忆</a></h1>
  

    </header>
    <div class="entry">
      
        <center><br>    年年如是，<br>    年年不同，<br>    依稀往事，<br>    如梦如风。<br></center>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2010-10-15T13:21:13.000Z"><a href="/2010/10/15/thread-executor/">10月 15 2010</a></time>
      
      
  
    <h1 class="title"><a href="/2010/10/15/thread-executor/">Java并发执行任务Executor(ExecutorService和Future)</a></h1>
  

    </header>
    <div class="entry">
      
        <p>为了方便并发执行任务,出现了一种专门用来执行任务的实现,也就是Executor。 由此,任务提交者不需要再创建管理线程,使用更方便,也减少了开销。</p>
<h3 id="Executor_任务的提交者和执行者">Executor 任务的提交者和执行者</h3>
<pre><code>       Task Submitter <span class="command">\
</span>                        <span class="command">\ </span>               ExecutorService
                          <span class="command">\ </span>                                             Executor Thread
                            <span class="command">\+</span>------+------+------+------+------+        
       Task Submitter -------+ Task + Task + Task + Task + Task +        Executor Thread
                             /+------+------+------+------+------+
                           /                                             Executor Thread
                         /
       Task Submitter  /
</code></pre><p>java.util.concurrent.Executors是Executor的工厂类,通过Executors可以创建你所需要的 Executor。</p>
<h3 id="Future_任务的提交者和执行者之间的通讯手段">Future 任务的提交者和执行者之间的通讯手段</h3>
<pre><code><span class="code">+--------------+</span>-------------+
<span class="header">|            Future&lt;T&gt;       |
+--------------+-------------+</span>
<span class="code">+--------------+</span>-------------+
| cancel(boolean) : boolean  |
| isCancelled() : boolean    |
| isDone() : boolean         |
| get() : T                  |
<span class="header">| get(long, TimeUnit) : T    |
+--------------+-------------+</span>
</code></pre><p>Task Submitter把任务提交给Executor执行,他们之间需要一种通 讯手段,这种手段的具体实现,通常叫做Future。Future通常包括 get(阻塞至任务完成), cancel,get(timeout)(等待一段时间) 等等。Future也用于异步变同步的场景。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ExecutorService executor = Executors.newSingleThreadExecutor();</div><div class="line">Callable&lt;Object&gt; task = <span class="keyword">new</span> Callable&lt;Object&gt;() { </div><div class="line">	<span class="keyword">public</span> Object <span class="title">call</span>() <span class="keyword">throws</span> Exception {</div><div class="line">		Object result = <span class="string">"..."</span>;</div><div class="line">		<span class="keyword">return</span> result; </div><div class="line">	}</div><div class="line">};</div><div class="line">Future&lt;Object&gt; future = executor.submit(task); </div><div class="line">future.get(); <span class="comment">// 等待至完成</span></div></pre></td></tr></table></figure>

<p>有两种任务:</p>
<ul>
<li>Runnable</li>
<li>Callable Callable是需要返回值的任务</li>
</ul>
<p>Task Submitter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Future&lt;Object&gt; future = executor.submit(task);</div><div class="line"><span class="comment">// 等待到任务被执行完毕返回结果</span></div><div class="line"><span class="comment">// 如果任务执行出错,这里会抛ExecutionException </span></div><div class="line">future.get();</div><div class="line"><span class="comment">//等待3秒,超时后会抛TimeoutException </span></div><div class="line">future.get(<span class="number">3</span>, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>

<p>Task Executor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Callable&lt;Object&gt; task = <span class="keyword">new</span> Callable&lt;Object&gt;() { </div><div class="line">	<span class="keyword">public</span> Object <span class="title">call</span>() <span class="keyword">throws</span> Exception {</div><div class="line">		Object result = <span class="string">"..."</span>;</div><div class="line">		<span class="keyword">return</span> result; </div><div class="line">	}</div><div class="line">};</div></pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>








<ul class="page-direction" id="page-direction">
    <li><a class="page-prev icon-chevron-sign-left" href="javascript:;" title="上一页"></a></li>
    <li><a class="page-next icon-chevron-sign-right" href="javascript:;" title="下一页"></a></li>
</ul>

    <nav id="page-list" class="page-list"><a class="extend prev" rel="prev" href="/page/6/">Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/8/">Next</a></nav>

<nav id="pagination">
  
    <a href="/page/6/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/8/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="text" name="q" results="0" placeholder="搜一下">
    <i class="icon-search"></i>
    <input type="hidden" name="q" value="site:lawrence-zxc.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/Git/">Git</a><small>2</small></li>
  
    <li><a href="/tags/Java/">Java</a><small>29</small></li>
  
    <li><a href="/tags/JavaScript/">JavaScript</a><small>4</small></li>
  
    <li><a href="/tags/LeetCode/">LeetCode</a><small>2</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>21</small></li>
  
    <li><a href="/tags/Mac-Unix/">Mac/Unix</a><small>1</small></li>
  
    <li><a href="/tags/Maven/">Maven</a><small>2</small></li>
  
    <li><a href="/tags/Mysql/">Mysql</a><small>2</small></li>
  
    <li><a href="/tags/Nginx/">Nginx</a><small>5</small></li>
  
    <li><a href="/tags/Oracle/">Oracle</a><small>4</small></li>
  
    <li><a href="/tags/Python/">Python</a><small>3</small></li>
  
    <li><a href="/tags/XMPP/">XMPP</a><small>2</small></li>
  
    <li><a href="/tags/其他/">其他</a><small>0</small></li>
  
    <li><a href="/tags/开始/">开始</a><small>3</small></li>
  
    <li><a href="/tags/技术/">技术</a><small>1</small></li>
  
    <li><a href="/tags/旅行/">旅行</a><small>1</small></li>
  
    <li><a href="/tags/架构/">架构</a><small>3</small></li>
  
    <li><a href="/tags/生活/">生活</a><small>1</small></li>
  
    <li><a href="/tags/读书/">读书</a><small>0</small></li>
  
    <li><a href="/tags/随感/">随感</a><small>7</small></li>
  
  </ul>
</div>


  <div class="trace-invest">
    <span>
        <a href="https://github.com/Lawrence-zxc" target="_blank">欢迎光临我的技术Blog网站 </br>Fork me on Github</a>
    </span>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/05/03/lock/">Java自旋锁、排队自旋锁、MCS锁、CLH锁</a>
      </li>
    
      <li>
        <a href="/2015/04/29/java-enum/">java枚举Enum的理解</a>
      </li>
    
      <li>
        <a href="/2015/04/04/jishu-hehuoren/">技术合伙人为什么喜欢谈钱胜过情怀？</a>
      </li>
    
      <li>
        <a href="/2015/04/01/reverse-o2o/">分享一个用户自发需求的反向O2O设想</a>
      </li>
    
      <li>
        <a href="/2015/03/08/shujiawang/">面向企业和个人O2O图书租赁服务设想</a>
      </li>
    
      <li>
        <a href="/2015/03/05/pingjiaapp/">关于电商商品评价评论独立第三方平台构想</a>
      </li>
    
      <li>
        <a href="/2015/01/23/suishoupai/">关于随手拍图片人脸识别APP需求的想法</a>
      </li>
    
      <li>
        <a href="/2014/11/25/xushen/">徐神的诗</a>
      </li>
    
      <li>
        <a href="/2014/11/20/openfire/">Openfire服务端错误解决</a>
      </li>
    
      <li>
        <a href="/2014/11/16/xmpp/">xmpp通信过程分析</a>
      </li>
    
      <li>
        <a href="/2014/11/10/oracle-index/">Oracle大批量高效地更新大数据表索引字段</a>
      </li>
    
      <li>
        <a href="/2014/11/10/oracle-partition/">Oracle Partition Common Usage</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2016 Jeck Zhang
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a5eb19e532c0b101d72226b1325e6a78";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</body>

</html>