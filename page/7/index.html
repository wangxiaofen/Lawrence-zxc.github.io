<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 7 页 | Jeck_Zhang</title>
  <meta name="author" content="Jeck Zhang">
  
  <meta name="description" content="zxc&#39;s blog | java | ruby | perl | linux">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Jeck_Zhang"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link type="image/x-icon" href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Jeck_Zhang" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45019001-1', 'topdna.org');
  ga('send', 'pageview');

</script>


</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Jeck_Zhang</a></h1>
  <h2><a href="/">Write the Code. Change the World.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="http://weibo.com/zxc337">weibo</a></li>
    
      <li><a href="/2014/10/01/aboutMe/">关于</a></li>
    
      <li><a href="/tags/随感/">随感</a></li>
    
      <li><a href="/tags/技术/">技术</a></li>
    
      <li><a href="/tags/理财/">理财</a></li>
    
      <li><a href="/tags/生活/">生活</a></li>
    
      <li><a href="/archives">归档</a></li>
    
    <li><a href="/atom.xml">RSS</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-03-19T15:01:00.000Z"><a href="/2011/03/19/thread-lock/">3月 19 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/03/19/thread-lock/">并发锁机制和Lock-Free算法</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="原子类型">原子类型</h3>
<p>这是由硬件提供原子操作指令实现的。在非激烈竞争的情况下,开销更小,速度更快。<br>java.util.concurrent中实现的原子操作类包括: <code>AtomicBoolean</code>、<code>AtomicInteger</code>、<code>AtomicLong</code>、<code>AtomicReference</code></p>
<p>不使用AtomicInteger</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">	<span class="comment">//若要线程安全执行执行count++,需要加锁</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment</span>() { </div><div class="line">		count++;</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span>() {</div><div class="line">		<span class="keyword">return</span> count;</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用AtomicInteger</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span>() { </div><div class="line">		<span class="comment">//￼使用AtomicInteger之后,不需要加锁,也可以实现线程安全</span></div><div class="line">		count.incrementAndGet();</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span>() {</div><div class="line">		<span class="keyword">return</span> count.get();</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="非阻塞型同步(Non-blocking_Synchronization)">非阻塞型同步(Non-blocking Synchronization)</h3>
<p>如何正确有效的保护共享数据是编写并行程序必须面临的一个难题,通常的手段就是同步;同步可分为阻塞型同步(Blocking Synchronization)和非阻塞型同步( Non-blocking Synchronization).</p>
<p>阻塞型同步是指当一个线程到达临界区时,因另外一个线程已经持有访问该共享数据的锁, 从而不能获取锁资源而阻塞,直到另外一个线程释放锁。常见的同步原语有 mutex、 semaphore 等。如果同步方案采用不当,就会造成死锁(deadlock),活锁(livelock)和 优先级反转(priority inversion),以及效率低下等现象。</p>
<p><img src="/img/threadLock.jpg"></p>
<p>为了降低风险程度和提高程序运行效率,业界提出了不采用锁的同步方案,依照这种设计思路设计的算法称为非阻塞型算法,其本质特征就是停止一个线程的执行不会阻碍系统中其他执行实体的运行。<br>当今比较流行的 Non-blocking Synchronization 实现方案有三种: </p>
<ul>
<li><p>Wait-free<br>Wait-free是指任意线程的任何操作都可以在有限步之内结束,而不用关心其它线程的执行速度。Wait-free是基于 per-thread 的,可以认为是 starvation-free 的。非常遗憾的是实际情况并非如此,采用 Wait-free 的程序并不能保证 starvation-free,同时内存消耗也随线程数量而线性增长。目前只有极少数的非阻塞算法实现了这一点。</p>
</li>
<li><p>Lock-Free<br>Lock-Free是指能够确保执行它的所有线程中至少有一个能够继续往下执行。由于每个线程不是 starvation-free 的,即有些线程可能会被任意地延迟,然而在每一步都至少有一 个线程能够往下执行,因此系统作为一个整体是在持续执行的,可以认为是 system-wide 的。所有 Wait-free 的算法都是 Lock-Free 的。</p>
</li>
<li><p>Obstruction-free<br>Obstruction-free是指在任何时间点,一个孤立运行线程的每一个操作可以在有限步之内结束。只要没有竞争,线程就可以持续运行。一旦共享数据被修改,Obstruction-free 要 求中止已经完成的部分操作,并进行回滚。 所有 Lock-Free 的算法都是 Obstruction-free 的。</p>
</li>
</ul>
<h3 id="使用Lock-Free算法">使用Lock-Free算法</h3>
<p>不使用Lock-Free算法示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> max = <span class="number">0</span>;</div><div class="line">	<span class="comment">//若要线程安全,需要加锁</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">set</span>(<span class="keyword">int</span> value) { </div><div class="line">		<span class="keyword">if</span> (value &gt; max) {</div><div class="line">			max = value; </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMax</span>() {</div><div class="line">		<span class="keyword">return</span> max;</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用Lock-Free算法代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> AtomicInteger max = <span class="keyword">new</span> AtomicInteger();</div><div class="line">	<span class="comment">//LockFree算法,不需要加锁。</span></div><div class="line">	<span class="comment">//通常都是三个部分组成: 1.循环 2.CAS (CompareAndSet) 3.回退</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span>(<span class="keyword">int</span> value) { </div><div class="line">		<span class="comment">//第一步循环</span></div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			<span class="keyword">int</span> current = max.get(); </div><div class="line">			<span class="keyword">if</span> (value &gt; current) {</div><div class="line">				<span class="comment">//第二步CAS</span></div><div class="line">				<span class="keyword">if</span> (max.compareAndSet(current, value)) { </div><div class="line">					<span class="comment">//第三步回退</span></div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				} <span class="keyword">else</span> {</div><div class="line">					<span class="keyword">continue</span>;</div><div class="line">				}</div><div class="line">			} <span class="keyword">else</span> { </div><div class="line">				<span class="keyword">break</span>; </div><div class="line">			}</div><div class="line">	￼￼	} </div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMax</span>() {</div><div class="line">		<span class="keyword">return</span> max.get();</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>同样地实现,把for(;;)改成do…while循环</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">class Counter {</div><div class="line">	<span class="keyword">private</span> AtomicInteger max = <span class="keyword">new</span> AtomicInteger();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span>(<span class="keyword">int</span> value) { </div><div class="line">		<span class="keyword">int</span> current;</div><div class="line">		do {</div><div class="line">			current = max.get();</div><div class="line">			<span class="keyword">if</span> (value &lt;= current) { </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			}</div><div class="line">		} <span class="keyword">while</span> (!max.compareAndSet(current, value));</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMax</span>() { </div><div class="line">		<span class="keyword">return</span> max.get();</div><div class="line">	} </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="使用Lock-Free数据结构">使用Lock-Free数据结构</h3>
<p>使用HashMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">class BeanManager {</div><div class="line">	<span class="keyword">private</span> Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">getBean</span>(String key) { </div><div class="line">		<span class="keyword">synchronized</span> (map) {</div><div class="line">			Object bean = map.get(key); </div><div class="line">			<span class="keyword">if</span> (bean == <span class="keyword">null</span>) {</div><div class="line">				map.put(key, createBean());</div><div class="line">				bean = map.get(key); </div><div class="line">			}</div><div class="line">			<span class="keyword">return</span> bean; </div><div class="line">		} </div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用ConcurrentHashMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class BeanManager {</div><div class="line">	<span class="keyword">private</span> ConcurrentMap&lt;String, Object&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">getBean</span>(String key) { </div><div class="line">		Object bean = map.get(key);</div><div class="line">		<span class="keyword">if</span> (bean == <span class="keyword">null</span>) {</div><div class="line">			<span class="comment">//使用ConcurrentMap,避免直接使用锁,锁由数据结构来管理。</span></div><div class="line">			map.putIfAbsent(key, createBean()); </div><div class="line">			bean = map.get(key);</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> bean; </div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ConcurrentHashMap并没有实现Lock-Free,只是使用了分离锁的办法使得能够支持多个Writer并发。 ConcurrentHashMap需要使用更多的内存。</p>
<h3 id="同样的思路用于更新数据库">同样的思路用于更新数据库</h3>
<p>乐观锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SequenceDao</span> <span class="keyword">extends</span> <span class="title">SqlMapClientDaoSupport</span> </span>{</div><div class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span>(String name, <span class="keyword">int</span> value, <span class="keyword">int</span> expect) {</div><div class="line">		Map&lt;String, Object&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(); parameters.put(<span class="string">"name"</span>, name);</div><div class="line">		parameters.put(<span class="string">"value"</span>, value);</div><div class="line">		parameters.put(<span class="string">"expect"</span>, expect);</div><div class="line">		<span class="comment">// UPDATE t_sequence SET value = #value# WHERE name = #name# AND value = #expect#</span></div><div class="line">		<span class="keyword">int</span> updateCount = getSqlMapClientTemplate().update(<span class="string">"Sequence.compareAndSet"</span>, parameters); <span class="comment">//通过UpdateCount来实现 CompareAndSet</span></div><div class="line">		<span class="keyword">return</span> updateCount == <span class="number">1</span>;</div><div class="line">	}</div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SequenceService</span> </span>{</div><div class="line">	<span class="annotation">@Transactional</span>(propagation = Propagation.NOT_SUPPORTED) </div><div class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment</span>(String sequenceName) {</div><div class="line">		<span class="comment">//三个部分:1.循环 2.CAS (CompareAndSet) 3.回退</span></div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			<span class="keyword">int</span> value = dao.getValue(sequenceName);</div><div class="line">			<span class="keyword">if</span> (dao.compareAndSet(sequenceName, value + <span class="number">1</span>, value)) {</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>注意,乐观锁时必须使用:@Transactional(propagation = Propagation.NOT_SUPPORTED)</p>
<p>对比,使用悲观锁版本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SequenceDao</span> <span class="keyword">extends</span> <span class="title">SqlMapClientDaoSupport</span> </span>{ </div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValueForUpdate</span>(String name) {</div><div class="line">		<span class="comment">// SELECT value FROM t_sequence WHERE name = #name# FOR UPDATE</span></div><div class="line">		<span class="keyword">return</span> (Integer) getSqlMapClientTemplate().queryForObject(<span class="string">"Sequence.getValueForUpdate"</span>, name); </div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span>(String name, <span class="keyword">int</span> value) {</div><div class="line">		Map&lt;String, Object&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(); parameters.put(<span class="string">"name"</span>, name);</div><div class="line">		parameters.put(<span class="string">"value"</span>, value);</div><div class="line">		<span class="comment">// UPDATE t_sequence SET value = #value# WHERE name = #name#</span></div><div class="line">		getSqlMapClientTemplate().update(<span class="string">"Sequence.set"</span>, parameters); </div><div class="line">	}</div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SequenceService</span> </span>{</div><div class="line">	<span class="annotation">@Transactional</span>(propagation = Propagation.REQUIRED) </div><div class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment2</span>(String sequenceName) {</div><div class="line">		<span class="comment">//￼读取时,就开始加锁</span></div><div class="line">		<span class="keyword">int</span> value = dao.getValueForUpdate(sequenceName);</div><div class="line">		dao.set(sequenceName, value + <span class="number">1</span>); </div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Lock-Free算法,可以说是乐观锁,如果非激烈竞争的时候,不需要使用锁,从而开销更小,速度更快。</p>
<h3 id="使用CopyOnWriteArrayList">使用CopyOnWriteArrayList</h3>
<p>COW(CopyOnWrite)是一种很古老的技术,类似的并发数据结构有:<code>ConcurrentSkipListMap</code>,<code>ConcurrentSkipListSet</code>,<code>CopyOnWriteArrayList</code>,<code>CopyOnWriteArraySet</code></p>
<p>不使用COW,使用ArrayList示例代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">class Engine {</div><div class="line">	<span class="keyword">private</span> List&lt;Listener&gt; listeners = <span class="keyword">new</span> ArrayList&lt;Listener&gt;();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addListener</span>(Listener listener) { </div><div class="line">		<span class="keyword">synchronized</span> (listeners) {</div><div class="line">			<span class="keyword">return</span> listeners.add(listener); </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doXXX</span>() { </div><div class="line">		<span class="keyword">synchronized</span> (listeners) {</div><div class="line">		<span class="keyword">for</span> (Listener listener : listeners) { </div><div class="line">			listener.handle();	</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用CopyOnWriteArrayList</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class Engine {</div><div class="line">	<span class="keyword">private</span> List&lt;Listener&gt; listeners = <span class="keyword">new</span> CopyOnWriteArrayList &lt;Listener&gt;();</div><div class="line">	<span class="comment">//￼适当使用CopyOnWriteArrayList,能够提高读操作效率</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addListener</span>(Listener listener) { </div><div class="line">		<span class="keyword">return</span> listeners.add(listener);</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doXXX</span>() {</div><div class="line">		<span class="keyword">for</span> (Listener listener : listeners) {</div><div class="line">			listeners.handle();</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="锁的使用">锁的使用</h3>
<ul>
<li><p>使用支持CAS的数据结构,避免使用锁,如: AtomicXXX、ConcurrentMap、CopyOnWriteList、ConcurrentLinkedQueue</p>
</li>
<li><p>一定要使用锁的时候,注意获得锁的顺序,相反顺序获得锁,就容易产生死锁。</p>
</li>
<li><p>死锁经常是无法完全避免的,鸵鸟策略被很多基础框架所采用。</p>
</li>
<li><p>通过Dump线程的StackTrace,例如linux下执行命令 <code>kill -3 &lt;pid&gt;</code>,或者<code>jstack –l &lt;pid&gt;</code>,或 者使用<code>Jconsole</code>连接上去查看线程的<code>StackTrace</code>,由此来诊断死锁问题。</p>
</li>
<li><p>外部锁常被忽视而导致死锁,例如数据库的锁</p>
</li>
<li><p>存在检测死锁的办法</p>
</li>
<li><p>存在一些预防死锁的手段,比如Lock的tryLock,JDK 7中引入的<code>Phaser</code>等。</p>
</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-03-14T13:45:57.000Z"><a href="/2011/03/14/thread-blocking/">3月 14 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/03/14/thread-blocking/">Java并发阻塞队列(put和take、offer和poll、drainTo)的使用</a></h1>
  

    </header>
    <div class="entry">
      
        <p>阻塞队列,是一种常用的并发数据结构,常用于生产者-消费者模式。 </p>
<h3 id="阻塞队列基础概念">阻塞队列基础概念</h3>
<p>在Java中,有很多种阻塞队列:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ArrayBlockingQueue  	<span class="comment">//最常用</span></div><div class="line">LinkedBlockingQueue  	<span class="comment">//不会满的</span></div><div class="line">SynchronousQueue    	<span class="comment">//size为0</span></div><div class="line">PriorityBlockingQueue</div><div class="line">CompletionService 		<span class="comment">//BlockingQueue + Executor</span></div><div class="line">TransferQueue 			<span class="comment">//JDK 7中更快的SynchronousQueue</span></div></pre></td></tr></table></figure>

<p>生产者消费者模型</p>
<pre><code>        producer    <span class="comment">------------------------&gt;    consumer</span>
                    +<span class="comment">----+----+----+----+----+</span>
                    +    +      +    +    +    +
                    +<span class="comment">----+----+----+----+----+</span>
                  /                            \ <span class="keyword">for</span> (;;) {
   <span class="comment"> // 如果队列满则阻塞                                blockingQ.take(); // 如果队列空则阻塞</span>
    blockingQ.<span class="built_in">put</span>(object);                        }
</code></pre><h3 id="使用阻塞队列">使用阻塞队列</h3>
<pre><code><span class="code">        +--------------+-------------+</span>
<span class="code">        |          Queue&lt;T&gt;          |</span>
<span class="code">        +--------------+-------------+</span>
<span class="code">        +--------------+-------------+</span>
<span class="code">        | add(E) : boolean           |</span>
<span class="code">        | remove() : E               |</span>
<span class="code">        | offer() : boolean          |</span>
<span class="code">        | poll() : E                 | </span>
<span class="code">        | element() : E              |</span>
<span class="code">        | peek() : E                 |</span>
<span class="code">        +--------------+-------------+</span>
<span class="code">                       ^</span>
<span class="code">                      /|\</span>
<span class="code">                继承自  |     </span>
<span class="header">                       |
+----------------------+---------------------+</span>
<span class="header">|             BlockingQueue&lt;T&gt;               |
+----------------------+---------------------+</span>
<span class="code">+----------------------+</span>---------------------+
| put(E)                                     |
| take() : E                                 |
| offer(E, long, TimeUnit) : boolean         |
| poll(long, TimeUnit) : E                   |
| remainingCapacity()                        |
| drainTo(Collection&lt;? super E&gt;) : int       |
<span class="header">| drainTo(Collection&lt;? super E&gt;, int ) : int |
+----------------------+---------------------+</span>
</code></pre><p>BlockingQueue使用注意:</p>
<ul>
<li>使用BlockingQueue的时候,尽量不要使用从Queue继承下来的方法,否则就失去了Blocking的特性了。</li>
<li>在BlockingQueue中,要使用put和take,而非offer和poll。如果 要使用offer和poll,也是要使用带等待时间参数的offer和poll。</li>
<li>使用drainTo批量获得其中的内容,能够减少锁的次数。</li>
</ul>
<p>代码片段一(错误)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> BlockingQueue&lt;Object&gt; blockingQ = <span class="keyword">new</span> ArrayBlockingQueue&lt;Object&gt;(<span class="number">10</span>); </div><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="string">"consumer thread"</span>) {</div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() { </div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			Object object = blockingQ.poll();<span class="comment">//错误,不等待就会直接返回</span></div><div class="line">			handle(object);</div><div class="line">		} </div><div class="line">	}</div><div class="line">};</div></pre></td></tr></table></figure>

<p>代码片段二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> BlockingQueue&lt;Object&gt; blockingQ = <span class="keyword">new</span> ArrayBlockingQueue&lt;Object&gt;(<span class="number">10</span>); </div><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="string">"consumer thread"</span>) {</div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() { </div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			<span class="keyword">try</span> {</div><div class="line">				<span class="comment">//注意此处</span></div><div class="line">				Object object = blockingQ.take(); <span class="comment">// 等到有数据才继续 </span></div><div class="line">				handle(object);</div><div class="line">			} <span class="keyword">catch</span> (InterruptedException e) { </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			} <span class="keyword">catch</span> (Exception e) {</div><div class="line">				<span class="comment">// handle exception</span></div><div class="line">			} </div><div class="line">		}</div><div class="line">	}</div><div class="line">};</div></pre></td></tr></table></figure>

<p>代码片段三</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> BlockingQueue&lt;Object&gt; blockingQ = <span class="keyword">new</span> ArrayBlockingQueue&lt;Object&gt;(<span class="number">10</span>); </div><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="string">"consumer thread"</span>) {</div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() { </div><div class="line">		<span class="keyword">for</span> (;;) {</div><div class="line">			<span class="keyword">try</span> {</div><div class="line">				<span class="comment">//注意此处</span></div><div class="line">				Object object = blockingQ.poll(<span class="number">1</span>, TimeUnit.SECONDS); <span class="comment">//防止死等 </span></div><div class="line">				<span class="keyword">if</span> (object == <span class="keyword">null</span>) {</div><div class="line">					<span class="keyword">continue</span>; <span class="comment">//或者做其他处理 </span></div><div class="line">				}</div><div class="line">			} <span class="keyword">catch</span> (InterruptedException e) { </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			} <span class="keyword">catch</span> (Exception e) {</div><div class="line">				<span class="comment">// handle exception</span></div><div class="line">			} </div><div class="line">		}</div><div class="line">	}</div><div class="line">};</div></pre></td></tr></table></figure>

<h3 id="实现一个简单的阻塞队列">实现一个简单的阻塞队列</h3>
<p>未取得锁就直接执行wait、notfiy、notifyAll会抛异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">class BlockingQ {</div><div class="line">	<span class="keyword">private</span> Object notEmpty = <span class="keyword">new</span> Object();</div><div class="line">	<span class="keyword">private</span> Queue&lt;Object&gt; linkedList = <span class="keyword">new</span> LinkedList&lt;Object&gt;();</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">take</span>() <span class="keyword">throws</span> InterruptedException { </div><div class="line">		<span class="keyword">synchronized</span> (notEmpty) {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				<span class="comment">//要执行wait操作,必须先取得该对象的锁</span></div><div class="line">				<span class="comment">//执行wait操作之后,锁会释放</span></div><div class="line">				<span class="comment">//被唤醒之前,需要先获得锁</span></div><div class="line">				notEmpty.wait();</div><div class="line">			}</div><div class="line">			<span class="keyword">return</span> linkedList.poll(); </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span>(Object object) { </div><div class="line">		<span class="keyword">synchronized</span> (notEmpty) {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				<span class="comment">//要执行notify和notifyAll操作,都必须先取得该对象的锁</span></div><div class="line">				notEmpty.notifyAll();</div><div class="line">			}</div><div class="line">			linkedList.add(object); </div><div class="line">		} </div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">class BlockingQ {</div><div class="line">	<span class="keyword">private</span> Object notEmpty = <span class="keyword">new</span> Object();</div><div class="line">	<span class="keyword">private</span> Object notFull = <span class="keyword">new</span> Object();</div><div class="line">	<span class="keyword">private</span> Queue&lt;Object&gt; linkedList = <span class="keyword">new</span> LinkedList&lt;Object&gt;(); </div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxLength = <span class="number">10</span>;</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">take</span>() <span class="keyword">throws</span> InterruptedException { </div><div class="line">		<span class="comment">//分别需要对notEmpty和notFull加锁</span></div><div class="line">		<span class="keyword">synchronized</span> (notEmpty) {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				notEmpty.wait();</div><div class="line">			}</div><div class="line">			<span class="comment">//分别需要对notEmpty和notFull加锁</span></div><div class="line">			<span class="keyword">synchronized</span> (notFull) {</div><div class="line">				<span class="keyword">if</span> (linkedList.size() == maxLength) { </div><div class="line">					notFull.notifyAll();</div><div class="line">				}</div><div class="line">			<span class="keyword">return</span> linkedList.poll(); </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span>(Object object) <span class="keyword">throws</span> InterruptedException { </div><div class="line">		<span class="comment">//分别需要对notEmpty和notFull加锁</span></div><div class="line">		<span class="keyword">synchronized</span> (notEmpty) {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				notEmpty.notifyAll();</div><div class="line">			}</div><div class="line">			<span class="comment">//分别需要对notEmpty和notFull加锁</span></div><div class="line">			<span class="keyword">synchronized</span> (notFull) {</div><div class="line">				<span class="keyword">if</span> (linkedList.size() == maxLength) { </div><div class="line">					notFull.wait();</div><div class="line">				}</div><div class="line">				linkedList.add(object); </div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">class BlockingQ {</div><div class="line">	<span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">	<span class="comment">// 一个锁可以创建多个Condition</span></div><div class="line">	<span class="keyword">private</span> Condition notEmpty = lock.newCondition();</div><div class="line">	<span class="keyword">private</span> Condition notFull = lock.newCondition();</div><div class="line">	<span class="keyword">private</span> Queue&lt;Object&gt; linkedList = <span class="keyword">new</span> LinkedList&lt;Object&gt;(); </div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxLength = <span class="number">10</span>;</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> Object <span class="title">take</span>() <span class="keyword">throws</span> InterruptedException {</div><div class="line">		lock.lock(); </div><div class="line">		<span class="keyword">try</span> {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				<span class="comment">// 要执行await操作,必须先取得该Condition的锁。 </span></div><div class="line">				<span class="comment">// 执行await操作之后,锁会释放。 </span></div><div class="line">				<span class="comment">// 被唤醒之前,需要先获得锁。</span></div><div class="line">				notEmpty.await();</div><div class="line">			}</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == maxLength) {</div><div class="line">				notFull.signalAll(); </div><div class="line">			}</div><div class="line">			<span class="keyword">return</span> linkedList.poll(); </div><div class="line">		} <span class="keyword">finally</span> {</div><div class="line">			lock.unlock(); </div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span>(Object object) <span class="keyword">throws</span> InterruptedException {</div><div class="line">		lock.lock(); </div><div class="line">		<span class="keyword">try</span> {</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == <span class="number">0</span>) { </div><div class="line">				<span class="comment">//￼要执行signal和signalAll操作,都必须先取 得该对象</span></div><div class="line">				notEmpty.signalAll();</div><div class="line">			}</div><div class="line">			<span class="keyword">if</span> (linkedList.size() == maxLength) {</div><div class="line">				notFull.await(); </div><div class="line">			}</div><div class="line">			linkedList.add(object); </div><div class="line">		} <span class="keyword">finally</span> {</div><div class="line">			lock.unlock(); </div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>注意:未锁就直接执行await、signal、siganlAll会抛异常</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-02-12T07:49:30.000Z"><a href="/2011/02/12/git-pro/">2月 12 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/02/12/git-pro/">Git配置和常用命令</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Git是一个分布式版本控制／软件配置管理软件，原来是linux内核开发者林纳斯·托瓦兹（Linus Torvalds）为了更好地管理linux内核开发而创立的。</p>
<h3 id="Git配置">Git配置</h3>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">git config --<span class="keyword">global</span> user.name <span class="string">"Lawrence-zxc"</span></div><div class="line">git config --<span class="keyword">global</span> user.email <span class="string">"zhangxiongcai337@gmail.com"</span></div><div class="line">git config --<span class="keyword">global</span> color.ui <span class="literal">true</span></div><div class="line">git config --<span class="keyword">global</span> <span class="keyword">alias</span>.co checkout</div><div class="line">git config --<span class="keyword">global</span> <span class="keyword">alias</span>.ci commit</div><div class="line">git config --<span class="keyword">global</span> <span class="keyword">alias</span>.st status</div><div class="line">git config --<span class="keyword">global</span> <span class="keyword">alias</span>.br branch</div><div class="line">git config -l  <span class="preprocessor"># 列举所有配置</span></div></pre></td></tr></table></figure>

<p>用户的git配置文件在<code>~/.gitconfig</code>，我的配置：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">  /Users/zxc/workspace/blog  ❤  cat ~/.gitconfig </div><div class="line">[user]</div><div class="line">    <span class="variable">email =</span> zhangxiongcai337@gmail.com</div><div class="line">    <span class="variable">name =</span> Lawrence-zxc</div><div class="line">[color]</div><div class="line">    <span class="variable">ui =</span> auto</div><div class="line">[color <span class="string">"branch"</span>]</div><div class="line">    <span class="variable">current =</span> yellow reverse</div><div class="line">    <span class="variable">local =</span> yellow</div><div class="line">    <span class="variable">remote =</span> green</div><div class="line">[color <span class="string">"diff"</span>]</div><div class="line">    <span class="variable">meta =</span> yellow bold</div><div class="line">    <span class="variable">frag =</span> magenta bold</div><div class="line">    <span class="variable">old =</span> red bold</div><div class="line">    <span class="variable">new =</span> green bold</div><div class="line">[color <span class="string">"status"</span>]</div><div class="line">    <span class="variable">added =</span> yellow</div><div class="line">    <span class="variable">changed =</span> green</div><div class="line">    <span class="variable">untracked =</span> cyan</div><div class="line">[alias]</div><div class="line">    <span class="variable">st =</span> <span class="string">"status"</span></div><div class="line">    <span class="variable">co =</span> checkout</div><div class="line">    <span class="variable">ls =</span> <span class="string">"ls-files"</span></div><div class="line">    <span class="variable">ci =</span> commit</div><div class="line">    <span class="variable">br =</span> branch</div><div class="line">    <span class="variable">rt =</span> reset --hard</div><div class="line">    <span class="variable">unstage =</span> reset HEAD</div><div class="line">    <span class="variable">uncommit =</span> reset --soft HEAD^</div><div class="line">    <span class="variable">l =</span> log <span class="variable">--pretty=</span>oneline --abbrev-commit --graph --decorate</div><div class="line">    <span class="variable">amend =</span> commit --amend </div><div class="line">    <span class="variable">who =</span> shortlog -n -s --no-merges </div><div class="line">    <span class="variable">g =</span> grep -n --color -E </div><div class="line">    <span class="variable">cp =</span> cherry-pick -x </div><div class="line">    <span class="variable">cb =</span> checkout -b </div><div class="line">[core]</div><div class="line">    <span class="variable">filemode =</span> <span class="constant">true</span></div></pre></td></tr></table></figure>

<h3 id="Git常用命令">Git常用命令</h3>
<p>查看、帮助命令</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git help &lt;command&gt;</span>  <span class="comment"># 显示command的help</span></span></div><div class="line">git show            <span class="comment"># 显示某次提交的内容</span></div><div class="line">git show <span class="variable">$id</span></div></pre></td></tr></table></figure>

<p>查看提交记录</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">git <span class="keyword">log</span></div><div class="line">git <span class="keyword">log</span> &lt;file&gt;      <span class="comment"># 查看该文件每次提交记录</span></div><div class="line">git <span class="keyword">log</span> -p &lt;file&gt;   <span class="comment"># 显示版本历史，以及版本间的内容差异</span></div><div class="line">git <span class="keyword">log</span> -p -<span class="number">2</span>       <span class="comment"># 查看最近两次详细修改内容的diff</span></div><div class="line">git <span class="keyword">log</span> --<span class="keyword">stat</span>      <span class="comment"># 查看提交统计信息</span></div><div class="line">git <span class="keyword">log</span> --since=<span class="string">"6 hours"</span>  <span class="comment"># 显示最近6小时提交</span></div><div class="line">git <span class="keyword">log</span> --before=<span class="string">"2 days"</span>  <span class="comment"># 显示2天前提交</span></div><div class="line">git <span class="keyword">log</span> -<span class="number">1</span> HEAD~<span class="number">3</span>          <span class="comment"># 显示比HEAD早3个提交的那个提交</span></div><div class="line">git <span class="keyword">log</span> -<span class="number">1</span> HEAD^^^</div><div class="line">git reflog                 <span class="comment"># 查看操作记录</span></div></pre></td></tr></table></figure>

<p>添加、提交、删除、找回，重置修改文件</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git co  -- &lt;file&gt;</span>   <span class="comment"># 抛弃工作区修改</span></span></div><div class="line"><span class="input"><span class="prompt">git co  .           # 抛弃工作区修改</span></span></div><div class="line">git co HEAD &lt;file&gt;  <span class="comment"># 抛弃工作目录区中文件的修改</span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git add &lt;file&gt;</span>      <span class="comment"># 将工作文件修改提交到本地暂存区</span></span></div><div class="line">git add .           <span class="comment"># 将所有修改过的工作文件提交暂存区</span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git rm &lt;file&gt;</span>       <span class="comment"># 从版本库中删除文件</span></span></div><div class="line"><span class="input"><span class="prompt">git rm &lt;file&gt;</span> --cached  <span class="comment"># 从版本库中删除文件，但不删除文件</span></span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git reset &lt;file&gt;</span>    <span class="comment"># 从暂存区恢复到工作文件</span></span></div><div class="line"><span class="input"><span class="prompt">git reset -- .      # 从暂存区恢复到工作文件</span></span></div><div class="line">git reset --hard  HEAD^ # 恢复最近一次提交过的状态，即放弃上次提交后的所有本次修改</div><div class="line">git reset --hard &lt;commit id&gt;  <span class="comment"># 恢复到某一次提交的状态</span></div><div class="line"><span class="input"><span class="prompt">git reset HEAD &lt;file&gt;</span> <span class="comment"># 抛弃暂存区中文件的修改</span></span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">git ci &lt;<span class="built_in">file</span>&gt;</div><div class="line">git ci .</div><div class="line">git ci -<span class="operator">a</span>           <span class="comment"># 将git add, git rm和git ci等操作都合并在一起做</span></div><div class="line">git ci -am <span class="string">"some comments"</span></div><div class="line">git ci <span class="comment">--amend      # 修改最后一次提交记录</span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git revert &lt;$id&gt;</span>    <span class="comment"># 恢复某次提交的状态，恢复动作本身也创建了一次提交对象</span></span></div><div class="line">git revert <span class="constant">HEAD</span>     <span class="comment"># 恢复最后一次提交的状态</span></div></pre></td></tr></table></figure>

<p>查看文件diff</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git diff &lt;file&gt;</span>     <span class="comment"># 比较当前文件和暂存区文件差异</span></span></div><div class="line"><span class="input"><span class="prompt">git diff</span></span></div><div class="line">git diff &lt;$id1&gt; &lt;<span class="variable">$id2</span>&gt;      <span class="comment"># 比较两次提交之间的差异</span></div><div class="line">git diff &lt;branch1&gt;..&lt;branch2&gt;   <span class="comment"># 在两个分支之间比较 </span></div><div class="line">git diff --staged   <span class="comment"># 比较暂存区和版本库差异</span></div><div class="line">git diff --cached   <span class="comment"># 比较暂存区和版本库差异</span></div><div class="line">git diff --stat     <span class="comment"># 仅仅比较统计信息</span></div></pre></td></tr></table></figure>

<h3 id="Git_本地分支管理">Git 本地分支管理</h3>
<p>查看、切换、创建和删除分支</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git br -r           # 查看远程分支</span></span></div><div class="line">git br -v           # 查看各个分支最后提交信息</div><div class="line">git br -a           # 列出所有分支</div><div class="line">git br --merged     # 查看已经被合并到当前分支的分支</div><div class="line">git br --no-merged  # 查看尚未被合并到当前分支的分支</div><div class="line">git br &lt;new_branch&gt; <span class="comment"># 基于当前分支创建新的分支</span></div><div class="line"><span class="input"><span class="prompt">git br &lt;new_branch&gt;</span>  &lt;start_point&gt;      <span class="comment"># 基于另一个起点（分支名称，提交名称或则标签名称），创建新的分支</span></span></div><div class="line"><span class="input"><span class="prompt">git br -f &lt;existing_branch&gt;</span>  &lt;start_point&gt;  <span class="comment"># 创建同名新分支，覆盖已有分支</span></span></div><div class="line"><span class="input"><span class="prompt">git br -d &lt;branch&gt;</span>  <span class="comment"># 删除某个分支</span></span></div><div class="line"><span class="input"><span class="prompt">git br -D &lt;branch&gt;</span>  <span class="comment"># 强制删除某个分支 (未被合并的分支被删除的时候需要强制)</span></span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git co &lt;branch&gt;</span>         <span class="comment"># 切换到某个分支</span></span></div><div class="line"><span class="input"><span class="prompt">git co -b &lt;new_branch&gt;</span>  <span class="comment"># 创建新的分支，并且切换过去</span></span></div><div class="line"><span class="input"><span class="prompt">git co -b &lt;new_branch&gt;</span> &lt;branch&gt;       <span class="comment"># 基于branch创建新的new_branch</span></span></div><div class="line"><span class="input"><span class="prompt">git co -m &lt;existing_branch&gt;</span> &lt;new_branch&gt;  <span class="comment"># 移动或重命名分支，当新分支不存在时</span></span></div><div class="line"><span class="input"><span class="prompt">git co -M &lt;existing_branch&gt;</span> &lt;new_branch&gt;  <span class="comment"># 移动或重命名分支，当新分支存在时就覆盖</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">git co $id               # 把某次历史提交记录checkout出来，但无分支信息，切换到其他分支会自动删除</div><div class="line">git co $id -b &lt;new_branch&gt;       <span class="comment"># 把某次历史提交记录checkout出来，创建成一个分支</span></div></pre></td></tr></table></figure>

<p>分支合并和rebase</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git merge &lt;branch&gt;</span>                  <span class="comment"># 将branch分支合并到当前分支</span></span></div><div class="line"><span class="input"><span class="prompt">git merge origin/master --no-ff     # 不要Fast-Foward合并，这样可以生成merge提交</span></span></div><div class="line">git merge --no-commit &lt;branch&gt;      <span class="comment"># 合并但不提交</span></div><div class="line"><span class="input"><span class="prompt">git merge --squash &lt;branch&gt;</span>         <span class="comment"># 把一条分支上的内容合并到另一个分支上的一个提交</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">git rebase master &lt;branch&gt;          <span class="comment"># 将master rebase到branch，相当于：</span></div><div class="line"><span class="input"><span class="prompt">git co &lt;branch&gt;</span> && git rebase master && git co master && git merge &lt;branch&gt;</span></div></pre></td></tr></table></figure>

<p>Git补丁管理</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git diff &gt; ../sync.<span class="keyword">patch</span>         <span class="preprocessor"># 生成补丁</span></div><div class="line">git apply ../sync.<span class="keyword">patch</span>          <span class="preprocessor"># 打补丁</span></div><div class="line">git apply --check ../sync.<span class="keyword">patch</span>  <span class="preprocessor"># 测试补丁能否成功</span></div><div class="line">git format-<span class="keyword">patch</span> -X              <span class="preprocessor"># 根据提交的log生成patch，X为数字，表示最近的几个日志</span></div></pre></td></tr></table></figure>

<p>Git暂存管理</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git stash                        <span class="comment"># 暂存</span></div><div class="line">git stash <span class="keyword">list</span>                   <span class="comment"># 列所有stash</span></div><div class="line">git stash apply                  <span class="comment"># 恢复暂存的内容</span></div><div class="line">git stash drop                   <span class="comment"># 删除暂存区</span></div></pre></td></tr></table></figure>

<p>Git远程分支管理</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">git pull                         <span class="comment"># 抓取远程仓库所有分支更新并合并到本地</span></div><div class="line">git pull --no-ff                 <span class="comment"># 抓取远程仓库所有分支更新并合并到本地，不要快进合并</span></div><div class="line">git fetch origin                 <span class="comment"># 抓取远程仓库所有更新</span></div><div class="line">git fetch origin remote-branch:local-branch <span class="comment">#抓取remote-branch分支的更新</span></div><div class="line">git fetch origin --tags          <span class="comment"># 抓取远程上的所有分支</span></div><div class="line">git checkout -b <span class="variable">&lt;new-branch&gt;</span> <span class="variable">&lt;remote_tag&gt;</span> <span class="comment"># 抓取远程上的分支</span></div><div class="line">git merge origin/master          <span class="comment"># 将远程主分支合并到本地当前分支</span></div><div class="line">git co --track origin/branch     <span class="comment"># 跟踪某个远程分支创建相应的本地分支</span></div><div class="line">git co -b <span class="variable">&lt;local_branch&gt;</span> origin/<span class="variable">&lt;remote_branch&gt;</span>  <span class="comment"># 基于远程分支创建本地分支，功能同上</span></div></pre></td></tr></table></figure>



<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">git push                         # push所有分支</span></span></div><div class="line">git push origin master           # 将本地主分支推到远程主分支</div><div class="line">git push -u origin master        # 将本地主分支推到远程(如无远程主分支则创建，用于初始化远程仓库)</div><div class="line">git push origin &lt;local_branch&gt;   <span class="comment"># 创建远程分支， origin是远程仓库名</span></div><div class="line">git push origin &lt;local_branch&gt;<span class="symbol">:&lt;remote_branch&gt;</span>  <span class="comment"># 创建远程分支</span></div><div class="line"><span class="input"><span class="prompt">git push origin :&lt;remote_branch&gt;</span>  <span class="comment">#先删除本地分支(git br -d &lt;branch&gt;)，然后再push删除远程分支</span></span></div></pre></td></tr></table></figure>

<p>Git远程仓库管理</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">git remote -v                    <span class="comment"># 查看远程服务器地址和仓库名称</span></div><div class="line">git remote show origin           <span class="comment"># 查看远程服务器仓库状态</span></div><div class="line">git remote <span class="built_in">add</span> origin git@github:XXX/test.git         <span class="comment"># 添加远程仓库地址</span></div><div class="line">git remote <span class="built_in">set</span>-url origin git@github.com:XXX/test.git <span class="comment"># 设置远程仓库地址(用于修改远程仓库地址)</span></div><div class="line">git remote rm &lt;repository&gt;       <span class="comment"># 删除远程仓库</span></div><div class="line">git remote <span class="built_in">set</span>-head origin master   <span class="comment"># 设置远程仓库的HEAD指向master分支</span></div><div class="line"></div><div class="line">git branch <span class="comment">--set-upstream master origin/master</span></div><div class="line">git branch <span class="comment">--set-upstream develop origin/develop</span></div></pre></td></tr></table></figure>

<h3 id="实例">实例</h3>
<p>打patch过程</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">add</span> .</div><div class="line">git status</div><div class="line">git diff <span class="comment">--cached &gt;XXX.patch</span></div><div class="line">git ci -m <span class="string">'add patch'</span></div></pre></td></tr></table></figure>

<h3 id="分支策略">分支策略</h3>
<p>在实际开发中，我们应该按照几个基本原则进行分支管理：</p>
<p>首先，master分支应该是非常稳定的，也就是仅用来发布新版本，平时不能在上面干活；</p>
<p>那在哪干活呢？干活都在dev分支上，也就是说，dev分支是不稳定的，到某个时候，比如1.0版本发布时，再把dev分支合并到master上，在master分支发布1.0版本；</p>
<p>你和你的小伙伴们每个人都在dev分支上干活，每个人都有自己的分支，时不时地往dev分支上合并就可以了。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-02-11T08:09:32.000Z"><a href="/2011/02/11/git-help/">2月 11 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/02/11/git-help/">Git使用帮助</a></h1>
  

    </header>
    <div class="entry">
      
        <p><br></p>
<h3 id="使用http协议">使用http协议</h3>
<p>对于较新版本的git，比如1.7.9以上，我们推荐使用http协议来访问git仓库，不需配置ssh key，使用注册用户名和密码就可以访问。</p>
<p>使用git credential-cache来记住用户名和密码：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config <span class="subst">--</span><span class="built_in">global</span> credential<span class="built_in">.</span>helper <span class="keyword">cache</span></div></pre></td></tr></table></figure>

<p>git<br>如果需要设置cache的时间，设置记住用户名和密码的时间(秒为单位)：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --<span class="keyword">global</span> credential.helper <span class="string">'cache --timeout=10000000'</span></div></pre></td></tr></table></figure>

<p>git默认的postbuffer是比较小的，在push一个大的commit会出现错误，设置postbuffer，相关链接看<a href="http://stackoverflow.com/questions/2702731/git-fails-when-pushing-commit-to-github" target="_blank" rel="external">这里</a>：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --<span class="keyword">global</span> http.postBuffer <span class="number">524288000</span></div></pre></td></tr></table></figure>

<p>在使用多个账户的情况下，为了避免混淆用户，可以使用@yourname来强制指定，比如：</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone http<span class="variable">s:</span>//Lawrence-zxc@github.<span class="keyword">com</span>/Lawrence-zxc/github.git</div></pre></td></tr></table></figure>

<h3 id="管理ssh_key">管理ssh key</h3>
<p>ssh 公钥密钥对是一切安全的基础，就像第一道防盗门。Github出于安全的考虑，一概通过ssh协议交换数据，保护好ssh密钥是一个程序员应该有的安全意识，希望您通过<code>1password</code>之类的工具妥善保存，此外最好能定期的更新密钥。</p>
<p>多人共用密钥是严格不支持的！</p>
<p>如果您第一次使用，按照以下的方式配置ssh密码：</p>
<p>快速入门：</p>
<p>如果您使用任何类unix系统，第一次配置 ssh 公钥密钥，请按照步骤，复制灰色背景字符，在终端执行命令，和编辑文件</p>
<p>如果不存在<code>~/.ssh/id_rsa</code>，执行以下命令，生成 ssh 密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa  -N <span class="string">''</span></div><div class="line">cat ~/.ssh/id_rsa.pub</div></pre></td></tr></table></figure>

<p>点击ssh public key 管理，输入标识保存公钥</p>
<p>[可选]如果你要生成特定 ssh 密钥只用于github（是第一步的另外可选方案）</p>
<p>执行以下命令，生成 ssh 密钥, 保存在 <code>~/.ssh/github.com_rsa</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa  -N <span class="string">''</span> <span class="operator">-f</span> ~/.ssh/github.com_rsa;</div></pre></td></tr></table></figure>

<p>编辑 ssh 客户端配置文件 <code>~/.ssh/config</code>，使用您熟悉的编辑器，在后面添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Host github.com</div><div class="line"> User </div><div class="line"> IdentityFile ~/.ssh/github.com_rsa</div><div class="line"> PreferredAuthentications publickey</div></pre></td></tr></table></figure>


<p>查看 ssh 公钥，使用 cat 命令，或者用编辑器打开，请复制 ssh 公钥的文本内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat ~/.ssh/github.com_rsa.pub</div></pre></td></tr></table></figure>

<p>点击ssh public key 管理，输入标识保存公钥</p>
<p>ssh 公钥配置之后就可以长期使用了，请保护好密钥。点击创建仓库，详细仓库说明有助于推广</p>
<p>你已经可以使用 github 来托管代码了，以下是示范的操作，详细信息请开始git的学习</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>git clone git<span class="variable">@github</span>.<span class="symbol">com:</span>your_name/repo_name</div><div class="line"><span class="variable">$ </span>cd repo_name;</div><div class="line"><span class="variable">$ </span>vim <span class="constant">README</span>.md</div><div class="line"><span class="variable">$ </span>git add <span class="constant">README</span>.md</div><div class="line"><span class="variable">$ </span>git commit -m <span class="string">"init README.md"</span> .</div><div class="line"><span class="variable">$ </span>git push -u origin master</div></pre></td></tr></table></figure>


<p>配置 user.name, user.mail ，两者对后台统计，信息push有重要的作用，选择您注册的用户名和email按照下面配置</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git config --global <span class="literal">user</span>.name <span class="string">"your_name"</span></div><div class="line">$ git config --global <span class="literal">user</span>.email <span class="string">"your_email"</span></div></pre></td></tr></table></figure>


<p>如果不想 global，在每个仓库里面执行 git config ，去掉 —global 参数</p>
<h3 id="管理仓库">管理仓库</h3>
<p>仓库是开发的基础容器，一切活动都源于仓库。如果您想让别人知道您的仓库，最好是<br>良好的命名，简单概要。<br>适当的注释，让人知道您的仓库做什么的，解决什么问题。<br>最重要的当然是不断的开发成为优秀的项目。<br>仓库除了代码之外，其他的数据都是被严格限制的，您务必理解这一点。</p>
<p>clone·push·pull代码</p>
<figure class="highlight git"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>git clone git<span class="variable">@github</span>.<span class="symbol">com:</span>your/repo</div><div class="line"><span class="variable">$ </span>cd repo; vim <span class="constant">README</span>.md</div><div class="line"><span class="variable">$ </span>git add <span class="constant">README</span>.md</div><div class="line"><span class="variable">$ </span>git commit -m <span class="string">"init README.md"</span></div><div class="line"><span class="variable">$ </span>git push -u origin master</div><div class="line"><span class="variable">$ </span>git pull</div></pre></td></tr></table></figure>

<h3 id="git外部学习资源">git外部学习资源</h3>
<ul>
<li>Git Official Site<a href="http://book.git-scm.com/" target="_blank" rel="external">http://book.git-scm.com/</a></li>
<li>Git Community Book 中文版<a href="http://gitbook.liuhui998.com/index.html" target="_blank" rel="external">http://gitbook.liuhui998.com/index.html</a></li>
<li>Pro Git 简体中文版<a href="http://git.oschina.net/progit/" target="_blank" rel="external">http://git.oschina.net/progit/</a></li>
<li>Git权威指南 相关blog<a href="http://www.worldhello.net/" target="_blank" rel="external">http://www.worldhello.net/</a></li>
<li>Markdown 语法<a href="http://qingbo.net/picky/502-markdown-syntax.html" target="_blank" rel="external">http://qingbo.net/picky/502-markdown-syntax.html</a></li>
<li>假如你没什么事情可以做了，还可以看看<a href="http://blog.gitshell.com/" target="_blank" rel="external">http://blog.gitshell.com/</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2011-01-12T03:13:23.000Z"><a href="/2011/01/12/spring-mvc-1/">1月 12 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/01/12/spring-mvc-1/">SpringMVC中约定优于配置</a></h1>
  

    </header>
    <div class="entry">
      
        <p>所谓的约定优于配置就是指在程序开发过程中我们约定好一些规则可以使我们更少的进行配置和代码编写。就这么简单的一句话可能你还不是很懂什么是约定优于配置，没关系，看完后面对SpringMVC的约定优于配置的介绍之后你就会明白了。</p>
<p>SpringMVC对约定优于配置的支持主要表现在三个方面，<em>Model</em>、<em>View</em>和<em>Controller</em>。</p>
<h3 id="Model：">Model：</h3>
<p>SpringMVC对Model的约定优于配置的支持是基于ModelMap的，由于ModelAndView中的Model就是一个ModelMap，所以ModelAndView也是支持的。约定优于配置在Model上的表现是通过ModelMap的addObject方法实现的，当我们需要往ModelMap中添加一个对象的时候，我们可以只添加一个对象，而不指定其对应的属性名称，即调用addObject(Object obj)方法，而不是调用addObject(String attrName, Object obj)方法。这个时候Spring就会根据它自身约定的一套机制给我们一个默认的属性名称。</p>
<p>Spring的约定是这样的：</p>
<ul>
<li>采用这种方式添加的对象不能为null，所以如果添加的对象有可能为null时就不应该使用这种方式，还是使用addObject(String attrName,Object obj)方法指定一个属性名称比较好。</li>
<li>采用这种方式添加的集合Collection不能为empty，同样如果该Collection有可能为empty的时候就不应该使用这种方式。</li>
<li>简单对象，当是一个简单对象的时候取该对象的类名称，不包括包名，然后采用JavaBean的属性命名规则来确定属性名称，如添加com.host.app.model.User对象时取的属性名称就是user，添加com.host.app.model.HelloWorld对象时取的属性名称就是helloWorld，添加com.host.app.model.ABCdef对象时取的属性名称就是ABCdef。</li>
<li>数组，当添加的是一个数组的时候，Spring会取该数组的类型按照规则3取到一个名称作为基名称，之后再加上List后缀作为约定的属性名称。如添加一个Object数组时，Spring约定的属性名称就是objectList，添加一个com.host.app.model.ABCdef数组时，Spring取的属性名称就是ABCdefList。</li>
<li>集合Collection，当添加的是一个集合的时候，Spring会采用Iterator的方式取该集合的第一个元素类型按照规则3取到一个名称作为基名称，之后再加上List后缀作为约定的名称。如添加一个List时，如果取出的该List的第一个元素是java.lang.Object对象，那么Spring取的属性名称就是objectList；添加一个包含的都是com.host.app.model.User的Set时，Spring取的属性名称就是userList；如果添加的HashSet中同时包含多种类型的对象时就应该使用addObject(String attrName, Object obj)方法指定自己的属性名称，因为HashSet内部的元素是无序的，每次取的第一个元素可能不一样，这也就会导致Spring取的属性名称会不一样。</li>
</ul>
<p>看下面一个示例，当我们访问控制器处理方法testModel时，往返回的模型中添加了一个包含User的List对象，这样在ModelAndView内部内置的ModelMap中就会采用约定好的方式取userList为该对象在模型中的属性名称。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> ModelAndView <span class="title">testModel</span>() {  </div><div class="line">   ModelAndView mav = <span class="keyword">new</span> ModelAndView(<span class="string">"modelTest"</span>);  </div><div class="line">   User user = <span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">"zhangsan"</span>);  </div><div class="line">   List&lt;User&gt; list = <span class="keyword">new</span> ArrayList&lt;User&gt;();  </div><div class="line">   list.add(user);  </div><div class="line">   mav.addObject(list);  </div><div class="line">   <span class="keyword">return</span> mav;  </div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="View：">View：</h3>
<p>当Controller处理器方法没有返回一个View对象或逻辑视图名称，并且在该方法中没有直接往response的输出流里面写数据的时候，Spring就会采用约定好的方式提供一个逻辑视图名称。这个逻辑视图名称是通过Spring定义的org.springframework.web.servlet.RequestToViewNameTranslator接口的getViewName方法来实现的，我们可以实现自己的RequestToViewNameTranslator接口来约定好没有返回视图名称的时候如何确定视图名称。Spring已经给我们提供了一个它自己的实现，那就是org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator。<br>在介绍DefaultRequestToViewNameTranslator是如何约定视图名称之前我们先来看一下它支持用户定义的属性：</p>
<ul>
<li>prefix：前缀，表示约定好的视图名称需要加上的前缀，默认是空串。</li>
<li>suffix：后缀，表示约定好的视图名称需要加上的后缀，默认是空串。</li>
<li>separator：分隔符，默认是斜杠“/”。</li>
<li>stripLeadingSlash：如果首字符是分隔符，是否要去除，默认是true。</li>
<li>stripTrailingSlash：如果最后一个字符是分隔符，是否要去除，默认是true。</li>
<li>stripExtension：如果请求路径包含扩展名是否要去除，默认是true。</li>
<li>urlDecode：是否需要对URL解码，默认是true。它会采用request指定的编码或者ISO-8859-1编码对URL进行解码。</li>
</ul>
<p>当我们没有在SpringMVC的配置文件中手动的定义一个名为viewNameTranlator的bean的时候，Spring就会为我们提供一个默认的viewNameTranslator，即DefaultRequestToViewNameTranslator。</p>
<p>接下来看一下，当Controller处理器方法没有返回逻辑视图名称的时候，DefaultRequestToViewNameTranslator是如何约定视图名称的。DefaultRequestToViewNameTranslator会获取到请求的URI，然后根据提供的属性做一些改造，把改造之后的结果作为视图名称返回。我们以请求路径<em><a href="http://localhost/app/product/index.html" target="_blank" rel="external">http://localhost/app/product/index.html</a></em>为例来说明DefaultRequestToViewNameTranslator是如何工作的。该请求路径对应的请求URI为/product/index.html,我们来看以下几种情况，它分别对应的逻辑视图名称是什么。</p>
<ul>
<li>prefix和suffix都存在，其他为默认值是对应返回的逻辑视图名称应该是prefixproduct/indexsuffix。</li>
<li>stripLeadingSlash和stripExtension都为false，其他默认，这时候对应的逻辑视图名称是/product/index.html。</li>
<li>都采用默认配置时，返回的逻辑视图名称应该是product/index。</li>
</ul>
<p>如果我们的逻辑视图名称都跟请求路径相同或者相关关系是一样的,我们就可以采用Spring为我们事先约定好的逻辑视图名称返回,这可以大大简化我们的开发工作。</p>
<p>下面是一个在SpringMVC配置文件中配置一个<code>RequestToViewNameTranslator bean</code>的示例,记住,该bean的名称只能为viewNameTranslator,如果不为viewNameTranslator时,Spring还是会使用默认配置的DefaultRequestToViewNameTranslator来约定逻辑视图名称</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"viewNameTranslator"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator"</span>&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"prefix"</span> <span class="attribute">value</span>=<span class="value">"prefix"</span>/&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"suffix"</span> <span class="attribute">value</span>=<span class="value">"suffix"</span>/&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"stripLeadingSlash"</span> <span class="attribute">value</span>=<span class="value">"false"</span>/&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"stripExtension"</span> <span class="attribute">value</span>=<span class="value">"false"</span>/&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="title">bean</span>&gt;</span></div></pre></td></tr></table></figure>



<h3 id="Controller：">Controller：</h3>
<p>此处讲SpringMVC对约定优于配置的支持是基于注解配置Controller的情况。考虑这样一种情况：定义了一个Controller，名为MyController，然后在MyController类上使用了@Controller注解进行标记，没有类级别的@RequestMapping。MyController中定义了一个处理器方法add，该方法使用了@RequestMapping注解标记。大概就是下面这个样子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>{  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"add"</span>)  </div><div class="line">    <span class="keyword">public</span> String <span class="title">add</span>() {  </div><div class="line">       <span class="keyword">return</span> <span class="string">"add"</span>;  </div><div class="line">    }     </div><div class="line">}</div></pre></td></tr></table></figure>



<p>这个时候如果我们需要访问到处理器方法add的话，我们需要请求/add.do，然后有另外一个AnotherController，里面也有一个add方法对应/add.do请求，这个时候如果你再请求/add.do的时候Spring就不知道到底该访问那个方法，然后就会抛出异常，这个时候我们最简单的解决办法就是在MyController上加上类级别的@RequestMapping用以区别，表示请求的路径到底是哪个Controller下面的，类似的情况还有我们会把相关的处理器方法放在一个Controller中，比如UserController下面会有user的add方法，user的del方法等。Spring为我们提供了一种机制可以自动根据我们的Controller类名称来进行请求映射，这是通过在SpringMVC的配置文件中定义一个org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping bean来实现的。通过它的名称我们可以知道ControllerClassNameHandlerMapping就是通过Controller的类名称来进行类级别的请求映射的。使用ControllerClassNameHandlerMapping的默认属性配置的时候Spring是这样来进行请求映射的：</p>
<ul>
<li>首先取得去掉包名称的Controller类名称。</li>
<li>如果该类名称是以Controller结尾，则只取Controller前面的部分，如MyController取My。</li>
<li>将取到的名称取全部小写，如MyHome取myhome。</li>
<li>然后将上面取到的名称映射为/name/<em>，如上面取到的名称是myhome，则映射为/myhome/</em>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>{  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"add"</span>)  </div><div class="line">    <span class="keyword">public</span> String <span class="title">add</span>() {  </div><div class="line">       <span class="keyword">return</span> <span class="string">"add"</span>;  </div><div class="line">    }    </div><div class="line">}</div></pre></td></tr></table></figure>


<p>还是这一段代码，当我们使用ControllerClassNameHandlerMapping来进行映射的时候，我们需要访问MyController的处理器方法add的时候就需要请求/my/add.do。<br>ControllerClassNameHandlerMapping支持用户定义如下属性：</p>
<ul>
<li>caseSensitive：大小写是否敏感，默认是false，该属性主要是用来生成映射路径的时候匹配大小写是否敏感，如果为true，则只把Controller类名称的首字母小写，其他的保持原样进行请求路径映射，如果为false，则全部小写。basePackage也使用同样的规则，只是basePackage在caseSensitive为true的时候不需要首字母小写。</li>
<li>basePackage：表示要用于生成路径映射的基包，默认是null，这个时候就采用Controller不包含包名称的类名称来映射，映射规则跟之前介绍的映射规则相同。如果定义了basePackage，假设为com.host.app，这个时候如果Controller类的全名称是com.host.app.abc.edf.MyController，那么映射的路径就是/abc/edf/my/*。</li>
<li>pathPrefix：表示映射路径的前缀，默认是空串。假设pathPrefix为prefix，basePackage为com.host.app，那么com.host.app.abc.MyController的映射路径就是/prefix/abc/my/*。</li>
<li>excludedPackages：是数组形式，表示需要把哪些包排除在ControllerClassNameHandlerMapping的映射范围之内。</li>
<li>excludedClasses：是数组形式，表示需要把哪些类排除在ControllerClassNameHandlerMapping的映射范围之内。</li>
</ul>
<p>在下面一个例子就排除了com.host.app.web.mymodule包、com.host.app.web.modulea.MyController和com.host.app.web.moduleb.UserController。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;bean class="org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping"&gt;  </div><div class="line">   &lt;property name="order" value="1"/&gt;  </div><div class="line">   &lt;property name="excludedPackages"&gt;  </div><div class="line">       &lt;array&gt;  </div><div class="line">          &lt;value&gt;com.host.app.web.mymodule &lt;/value&gt;  </div><div class="line">       &lt;/array&gt;  </div><div class="line">   &lt;/property&gt;  </div><div class="line">   &lt;property name="excludedClasses"&gt;  </div><div class="line">       &lt;array&gt;  </div><div class="line">          &lt;value&gt;com.host.app.web.modulea.MyController&lt;/value&gt;  </div><div class="line">          &lt;value&gt;com.host.app.web.moduleb.UserController&lt;/value&gt;  </div><div class="line">       &lt;/array&gt;  </div><div class="line">   &lt;/property&gt;  </div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>



<p>使用ControllerClassNameHandlerMapping需要注意的地方：</p>
<ul>
<li>需要使用ControllerClassNameHandlerMapping来映射的Controller类上如果加了@RequestMapping注解ControllerClassNameHandlerMapping也是可以进行URL路径映射的。</li>
<li>使用ControllerClassNameHandlerMapping映射的是类似于<code>/controllerName/*</code>这样的形式，这也就是说只有在处理器方法映射不存在斜杠的时候才可以使用这种形式访问到。看下面一个例子，在下面代码中MyController类能够映射的请求路径是<code>/my/*</code>，这也意味着只有满足/my/*的请求路径才能映射到MyController，才能访问到它里面的处理器方法，所以当请求/my/test1.do的时候毫无疑问可以访问到处理器方法test1，但是当想访问MyController的test2方法，请求/my/test/test2.do的时候由于它不能映射到MyController，所以不能如愿的访问到MyController的test2方法。这也是ControllerClassNameHandlerMapping 一个缺陷。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>{  </div><div class="line">   </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"test1"</span>)  </div><div class="line">    <span class="keyword">public</span> String <span class="title">test1</span>() {  </div><div class="line">       <span class="keyword">return</span> <span class="string">"test"</span>;  </div><div class="line">    }  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"test/test2"</span>)  </div><div class="line">    <span class="keyword">public</span> String <span class="title">test2</span>() {  </div><div class="line">       <span class="keyword">return</span> <span class="string">"test"</span>;  </div><div class="line">    }      </div><div class="line">}</div></pre></td></tr></table></figure>


<ul>
<li>由于在SpringMVC应用中可以同时定义多个HandlerMapping，这就涉及到一个映射的优先级问题。HandlerMapping都实现了Ordered接口，所以我们可以通过HandlerMapping的order属性来指定匹配映射的先后顺序。我们知道在ViewResolver链中，如果一个逻辑视图被一个ViewResolver解析了之后，该次视图解析就结束了，其他的视图解析器就不能再解析这个视图了，它的order属性是用来定义ViewResolver进行视图解析的先后顺序的。但是HandlerMapping不一样，它是在SpringMVC的配置文件中定义的所有的HandlerMapping都可以进行URL映射，它的order属性是用于指定映射匹配的先后顺序的。看一个例子：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping"</span>&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"order"</span> <span class="attribute">value</span>=<span class="value">"1"</span>/&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="title">bean</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping"</span>&gt;</span>  </div><div class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"order"</span> <span class="attribute">value</span>=<span class="value">"10"</span>/&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="title">bean</span>&gt;</span></div></pre></td></tr></table></figure>



<p>我们在SpringMVC的配置文件里面定义了两个HandlerMapping，代码如上所示，由它们的order属性我们知道ControllerClassNameHandlerMapping会先于DefaultAnnotationHandlerMapping进行映射匹配。定义了一个MyTestController，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTestController</span> </span>{  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"mytest/test"</span>)  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span>() {  </div><div class="line">       System.out.println(<span class="string">"--------hello test---------"</span>);  </div><div class="line">    }  </div><div class="line">     </div><div class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"test"</span>)  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span>() {  </div><div class="line">       System.out.println(<span class="string">"--------hello test2---------"</span>);  </div><div class="line">    }  </div><div class="line">}</div></pre></td></tr></table></figure>

<p>我们知道<code>ControllerClassNameHandlerMapping</code>会把<code>MyTestController</code>映射为<code>“/mytest/*”</code>,按照这种方式我们只能利用<code>/mytest/test.do</code>请求到MyTestController的test2方法,而没法利用<code>/mytest/mytest/test.do</code>请求到test方法。</p>
<p>而<code>DefaultAnnotationHandlerMapping</code>会把<code>MyTestController</code>的test2方法映射为<code>“/test.do”</code>,把test方法映射为“/mytest/test.do”。而根据Spring定义了多个HandlerMapping就会有多个映射机制存在的这么一个机制我们知道上述几种映射关系都是会存在的。那么这个时候如果我请求/mytest/test.do会请求哪个方法呢?</p>
<p>我们知道,如果是按照<code>ControllerClassNameHandlerMapping</code>的映射机制会访问MyTestController的test2方法,而按照<code>DefaultAnnotationHandlerMapping</code>的映射机制就会访问MyTestController的test方法;这个时候HandlerMapping的order属性就起作用了,order属性越小的就会先匹配,由上面的配置我们知道<code>ControllerClassNameHandlerMapping</code>的order属性相对较小,所以将使用它的映射URL来匹配这次请求,所以处理的是MyTestController的test2方法。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2010-12-05T09:10:34.000Z"><a href="/2010/12/05/rizhi/">12月 5 2010</a></time>
      
      
  
    <h1 class="title"><a href="/2010/12/05/rizhi/">琐忆</a></h1>
  

    </header>
    <div class="entry">
      
        <center><br>    年年如是，<br>    年年不同，<br>    依稀往事，<br>    如梦如风。<br></center>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2010-10-15T13:21:13.000Z"><a href="/2010/10/15/thread-executor/">10月 15 2010</a></time>
      
      
  
    <h1 class="title"><a href="/2010/10/15/thread-executor/">Java并发执行任务Executor(ExecutorService和Future)</a></h1>
  

    </header>
    <div class="entry">
      
        <p>为了方便并发执行任务,出现了一种专门用来执行任务的实现,也就是Executor。 由此,任务提交者不需要再创建管理线程,使用更方便,也减少了开销。</p>
<h3 id="Executor_任务的提交者和执行者">Executor 任务的提交者和执行者</h3>
<pre><code>       Task Submitter <span class="command">\
</span>                        <span class="command">\ </span>               ExecutorService
                          <span class="command">\ </span>                                             Executor Thread
                            <span class="command">\+</span>------+------+------+------+------+        
       Task Submitter -------+ Task + Task + Task + Task + Task +        Executor Thread
                             /+------+------+------+------+------+
                           /                                             Executor Thread
                         /
       Task Submitter  /
</code></pre><p>java.util.concurrent.Executors是Executor的工厂类,通过Executors可以创建你所需要的 Executor。</p>
<h3 id="Future_任务的提交者和执行者之间的通讯手段">Future 任务的提交者和执行者之间的通讯手段</h3>
<pre><code><span class="code">+--------------+</span>-------------+
<span class="header">|            Future&lt;T&gt;       |
+--------------+-------------+</span>
<span class="code">+--------------+</span>-------------+
| cancel(boolean) : boolean  |
| isCancelled() : boolean    |
| isDone() : boolean         |
| get() : T                  |
<span class="header">| get(long, TimeUnit) : T    |
+--------------+-------------+</span>
</code></pre><p>Task Submitter把任务提交给Executor执行,他们之间需要一种通 讯手段,这种手段的具体实现,通常叫做Future。Future通常包括 get(阻塞至任务完成), cancel,get(timeout)(等待一段时间) 等等。Future也用于异步变同步的场景。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ExecutorService executor = Executors.newSingleThreadExecutor();</div><div class="line">Callable&lt;Object&gt; task = <span class="keyword">new</span> Callable&lt;Object&gt;() { </div><div class="line">	<span class="keyword">public</span> Object <span class="title">call</span>() <span class="keyword">throws</span> Exception {</div><div class="line">		Object result = <span class="string">"..."</span>;</div><div class="line">		<span class="keyword">return</span> result; </div><div class="line">	}</div><div class="line">};</div><div class="line">Future&lt;Object&gt; future = executor.submit(task); </div><div class="line">future.get(); <span class="comment">// 等待至完成</span></div></pre></td></tr></table></figure>

<p>有两种任务:</p>
<ul>
<li>Runnable</li>
<li>Callable Callable是需要返回值的任务</li>
</ul>
<p>Task Submitter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Future&lt;Object&gt; future = executor.submit(task);</div><div class="line"><span class="comment">// 等待到任务被执行完毕返回结果</span></div><div class="line"><span class="comment">// 如果任务执行出错,这里会抛ExecutionException </span></div><div class="line">future.get();</div><div class="line"><span class="comment">//等待3秒,超时后会抛TimeoutException </span></div><div class="line">future.get(<span class="number">3</span>, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>

<p>Task Executor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Callable&lt;Object&gt; task = <span class="keyword">new</span> Callable&lt;Object&gt;() { </div><div class="line">	<span class="keyword">public</span> Object <span class="title">call</span>() <span class="keyword">throws</span> Exception {</div><div class="line">		Object result = <span class="string">"..."</span>;</div><div class="line">		<span class="keyword">return</span> result; </div><div class="line">	}</div><div class="line">};</div></pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2010-10-14T09:09:55.000Z"><a href="/2010/10/14/thread-jichu/">10月 14 2010</a></time>
      
      
  
    <h1 class="title"><a href="/2010/10/14/thread-jichu/">线程的使用经验(设置名称、响应中断、使用ThreadLocal)</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="启动线程的注意事项">启动线程的注意事项</h3>
<p>方式一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="string">"thread name"</span>) { </div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">		<span class="comment">// do xxx</span></div><div class="line">	}</div><div class="line">};</div><div class="line">thread.start();</div></pre></td></tr></table></figure>

<p>方式二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>{ </div><div class="line">	<span class="keyword">public</span> <span class="title">MyThread</span>() {</div><div class="line">		<span class="keyword">super</span>(<span class="string">"thread name"</span>);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() { </div><div class="line">		<span class="comment">// do xxx</span></div><div class="line">	} </div><div class="line">};</div><div class="line">MyThread thread = <span class="keyword">new</span> MyThread (); </div><div class="line">thread.start();</div></pre></td></tr></table></figure>

<p>方式三</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Thread thread = <span class="keyword">new</span> Thread() { </div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">		<span class="comment">// do xxx  </span></div><div class="line">	}</div><div class="line">};</div><div class="line">thread.setName(<span class="string">"thread name"</span>); </div><div class="line">thread.start();</div></pre></td></tr></table></figure>

<p>方式四</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Thread thread = new Thread(task); </div><div class="line">// 传入任务 </div><div class="line">thread.setName(“thread name"); </div><div class="line">thread.start();</div></pre></td></tr></table></figure>

<p>方式五</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Thread thread = new Thread(task, “thread name");</div><div class="line">thread.start();</div></pre></td></tr></table></figure>

<p>无论何种方式,启动一个线程,就要给它一个名字!这对排错诊断系统监控有帮助。否则诊断问题时,无法直观知道某个线程的用途。</p>
<h3 id="要响应线程中断">要响应线程中断</h3>
<p>thread.interrupt();<br>方式一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="string">"interrupt test"</span>) { </div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">		<span class="keyword">for</span> (;;) { </div><div class="line">			doXXX();</div><div class="line">			<span class="keyword">if</span> (Thread.interrupted()) { </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			} </div><div class="line">		}</div><div class="line">	}</div><div class="line">};</div><div class="line">thread.start();</div></pre></td></tr></table></figure>

<p>方式二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span>() <span class="keyword">throws</span> InterruptedException { </div><div class="line">	<span class="keyword">if</span> (Thread.interrupted()) {</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException(); </div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>方式三</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="string">"interrupt test"</span>) { </div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">		<span class="keyword">for</span> (;;) { </div><div class="line">			<span class="keyword">try</span> {</div><div class="line">				doXXX();</div><div class="line">			} <span class="keyword">catch</span> (InterruptedException e) { </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			} <span class="keyword">catch</span> (Exception e) {</div><div class="line">				<span class="comment">// handle Exception</span></div><div class="line">			} </div><div class="line">		}</div><div class="line">	}</div><div class="line">}; </div><div class="line">thread.start();</div></pre></td></tr></table></figure>

<p>程序应该对线程中断作出恰当的响应。</p>
<h3 id="ThreadLocal">ThreadLocal</h3>
<pre><code><span class="code">+-------------+</span>---------+
<span class="header">|     ThreadLocal&lt;T&gt;    |
+-------------+---------+</span>
<span class="code">+-------------+</span>---------+
| initialValue() : T    |
| get() : T             |
| set(T value)          |
<span class="header">| remove()              |
+-------------+---------+</span>
</code></pre><p>顾名思义它是local variable(线程局部变量)。它的功用非常简单,就是为每一个使用该变量的线程都提供一个变量值的副本,是每一个线程都可以独立地改变自己的副本,而不 会和其它线程的副本冲突。从线程的角度看,就好像每一个线程都完全拥有该变量。</p>
<p>使用场景</p>
<ul>
<li>To keep state with a thread (user-id, transaction-id, logging-id) </li>
<li>To cache objects which you need frequently</li>
<li>隐式传参</li>
</ul>
<p>注意:使用ThreadLocal,一般都是声明在静态变量中,如果不断的创建ThreadLocal而且没有调用其remove方法,将会导致<code>内存泄露</code>。<br>同时请注意,如果是static的ThreadLocal,一般不需要调用remove。</p>
<h3 id="线程间的协调(lock、condition、wait、notify、notifyAll)">线程间的协调(lock、condition、wait、notify、notifyAll)</h3>
<h4 id="ReentrantLock和Synchronized">ReentrantLock和Synchronized</h4>
<p>Synchronized是Lock的一种简化实现,一个Lock可以对应多个Condition,而synchronized把Lock和Condition合并了,一个synchronized Lock只对应一个Condition,可以说Synchronized是Lock的简化版本。<br>在JDK 5,Synchronized要比Lock慢很多,但是在JDK 6中,它们的效 率差不多。</p>
<p><img src="/img/thread.jpg"></p>
<p>不要在Lock和Condition上使用wait、notiffy、notifyAll方法!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2010-07-16T07:45:02.000Z"><a href="/2010/07/16/shell-style/">7月 16 2010</a></time>
      
      
  
    <h1 class="title"><a href="/2010/07/16/shell-style/">Shell编码风格和脚本配置文件格式</a></h1>
  

    </header>
    <div class="entry">
      
        <p><a href="http://wiki.bash-hackers.org/scripting/style" target="_blank" rel="external">Scripting with style</a> 是少见的一篇介绍 Shell 编码风格 的文章，相信对大多数运维人员和linux爱好者都有用，现在将译文奉上。</p>
<h2 id="Shell编码风格">Shell编码风格</h2>
<h3 id="缩进准则">缩进准则</h3>
<p>我一般使用2个空格来缩进（尽管大多人使用4个空格），原因是：</p>
<ul>
<li>输入简单快速；</li>
<li>没有输入一个Tab键，避免不同环境下显示的差异问题；</li>
<li>缩进的效果已经足够，并且没有浪费太多的空间；</li>
</ul>
<p><strong><em>译者注：本人也是使用4个空格，如果你也与本文作者的风格不一样，下面说到2个空格的地方请自觉替换成你实际使用的空格数。个人认为，缩进只是一个个人的风格，只要不影响可读性即可。</em></strong></p>
<p>顺便说一句，尽量不要使用Tab键，它们容易带来麻烦，我只能想到一种情况下它是有用的：here document中的缩进。</p>
<h3 id="分隔长行">分隔长行</h3>
<p>如果需要分隔过长的代码，你可以使用下面的任意一种方法：</p>
<p>1） 使用与命令宽度相同的缩进</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">activate some_very_long_option <span class="command">\</span></div><div class="line">         some_other_option</div></pre></td></tr></table></figure>

<p>2） 使用2个空格缩进</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">activate some_very_long_option <span class="command">\</span></div><div class="line">  some_other_option</div></pre></td></tr></table></figure>

<p>从个人的角度来说，除非有特别的需要，我更倾向于第一种形式，因为它突出“上下两行的内容是一起的”这一联系。</p>
<h3 id="分离复合命令">分离复合命令</h3>
<p><strong><em>译者注：其实这里的复合命令就是指块语句，例如for/while循环, if分支结构等等。</em></strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="title">HEAD_KEYWORD</span> parameters; <span class="title">BODY_BEGIN</span></div><div class="line">  BODY_COMMANDS</div><div class="line">BODY_END</div></pre></td></tr></table></figure>

<p>我习惯于：</p>
<ul>
<li>将HEAD_KEYWORD和初始化命令或者参数放在第一行；</li>
<li>将BODY_BEGIN同样放在第一行；</li>
<li>复合命令中的BODY部分以2个空格缩进；</li>
<li>BODY_END部分独立一行放在最后；</li>
</ul>
<p>1）if/then/elif/else分支语句</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="keyword">...</span>; then</div><div class="line">  <span class="keyword">...</span></div><div class="line">elif <span class="keyword">...</span>; then</div><div class="line">  <span class="keyword">...</span></div><div class="line"><span class="keyword">else</span></div><div class="line">  <span class="keyword">...</span></div><div class="line">fi</div></pre></td></tr></table></figure>

<p>2）for循环</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> /etc/*; do</div><div class="line">  <span class="keyword">...</span></div><div class="line">done</div></pre></td></tr></table></figure>

<p>3） while/until循环</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> [[ $answer != [YyNn] ]]; do</div><div class="line">  <span class="keyword">...</span></div><div class="line">done</div></pre></td></tr></table></figure>

<p>4） case分支语句</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="variable">$input</span> <span class="keyword">in</span></div><div class="line">  hello)</div><div class="line">    <span class="built_in">echo</span> <span class="string">"You said hello"</span></div><div class="line">  ;;</div><div class="line">  bye)</div><div class="line">    <span class="built_in">echo</span> <span class="string">"You said bye"</span></div><div class="line">    <span class="keyword">if</span> foo; <span class="keyword">then</span></div><div class="line">      bar</div><div class="line">    <span class="keyword">fi</span></div><div class="line">  ;;</div><div class="line">  *)</div><div class="line">    <span class="built_in">echo</span> <span class="string">"You said something weird..."</span></div><div class="line">  ;;</div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure>

<p>几点注意的地方：</p>
<ul>
<li>如果不是100%需要，匹配部分左右的括号不需要写（译者注：例如写成hello)而不是(hello)）；</li>
<li>匹配模式与分支的终止符号;;位于同一缩进级别</li>
<li>分支内部的命令多缩进一层；</li>
<li>尽管是可选的，这里还是把最后一个分支的终止符号也写上了；</li>
</ul>
<h3 id="语法和编码指引">语法和编码指引</h3>
<p>晦涩的语法结构</p>
<p>我们都喜欢一些晦涩的语法结构，因为它们很简洁。但是如果不是100%需要用到，尽量不要使用它们，否则大多数人无法理解你的代码。</p>
<p>所以有有时候，我们需要在代码的智能，效率与可读性之间找到一个平衡点。</p>
<p>如果你一定要使用这种语法结构，记得在用的地方写上一小段注释。</p>
<p><strong><em>译者注：Shell提供的一些语法糖很难理解，但是有非常简洁实用，本人也很喜欢用，这样可以省下一大堆精力，而且用熟了也没有什么难以理解的，但是作者说的也有道理，这一点就仁者见仁，智者见智了</em></strong></p>
<h3 id="变量名">变量名</h3>
<p>因为所有保留的变量名都是大写的，最安全的方法是仅使用小写字母作为变量名，例如读入用户的输入、循环变量等等……：</p>
<ul>
<li>变量名尽量选择小写字母；</li>
<li>如果你使用大写的变量名，不要使用保留的变量名（一份不完全的列表参见SUS）；</li>
<li>如果你使用大写的变量名，最后在变量名前面加一个独特的前缀（例如下面例子中的MY_）；</li>
</ul>
<p>下面是一个例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/bash</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># the prefix 'MY_'</span></div><div class="line">MY_LOG_DIRECTORY=/var/adm/</div><div class="line"></div><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="string">"<span class="variable">$MY_LOG_DIRECTORY</span>"</span>/*; <span class="keyword">do</span></div><div class="line">  <span class="built_in">echo</span> <span class="string">"Found Logfile: <span class="variable">$file</span>"</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>

<h3 id="变量初始化">变量初始化</h3>
<p>正如C语言一样，最好的处理是在变量声明的时候初始化。</p>
<p>用户可以将一个变量以环境变量的形式传递到脚本中。如果你盲目地假定你使用的所有变量都是未初始化的，其它人可以以环境变量的形式劫持一个变量。</p>
<p><strong><em>译者注：一个例子说明这一点：</em></strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">cat</span> <span class="keyword">b</span>.<span class="keyword">sh</span> </div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -<span class="keyword">z</span> <span class="string">"$var"</span> ]; then</div><div class="line">    <span class="keyword">echo</span> <span class="string">"$var is not set"</span></div><div class="line">    var=<span class="number">1</span></div><div class="line">fi</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">"Now, var is equals to $var"</span></div><div class="line">var=<span class="number">2</span> <span class="keyword">sh</span> <span class="keyword">b</span>.<span class="keyword">sh</span></div><div class="line">Now, var <span class="keyword">is</span> equals <span class="keyword">to</span> <span class="number">2</span></div></pre></td></tr></table></figure>

<p>解决这个问题的方法很简单，将变量初始化：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">my_input=</span><span class="string">""</span></div><div class="line"><span class="variable">my_array=</span>()</div><div class="line"><span class="variable">my_number=</span><span class="number">0</span></div></pre></td></tr></table></figure>

<h3 id="参数展开">参数展开</h3>
<p>除非你知道自己做的事情，请在参数展开的地方使用双引号</p>
<p>当然，也有一些地方并不需要使用双引号，例如：</p>
<ul>
<li>[[ ]]测试表达式内部是不会展开的；</li>
<li>在case $WORD in语法中WORD也不会展开的；</li>
<li>在变量赋值var=$WORD的地方也是不会展开的</li>
</ul>
<p>但是在这些地方使用引号并不会出错，如果你习惯于在每个可能展开参数的地方使用引号，你写得代码会很安全。</p>
<p>如果你要传递一个参数作为一个单词列表，你可以不使用引号，例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">list=<span class="string">"one two three"</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># you MUST NOT quote $list here</span></div><div class="line"><span class="keyword">for</span> word <span class="keyword">in</span> $list; do</div><div class="line">  <span class="keyword">...</span></div><div class="line">done</div></pre></td></tr></table></figure>

<h3 id="函数名称">函数名称</h3>
<p>函数名称应该采用小写的形式，并且有一个很好的意义。函数名称应该容易让人理解，比如f1这个名称虽然容易输入但是对调试和其它人阅读代码造成了很大的困难，它说明不了任何东西。好的函数名称可以帮助说明代码，而不需要额外的注释。</p>
<p>一个或多或少有趣的是：如果你无意这样做，不要把函数名称命名为常见的命令名，新手往往比较容易将脚本或者函数名命名成test，这样就和UNIX的test命令冲突了。</p>
<p>除非绝对必要，仅使用字母、数字和下划线作为函数名称。/bin/ls也是一个合法的Bash函数名称。</p>
<p><strong><em>译者注：/bin/ls不是一个合法的函数名称。</em></strong></p>
<h3 id="命令替换">命令替换</h3>
<p>正如文章<a href="http://wiki.bash-hackers.org/syntax/expansion/cmdsubst" target="_blank" rel="external">the article about command substitution [Bash Hackers Wiki]</a>中提及的，你应该使用$( .. )形式。</p>
<p>不过，如果可移植性是一个问题，你可能必须使用反引号的形式<code>...</code>。</p>
<p>在任何情况，如果其它展开或者单词分隔并不是你期望的，你应该将命令替换用双引号引起来。</p>
<h3 id="Eval命令">Eval命令</h3>
<p>正如Greg据说的：<strong><em>“If eval is the answer, surely you are asking the wrong question.”</em></strong>。</p>
<p>避免它，除非绝对必要：</p>
<ul>
<li>eval can be your neckshot（可能是你的麻烦？）</li>
<li>很有可能有其它的方法来实现你需要的；</li>
<li>如果可能，重新思考下脚本的工作过程，当eval的使用不可避免的时候；</li>
<li>如果你实在需要使用，小心慎用；</li>
</ul>
<h3 id="脚本的基本结构">脚本的基本结构</h3>
<p>一个脚本的基本结构是这样的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!SHEBANG</span></div><div class="line"></div><div class="line">CONFIGURATION_VARIABLES</div><div class="line"></div><div class="line">FUNCTION_DEFINITIONS</div><div class="line"></div><div class="line">MAIN_CODE</div></pre></td></tr></table></figure>

<h3 id="Shebang">Shebang</h3>
<p>如果可能，请不要忘记shebang。</p>
<p>请小心使用/bin/sh作为shebang，在Linux系统中，/bin/sh就是Bash这是一个错误的观点。</p>
<p>于我而言，shebang有两个目的：</p>
<ul>
<li>说明直接执行时以哪个解释器来执行；</li>
<li>明确该脚本应该以哪个解释器来执行；</li>
</ul>
<h3 id="配置变量">配置变量</h3>
<p>在这里，我将这一类变量——可以被用户更改的——叫做配置变量。</p>
<p>让这类变量容易找到，一般放在脚本的头部，给它们有意义的名称并且加上注释说明。正如上面说的，仅当你知道你为什么这么做的时候，才用大写的变量名形式，否则小写形式更加安全。</p>
<p>函数定义</p>
<p>所有函数定义应该在脚本主要代码执行之前，这样可以给人全局的印象，并且确保所有函数在使用之前它是已知的。</p>
<p>你应该使用可移植性高的函数定义形式，即不带function关键字的形式。</p>
<h3 id="脚本行为和健壮性">脚本行为和健壮性</h3>
<p>当脚本检测到问题时尽早退出，以免执行潜在的问题；<br>如果你需要用到的命令可能并没有安装在系统上，在脚本执行的时候最好检查命令是否存在并且提醒用户缺少什么；<br>采用有意义的脚本返回值，例如0代码成功，1代码错误或者失败；</p>
<h3 id="其它">其它</h3>
<p>输出内容</p>
<ul>
<li>if the script is interactive, if it works for you and if you think this is a nice feature, you can try to save the terminal content and restore it after execution；（译者注：不理解这一点是什么意思）</li>
<li>在屏幕中输出简单易理解的消息；</li>
<li>使用颜色或者特别的前缀区分错误和警告信息；</li>
<li>输出正常的内容到STDOUT，而输出错误、警告或者诊断的信息到STDERR；</li>
<li>在日志文件中输出所有详细的信息；</li>
</ul>
<p>输入</p>
<p>不要盲目地假设任何事情，如果你希望用户输入一个数字，请在脚本中主动检查它是否真得是一个数字，检查头部是否包含0，等等。我们都应该知道这一点，用户仅仅是用户而不是程序员，他们会做他们想要的，而不是程序想要的。</p>
<h2 id="Sehll脚本配置文件格式">Sehll脚本配置文件格式</h2>
<p>开发过程中为了减少 hardcode，不可避免的需要提供配置文件给用户定制。对于高级编程语言来说，因为有丰富的第三方库，可供选择的配置文件格式有很多，比如 xml、jsno、ini、yaml 等等。</p>
<h3 id="key=value_文本格式配置">key=value 文本格式配置</h3>
<p>而对于 linux shell，基本上很难使用前面提到的各种格式。所以在 unix 系统上，很多 shell 脚本的配置文件都是纯粹的 key=value 文本格式，例如绝大多数的开机服务启动脚本、网络配置文件等。</p>
<p>例子 1：ntp 配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ cat /etc/sysconfig/ntpd</div><div class="line"># <span class="operator"><span class="keyword">Drop</span> root <span class="keyword">to</span> id <span class="string">'ntp:ntp'</span> <span class="keyword">by</span> <span class="keyword">default</span>.</span></div><div class="line">OPTIONS=<span class="string">"-u ntp:ntp -p /var/run/ntpd.pid"</span></div><div class="line">#</div><div class="line"># <span class="keyword">Set</span> <span class="keyword">to</span> <span class="string">'yes'</span> <span class="keyword">to</span> sync hw clock <span class="keyword">after</span> successful ntpdate</div><div class="line">SYNC_HWCLOCK=<span class="keyword">no</span></div><div class="line">#</div><div class="line"># Additional options <span class="keyword">for</span> ntpdate</div><div class="line">NTPDATE_OPTIONS=<span class="string">""</span></div></pre></td></tr></table></figure>

<p>例子 2：网络配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cat /etc/sysconfig/network</div><div class="line"><span class="constant">NETWORKING</span>=<span class="string">"yes"</span></div><div class="line"><span class="constant">HOSTNAME</span>=<span class="string">"xx.com"</span></div></pre></td></tr></table></figure>

<p>而且，要注意得是，一般<code>key=value</code>的等号两边不应该有空格，因为大多数脚本都是直接 source 配置文件的（当然，也有部分脚本是会自己处理配置文件格式），使用起来很简单，基本上没有解析的操作：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ cat /etc/init.d/network</div><div class="line"><span class="keyword">if</span> [ ! <span class="operator">-f</span> /etc/sysconfig/network ]; <span class="keyword">then</span></div><div class="line">    <span class="keyword">exit</span> <span class="number">0</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="comment">#</span></div><div class="line">. /etc/sysconfig/network</div></pre></td></tr></table></figure>

<p>理所当然，这种格式无法满足更复杂的配置文件需求，比如 ini 格式的 section。那么，在 shell 中除了满世界去找一个解析库之外，能有什么方法可以实现呢？</p>
<h3 id="扩展_key=value_文本格式配置">扩展 key=value 文本格式配置</h3>
<p>假设，我们管理着 n 个集群，每个集群配置项都是一样的，我们需要在 shell 脚本中，可以根据集群的名称来导入对应的配置。</p>
<p>下面我们介绍一种最简单的方法，只需要针对第一种格式扩展下即可。我们创建一个配置文件目录<code>conf.d</code>，在这个目录下存放各个集群的配置文件。每个集群对应一个配置文件，文件名为集群名称，例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">cat</span> <span class="keyword">conf</span>.<span class="keyword">d</span>/CLUSTER_A</div><div class="line">c_cluster_name=<span class="string">"CLUSTER_A"</span></div><div class="line">c_cluster_type=<span class="number">1</span></div></pre></td></tr></table></figure>

<p>在脚本中，我们可以这样来导入相应集群的配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">function <span class="function"><span class="title">load_config</span></span>()</div><div class="line">{</div><div class="line">    local cluster_name=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [ <span class="operator">-f</span> <span class="string">"conf.d/<span class="variable">$cluster_name</span>"</span> ]; <span class="keyword">then</span></div><div class="line">        . conf.d/<span class="variable">$cluster_name</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">}</div><div class="line"><span class="comment">#</span></div><div class="line">load_config CLUSTER_A</div></pre></td></tr></table></figure>

<p>因为各个集群的配置文件相互独立，所以如果包含一些全局范围的配置项，需要在每个配置文件中都增加。或者，再增加一个入口的配置文件：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat global.conf</span></div><div class="line"><span class="variable">g_conf_dir=</span>conf.d   <span class="comment"># 配置文件目录</span></div><div class="line"><span class="variable">g_version=</span><span class="string">"0.1"</span>  <span class="comment"># 全局配置</span></div></pre></td></tr></table></figure>

<p>脚本相应调整下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">GLOBAL_CONF=/etc/xxx/global.conf</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="operator">-f</span> <span class="string">"<span class="variable">$GLOBAL_CONF</span>"</span> ]; <span class="keyword">then</span></div><div class="line">    . <span class="variable">$GLOBAL_CONF</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$g_conf_dir</span>"</span> != /* ]]; <span class="keyword">then</span>  <span class="comment"># 如果是相对路径</span></div><div class="line">    g_conf_dir=<span class="string">"<span class="variable">$(dirname $GLOBAL_CONF)</span>/<span class="variable">$g_conf_dir</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">function <span class="function"><span class="title">load_config</span></span>()</div><div class="line">{</div><div class="line">    local cluster_name=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [ <span class="operator">-f</span> <span class="string">"<span class="variable">$g_conf_dir</span>/<span class="variable">$cluster_name</span>"</span> ]; <span class="keyword">then</span></div><div class="line">        . <span class="variable">$g_conf_dir</span>/<span class="variable">$cluster_name</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">}</div><div class="line"></div><div class="line">load_config CLUSTER_A</div></pre></td></tr></table></figure>

<h3 id="类_ini_配置格式">类 ini 配置格式</h3>
<p>第二种方法，基本上已经可以解决我们之前假设中提出的需求，简单而且实现方便，不足的是配置文件比较零散，管理上可能不是很方便。如果，你仍然倾向于一种类似 ini 格式的配置，可以试试下面这种方法。</p>
<p>在这种场景下，每个集群应该是一个独立的 section，所以转换成 ini 格式，配置文件应该是这样的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="title">[DEFAULT]</span></div><div class="line"><span class="setting">g_version=<span class="value"><span class="string">"0.1"</span>     ; 全局配置</span></span></div><div class="line"></div><div class="line"><span class="title">[CLUSTER_A]</span></div><div class="line"><span class="setting">c_cluster_name=<span class="value"><span class="string">"CLUSTER_A"</span></span></span></div><div class="line"><span class="setting">c_cluster_type=<span class="value"><span class="number">1</span></span></span></div></pre></td></tr></table></figure>

<p>但是，我们前面提到过，原生的 shell 是很难去解析 ini 格式的配置文件的，所以上面的形式还得变化下，我们用 shell 中的函数来模拟 section：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ cat cluster.conf</div><div class="line"><span class="preprocessor"># global config</span></div><div class="line">g_version=<span class="string">"0.1"</span>  <span class="preprocessor"># 全局配置</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">section_cluster_a</span><span class="params">()</span></span></div><div class="line">{</div><div class="line">    c_cluster_name=<span class="string">"CLUSTER_A"</span></div><div class="line">    c_cluster_type=<span class="number">1</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">section_cluster_b</span><span class="params">()</span></span></div><div class="line">{</div><div class="line">    c_cluster_name=<span class="string">"CLUSTER_B"</span></div><div class="line">    c_cluster_type=<span class="number">1</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>配套的配置文件解析库：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">$ cat config.sh</div><div class="line"><span class="comment">#!/bin/echo Warnning, this library must only be sourced!</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ ! <span class="operator">-f</span> <span class="string">"cluster.conf"</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="keyword">exit</span> <span class="number">0</span>  <span class="comment"># or print error before exit</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">. cluster.conf</div><div class="line"></div><div class="line">function <span class="function"><span class="title">load_config</span></span>()</div><div class="line">{</div><div class="line">    local cluster_name=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>"</span> | tr A-Z.- a-z__)  <span class="comment"># 特殊符号转换</span></div><div class="line">    section_<span class="variable">$cluster_name</span> &&gt;/dev/null  <span class="comment"># 执行函数，将集群的配置赋值给对应的全局变量</span></div><div class="line">}</div><div class="line"></div><div class="line">function <span class="function"><span class="title">option</span></span>()</div><div class="line">{</div><div class="line">    local opt_name=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$opt_name</span>"</span> != c_* ]]; <span class="keyword">then</span>   <span class="comment"># no "c_" prefix</span></div><div class="line">        opt_name=<span class="string">"c_<span class="variable">$opt_name</span>"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">${!opt_name}</span>"</span>  <span class="comment"># indirect reference by variable name</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>测试脚本：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">cat</span> test.<span class="keyword">sh</span></div><div class="line">. config.<span class="keyword">sh</span></div><div class="line"></div><div class="line">load_config CLUSTER_B</div><div class="line">option cluster_name  # puts CLUSTER_B</div></pre></td></tr></table></figure>

<p>在<code>PET</code>运维工具中，我是采取了第三种方式来维护集群的配置文件，基本上可以满足绝大多数需求。大家也可以贴出你们是怎么设计shell的配置文件的？我们探讨下!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2010-05-11T08:53:37.000Z"><a href="/2010/05/11/transient-volatile-strictfp/">5月 11 2010</a></time>
      
      
  
    <h1 class="title"><a href="/2010/05/11/transient-volatile-strictfp/">java中的transient, volatile, strictfp关键字用法</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="Volatile_-_修饰符告诉编译器被volatile修饰的变量可以被程序的其他部分改变。在多线程程序中，有时两个或更多地线程共享一个相同的实例变量。考虑效率问题，每个线程可以自己保存该共享变量的私有拷贝。实际的变量副本在不同的时候更新，比如当进入synchronized方法时。">Volatile - 修饰符告诉编译器被volatile修饰的变量可以被程序的其他部分改变。在多线程程序中，有时两个或更多地线程共享一个相同的实例变量。考虑效率问题，每个线程可以自己保存该共享变量的私有拷贝。实际的变量副本在不同的时候更新，比如当进入synchronized方法时。</h3>
<p>该变量声明为volatile（不稳定的），这就指示JVM，这个变量是不稳定的，每次使用它都到主存中进行读取。一般说来，多任务环境下各任务间共享的标志都应该加volatile修饰。</p>
<p>volatile修饰变量。在每次被线程访问时，都强迫从共享内存中重读该成员变量的值。而且，当成员变量发生变化时，强迫线程将变化值回写到共享内存。这样在任何时刻，两个不同的线程总是看到某个成员变量的同一个值。</p>
<p>Reference: </p>
<p><a href="http://developer.51cto.com/art/201105/264855.htm" target="_blank" rel="external">http://developer.51cto.com/art/201105/264855.htm</a></p>
<p><a href="http://www.cnblogs.com/aigongsi/archive/2012/04/01/2429166.html" target="_blank" rel="external">http://www.cnblogs.com/aigongsi/archive/2012/04/01/2429166.html</a></p>
<h3 id="Strictfp_-_确保浮点运算，其意思是FP-strict，即_strict_float_point_(精确浮点)，也就是说精确浮点的意思。在java虚拟机进行浮点运算时，如果没有指定strictfp关键字时，Java的编译器以及运行环境在对浮点数的表达式是采取一种近似于我行我素的行为来完成这些操作，以至于得到的结果往往无法令你满意。而一旦使用了strictfp来声明一个类，借口或者方法时，那么所声明的范围内java的编译器以及运行环境会完全依照浮点规范IEEE-754来执行。">Strictfp - 确保浮点运算，其意思是FP-strict，即 strict float point (精确浮点)，也就是说精确浮点的意思。在java虚拟机进行浮点运算时，如果没有指定strictfp关键字时，Java的编译器以及运行环境在对浮点数的表达式是采取一种近似于我行我素的行为来完成这些操作，以至于得到的结果往往无法令你满意。而一旦使用了strictfp来声明一个类，借口或者方法时，那么所声明的范围内java的编译器以及运行环境会完全依照浮点规范IEEE-754来执行。</h3>
<p>你可以将一个类、接口以及方法声明为strictfp，但是不允许对接口中的方法以及构造函数声明strictfp关键字。</p>
<h3 id="native_关键字">native 关键字</h3>
<p>native是方法修饰符。Native方法是由另外一种语言（如c/c++，FORTRAN，汇编）实现的本地方法。因为在外部实现了方法，所以在java代码中，就不需要声明了，有点类似于借口方法。Native可以和其他一些修饰符连用，但是abstract方法和Interface方法不能用native来修饰。</p>
<p>为什么需要使用native method？请参考：<br><a href="http://www.javaeye.com/topic/72543" target="_blank" rel="external">http://www.javaeye.com/topic/72543</a> java Native Method初涉  </p>
<h3 id="Transient_-_声明一个实例变量，当对象存储或序列化时，它的值不需要维持">Transient - 声明一个实例变量，当对象存储或序列化时，它的值不需要维持</h3>
<p>Java的serialization提供了一种持久化对象实例的机制。当持久化对象时，可能有一个特殊的对象数据成员，我们不想<br>用serialization机制来保存它。为了在一个特定对象的一个域上关闭serialization，可以在这个域前加上关键字transient。<br>transient是Java语言的关键字，用来表示一个域不是该对象串行化的一部分。当一个对象被串行化的时候，transient型变量的值不包括在串行化的表示中，然而非transient型的变量是被包括进去的。</p>
<p>Reference:</p>
<p><a href="http://www.blogjava.net/fhtdy2004/archive/2009/06/20/286112.html" target="_blank" rel="external">http://www.blogjava.net/fhtdy2004/archive/2009/06/20/286112.html</a></p>
<h4 id="1-transient的作用及使用方法">1.transient的作用及使用方法</h4>
<p>我们都知道一个对象只要实现了Serilizable接口，这个对象就可以被序列化，java的这种序列化模式为开发者提供了很多便利，我们可以不必关系具体序列化的过程，只要这个类实现了Serilizable接口，这个类的所有属性和方法都会自动序列化。<br>然而在实际开发过程中，我们常常会遇到这样的问题，这个类的有些属性需要序列化，而其他属性不需要被序列化，打个比方，如果一个用户有一些敏感信息（如密码，银行卡号等），为了安全起见，不希望在网络操作（主要涉及到序列化操作，本地序列化缓存也适用）中被传输，这些信息对应的变量就可以加上transient关键字。换句话说，这个字段的生命周期仅存于调用者的内存中而不会写到磁盘里持久化。<br>总之，java 的transient关键字为我们提供了便利，你只需要实现Serilizable接口，将不需要序列化的属性前添加关键字transient，序列化对象的时候，这个属性就不会序列化到指定的目的地中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.FileInputStream;  </div><div class="line"><span class="keyword">import</span> java.io.FileNotFoundException;  </div><div class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </div><div class="line"><span class="keyword">import</span> java.io.IOException;  </div><div class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </div><div class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </div><div class="line"><span class="keyword">import</span> java.io.Serializable;  </div><div class="line">  </div><div class="line"><span class="javadoc">/** </span></div><div class="line"> *<span class="javadoctag"> @description</span> 使用transient关键字不序列化某个变量 </div><div class="line"> *        注意读取的时候，读取数据的顺序一定要和存放数据的顺序保持一致 </div><div class="line"> *         </div><div class="line"> *<span class="javadoctag"> @author</span> zxc </div><div class="line"> *<span class="javadoctag"> @date</span>  2011-12-09 </div><div class="line"> */  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientTest</span> </span>{  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) {  </div><div class="line">          </div><div class="line">        User user = <span class="keyword">new</span> User();  </div><div class="line">        user.setUsername(<span class="string">"zxc"</span>);  </div><div class="line">        user.setPasswd(<span class="string">"123456"</span>);  </div><div class="line">          </div><div class="line">        System.out.println(<span class="string">"read before Serializable: "</span>);  </div><div class="line">        System.out.println(<span class="string">"username: "</span> + user.getUsername());  </div><div class="line">        System.err.println(<span class="string">"password: "</span> + user.getPasswd());  </div><div class="line">          </div><div class="line">        <span class="keyword">try</span> {  </div><div class="line">            ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(  </div><div class="line">                    <span class="keyword">new</span> FileOutputStream(<span class="string">"/home/zxc/user.txt"</span>));  </div><div class="line">            os.writeObject(user); <span class="comment">// 将User对象写进文件  </span></div><div class="line">            os.flush();  </div><div class="line">            os.close();  </div><div class="line">        } <span class="keyword">catch</span> (FileNotFoundException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        } <span class="keyword">catch</span> (IOException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        }  </div><div class="line">        <span class="keyword">try</span> {  </div><div class="line">            ObjectInputStream is = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(  </div><div class="line">                    <span class="string">"/home/zxc/user.txt"</span>));  </div><div class="line">            user = (User) is.readObject(); <span class="comment">// 从流中读取User的数据  </span></div><div class="line">            is.close();  </div><div class="line">              </div><div class="line">            System.out.println(<span class="string">"\nread after Serializable: "</span>);  </div><div class="line">            System.out.println(<span class="string">"username: "</span> + user.getUsername());  </div><div class="line">            System.err.println(<span class="string">"password: "</span> + user.getPasswd());  </div><div class="line">              </div><div class="line">        } <span class="keyword">catch</span> (FileNotFoundException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        } <span class="keyword">catch</span> (IOException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        } <span class="keyword">catch</span> (ClassNotFoundException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        }  </div><div class="line">    }  </div><div class="line">}  </div><div class="line">  </div><div class="line">class User implements Serializable {  </div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">9294180014912103005</span>L;    </div><div class="line">      </div><div class="line">    <span class="keyword">private</span> String username;  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> String passwd;  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> String <span class="title">getUsername</span>() {  </div><div class="line">        <span class="keyword">return</span> username;  </div><div class="line">    }  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span>(String username) {  </div><div class="line">        <span class="keyword">this</span>.username = username;  </div><div class="line">    }  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> String <span class="title">getPasswd</span>() {  </div><div class="line">        <span class="keyword">return</span> passwd;  </div><div class="line">    }  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPasswd</span>(String passwd) {  </div><div class="line">        <span class="keyword">this</span>.passwd = passwd;  </div><div class="line">    }  </div><div class="line">}</div></pre></td></tr></table></figure>

<p>输出为:</p>
<pre><code>    <span class="built_in">read</span> <span class="keyword">before</span> Serializable:   
    username: zxc  
    password: <span class="number">123456</span>  

    <span class="built_in">read</span> <span class="keyword">after</span> Serializable:   
    username: zxc  
    password: <span class="constant">null</span>
</code></pre><p>密码字段为null，说明反序列化时根本没有从文件中获取到信息。</p>
<h4 id="2-_transient使用小结">2. transient使用小结</h4>
<ul>
<li>一旦变量被transient修饰，变量将不再是对象持久化的一部分，该变量内容在序列化后无法获得访问。</li>
<li>transient关键字只能修饰变量，而不能修饰方法和类。注意，本地变量是不能被transient关键字修饰的。变量如果是用户自定义类变量，则该类需要实现Serializable接口。</li>
<li>被transient关键字修饰的变量不再能被序列化，一个静态变量不管是否被transient修饰，均不能被序列化。<br>第三点可能有些人很迷惑，因为发现在User类中的username字段前加上transient关键字后，程序运行结果依然不变，即static类型的username也读出来为“zxc”了，这不与第三点说的矛盾吗？实际上是这样的：第三点确实没错（一个静态变量不管是否被transient修饰，均不能被序列化），反序列化后类中static型变量username的值为当前JVM中对应static变量的值，这个值是JVM中的不是反序列化得出的，不相信？好吧，下面我来证明：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.FileInputStream;  </div><div class="line"><span class="keyword">import</span> java.io.FileNotFoundException;  </div><div class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </div><div class="line"><span class="keyword">import</span> java.io.IOException;  </div><div class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </div><div class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </div><div class="line"><span class="keyword">import</span> java.io.Serializable;  </div><div class="line">  </div><div class="line"><span class="javadoc">/** </span></div><div class="line"> *<span class="javadoctag"> @description</span> 使用transient关键字不序列化某个变量 </div><div class="line"> *        注意读取的时候，读取数据的顺序一定要和存放数据的顺序保持一致 </div><div class="line"> *         </div><div class="line"> *<span class="javadoctag"> @author</span> zxc </div><div class="line"> *<span class="javadoctag"> @date</span>  2011-12-09 </div><div class="line"> */  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientTest</span> </span>{  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) {  </div><div class="line">          </div><div class="line">        User user = <span class="keyword">new</span> User();  </div><div class="line">        user.setUsername(<span class="string">"zxc"</span>);  </div><div class="line">        user.setPasswd(<span class="string">"123456"</span>);  </div><div class="line">          </div><div class="line">        System.out.println(<span class="string">"read before Serializable: "</span>);  </div><div class="line">        System.out.println(<span class="string">"username: "</span> + user.getUsername());  </div><div class="line">        System.err.println(<span class="string">"password: "</span> + user.getPasswd());  </div><div class="line">          </div><div class="line">        <span class="keyword">try</span> {  </div><div class="line">            ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(  </div><div class="line">                    <span class="keyword">new</span> FileOutputStream(<span class="string">"/home/zxc/user.txt"</span>));  </div><div class="line">            os.writeObject(user); <span class="comment">// 将User对象写进文件  </span></div><div class="line">            os.flush();  </div><div class="line">            os.close();  </div><div class="line">        } <span class="keyword">catch</span> (FileNotFoundException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        } <span class="keyword">catch</span> (IOException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        }  </div><div class="line">        <span class="keyword">try</span> {  </div><div class="line">            <span class="comment">// 在反序列化之前改变username的值  </span></div><div class="line">            User.username = <span class="string">"alibaba"</span>;  </div><div class="line">              </div><div class="line">            ObjectInputStream is = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(  </div><div class="line">                    <span class="string">"/home/zxc/user.txt"</span>));  </div><div class="line">            user = (User) is.readObject(); <span class="comment">// 从流中读取User的数据  </span></div><div class="line">            is.close();  </div><div class="line">              </div><div class="line">            System.out.println(<span class="string">"\nread after Serializable: "</span>);  </div><div class="line">            System.out.println(<span class="string">"username: "</span> + user.getUsername());  </div><div class="line">            System.err.println(<span class="string">"password: "</span> + user.getPasswd());  </div><div class="line">              </div><div class="line">        } <span class="keyword">catch</span> (FileNotFoundException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        } <span class="keyword">catch</span> (IOException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        } <span class="keyword">catch</span> (ClassNotFoundException e) {  </div><div class="line">            e.printStackTrace();  </div><div class="line">        }  </div><div class="line">    }  </div><div class="line">}  </div><div class="line">  </div><div class="line">class User implements Serializable {  </div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">9294180014912103005</span>L;    </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String username;  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> String passwd;  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> String <span class="title">getUsername</span>() {  </div><div class="line">        <span class="keyword">return</span> username;  </div><div class="line">    }  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span>(String username) {  </div><div class="line">        <span class="keyword">this</span>.username = username;  </div><div class="line">    }  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> String <span class="title">getPasswd</span>() {  </div><div class="line">        <span class="keyword">return</span> passwd;  </div><div class="line">    }  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPasswd</span>(String passwd) {  </div><div class="line">        <span class="keyword">this</span>.passwd = passwd;  </div><div class="line">    }  </div><div class="line">}</div></pre></td></tr></table></figure>

<p>输出为:</p>
<pre><code>    <span class="built_in">read</span> <span class="keyword">before</span> Serializable:   
    username: zxc  
    password: <span class="number">123456</span>  

    <span class="built_in">read</span> <span class="keyword">after</span> Serializable:   
    username: alibaba  
    password: <span class="constant">null</span>
</code></pre><p>这说明反序列化后类中static型变量username的值为当前JVM中对应static变量的值，为修改后alibaba，而不是序列化时的值zxc。</p>
<h4 id="3-_transient使用细节——被transient关键字修饰的变量真的不能被序列化吗？">3. transient使用细节——被transient关键字修饰的变量真的不能被序列化吗？</h4>
<p>思考下面的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.Externalizable;  </div><div class="line"><span class="keyword">import</span> java.io.File;  </div><div class="line"><span class="keyword">import</span> java.io.FileInputStream;  </div><div class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </div><div class="line"><span class="keyword">import</span> java.io.IOException;  </div><div class="line"><span class="keyword">import</span> java.io.ObjectInput;  </div><div class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </div><div class="line"><span class="keyword">import</span> java.io.ObjectOutput;  </div><div class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </div><div class="line">  </div><div class="line"><span class="javadoc">/** </span></div><div class="line"> *<span class="javadoctag"> @descripiton</span> Externalizable接口的使用 </div><div class="line"> *  </div><div class="line"> *<span class="javadoctag"> @author</span> Alexia </div><div class="line"> *<span class="javadoctag"> @date</span> 2011-12-09 </div><div class="line"> */  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExternalizableTest</span> <span class="keyword">implements</span> <span class="title">Externalizable</span> </span>{  </div><div class="line">  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> String content = <span class="string">"是的,我将会被序列化,不管我是否被transient关键字修饰"</span>;  </div><div class="line">  </div><div class="line">    <span class="annotation">@Override</span>  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeExternal</span>(ObjectOutput out) <span class="keyword">throws</span> IOException {  </div><div class="line">        out.writeObject(content);  </div><div class="line">    }  </div><div class="line">  </div><div class="line">    <span class="annotation">@Override</span>  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span>(ObjectInput in) <span class="keyword">throws</span> IOException,  </div><div class="line">            ClassNotFoundException {  </div><div class="line">        content = (String) in.readObject();  </div><div class="line">    }  </div><div class="line">  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) <span class="keyword">throws</span> Exception {  </div><div class="line">          </div><div class="line">        ExternalizableTest et = <span class="keyword">new</span> ExternalizableTest();  </div><div class="line">        ObjectOutput out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(  </div><div class="line">                <span class="keyword">new</span> File(<span class="string">"test"</span>)));  </div><div class="line">        out.writeObject(et);  </div><div class="line">  </div><div class="line">        ObjectInput in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(  </div><div class="line">                <span class="string">"test"</span>)));  </div><div class="line">        et = (ExternalizableTest) in.readObject();  </div><div class="line">        System.out.println(et.content);  </div><div class="line">  </div><div class="line">        out.close();  </div><div class="line">        in.close();  </div><div class="line">    }  </div><div class="line">}</div></pre></td></tr></table></figure>

<p>content变量会被序列化吗？好吧，我把答案都输出来了，是的，运行结果就是：</p>
<pre><code>    是的,我将会被序列化,不管我是否被<span class="keyword">transient</span>关键字修饰
</code></pre><p>这是为什么呢，不是说类的变量被transient关键字修饰以后将不能序列化了吗？</p>
<p>我们知道在Java中，对象的序列化可以通过实现两种接口来实现，若实现的是Serializable接口，则所有的序列化将会自动进行，若实现的是Externalizable接口，则没有任何东西可以自动序列化，需要在writeExternal方法中进行手工指定所要序列化的变量，这与是否被transient修饰无关。因此第二个例子输出的是变量content初始化的内容，而不是null。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>








<ul class="page-direction" id="page-direction">
    <li><a class="page-prev icon-chevron-sign-left" href="javascript:;" title="上一页"></a></li>
    <li><a class="page-next icon-chevron-sign-right" href="javascript:;" title="下一页"></a></li>
</ul>

    <nav id="page-list" class="page-list"><a class="extend prev" rel="prev" href="/page/6/">Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/8/">Next</a></nav>

<nav id="pagination">
  
    <a href="/page/6/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/8/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="text" name="q" results="0" placeholder="搜一下">
    <i class="icon-search"></i>
    <input type="hidden" name="q" value="site:lawrence-zxc.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/Git/">Git</a><small>2</small></li>
  
    <li><a href="/tags/Java/">Java</a><small>24</small></li>
  
    <li><a href="/tags/JavaScript/">JavaScript</a><small>4</small></li>
  
    <li><a href="/tags/LeetCode/">LeetCode</a><small>2</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>21</small></li>
  
    <li><a href="/tags/Mac-Unix/">Mac/Unix</a><small>1</small></li>
  
    <li><a href="/tags/Maven/">Maven</a><small>1</small></li>
  
    <li><a href="/tags/Mysql/">Mysql</a><small>2</small></li>
  
    <li><a href="/tags/Nginx/">Nginx</a><small>5</small></li>
  
    <li><a href="/tags/Oracle/">Oracle</a><small>4</small></li>
  
    <li><a href="/tags/Python/">Python</a><small>3</small></li>
  
    <li><a href="/tags/XMPP/">XMPP</a><small>2</small></li>
  
    <li><a href="/tags/其他/">其他</a><small>0</small></li>
  
    <li><a href="/tags/开始/">开始</a><small>3</small></li>
  
    <li><a href="/tags/技术/">技术</a><small>1</small></li>
  
    <li><a href="/tags/旅行/">旅行</a><small>1</small></li>
  
    <li><a href="/tags/架构/">架构</a><small>3</small></li>
  
    <li><a href="/tags/生活/">生活</a><small>1</small></li>
  
    <li><a href="/tags/读书/">读书</a><small>0</small></li>
  
    <li><a href="/tags/随感/">随感</a><small>7</small></li>
  
  </ul>
</div>


  <div class="trace-invest">
    <span>
        <a href="https://github.com/Lawrence-zxc" target="_blank">欢迎光临我的技术Blog网站 </br>Fork me on Github</a>
    </span>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/04/04/jishu-hehuoren/">技术合伙人为什么喜欢谈钱胜过情怀？</a>
      </li>
    
      <li>
        <a href="/2015/04/01/reverse-o2o/">分享一个用户自发需求的反向O2O设想</a>
      </li>
    
      <li>
        <a href="/2015/03/08/shujiawang/">面向企业和个人O2O图书租赁服务设想</a>
      </li>
    
      <li>
        <a href="/2015/03/05/pingjiaapp/">关于电商商品评价评论独立第三方平台构想</a>
      </li>
    
      <li>
        <a href="/2015/01/23/suishoupai/">关于随手拍图片人脸识别APP需求的想法</a>
      </li>
    
      <li>
        <a href="/2014/11/25/xushen/">徐神的诗</a>
      </li>
    
      <li>
        <a href="/2014/11/20/openfire/">Openfire服务端错误解决</a>
      </li>
    
      <li>
        <a href="/2014/11/16/xmpp/">xmpp通信过程分析</a>
      </li>
    
      <li>
        <a href="/2014/11/10/oracle-index/">Oracle大批量高效地更新大数据表索引字段</a>
      </li>
    
      <li>
        <a href="/2014/11/10/oracle-partition/">Oracle Partition Common Usage</a>
      </li>
    
      <li>
        <a href="/2014/10/28/jvm-strace/">jvm退出的原因,使用strace定位</a>
      </li>
    
      <li>
        <a href="/2014/10/28/load-balancing/">负载均衡和过载保护</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Jeck Zhang
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a5eb19e532c0b101d72226b1325e6a78";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</body>

</html>