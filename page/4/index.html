<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 4 页 | Jeck_Zhang</title>
  <meta name="author" content="Jeck Zhang">
  
  <meta name="description" content="zxc&#39;s blog | java | ruby | perl | linux">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Jeck_Zhang"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link type="image/x-icon" href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Jeck_Zhang" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45019001-1', 'topdna.org');
  ga('send', 'pageview');

</script>


</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Jeck_Zhang</a></h1>
  <h2><a href="/">Write the Code. Change the World.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="http://weibo.com/zxc337">weibo</a></li>
    
      <li><a href="/2014/10/01/aboutMe/">关于</a></li>
    
      <li><a href="/tags/随感/">随感</a></li>
    
      <li><a href="/tags/技术/">技术</a></li>
    
      <li><a href="/tags/理财/">理财</a></li>
    
      <li><a href="/tags/生活/">生活</a></li>
    
      <li><a href="/archives">归档</a></li>
    
    <li><a href="/atom.xml">RSS</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2013-06-18T08:15:01.000Z"><a href="/2013/06/18/hello/">6月 18 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/06/18/hello/">tomcat关闭时dubbo consumer导致jvm进程无法退出的问题</a></h1>
  

    </header>
    <div class="entry">
      
        <p>在apache-tomcat托管的应用里如果使用了dubbo的消费端，关闭tomcat时，会无法退出进程，应用会被关闭，connector端口也关闭了，但dubbo相关的一些线程仍存在，导致java进程并不会消失。</p>
<p>这其实是由非daemon线程引起的，jvm里当前main线程在退出时，只要存在非daemon的子线程，就不会退出jvm，哪怕这个非daemon的线程是在一个daemon线程里启动的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonTest</span> </span>{</div><div class="line"></div><div class="line">    <span class="keyword">static</span> class MyThread extends Thread {</div><div class="line">        <span class="keyword">public</span> <span class="title">MyThread</span>(<span class="keyword">boolean</span> isDaemon){</div><div class="line">            <span class="keyword">this</span>.setDaemon(isDaemon);</div><div class="line">        }</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>(){</div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                Thread.sleep(<span class="number">1000</span>*<span class="number">10000</span>);;</div><div class="line">            } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) <span class="keyword">throws</span> Exception{</div><div class="line">        Thread t1 = <span class="keyword">new</span> MyThread(<span class="keyword">true</span>);</div><div class="line">        Thread t2 = <span class="keyword">new</span> MyThread(<span class="keyword">true</span>);</div><div class="line">        Thread t3 = <span class="keyword">new</span> MyThread(<span class="keyword">true</span>);</div><div class="line">        Thread t4 = <span class="keyword">new</span> MyThread(<span class="keyword">true</span>) {</div><div class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">                <span class="keyword">try</span> {</div><div class="line">                    <span class="keyword">new</span> MyThread(<span class="keyword">false</span>).start(); <span class="comment">//非daemon</span></div><div class="line">                    Thread.sleep(<span class="number">1000</span> * <span class="number">10000</span>);</div><div class="line">                } <span class="keyword">catch</span> (Exception e) {</div><div class="line">                }</div><div class="line">            }</div><div class="line">        };</div><div class="line"></div><div class="line"></div><div class="line">        t1.start();</div><div class="line">        t2.start();</div><div class="line">        t3.start();</div><div class="line">        t4.start();</div><div class="line"></div><div class="line">        Thread.sleep(<span class="number">2000</span>);</div><div class="line">        System.out.println(<span class="string">"main thread quit"</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>上面启动了4个子线程，都是daemon的，其中有一个子线程又启动了一个非daemon线程，结果主线程退出时，jvm进程并不会退出，并且其他daemon线程也继续运行。</p>
<p>Dubbo的线程都是daemon的，不过它使用的netty框架却有一个非daemon的“Hashed wheel timer”线程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="string">"Hashed wheel timer #1"</span> #<span class="number">1582</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0x00002aaac5054800</span> nid=<span class="number">0x7fd3</span> waiting on condition [<span class="number">0x0000000041262000</span>]</div><div class="line">   java.lang.Thread.State: TIMED_WAITING (sleeping)</div><div class="line">    at java.lang.Thread.sleep(Native Method)</div><div class="line">    at org.jboss.netty.util.HashedWheelTimer$Worker.waitForNextTick(HashedWheelTimer.java:<span class="number">459</span>)</div><div class="line">    at org.jboss.netty.util.HashedWheelTimer$Worker.run(HashedWheelTimer.java:<span class="number">376</span>)</div><div class="line">    at org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:<span class="number">108</span>)</div><div class="line">    at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</div></pre></td></tr></table></figure>

<p>正是这个非daemon线程，导致tomcat的主线程退出后，jvm进程没能退出。类似的问题以前在HSF2里也存在，后来已经解决了。dubbo的这个问题可以通过kill来结束。</p>
<p>在tomcat的脚本里，先使用正常的方式(viaport)停止tomcat，在不成功之后会尝试”kill”方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># stop failed. Shutdown port disabled? Try a normal kill.</div><div class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ]; then</div><div class="line">    <span class="keyword">if</span> [ ! -z <span class="string">"$CATALINA_PID"</span> ]; then</div><div class="line">      echo <span class="string">"The stop command failed. Attempting to signal the process to stop through OS signal."</span></div><div class="line">      kill -<span class="number">15</span> `cat <span class="string">"$CATALINA_PID"</span>` &gt;/dev/<span class="keyword">null</span> <span class="number">2</span>&gt;&<span class="number">1</span></div><div class="line">    fi</div><div class="line">fi</div></pre></td></tr></table></figure>

<p>但这里的一个问题是”$CATALINA_PID”默认并没有被记录起来，所以没有执行kill，需要运维人员主意这一点。</p>
<p>// 补充<br>发现这个问题并不是一定发生的，只在dubbo发生了某种异常的情况下会有。正常情况下tomcat关闭(viaport方式)还是可以让jvm进程退出的(估计dubbo或netty有逻辑去处理那个timer线程），但这个异常是怎么回事产生的暂没有精力去跟踪了。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2013-04-02T09:20:33.000Z"><a href="/2013/04/02/nginx-upstream/">4月 2 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/04/02/nginx-upstream/">nginx upstream的5种配置方式</a></h1>
  

    </header>
    <div class="entry">
      
        <p>1、轮询（默认）<br>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。<br>weight指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。<br>例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="title">upstream</span> bakend {</div><div class="line">     <span class="title">server</span> <span class="number">192.168.0.14</span> weight=<span class="number">10</span>;</div><div class="line">     <span class="title">server</span> <span class="number">192.168.0.15</span> weight=<span class="number">10</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>2、ip_hash<br>每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。<br>例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream bakend {</div><div class="line">     ip_hash;</div><div class="line">     server 192.168.0.14:88;</div><div class="line">     server 192.168.0.15:80;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>3、fair（第三方）<br>按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream backend {</div><div class="line">    server server1;</div><div class="line">    server server2;</div><div class="line">    fair;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>4、url_hash（第三方）<br>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。<br>例：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="title">upstream</span> backend {</div><div class="line">    <span class="title">server</span> squid1:<span class="number">3128</span>;</div><div class="line">    <span class="title">server</span> squid2:<span class="number">3128</span>;</div><div class="line">    <span class="title">hash</span>   <span class="variable">$request_uri</span>;</div><div class="line">    <span class="title">hash_method</span> crc32;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>5、tips:<br>upstream bakend{#定义负载均衡设备的Ip及设备状态</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ip_hash;</div><div class="line">    server 127.0.0.1:9090 down;</div><div class="line">    server 127.0.0.1:8080 weight=2;</div><div class="line">    server 127.0.0.1:6060;</div><div class="line">    server 127.0.0.1:7070 backup;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>在需要使用负载均衡的server中增加</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="title">proxy_pass</span> <span class="url">http://bakend/</span>;</div></pre></td></tr></table></figure>

<p>每个设备的状态设置为:</p>
<ul>
<li>1.down 表示单前的server暂时不参与负载</li>
<li>2.weight 默认为1.weight越大，负载的权重就越大。</li>
<li>3.max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误</li>
<li>4.fail_timeout:max_fails次失败后，暂停的时间。</li>
<li>5.backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。<br>  nginx支持同时设置多组的负载均衡，用来给不用的server来使用。<br>  client_body_in_file_only 设置为On 可以讲client post过来的数据记录到文件中用来做debug<br>  client_body_temp_path 设置记录文件的目录 可以设置最多3层目录<br>  location 对URL进行匹配.可以进行重定向或者进行新的代理 负载均衡</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2013-03-21T04:00:35.000Z"><a href="/2013/03/21/nginx-gzip/">3月 21 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/03/21/nginx-gzip/">nginx启用gzip压缩</a></h1>
  

    </header>
    <div class="entry">
      
        <p><br></p>
<p>网站的访问量如果越来越高，那么就需要考虑带宽的问题了，因为流量会提升一些费用成本，没有经过压缩的文本也会影响网页的加载速度。当然我目前对这个考虑还是远了，因为流量对我来说还没感受到那么大的问题。只是考虑用户提升访问速度。</p>
<p>当然了gzip压缩在当前HTTP传输来说还是主流的，所有的服务器应该都能启用gzip压缩才对。</p>
<p>对于Nginx来启用gzip很简单。打开nginx.conf配置进行编辑：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="title">http</span> {   <span class="comment">#在http里面进行设置</span></div><div class="line"> </div><div class="line">    <span class="comment">#开启gzip压缩</span></div><div class="line">    <span class="title">gzip</span>  <span class="built_in">on</span>;</div><div class="line"> </div><div class="line">    <span class="comment">#启用gzip压缩最小长度必须大于1kB，否则不启用压缩</span></div><div class="line">    <span class="title">gzip_min_length</span> <span class="number">1k</span>;</div><div class="line"> </div><div class="line">    <span class="comment"># gzip压缩的缓冲区</span></div><div class="line">    <span class="title">gzip_buffers</span> <span class="number">4</span> <span class="number">16k</span>;</div><div class="line"> </div><div class="line">    <span class="comment"># gzip压缩的等级，0-9之间，数字越大，压缩率越高，但是cpu消耗也大。</span></div><div class="line">    <span class="title">gzip_comp_level</span> <span class="number">9</span>;</div><div class="line"> </div><div class="line">    <span class="comment"># 启用gzip的文件类型，一般text、css、json、javascript、xml进行压缩，image最好不要压缩了吧？</span></div><div class="line">    <span class="title">gzip_types</span> text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;</div><div class="line"> </div><div class="line">    <span class="comment"># 和http头有关系，加个vary头，给代理服务器用的，有的浏览器支持压缩，有的不支持。</span></div><div class="line">    <span class="comment"># 因此，为避免浪费不支持的也压缩，需要根据客户端的HTTP头来判断，是否需要压缩。</span></div><div class="line">    <span class="title">gzip_vary</span> <span class="built_in">on</span>;</div><div class="line"> </div><div class="line">    <span class="comment"># 好吧，IE6对gzip压缩不太好，但是应该要淘汰IE6了吧，你的受众是IE6用户，那么你也太没有魅力了。</span></div><div class="line">    <span class="comment">#gzip_disable "MSIE [1-6]\.";</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>推荐一个：<a href="http://gtmetrix.com/可以对页面访问速度进行一个打分，类似google" target="_blank" rel="external">http://gtmetrix.com/可以对页面访问速度进行一个打分，类似google</a> page speed。<br>还有一个，阿里测<a href="http://alibench.com/" target="_blank" rel="external">http://alibench.com/</a></p>
<h4 id="参考文章">参考文章</h4>
<ul>
<li><a href="http://blog.csdn.net/xzknet/article/details/7416148" target="_blank" rel="external">http://blog.csdn.net/xzknet/article/details/7416148</a></li>
<li><a href="http://www.veryhuo.com/a/view/51706.html" target="_blank" rel="external">http://www.veryhuo.com/a/view/51706.html</a></li>
<li><a href="http://willko.iteye.com/blog/667091" target="_blank" rel="external">http://willko.iteye.com/blog/667091</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2013-02-07T08:15:33.000Z"><a href="/2013/02/07/linux-share/">2月 7 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/02/07/linux-share/">Linux Shell编程分享总结</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="一-linux基础命令">一.linux基础命令</h2>
<h3 id="1-系统相关">1.系统相关</h3>
<p>$PATH</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">echo</span> <span class="variable">$PATH</span> | tr <span class="string">':'</span> <span class="string">'\n'</span>`; <span class="keyword">do</span> ls <span class="variable">$i</span> <span class="number">2</span>&gt;/dev/null; <span class="keyword">done</span>               <span class="comment">#显示所有的linux命令</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">echo</span> <span class="variable">$PATH</span> |tr <span class="string">':'</span> <span class="string">'\n'</span>|grep -v <span class="string">"yueji"</span>|grep -v <span class="string">"home"</span>`; <span class="keyword">do</span> ls <span class="variable">$i</span> <span class="number">2</span>&gt;/dev/null; <span class="keyword">done</span></div></pre></td></tr></table></figure>

<p>crontab,at</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">crontab <span class="operator">-l</span> <span class="comment">#查看当前用户的计划任务  </span></div><div class="line">crontab -r <span class="comment">#删除</span></div><div class="line">crontab <span class="operator">-e</span> <span class="comment">#编辑</span></div></pre></td></tr></table></figure>

<p>时间程式的格式:<br>　　分钟f1 小时f2 日f3 月f4 星期f5 program<br>　　当 f1 为 <em> 时表示每分钟都要执行 program,f2 为 </em> 时表示每小时都要执行程式<br>　　当 f1 为 a-b 时表示从第 a 分钟到第 b 分钟这段时间内要执行,f2 为 a-b 时表示从第 a 到第 b 小时都要执行<br>　　当 f1 为 <em>/n 时表示每 n 分钟个时间间隔执行一次,f2 为 </em>/n 表示每 n 小时个时间间隔执行一次<br>　　当 f1 为 a, b, c,… 时表示第 a, b, c,… 分钟要执行,f2 为 a, b, c,… 时表示第 a, b, c…个小时要执行<br>　　每月每天每小时的第0分钟执行一次 /bin/top:<br>　　0 <em> </em> <em> </em> /bin/top </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">at <span class="number">23</span>:<span class="number">59</span> <span class="number">12</span>/<span class="number">31</span>/<span class="number">2013</span></div></pre></td></tr></table></figure>

<p>echo the end of world ! #定时任务(需要开启<code>/etc/init.d/atd start</code>)</p>
<p>系统命令 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">bg,fb,jobs <span class="comment">#进程与作业</span></div><div class="line">&   <span class="comment">#在后台挂起程序 </span></div><div class="line">^Z <span class="comment">#挂起(暂停)前台程序 </span></div><div class="line">fg <span class="comment">#将作业移到前台 </span></div><div class="line">suspend <span class="comment">#挂起(暂停)shell </span></div><div class="line">jobs <span class="comment">#显示作业信息 </span></div><div class="line">bg <span class="comment">#将作业移至后台 </span></div><div class="line">ps <span class="comment">#显示进程信息 </span></div><div class="line">top <span class="comment">#显示使用最多CPU的进程的数据 </span></div><div class="line">prstat <span class="comment">#显示进程的动态信息 </span></div><div class="line">pstree <span class="comment">#显示进程树图表 </span></div><div class="line">ptree <span class="comment">#显示进程树图表 </span></div><div class="line">fuser <span class="comment">#识别使用指定文件的进程 </span></div><div class="line">kill <span class="comment">#终止进程；给进程发送信号 </span></div><div class="line">nice <span class="comment">#使用指定的调度优先级运行程序 </span></div><div class="line">renice <span class="comment">#改变已运行程序的调度优先级</span></div></pre></td></tr></table></figure>

<p>free</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">free -m |grep <span class="string">"Mem"</span> | awk <span class="string">'{print $2}'</span></div></pre></td></tr></table></figure>

<p>df,du,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">df -h <span class="comment"># 查看各分区使用情况</span></div><div class="line">du -sh &lt;目录名&gt; <span class="comment"># 查看指定目录的大小</span></div></pre></td></tr></table></figure>

<p>uptime,w,top,ps</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">uptime <span class="comment"># 查看系统运行时间、用户数、负载</span></div><div class="line">ps aux | sort -nk +<span class="number">4</span> | tail <span class="comment">#显示消耗内存最多的 10 个运行中的进程，以内存使用量排序</span></div></pre></td></tr></table></figure>

<p>last,history</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">last <span class="comment"># 查看用户登录日志</span></div><div class="line">last | cut <span class="operator">-d</span> <span class="string">' '</span> <span class="operator">-f</span> <span class="number">1</span> <span class="comment">#查看最近登陆的用户名</span></div><div class="line">last |tr <span class="operator">-s</span> <span class="string">' '</span>| cut <span class="operator">-d</span> <span class="string">' '</span> <span class="operator">-f</span> <span class="number">2</span>|less </div><div class="line">history | awk <span class="string">'{a[$2]++}END{for(i in a){print a[i] " " i}}'</span> | sort -rn | head <span class="comment">#列出你最常用的10条命令</span></div><div class="line">history | awk {<span class="string">'print $2'</span>} | sort | uniq -c | sort -k1 -rn <span class="comment">#输出用户了命令历史；awk统计并输出列表；sort排序；head截出前10行</span></div></pre></td></tr></table></figure>

<p>netstat,ifconfig</p>
<p>mount,unmount,</p>
<p>source<br>管道,重定向,tee</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ls <span class="operator">-l</span> /home | tee ~/homefile | more </div><div class="line">ls <span class="operator">-l</span> / | tee <span class="operator">-a</span> ~/homefile | more <span class="comment">#-a是append</span></div></pre></td></tr></table></figure>

<p>ulimit命令</p>
<p>source 在当前shell中执行指定shell程序。 </p>
<h3 id="2-用户相关">2.用户相关</h3>
<p>权限:chmod,chgrp,chown</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">chown +x file 与 chown <span class="number">774</span> file 与 chown u+x file 区别? </div><div class="line">chmod ugo+rwx directory1 <span class="comment">#设置目录的所有人(u)、群组(g)以及其他人(o)以读（r ）、写(w)和执行(x)的权限</span></div><div class="line">chmod go-rwx directory1 <span class="comment">#删除群组(g)与其他人(o)对目录的读写执行权限</span></div><div class="line">chown user1 file1 <span class="comment">#改变一个文件的所有人属性</span></div><div class="line">chown -R user1 directory1 <span class="comment">#改变一个目录的所有人属性并同时改变改目录下所有文件的属性</span></div><div class="line">chgrp group1 file1 <span class="comment">#改变文件的群组</span></div><div class="line">chown user1:group1 file1 <span class="comment">#改变一个文件的所有人和群组属性</span></div></pre></td></tr></table></figure>

<p>groups,groupadd,groupdel,group mod,useradd,userdel,usermod </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">groups <span class="comment">#该命令用于显示当前用户所在的组</span></div><div class="line">groupadd group_name <span class="comment">#创建一个新用户组</span></div><div class="line">groupdel group_name <span class="comment">#删除一个用户组</span></div><div class="line">groupmod -n new_group_name old_group_name <span class="comment">#重命名一个用户组,该命令用户修改组的属性</span></div><div class="line">useradd -c <span class="string">"Name Surname"</span> -g admin <span class="operator">-d</span> /home/user1 <span class="operator">-s</span> /bin/bash user1 <span class="comment">#创建一个属于 "admin" 用户组的用户</span></div><div class="line">useradd user1 <span class="comment">#创建一个新用户</span></div><div class="line">userdel -r user1 <span class="comment">#删除一个用户('-r' 排除主目录)</span></div><div class="line">usermod -c <span class="string">"User FTP"</span> -g system <span class="operator">-d</span> /ftp/user1 <span class="operator">-s</span> /bin/nologin user1 <span class="comment">#修改用户属性</span></div><div class="line">passwd <span class="comment">#修改口令</span></div><div class="line">passwd user1 <span class="comment">#修改一个用户的口令(只容许root执行)</span></div><div class="line">chage -E <span class="number">2005</span>-<span class="number">12</span>-<span class="number">31</span> user1 <span class="comment">#设置用户口令的失效期限</span></div><div class="line">newgrp group_name <span class="comment">#登陆进一个新的群组以改变新创建文件的预设群组</span></div><div class="line">w,who <span class="comment">#查看当前计算器有哪些用户登录</span></div><div class="line">whoami  <span class="comment">#查看当前登录用户名</span></div></pre></td></tr></table></figure>

<h3 id="3-文件相关">3.文件相关</h3>
<p>mime,ctime,atime</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">find /home/dam -name <span class="string">"*.zip"</span> -mtime +<span class="number">7</span> -o -name <span class="string">"*.xml"</span> -mtime +<span class="number">7</span> | xargs rm <span class="operator">-f</span> <span class="comment">#查找七天前</span></div><div class="line">find /home/dam \( -name *.zip -o -name *.xml \) -ctime +<span class="number">7</span></div></pre></td></tr></table></figure>

<p>查看ls</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ls /tmp | pr -T5 -W<span class="variable">$COLUMNS</span> <span class="comment">#将终端划分成5栏显示</span></div><div class="line">ls | sed <span class="string">"s:^:`pwd`/:"</span> <span class="comment">#列出文件的绝对路径</span></div></pre></td></tr></table></figure>

<p>文件:lsattr,chattr,cat,tac,tail,head,nl, more,less, dd </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chattr +a file1 <span class="comment">#只允许以追加方式读写文件 </span></div><div class="line">chattr +i file1 <span class="comment">#设置成不可变的文件，不能被删除、修改、重命名或者链接</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[admin@server190 ~]$ lsattr <span class="operator">-d</span> ~/work</div><div class="line">----<span class="operator">-a</span>------<span class="operator">-e</span>- /home/admin/work</div></pre></td></tr></table></figure>

<p>归档,打包,解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">tar -cvzf ,tar -xvzf <span class="comment">#打包和压缩文件</span></div><div class="line">bunzip2 file1.bz2 <span class="comment">#解压'file1.bz2'这个文件</span></div><div class="line">bzip2 file1 <span class="comment">#压缩一个叫做'file1' 的文件</span></div><div class="line">gunzip file1.gz <span class="comment">#解压一个叫做'file1.gz'的文件</span></div><div class="line">gzip file1 <span class="comment">#压缩一个叫做'file1'的文件</span></div><div class="line">gzip -<span class="number">9</span> file1 <span class="comment">#最大程度压缩</span></div><div class="line">rar a file1.rar test_file <span class="comment">#创建一个叫做 'file1.rar' 的包</span></div><div class="line">rar a file1.rar file1 file2 dir1 <span class="comment">#同时压缩 'file1', 'file2' 以及目录 'dir1'</span></div><div class="line">rar x file1.rar <span class="comment">#解压rar包</span></div><div class="line">unrar x file1.rar <span class="comment">#解压rar包</span></div><div class="line">tar -cvf archive.tar file1 <span class="comment">#创建一个非压缩的 tarball</span></div><div class="line">tar -cvf archive.tar file1 file2 dir1 <span class="comment">#创建一个包含了 'file1', 'file2' 以及 'dir1'的档案文件</span></div><div class="line">tar -tf archive.tar <span class="comment">#显示一个包中的内容</span></div><div class="line">tar -xvf archive.tar <span class="comment">#释放一个包</span></div><div class="line">tar -xvf archive.tar -C /tmp <span class="comment">#将压缩包释放到/tmp目录下</span></div><div class="line">tar -cjvf archive.tar.bz2 dir1 <span class="comment">#创建一个bzip2格式的压缩包</span></div><div class="line">tar -xjvf archive.tar.bz2 <span class="comment">#解压一个bzip2格式的压缩包</span></div><div class="line">tar -tjvf</div><div class="line">tar -czvf archive.tar.gz dir1 <span class="comment">#创建一个gzip格式的压缩包</span></div><div class="line">tar -xzvf archive.tar.gz <span class="comment">#解压一个gzip格式的压缩包</span></div><div class="line">tar -tzvf</div><div class="line">zip file1.zip file1 <span class="comment">#创建一个zip格式的压缩包</span></div><div class="line">zip -r file1.zip file1 file2 dir1 <span class="comment">#将几个文件和目录同时压缩成一个zip格式的压缩包</span></div><div class="line">unzip file1.zip <span class="comment">#解压一个zip格式压缩包</span></div></pre></td></tr></table></figure>

<p>搜索 find,locate,whereis</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">find -type d -name <span class="string">".svn"</span>|xargs rm -rf 或者 find -type d -iname <span class="string">".svn"</span> -exec rm -rf {} \;</div><div class="line">find -name <span class="string">'*.[ch]'</span> | xargs grep -E <span class="string">'expr'</span> <span class="comment">#在当前目录及其子目录下所有.c和.h文件中寻找'expr'</span></div><div class="line">find -type f -print0 | xargs -r0 grep -F <span class="string">'example'</span> <span class="comment">#在当前目录及其子目录中的常规文件中查找字符串'example'</span></div><div class="line">find -maxdepth <span class="number">1</span> -type d | <span class="keyword">while</span> <span class="built_in">read</span> dir; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$dir</span>; <span class="built_in">echo</span> cmd2; <span class="keyword">done</span> <span class="comment">#对每一个找到的文件执行多个命令(使用while循环)</span></div><div class="line">find -type f ! -perm -<span class="number">444</span> <span class="comment">#寻找所有不可读的文件</span></div><div class="line">find -type d ! -perm -<span class="number">111</span> <span class="comment">#寻找不可访问的目录</span></div><div class="line">locate -r <span class="string">'file[^/]*\.txt'</span> <span class="comment">#使用locate 查找所有符合*file*.txt的文件</span></div><div class="line">比较 diff 操作 ln,mkdir</div><div class="line">mkdir -p /tmp/dir1/dir2 <span class="comment">#创建一个目录树</span></div><div class="line">ln <span class="operator">-s</span> <span class="built_in">source</span> lnk1 <span class="comment">#创建一个指向文件或目录的软链接</span></div><div class="line">ln <span class="built_in">source</span> lnk1 <span class="comment">#创建一个指向文件或目录的物理链接</span></div></pre></td></tr></table></figure>

<p>seq</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">seq -ws <span class="string">'-'</span> <span class="number">1</span> <span class="number">100</span> <span class="comment">#输出1到100用-分割</span></div><div class="line">seq <span class="operator">-f</span> <span class="string">'dir%03g'</span> <span class="number">1</span> <span class="number">10</span> | xargs mkdir <span class="comment">#一次制做10 個名dir001 , dir002 .. dir010 的目录</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq <span class="operator">-f</span> <span class="string">'%02g'</span> <span class="number">1</span> <span class="number">20</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line"><span class="keyword">if</span> ! wget -P <span class="variable">$HOME</span>/tmp -c [img]http://www.yueji.com/photo/<span class="variable">$i</span>.jpg[/img] ; <span class="keyword">then</span></div><div class="line">wget -P <span class="variable">$HOME</span>/tmp -c <span class="variable">$_</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq -w <span class="number">1</span> <span class="number">20</span>`; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">'zxc'</span>_<span class="variable">$i</span>; <span class="keyword">done</span>;</div></pre></td></tr></table></figure>

<h2 id="二-linux文档,字符串操作">二.linux文档,字符串操作</h2>
<p>vi/vim, sed ,perl</p>
<h3 id="批量替换">批量替换</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">find -name <span class="string">'pom.xml'</span> | xargs perl -pi <span class="operator">-e</span> <span class="string">'s|http://repo1.maven.org/maven2|http://localhost:8081/nexus/content /groups/public|g'</span></div><div class="line">perl -pe <span class="string">'s/\r//g'</span> /tmp/t|grep -v ^$&gt;brand.txt <span class="comment">#替换回车换行</span></div><div class="line">perl -pe <span class="string">'s/^\n$//'</span> /tmp/t &gt; /tmp/tt <span class="comment">#去掉回车符号</span></div><div class="line">find -name <span class="string">"ubuntu_init_env.sh"</span>|sed -n <span class="string">'1p'</span>|xargs cat|sed -n <span class="string">"88p"</span>  <span class="comment">#取find命令找到的第一个文件cat，并取88行输出</span></div></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">"s/oldString/newString/g"</span> `grep oldString -rl /path`</div></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep oldString -rl /path | xargs sed -i <span class="string">"s/oldString/newString/g"</span></div></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">"abc"</span> * -R | awk -F: <span class="string">'{print $1}'</span> | sort | uniq | xargs sed -i <span class="string">'s/abc/abcde/g'</span> <span class="comment">#一次性将所有文件中的指定字符串进行修改</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'s/string1/string2/g'</span> <span class="comment">#使用string2替换string1</span></div><div class="line">sed <span class="string">'s/\(.*\)1/\12/g'</span> <span class="comment">#将任何以1结尾的字符串替换为以2结尾的字符串</span></div><div class="line">sed <span class="string">'/^ *#/d; /^ *$/d'</span> <span class="comment">#删除注释和空白行</span></div><div class="line">sed <span class="string">':a; /\\$/N; s/\\\n//; ta'</span> <span class="comment">#连接结尾有\的行和其下一行</span></div><div class="line">sed <span class="string">'s/[ \t]*$//'</span> <span class="comment">#删除每行后的空白</span></div><div class="line">sed <span class="string">'s/\([\\`\\"$\\\\]\)/\\\1/g'</span> <span class="comment">#将所有转义字符之前加上\</span></div><div class="line">seq <span class="number">10</span> | sed <span class="string">"s/^/ /; s/ *\(.\{7,\}\)/\1/"</span> <span class="comment">#向右排N(任意数)列</span></div><div class="line">sed -n <span class="string">'1000p;1000q'</span> <span class="comment">#输出第一千行</span></div><div class="line">sed -n <span class="string">'10,20p;20q'</span> <span class="comment">#输出第10-20行</span></div><div class="line">sed -n <span class="string">'s/.*&lt;title&gt;\(.*\)&lt;\/title&gt;.*/\1/ip;T;q'</span> <span class="comment">#输出HTML文件的&lt;title&gt;&lt;/title&gt;字段中的内容</span></div><div class="line">sort -t. -k1,<span class="number">1</span>n -k2,<span class="number">2</span>n -k3,<span class="number">3</span>n -k4,<span class="number">4</span>n <span class="comment">#排序IPV4地址</span></div></pre></td></tr></table></figure>

<h3 id="sort,uniq,wc,grep">sort,uniq,wc,grep</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uniq <span class="operator">-f</span> <span class="number">3</span> /var/log/messages   <span class="comment">#跳过前三个字段进行去重</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">'^MANPATH'</span> /etc/man.config | head -n <span class="number">3</span> | \</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">grep -v <span class="string">'^$'</span> /etc/syslog.conf | grep -v <span class="string">'^#'</span>  <span class="comment"># 结果仅有 10 行，其中第一个 -v '^$' 代表不要空白行，第二个-v '^#'代表不要开头是 # 的那行</span></div><div class="line">grep -c <span class="string">"Exception"</span> logs/com.yue.commons.standalone.web.log  <span class="comment">#统计到grep匹配的次数</span></div><div class="line">grep -A10 <span class="string">"java.sql.SQLException:"</span> web.log|less  <span class="comment">#找到抛异常的地方并输出后续的10行</span></div><div class="line">grep -A10 --color=auto <span class="string">"java.sql.SQLException:"</span> web.log</div></pre></td></tr></table></figure>

<h3 id="cut,join,tr,col,split">cut,join,tr,col,split</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">'ZHANGXIONGCAI337@YUEJI.COM'</span>|tr <span class="string">"[A-Z]"</span> <span class="string">"[a-z]"</span> <span class="comment">#tr字符串替换</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'Test'</span> | tr <span class="string">'[:lower:]'</span> <span class="string">'[:upper:]'</span> <span class="comment">#转换成大写</span></div><div class="line">tr -dc <span class="string">'[:print:]'</span> &lt; /dev/urandom <span class="comment">#过滤掉不能打印的字符</span></div><div class="line">cat /etc/passwd | tr <span class="operator">-d</span> <span class="string">':'</span> <span class="comment">#将冒号删除</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">last | cut <span class="operator">-d</span> <span class="string">' '</span> <span class="operator">-f</span>1 | sort | uniq -c <span class="comment">#最近每个人登陆的总次数</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">sort file1 file2 | uniq <span class="comment">#两个未排序文件的并集</span></div><div class="line">sort file1 file2 | uniq <span class="operator">-d</span> <span class="comment">#两个未排序文件的交集</span></div><div class="line">sort file1 file1 file2 | uniq -u <span class="comment">#两个未排序文件的差集</span></div><div class="line">sort file1 file2 | uniq -u <span class="comment">#两个未排序文件的对称差集</span></div><div class="line">join -t<span class="string">'\0'</span> <span class="operator">-a</span>1 <span class="operator">-a</span>2 file1 file2 <span class="comment">#两个有序文件的并集</span></div><div class="line">join -t<span class="string">'\0'</span> file1 file2 <span class="comment">#两个有序文件的交集</span></div><div class="line">join -t<span class="string">'\0'</span> -v2 file1 file2 <span class="comment">#两个有序文件的差集</span></div><div class="line">join -t<span class="string">'\0'</span> -v1 -v2 file1 file2 <span class="comment">#两个有序文件的对称差集</span></div></pre></td></tr></table></figure>

<h3 id="awk">awk</h3>
<p>比较两个文件的不同 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'{if (NR==FNR) {a[$0]}; if (NR!=FNR&&!($0 in a)) {print $0}}'</span> firstfile secondfile   </div><div class="line">awk <span class="string">'NR==FNR {a[$0]} NR!=FNR&&!($0 in a) {print $0}'</span> firstfile secondfile   </div><div class="line">cat firstfile secondfile | sort |uniq -u</div></pre></td></tr></table></figure>

<h2 id="三-linux网络命令">三.linux网络命令</h2>
<h3 id="wget">wget</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -c http://www.yueji.com/bo.JPG <span class="comment">#断点续传 或者 curl -c -O http://www.yueji.com/bo.JPG</span></div></pre></td></tr></table></figure>

<h3 id="ssh_端口转发">ssh 端口转发</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ssh -N <span class="operator">-f</span> -R X:Y:Z K   <span class="comment">#远程转发 将IP为的Y机器的Z端口[映射到远程]机器K的X端口上,K机器就可以通过访问X端口,而访问Y的Z端口服务 -R ：remote (远程)</span></div><div class="line">ssh -R <span class="number">9090</span>:local-secret.com:<span class="number">8080</span> my-remote-host.com <span class="comment">#远程访问my-remote-host.com:9090就等同于用本机访问local-secret.com:8080</span></div><div class="line">ssh -N <span class="operator">-f</span> -L X:Y:Z K   <span class="comment">#本地转发 将IP为Y的机器的Z端口通过中间服务器K[映射到本地]机器的X端口, -L local (本地)</span></div><div class="line">ssh -L <span class="number">9090</span>:remote-secret.com:<span class="number">8080</span> my-remote-host.com <span class="comment">#访问本地的9090端口就相当于用远程服务器my-remote-host.com访问remote-secret.com:8080</span></div><div class="line">-N <span class="comment">#告诉SSH客户端，这个连接不需要执行任何命令。仅仅做端口转发</span></div><div class="line"><span class="operator">-f</span> <span class="comment">#告诉SSH客户端在后台运行</span></div><div class="line">-i <span class="comment">#使用指定的密钥登录</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ssh -p <span class="number">222</span> admin@<span class="number">122.193</span>.<span class="number">22.120</span></div><div class="line">ssh -R <span class="number">1234</span>:localhost:<span class="number">45555</span> <span class="number">121.196</span>.<span class="number">128.188</span> </div><div class="line"><span class="comment">#主机 A :localhost把本地的 21端口(对应ftp服务)映射为 B 121.196.128.188的1234 端口(任意未被占用)，同时 A 监听 B 的1234 端口。 </span></div><div class="line"><span class="comment">#在 B 上用 netstat -al | grep 1234 ，看到这个监听连接。 </span></div><div class="line"><span class="comment">#任何发送到 B 1234 端口的请求将被传送到 A的 21 端口</span></div><div class="line"><span class="comment">#在B上 curl localhost:45555</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh -N <span class="operator">-f</span> -L <span class="number">2121</span>:<span class="number">234.234</span>.<span class="number">234.234</span>:<span class="number">21</span> <span class="number">123.123</span>.<span class="number">123.123</span></div><div class="line">ftp localhost:<span class="number">2121</span> <span class="comment"># 现在访问本地192.168.1.100的2121端口，就能连接234.234.234.234的21端口了</span></div></pre></td></tr></table></figure>

<h3 id="curl_数据爬取">curl 数据爬取</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -A <span class="string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)"</span> -o page.html -D cookie0001.txt http://www.yueji.com <span class="comment">#模仿运行在Windows 2000上的 IE6.0访问</span></div></pre></td></tr></table></figure>

<h3 id="dig,ping">dig,ping</h3>
<h2 id="四,Shell基础">四,Shell基础</h2>
<h3 id="$@,$#,$*,$0,$1~$n,#?,$?">$@,$#,$*,$0,$1~$n,#?,$?</h3>
<h3 id="if,for,while,util,select,case">if,for,while,util,select,case</h3>
<h3 id="read,">read,</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$0</span>   		<span class="comment">#当前执行的shell script文件名（带完整路径） </span></div><div class="line"><span class="variable">$1</span> ~ <span class="variable">$n</span>  	<span class="comment">#依次存放shell script的命令行参数，数值大于9时必须要用{}括起来，比如${10}。命令行参数可以通过shift命令进行位移操作，位置参数根据shift命令指定的数值往前移动，如不指定移动值，则移动1次。例如: </span></div><div class="line"><span class="variable">$*</span>   		<span class="comment">#将所有命令行参数做为一个字符串存入此变量。 </span></div><div class="line"><span class="variable">$@</span>   		<span class="comment">#将所有命令行参数做为一个字符串数组，每个参数为一个成员变量，存入此变量。 </span></div><div class="line"><span class="variable">$#</span>   		<span class="comment">#命令行参数的个数。 </span></div><div class="line"><span class="variable">$?</span>   		<span class="comment">#上一条命令执行后的返回码。 </span></div><div class="line"><span class="variable">$ </span>    		<span class="comment">#当前执行的shell script进程编号。 </span></div><div class="line"><span class="variable">$!</span>   		<span class="comment">#上一个后台程序的进程编号。 </span></div><div class="line"><span class="variable">$_</span>   		<span class="comment">#script执行时，存放bash的绝对路径;bash交互时，存放上一个命令最后一个命令行参数;邮件检测时，存放邮件文件名</span></div></pre></td></tr></table></figure>

<h3 id="条件判断">条件判断</h3>
<p>数值判断，仅支持整型</p>
<pre><code>    [ n1 <span class="operator">-eq</span> n2 ]   <span class="comment">#判断n1==n2</span>
    [ n1 -ge n2 ]   <span class="comment">#判断n1&gt;=n2</span>
    [ n1 <span class="operator">-gt</span> n2 ]   <span class="comment">#判断n1&gt;n2</span>
    [ n1 -le n2 ]   <span class="comment">#判断n1&lt;=n2</span>
    [ n1 <span class="operator">-lt</span> n2 ]   <span class="comment">#判断n1&lt;n2</span>
    [ n1 <span class="operator">-ne</span> n2 ]   <span class="comment">#判断n1!=n2</span>
</code></pre><p>字串判断</p>
<pre><code>    <span class="attr_selector">[ str1 = str2 ]</span>   
    <span class="attr_selector">[ str1 != str2 ]</span>   
    <span class="attr_selector">[ str1 &lt; str2 ]</span>   
    <span class="attr_selector">[ str1 &gt; str2 ]</span>   
    <span class="attr_selector">[ -n str1 ]</span>   #判断<span class="tag">str1</span>长度是否非0   
    <span class="attr_selector">[ -z str1 ]</span>   #判断<span class="tag">str1</span>长度是否为0 
</code></pre><p>文件判断</p>
<pre><code>    [ -d <span class="built_in">file</span> ]   <span class="comment">#判断目录file是否存在</span>
    [ -e <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在</span>
    [ -f <span class="built_in">file</span> ]   <span class="comment">#判断文件file是否存在</span>
    [ -r <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并可读</span>
    [ -s <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并非空</span>
    [ -w <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并可写</span>
    [ -x <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并可执行</span>
    [ -O <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并属于当前用户</span>
    [ -G <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在且默认组于当前用户所属组是否相同</span>
    [ file1 -nt file2 ]   <span class="comment">#判断file1是否比file2新</span>
    [ file1 -ot file2 ]   <span class="comment">#判断file1是否比file2旧</span>
</code></pre><p>复合判断</p>
<pre><code>    -<span class="operator">a</span>  与操作，例如：[ -e <span class="built_in">file</span> -<span class="operator">a</span> -r <span class="built_in">file</span> ]
    -o  或操作，例如：[ -e <span class="built_in">file</span> -o -r <span class="built_in">file</span> ]   
</code></pre><h2 id="五,Shell脚本">五,Shell脚本</h2>
<ul>
<li>1.服务器监控脚本 </li>
<li>2.数据库备份脚本 </li>
<li>3.日志操作脚本 </li>
<li>4.批量生成linux所有命令帮助文档  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">echo</span> <span class="variable">$PATH</span> |tr <span class="string">':'</span> <span class="string">'\n'</span>|grep -v <span class="string">"yueji"</span>|grep -v <span class="string">"home"</span>`; <span class="keyword">do</span> man `ls <span class="variable">$i</span>`|col -b  &gt;&gt; cmd.man ;<span class="keyword">done</span> <span class="number">2</span>&gt;/dev/null    <span class="comment">#将所有的linux命令man文档保存下来</span></div><div class="line"><span class="comment">###</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">echo</span> <span class="variable">$PATH</span> |tr <span class="string">':'</span> <span class="string">'\n'</span>|grep -v <span class="string">"yueji"</span>|grep -v <span class="string">"home"</span>`; <span class="keyword">do</span> man `ls <span class="variable">$i</span>`|col -b | ps2pdf - &gt;&gt; man.pdf; <span class="keyword">done</span> <span class="number">2</span>&gt;/dev/null</div><div class="line"><span class="comment">###</span></div><div class="line">man ls | col -b &gt; ls.man.txt</div></pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2013-01-02T03:04:47.000Z"><a href="/2013/01/02/linux-shell-xml/">1月 2 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/01/02/linux-shell-xml/">Linux Shell脚本读写XML文件</a></h1>
  

    </header>
    <div class="entry">
      
        <p>在Linux下如何用<code>Shell</code>脚本读写<code>XML</code>? 现有一个config.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">config</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">server-ip</span>&gt;</span>192.168.0.107<span class="tag">&lt;/<span class="title">server-ip</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">server-port</span>&gt;</span>6379<span class="tag">&lt;/<span class="title">server-port</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">repository-temp-path</span>&gt;</span>/Users/zxc/workspace/redis/<span class="tag">&lt;/<span class="title">repository-temp-path</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">config</span>&gt;</span></div></pre></td></tr></table></figure>

<p>需要修改里面的<code>server-ip</code>, <code>server-port</code> 和 <code>import-path</code>,用Shell脚本的参数$1,$2,$3来写入。</p>
<p><br></p>
<h3 id="方法1:用sed命令实现">方法1:用sed命令实现</h3>
<p>首先想到的就是用sed正则匹配替换实现，写了一个shell脚本，是这样的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/sh</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="operator">-ne</span> <span class="number">3</span> ];<span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"usage: argument 1:IP_Address 2:Server_PORT 3:Temp_PATH"</span></div><div class="line"><span class="keyword">exit</span> <span class="number">1</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">IP=<span class="variable">$1</span></div><div class="line">PORT=<span class="variable">$2</span></div><div class="line">DIRT=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Change values in config.xml..."</span></div><div class="line"></div><div class="line">sed <span class="string">"s/&lt;server-ip&gt;.*&lt;\/server-ip&gt;/&lt;server-ip&gt;<span class="variable">${IP}</span>&lt;\/server-ip&gt;/;s/&lt;server-port&gt;.*&lt;\/server-port&gt;/&lt;server-port&gt;<span class="variable">${PORT}</span>&lt;\/server-port&gt;/;s/&lt;repository-temp-path&gt;.*&lt;\/repository-temp-path&gt;/&lt;repository-temp-path&gt;<span class="variable">${DIRT}</span>&lt;\/repository-temp-path&gt;/"</span> config.xml &gt; config.xml</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Done."</span></div></pre></td></tr></table></figure>

<p>测试下来调用$ ./abc.sh 192.168.1.6 9909 \/home\/abc”是可以的，但环境变量不行，例如：$ ./abc.sh 192.168.1.6 9909 $HOME\/abc”，因为首先环境变量被解析了，所以存在反斜杠转义字符和sed替换冲突的问题。<br>用另外一个思路实现</p>
<p><br></p>
<h3 id="方法2:是直接输出该xml的内容，测试下来很管用，使用很方便，不存在反斜杠转义字符的问题和环境变量的问题：">方法2:是直接输出该xml的内容，测试下来很管用，使用很方便，不存在反斜杠转义字符的问题和环境变量的问题：</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/sh</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="operator">-ne</span> <span class="number">3</span> ];<span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"usage: argument 1:IP_Address 2:Server_PORT 3:Temp_PATH"</span></div><div class="line"><span class="keyword">exit</span> <span class="number">1</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">IP=<span class="variable">$1</span></div><div class="line">PORT=<span class="variable">$2</span></div><div class="line">DIRT=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Change values in config.xml..."</span></div><div class="line"></div><div class="line">cat &lt;&lt;EOF &gt;config.xml</div><div class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</div><div class="line">&lt;config&gt;</div><div class="line">   &lt;server-ip&gt;<span class="variable">${IP}</span>&lt;/server-ip&gt;</div><div class="line">   &lt;server-port&gt;<span class="variable">${PORT}</span>&lt;/server-port&gt;</div><div class="line">   &lt;repository-temp-path&gt;<span class="variable">${DIRT}</span>&lt;/repository-temp-path&gt;</div><div class="line">&lt;/config&gt;</div><div class="line">EOF  </div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Done."</span></div></pre></td></tr></table></figure>

<p><br></p>
<h3 id="方法3：用XMLStarlet">方法3：用XMLStarlet</h3>
<p>XML + shell = XMLStarlet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ xmlstarlet ed -u /config/server-ip -v <span class="number">192.168</span>.<span class="number">1.6</span> -u /config/server-port -v <span class="number">9909</span> -u /config/repository-temp-path -v /home/bbb input.xml</div><div class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</div><div class="line">&lt;config&gt;</div><div class="line">  &lt;server-ip&gt;<span class="number">192.168</span>.<span class="number">0.107</span>&lt;/server-ip&gt;</div><div class="line">  &lt;server-port&gt;<span class="number">6379</span>&lt;/server-port&gt;</div><div class="line">  &lt;repository-temp-path&gt;/Users/zxc/workspace/redis/&lt;/repository-temp-path&gt;</div><div class="line">&lt;/config&gt;</div></pre></td></tr></table></figure>

<p><br></p>
<h3 id="方法4：用xsltproc">方法4：用xsltproc</h3>
<p>很多Linux比如CentOS默认已安装<code>xsltproc</code>，所以用xslt可以很方便的把一个xml转换为另外一个xml。<a href="http://xmlsoft.org/XSLT/xsltproc.html" target="_blank" rel="external">具体用法</a>。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-12-27T02:57:11.000Z"><a href="/2012/12/27/spring-mvc-wizard/">12月 27 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/12/27/spring-mvc-wizard/">Spring MVC注解方式实现向导式跳转页面</a></h1>
  

    </header>
    <div class="entry">
      
        <p>近期项目需要用到向导式的跳转页面效果，本项目又是用spring mvc实现的，刚开始想到用spring的<code>webflow</code>，不过<code>webflow</code>太过笨重，对于我们不是很复杂的跳转来说好像有种“杀鸡焉用牛刀”的感觉，于是就网上搜索看有没有类似的解决方案，网上的答案一般都是叫你继承<code>AbstractWizardFormContoller</code>这个类来实现，但对于<code>spring mvc3.0.x</code>这个类将不再使用，转而推荐使用<code>注解</code>的方式来实现，于是参考<code>官方文档</code>，用注解方式实现了向导式页面。</p>
<p>下面是代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="annotation">@RequestMapping</span>(<span class="string">"/wizard.htm"</span>)    </div><div class="line"><span class="annotation">@SessionAttributes</span>(<span class="string">"bean"</span>)  <span class="comment">//需要保存在session中的变量</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestWizardController</span></span>{  </div><div class="line">    </div><div class="line">  <span class="annotation">@Resource</span>(name = <span class="string">"beanService"</span>)  </div><div class="line">  <span class="keyword">private</span> BeanService beanService;    </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>  </div><div class="line">  <span class="keyword">public</span> String <span class="title">step1</span>(<span class="keyword">final</span> ModelMap modelMap){  </div><div class="line">    modelMap.addAttribute(<span class="string">"bean"</span>, <span class="keyword">new</span> Bean());  </div><div class="line">    <span class="keyword">return</span> <span class="string">"step1"</span>;  </div><div class="line">  }  </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>(params = <span class="string">"_step=2"</span>)  </div><div class="line">  <span class="keyword">public</span> String <span class="title">step2</span>(<span class="keyword">final</span> @<span class="title">ModelAttribute</span>("bean") Bean bean,  </div><div class="line">                      <span class="keyword">final</span> Errors errors){  </div><div class="line">    <span class="keyword">return</span> <span class="string">"step2"</span>;  </div><div class="line">  }  </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>(params = <span class="string">"_step=3"</span>)  </div><div class="line">  <span class="keyword">public</span> String <span class="title">step3</span>(<span class="keyword">final</span> @<span class="title">ModelAttribute</span>("bean") Bean bean,  </div><div class="line">                      <span class="keyword">final</span> Errors errors){  </div><div class="line">    <span class="keyword">return</span> <span class="string">"step3"</span>;  </div><div class="line">  }  </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>(params = <span class="string">"_finish"</span>)  </div><div class="line">  <span class="keyword">public</span> String <span class="title">processFinish</span>(@<span class="title">ModelAttribute</span>("bean")Bean bean,  </div><div class="line">                              <span class="keyword">final</span> Errors errors,  </div><div class="line">                              <span class="keyword">final</span> ModelMap modelMap,  </div><div class="line">                              <span class="keyword">final</span> SessionStatus status){  </div><div class="line">  </div><div class="line">    beanService.add(bean);     </div><div class="line">    status.setComplete();  </div><div class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;  </div><div class="line">  }  </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>(params = <span class="string">"_cancel"</span>)  </div><div class="line">  <span class="keyword">public</span> String <span class="title">processCancel</span>(<span class="keyword">final</span> HttpServletRequest request,  </div><div class="line">                              <span class="keyword">final</span> HttpServletResponse response,  </div><div class="line">                              <span class="keyword">final</span> SessionStatus status){  </div><div class="line">     status.setComplete();  </div><div class="line">     <span class="keyword">return</span> <span class="string">"cancel"</span>;  </div><div class="line">  }  </div><div class="line">      </div><div class="line">}</div></pre></td></tr></table></figure>

<p>其中起到最大作用的就是<code>@SessionAttributes</code>这个注解，它定义了一个在<code>session</code>范围内的变量，这个变量可以在不同的页面跳转时保持状态。</p>
<p>第一次访问 <a href="http://www.example.com/wizard.htm" target="_blank" rel="external">http://www.example.com/wizard.htm</a> 时进入step1方法，其后提交的表单action后面都要加上相应的参数，如：</p>
<p>step1页面 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"http://www.example.com/wizard.htm?_step=2"</span>&gt;</span></div></pre></td></tr></table></figure>

<p>step2页面 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"http://www.example.com/wizard.htm?_step=3"</span>&gt;</span></div></pre></td></tr></table></figure>

<p>step3页面 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"http://www.example.com/wizard.htm?_finish"</span>&gt;</span></div></pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-11-26T08:03:16.000Z"><a href="/2012/11/26/spring-mvc-xss/">11月 26 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/11/26/spring-mvc-xss/">Spring MVC里面xss攻击的预防</a></h1>
  

    </header>
    <div class="entry">
      
        <p>关于xss的介绍可以看 <a href="http://www.cnblogs.com/luminji/archive/2012/05/22/2507185.html" target="_blank" rel="external">Asp.net安全架构之1：xss（跨站脚本）</a>和 <a href="http://www.cnblogs.com/kingthy/archive/2011/08/20/2147355.html" target="_blank" rel="external">腾讯微博的XSS攻击漏洞</a> 网页，</p>
<p>具体我就讲讲Spring MVC里面的预防：</p>
<h3 id="第一种方法,使用Spring_MVC">第一种方法,使用Spring MVC</h3>
<p>web.xml加上：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">context-param</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">param-name</span>&gt;</span>defaultHtmlEscape<span class="tag">&lt;/<span class="title">param-name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="title">param-value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">context-param</span>&gt;</span></div></pre></td></tr></table></figure>

<p>Forms加上：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">spring:htmlEscape</span> <span class="attribute">defaultHtmlEscape</span>=<span class="value">"true"</span> /&gt;</span></div></pre></td></tr></table></figure>


<p>更多信息查看<a href="https://www.owasp.org/index.php/Main_Page" target="_blank" rel="external">OWASP</a>的<a href="https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet" target="_blank" rel="external">页面</a></p>
<p><br></p>
<h3 id="第二种方法是手动escape">第二种方法是手动escape</h3>
<p>例如用户可以输入：</p>
<figure class="highlight javaScript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;alert();<span class="xml"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span></div></pre></td></tr></table></figure>

<p>或者输入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">h2</span>&gt;</span>abc<span class="tag">&lt;<span class="title">h2</span>&gt;</span></div></pre></td></tr></table></figure>

<p>,如果有异常,显然有xss漏洞。<br>首先添加一个jar包:<code>commons-lang-2.5.jar</code>,然后在后台调用这些函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">StringEscapeUtils.escapeHtml(string); </div><div class="line">StringEscapeUtils.escapeJavaScript(string); </div><div class="line">StringEscapeUtils.escapeSql(string);</div></pre></td></tr></table></figure>

<p>前台js调用escape函数即可。</p>
<p><br></p>
<h3 id="第三种方法是后台加Filter,对每个post请求的参数过滤一些关键字,替换成安全的">第三种方法是后台加Filter,对每个post请求的参数过滤一些关键字,替换成安全的</h3>
<p>例如：&lt; &gt; ‘ “ \ /  # &amp;<br>方法是实现一个自定义的<code>HttpServletRequestWrapper</code>，然后在Filter里面调用它，替换掉getParameter函数即可。<br>首先添加一个<code>XssHttpServletRequestWrapper</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.ibm.web.beans;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Enumeration;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XssHttpServletRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>{  </div><div class="line">    <span class="keyword">public</span> <span class="title">XssHttpServletRequestWrapper</span>(HttpServletRequest servletRequest) {</div><div class="line">        <span class="keyword">super</span>(servletRequest);</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> String[] <span class="title">getParameterValues</span>(String parameter) {</div><div class="line">      String[] values = <span class="keyword">super</span>.getParameterValues(parameter);</div><div class="line">      <span class="keyword">if</span> (values==<span class="keyword">null</span>)  {</div><div class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">          }</div><div class="line">      <span class="keyword">int</span> count = values.length;</div><div class="line">      String[] encodedValues = <span class="keyword">new</span> String[count];</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) {</div><div class="line">                 encodedValues[i] = cleanXSS(values[i]);</div><div class="line">       }</div><div class="line">      <span class="keyword">return</span> encodedValues;</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> String <span class="title">getParameter</span>(String parameter) {</div><div class="line">          String value = <span class="keyword">super</span>.getParameter(parameter);</div><div class="line">          <span class="keyword">if</span> (value == <span class="keyword">null</span>) {</div><div class="line">                 <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                  }</div><div class="line">          <span class="keyword">return</span> cleanXSS(value);</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> String <span class="title">getHeader</span>(String name) {</div><div class="line">        String value = <span class="keyword">super</span>.getHeader(name);</div><div class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">return</span> cleanXSS(value);</div><div class="line">    }</div><div class="line">    <span class="keyword">private</span> String <span class="title">cleanXSS</span>(String value) {</div><div class="line">                <span class="comment">//You'll need to remove the spaces from the html entities below</span></div><div class="line">        value = value.replaceAll(<span class="string">"&lt;"</span>, <span class="string">"& lt;"</span>).replaceAll(<span class="string">"&gt;"</span>, <span class="string">"& gt;"</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"\\("</span>, <span class="string">"& #40;"</span>).replaceAll(<span class="string">"\\)"</span>, <span class="string">"& #41;"</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"'"</span>, <span class="string">"& #39;"</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"eval\\((.*)\\)"</span>, <span class="string">""</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"[\\\"\\\'][\\s]*javascript:(.*)[\\\"\\\']"</span>, <span class="string">"\"\""</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"script"</span>, <span class="string">""</span>);</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    }</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>然后添加一个过滤器XssFilter ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.ibm.web.beans;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;  </div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.Filter;  </div><div class="line"><span class="keyword">import</span> javax.servlet.FilterChain;  </div><div class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;  </div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </div><div class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </div><div class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;  </div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XssFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</div><div class="line">    FilterConfig filterConfig = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span>(FilterConfig filterConfig) <span class="keyword">throws</span> ServletException {</div><div class="line">        <span class="keyword">this</span>.filterConfig = filterConfig;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span>() {</div><div class="line">        <span class="keyword">this</span>.filterConfig = <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span>(ServletRequest request, ServletResponse response,</div><div class="line">            FilterChain chain) <span class="keyword">throws</span> IOException, ServletException {</div><div class="line">        chain.doFilter(<span class="keyword">new</span> XssHttpServletRequestWrapper(</div><div class="line">                (HttpServletRequest) request), response);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>最后在web.xml里面配置一下，所有的请求的getParameter会被替换，如果参数里面含有<code>敏感词</code>会被替换掉：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">filter</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">filter-name</span>&gt;</span>XssSqlFilter<span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">filter-class</span>&gt;</span>com.ibm.web.beans.XssFilter<span class="tag">&lt;/<span class="title">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">filter-mapping</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">filter-name</span>&gt;</span>XssSqlFilter<span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="title">url-pattern</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">dispatcher</span>&gt;</span>REQUEST<span class="tag">&lt;/<span class="title">dispatcher</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>

<p> (这个Filter也可以防止SQL注入攻击) </p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-11-12T04:19:34.000Z"><a href="/2012/11/12/ibatis1/">11月 12 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/11/12/ibatis1/">Mybatis中传参$与#区别以及对List的排序</a></h1>
  

    </header>
    <div class="entry">
      
        <p>开发中Mybatis会用到： $ 和 # 符号。</p>
<p>一、区别</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$aaa$ 输出参数是以字符串方式直接输出 123</div><div class="line"></div><div class="line">#aaa# 输出参数是以Parameter方式输出 @aaa</div></pre></td></tr></table></figure>

<p>二、实例</p>
<p>SQL :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;select id="selectMetaMandao"  parameterClass="java.util.HashMap" resultMap="WaasmetaMandaoMap" &gt;  </div><div class="line">    SELECT $subCategory$ rchannel,sum(mandao) mandao from</div><div class="line">    ( SELECT nvl(channel,'-') channel,ROUND(count(1)*0.1131) mandao  FROM WAAS_VIEW_USER_RESULT a </div><div class="line">    AND not EXISTS (</div><div class="line">    SELECT msgid</div><div class="line">      FROM DT_XMS_MT b</div><div class="line">     WHERE EXISTS</div><div class="line">           (SELECT MSGID FROM WAAS_VIEW_USER_RESULT WHERE STATUS = 'SUCCESS' AND msgid = b.msgid)</div><div class="line">    AND msgid = a.msgid)</div><div class="line">       GROUP BY channel) d LEFT JOIN waas_channel_summary c ON d.channel = c.original_channel </div><div class="line">    &lt;isNotEmpty property="channel"&gt;</div><div class="line">            WHERE c.original_channel LIKE '%'||#channel#||'%' </div><div class="line">     &lt;/isNotEmpty&gt;</div><div class="line">       GROUP BY $subCategory$</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>

<p>代码 :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@RequestMapping</span>(<span class="string">"queryMeta"</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectMeta</span>(HttpServletRequest request, HttpServletResponse response) {</div><div class="line">    String channel = request.getParameter(<span class="string">"channel"</span>);</div><div class="line">    Map&lt;String, Object&gt; param = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">    <span class="comment">//以参数方式输出, 相当于一个变量 (活的)</span></div><div class="line">    param.put(<span class="string">"channel"</span>, channel); </div><div class="line">    <span class="comment">//以字符串方式输出, 直接输出(死的)</span></div><div class="line">    param.put(<span class="string">"subCategory"</span>, channel == <span class="keyword">null</span> ? <span class="string">"primary_category"</span> : <span class="string">"ORIGINAL_CHANNEL"</span>); </div><div class="line">    List&lt;WAASUserMOTypeResult&gt; data = wumtService.selectMeta(param);</div><div class="line">    <span class="comment">//因为楼上这个List查完之后重新封装的, 所以无序, 要对List里面的对象进行排序, 如下</span></div><div class="line">    Collections.sort(data, <span class="keyword">new</span> Comparator&lt;WAASUserMOTypeResult&gt;() {</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span>(WAASUserMOTypeResult o1, WAASUserMOTypeResult o2) {</div><div class="line">            <span class="keyword">return</span> o2.getShijia() - o1.getShijia(); <span class="comment">//排序字段, 倒序</span></div><div class="line">        }</div><div class="line">    });</div><div class="line">	</div><div class="line">    ......</div><div class="line">	</div><div class="line">    renderJson(response, resultJson.toString());</div><div class="line">}</div></pre></td></tr></table></figure>

<p>实现效果:</p>
<p>如果传channel参数, 则根据原始媒体(ORIGINAL_CHANNEL)分组, 不传则根据合并后的大媒体(primary_category) 分组.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-10-24T08:58:25.000Z"><a href="/2012/10/24/java-regex/">10月 24 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/10/24/java-regex/">正则表达式匹配中文</a></h1>
  

    </header>
    <div class="entry">
      
        <p>匹配中文字符的正则表达式： <strong>[\u4e00-\u9fa5]</strong><br>匹配双字节字符(包括汉字在内)：<strong>[^\x00-\xff]</strong></p>
<p>js代码：</p>
<figure class="highlight javaScript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> reg = <span class="regexp">/^[u4E00-u9FA5]+$/</span>;</div><div class="line">    <span class="keyword">if</span>(!reg.test(str)){</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    }</div><div class="line"><span class="keyword">return</span> <span class="literal">true</span>;</div></pre></td></tr></table></figure>

<p>java代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Pattern pattern = Pattern.compile(<span class="string">"[\u4e00-\u9fa5]"</span>);</div><div class="line">Matcher m = pattern.matcher(str);</div><div class="line"><span class="keyword">if</span> (m.matches()) {</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">} <span class="keyword">else</span> {</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p><br></p>
<h3 id="常用正则表达式">常用正则表达式</h3>
<p>说明：正则表达式通常用于两种任务：1.验证，2.搜索/替换。用于验证时，通常需要在前后分别加上^和$，以匹配整个待验证字符串；搜索/替换时是否加上此限定则根据搜索的要求而定，此外，也有可能要在前后加上\b而不是^和$。此表所列的常用正则表达式，除个别外均未在前后加上任何限定，请根据需要，自行处理。</p>
<p>说明     | 正则表达式<br>网址（URL）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[a-zA-z]+://[^\s]*</div></pre></td></tr></table></figure>

<p>IP地址(IP Address)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">((2[0-4]\d|25[0-5]|[01]?\d\d?)\.){3}(2[0-4]\d|25[0-5]|[01]?\d\d?)</div></pre></td></tr></table></figure>

<p>电子邮件(Email)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*</div></pre></td></tr></table></figure>

<p>QQ号码    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[1-9]\d{4,}</div></pre></td></tr></table></figure>

<p>HTML标记(包含内容或自闭合)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">(.*)(.*)</span>&gt;</span>.*<span class="tag">&lt;<span class="title">\</span>/\<span class="attribute">1</span>&gt;</span>|<span class="tag">&lt;<span class="title">(.*)</span> \/&gt;</span></div></pre></td></tr></table></figure>

<p>密码(由数字/大写字母/小写字母/标点符号组成，四种都必有，8位以上)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(?=^.{8,}$)(?=.*\d)(?=.*\W+)(?=.*[A-Z])(?=.*[a-z])(?!.*\n).*$</div></pre></td></tr></table></figure>

<p>日期(年-月-日)</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(\d{4}|\d{2})-((1[0-2])|(0?[1-9]))-(([12][0-9])|(3[01])|(0?[1-9]))</div></pre></td></tr></table></figure>

<p>日期(月/日/年)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">((1[0-2])|(0?[1-9]))/(([12][0-9])|(3[01])|(0?[1-9]))/(\d{4}|\d{2})</div></pre></td></tr></table></figure>


<p>时间(小时:分钟, 24小时制)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">((1|0?)[0-9]|2[0-3]):([0-5][0-9])</div></pre></td></tr></table></figure>

<p>汉字(字符)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[\u4e00-\u9fa5]</div></pre></td></tr></table></figure>


<p>中文及全角标点符号(字符)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[\u3000-\u301e\ufe10-\ufe19\ufe30-\ufe44\ufe50-\ufe6b\uff01-\uffee]</div></pre></td></tr></table></figure>


<p>中国大陆固定电话号码    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(\d{4}-|\d{3}-)?(\d{8}|\d{7})</div></pre></td></tr></table></figure>

<p>中国大陆手机号码    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1\d{10}</div></pre></td></tr></table></figure>


<p>中国大陆邮政编码    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[1-9]\d{5}</div></pre></td></tr></table></figure>


<p>中国大陆身份证号(15位或18位)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\d{15}(\d\d[0-9xX])?</div></pre></td></tr></table></figure>

<p>非负整数(正整数或零)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\d+</div></pre></td></tr></table></figure>

<p>正整数    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[0-9]*[1-9][0-9]*</div></pre></td></tr></table></figure>


<p>负整数    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-[0-9]*[1-9][0-9]*</div></pre></td></tr></table></figure>

<p>整数    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-?\d+</div></pre></td></tr></table></figure>

<p>小数    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(-?\d+)(\.\d+)?</div></pre></td></tr></table></figure>

<p>不包含abc的单词    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\b((?!abc)\w)+\b</div></pre></td></tr></table></figure>



<p>以上正则表达式均经过多次测试，如果你发现有错误，请通过微博联系我．</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-08-15T09:06:46.000Z"><a href="/2012/08/15/java-mybatis/">8月 15 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/08/15/java-mybatis/">分享一个java对mybatis封装</a></h1>
  

    </header>
    <div class="entry">
      
        <p><br></p>
<p>写了一个对mybatis封装code,源码</p>
<p>BaseDao是一个基础类,对Mapper中方法的实现</p>
<pre><code><span class="comment">/*
 * Copyright 2012-2017 MUSN.com All right reserved. This software is the confidential and proprietary information of
 * MUSN.com ("Confidential Information"). You shall not disclose such Confidential Information and shall use it only
 * in accordance with the terms of the license agreement you entered into with MUSN.com.
 */</span>
<span class="keyword">package</span> com.msun.app.biz.base;

<span class="keyword">import</span> java.io.Serializable;
<span class="keyword">import</span> java.lang.reflect.Method;
<span class="keyword">import</span> java.lang.reflect.ParameterizedType;
<span class="keyword">import</span> java.lang.reflect.Type;
<span class="keyword">import</span> java.util.Arrays;
<span class="keyword">import</span> java.util.Collection;
<span class="keyword">import</span> java.util.Collections;
<span class="keyword">import</span> java.util.HashMap;
<span class="keyword">import</span> java.util.List;
<span class="keyword">import</span> java.util.Map;

<span class="keyword">import</span> org.apache.commons.lang.StringUtils;
<span class="keyword">import</span> org.apache.ibatis.session.SqlSession;
<span class="keyword">import</span> org.mybatis.spring.SqlSessionTemplate;
<span class="keyword">import</span> org.mybatis.spring.support.SqlSessionDaoSupport;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;

<span class="keyword">import</span> com.msun.app.common.core.lang.Argument;
<span class="keyword">import</span> com.msun.app.common.core.lang.ArrayUtils;
<span class="keyword">import</span> com.msun.app.common.core.lang.Assert;
<span class="keyword">import</span> com.msun.app.common.exception.UnSupportBaseDaoException;
<span class="keyword">import</span> com.msun.app.common.pagination.Pagination;
<span class="keyword">import</span> com.msun.app.common.pagination.PaginationList;
<span class="keyword">import</span> com.msun.app.common.pagination.PaginationParser;
<span class="keyword">import</span> com.msun.app.common.pagination.PaginationParser.IPageUrl;

<span class="javadoc">/**
 * 分页可以不注入SqlSessionTemplate对象,用Mapper方式实现,在BaseDao封装
 * 
 *<span class="javadoctag"> @author</span> zxc Jun 15, 2012 11:10:41 PM
 */</span>
<span class="annotation">@SuppressWarnings</span>({ <span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span> })
<span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDao</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Serializable</span>, <span class="title">M</span>, <span class="title">Q</span>&gt; <span class="keyword">extends</span> <span class="title">SqlSessionDaoSupport</span> <span class="keyword">implements</span> <span class="title">IBase</span> </span>{

    <span class="annotation">@Autowired</span>
    <span class="keyword">protected</span> M      m;

    <span class="keyword">private</span> Class&lt;T&gt; entityClass;

    <span class="keyword">private</span> Class&lt;M&gt; mapperClass;

    <span class="annotation">@Autowired</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSqlSessionTemplate</span>(SqlSessionTemplate sqlSessionTemplate) {
        <span class="keyword">super</span>.setSqlSessionTemplate(sqlSessionTemplate);
    }

    <span class="javadoc">/**
     * 创建默认构造方法，以取得真正的泛型类型
     */</span>
    <span class="keyword">public</span> <span class="title">BaseDao</span>() {
        Class&lt;?&gt; c = getClass();
        Type type = c.getGenericSuperclass();
        <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) {
            Type[] parameterizedType = ((ParameterizedType) type).getActualTypeArguments();
            <span class="keyword">if</span> (Argument.isEmptyArray(parameterizedType)) {
                <span class="keyword">throw</span> <span class="keyword">new</span> UnSupportBaseDaoException(<span class="string">"init entityClass mapperClass failed!"</span>);
            }
            <span class="keyword">this</span>.entityClass = (Class&lt;T&gt;) parameterizedType[<span class="number">0</span>];
            <span class="keyword">this</span>.mapperClass = (Class&lt;M&gt;) parameterizedType[<span class="number">1</span>];
        } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> UnSupportBaseDaoException(String.format(<span class="string">"没有找到【%s】的动态参数T"</span>, getClass().getSimpleName()));
        }
    }

    <span class="annotation">@Override</span>
    <span class="keyword">public</span> Class&lt;T&gt; <span class="title">getEntityClass</span>() {
        <span class="keyword">return</span> entityClass;
    }

    <span class="javadoc">/**
     * 命名空间
     * 
     *<span class="javadoctag"> @return</span> String
     */</span>
    <span class="keyword">public</span> String <span class="title">getNameSpace</span>() {
        <span class="keyword">return</span> mapperClass.getName();
    }

    <span class="javadoc">/**
     * 根据ID查询对象
     */</span>
    <span class="keyword">public</span> &lt;D extends Number&gt; T <span class="title">getById</span>(D id) {
        Assert.assertNotNull(id);
        <span class="keyword">if</span> (id <span class="keyword">instanceof</span> Integer) {
            <span class="keyword">return</span> ((BaseMapper&lt;T&gt;) m).getById((Integer) id);
        }
        <span class="keyword">if</span> (id <span class="keyword">instanceof</span> Long) {
            <span class="keyword">return</span> ((BaseMapper&lt;T&gt;) m).getById(((Long) id).intValue());
        }
        <span class="keyword">return</span> <span class="keyword">null</span>;
    }

    <span class="javadoc">/**
     * 分页查询,已废弃，请使用paginationList
     * 
     *<span class="javadoctag"> @param</span> map
     *<span class="javadoctag"> @return</span>
     */</span>
    <span class="annotation">@Deprecated</span>
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">listPagination</span>(Pagination pagination) {
        <span class="keyword">return</span> ((BaseMapper&lt;T&gt;) m).listPagination(pagination);
    }

    <span class="javadoc">/**
     * 查询所有或limit 的几条数据
     * 
     *<span class="javadoctag"> @param</span> map
     *<span class="javadoctag"> @param</span> limitSize == null 则查所有
     */</span>
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">listAll</span>(Integer limitSize) {
        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();
        map.put(<span class="string">"limitSize"</span>, limitSize);
        map.put(<span class="string">"endRecordIndex"</span>, limitSize);
        map.put(<span class="string">"startRecordIndex"</span>, <span class="number">0</span>);
        <span class="keyword">return</span> ((BaseMapper&lt;T&gt;) m).list(map);
    }

    <span class="javadoc">/**
     * 查询所有数据
     */</span>
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">list</span>() {
        <span class="keyword">return</span> <span class="keyword">this</span>.listAll(<span class="keyword">null</span>);
    }

    <span class="javadoc">/**
     * Find 查询所有数据,mapper.xml中必须有find等SQL语句
     * 
     *<span class="javadoctag"> @param</span> q
     */</span>
    <span class="keyword">public</span> T <span class="title">find</span>(Q q) {
        Assert.assertNotNull(q);
        <span class="keyword">return</span> (T) <span class="keyword">this</span>.getSqlSession().selectOne(_getNameSpace() + <span class="string">"find"</span>, (Pagination) q);
    }

    <span class="javadoc">/**
     * Find 查询所有数据,mapper.xml中必须有自定义queryStatementName等SQL语句
     * 
     *<span class="javadoctag"> @param</span> queryStatementName 查询操作语句
     *<span class="javadoctag"> @param</span> q
     */</span>
    <span class="keyword">public</span> T <span class="title">find</span>(Q q, String queryStatementName) {
        Assert.assertNotNull(q);
        <span class="keyword">return</span> (T) <span class="keyword">this</span>.getSqlSession().selectOne(_getNameSpace() + queryStatementName, (Pagination) q);
    }

    <span class="javadoc">/**
     * List 查询数据,mapper.xml中必须有listQuery等SQL语句
     * 
     *<span class="javadoctag"> @param</span> q
     */</span>
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">list</span>(Q q) {
        Assert.assertNotNull(q);
        <span class="keyword">return</span> <span class="keyword">this</span>.getSqlSession().selectList(_getNameSpace() + <span class="string">"listQuery"</span>, (Pagination) q);
    }

    <span class="javadoc">/**
     * List 查询数据,mapper.xml中必须有自定义queryStatementName等SQL语句
     * 
     *<span class="javadoctag"> @param</span> queryStatementName 查询操作语句
     *<span class="javadoctag"> @param</span> q
     */</span>
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">list</span>(Q q, String queryStatementName) {
        Assert.assertNotNull(q);
        <span class="keyword">return</span> <span class="keyword">this</span>.getSqlSession().selectList(_getNameSpace() + queryStatementName, (Pagination) q);
    }

    <span class="javadoc">/**
     * PaginationList 查询数据
     * 
     * &lt;pre&gt;
     *      1.默认COUNT查询语句为'count',
     *      2.默认PAGINATION查询语句为'listPagination',
     *      3.请实现getNameSpace()方法
     *      4.mapper.xml中必须有count，listPagination等SQL语句
     * &lt;/pre&gt;
     * 
     *<span class="javadoctag"> @param</span> q
     */</span>
    <span class="keyword">public</span> PaginationList <span class="title">paginationList</span>(Q q, IPageUrl... iPages) {
        Assert.assertNotNull(q);
        <span class="keyword">return</span> parsePages(q, <span class="keyword">this</span>.paginationList(<span class="string">"listPagination"</span>, q), iPages);
    }

    <span class="javadoc">/**
     * 已过时,请使用带有IPageUrl的同名方法
     * 
     *<span class="javadoctag"> @param</span> q
     *<span class="javadoctag"> @return</span>
     */</span>
    <span class="annotation">@Deprecated</span>
    <span class="keyword">public</span> PaginationList <span class="title">paginationList</span>(Q q) {
        Assert.assertNotNull(q);
        <span class="keyword">return</span> <span class="keyword">this</span>.paginationList(<span class="string">"listPagination"</span>, q);
    }

    <span class="javadoc">/**
     * 分页查询 默认COUNT查询语句为'count',请实现getNameSpace()方法
     * 
     *<span class="javadoctag"> @param</span> queryStatementName
     *<span class="javadoctag"> @param</span> query
     *<span class="javadoctag"> @return</span>
     */</span>
    <span class="keyword">public</span> PaginationList <span class="title">paginationList</span>(String queryStatementName, Q q, IPageUrl... iPages) {
        <span class="keyword">if</span> (StringUtils.isEmpty(queryStatementName)) {
            log.error(<span class="string">"BaseDao paginationList: queryStatementName is null,please check!"</span>);
            <span class="keyword">return</span> (PaginationList) Collections.&lt;Object&gt; emptyList();
        }
        Assert.assertNotNull(q);
        <span class="keyword">return</span> parsePages(q, <span class="keyword">this</span>.paginationList(<span class="string">"count"</span>, queryStatementName, q), iPages);
    }

    <span class="javadoc">/**
     * PaginationList 查询数据
     * 
     *<span class="javadoctag"> @param</span> countStatementName count操作语句
     *<span class="javadoctag"> @param</span> queryStatementName 分页操作语句
     *<span class="javadoctag"> @param</span> q
     *<span class="javadoctag"> @return</span>
     */</span>
    <span class="keyword">public</span> PaginationList <span class="title">paginationList</span>(String countStatementName, String queryStatementName, Q q, IPageUrl... iPages) {
        <span class="keyword">if</span> (StringUtils.isEmpty(countStatementName) || StringUtils.isEmpty(queryStatementName)) {
            log.error(<span class="string">"BaseDao paginationList:countStatementName or queryStatementName is null,please check!"</span>);
            <span class="keyword">return</span> (PaginationList) Collections.&lt;Object&gt; emptyList();
        }
        Assert.assertNotNull(q);
        <span class="keyword">return</span> parsePages(q, <span class="keyword">this</span>.queryForPagination(_getNameSpace() + countStatementName, _getNameSpace()
                                                                                           + queryStatementName,
                                                     (Pagination) q), iPages);
    }

    <span class="javadoc">/**
     * count Query 数据:默认COUNT查询语句为'count',请实现getNameSpace()方法
     * 
     *<span class="javadoctag"> @param</span> q
     */</span>
    <span class="keyword">public</span> Integer <span class="title">count</span>(Q q) {
        Assert.assertNotNull(q);
        <span class="keyword">return</span> (Integer) getSqlSession().selectOne(_getNameSpace() + <span class="string">"count"</span>, q);
    }

    <span class="javadoc">/**
     * count Query 数据:COUNT查询语句自定义queryStatementName等SQL语句,请实现getNameSpace()方法
     * 
     *<span class="javadoctag"> @param</span> queryStatementName 分页操作语句
     *<span class="javadoctag"> @param</span> q
     */</span>
    <span class="keyword">public</span> Integer <span class="title">count</span>(Q q, String queryStatementName) {
        Assert.assertNotNull(q);
        <span class="keyword">return</span> (Integer) getSqlSession().selectOne(_getNameSpace() + queryStatementName, q);
    }

    <span class="javadoc">/**
     * 根据主键ID删除
     */</span>
    <span class="keyword">public</span> &lt;D extends Number&gt; <span class="keyword">boolean</span> <span class="title">deleteById</span>(D id) {
        Assert.assertNotNull(id);
        Integer count = <span class="number">0</span>;
        <span class="keyword">if</span> (id <span class="keyword">instanceof</span> Integer) {
            count = ((BaseMapper&lt;T&gt;) m).deleteById((Integer) id);
        }
        <span class="keyword">if</span> (id <span class="keyword">instanceof</span> Long) {
            count = ((BaseMapper&lt;T&gt;) m).deleteById(((Long) id).intValue());
        }
        <span class="keyword">return</span> count == <span class="number">0</span> ? <span class="keyword">false</span> : <span class="keyword">true</span>;
    }

    <span class="javadoc">/**
     * 插入 T
     */</span>
    <span class="keyword">public</span> Integer <span class="title">insert</span>(T t) {
        Assert.assertNotNull(t);
        <span class="keyword">return</span> ((BaseMapper&lt;T&gt;) m).insert(t);
    }

    <span class="javadoc">/**
     * 插入 Arrays
     */</span>
    <span class="keyword">public</span> Integer <span class="title">insert</span>(T... t) {
        ArrayUtils.removeNullElement(t);
        <span class="keyword">if</span> (Argument.isEmptyArray(t)) {
            <span class="keyword">return</span> <span class="number">0</span>;
        }
        Assert.assertNotNull(t);
        <span class="keyword">if</span> (t.length == <span class="number">1</span> &amp;&amp; t[<span class="number">0</span>] != <span class="keyword">null</span>) {
            <span class="keyword">return</span> ((BaseMapper&lt;T&gt;) m).insert(t[<span class="number">0</span>]);
        }
        <span class="keyword">return</span> <span class="keyword">this</span>.batchInsertByMapper(Arrays.asList(t));
    }

    <span class="javadoc">/**
     * 插入 List
     */</span>
    <span class="keyword">public</span> Integer <span class="title">insert</span>(List&lt;T&gt; list) {
        Assert.assertNotNull(list);
        Integer lastInsertId = <span class="keyword">new</span> Integer(<span class="number">0</span>);
        <span class="keyword">for</span> (T t : list) {
            <span class="keyword">if</span> (t != <span class="keyword">null</span>) {
                lastInsertId = ((BaseMapper&lt;T&gt;) m).insert(t);
            }
        }
        <span class="keyword">return</span> lastInsertId;
    }

    <span class="javadoc">/**
     * 根据主键ID更新
     */</span>
    <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateById</span>(T... t) {
        Assert.assertNotNull(t);
        ArrayUtils.removeNullElement(t);
        <span class="keyword">if</span> (Argument.isEmptyArray(t)) {
            <span class="keyword">return</span> <span class="keyword">false</span>;
        }
        Assert.assertNotNull(t);
        Integer count = <span class="number">0</span>;
        <span class="keyword">if</span> (t.length == <span class="number">1</span> &amp;&amp; t[<span class="number">0</span>] != <span class="keyword">null</span>) {
            count = ((BaseMapper&lt;T&gt;) m).updateById(t[<span class="number">0</span>]);
        } <span class="keyword">else</span> {
            count = <span class="keyword">this</span>.batchUpdateByMapper(Arrays.asList(t));
        }
        <span class="keyword">return</span> count == <span class="keyword">null</span> ? <span class="keyword">false</span> : count == <span class="number">0</span> ? <span class="keyword">false</span> : <span class="keyword">true</span>;
    }

    <span class="javadoc">/**
     * 批量插入
     * 
     *<span class="javadoctag"> @param</span> sqlSessionFactory
     *<span class="javadoctag"> @param</span> mapperClass 要使用的Mapper的Class
     *<span class="javadoctag"> @param</span> pojoClass 列表中POJO对象的Class
     *<span class="javadoctag"> @param</span> methodName 要执行的Mapper类中的方法名 默认insert
     *<span class="javadoctag"> @param</span> objList 要入库的数据列表
     */</span>
    <span class="keyword">public</span> Integer <span class="title">batchInsertByMapper</span>(Collection&lt;T&gt; objList) {
        <span class="keyword">return</span> batchOptByMapper(objList, <span class="string">"insert"</span>);
    }

    <span class="javadoc">/**
     * 批量更新
     * 
     *<span class="javadoctag"> @param</span> sqlSessionFactory
     *<span class="javadoctag"> @param</span> mapperClass 要使用的Mapper的Class
     *<span class="javadoctag"> @param</span> pojoClass 列表中POJO对象的Class
     *<span class="javadoctag"> @param</span> methodName 要执行的Mapper类中的方法名 默认"updateById"
     *<span class="javadoctag"> @param</span> objList 要入库的数据列表
     */</span>
    <span class="keyword">public</span> Integer <span class="title">batchUpdateByMapper</span>(Collection&lt;T&gt; objList) {
        <span class="keyword">return</span> batchOptByMapper(objList, <span class="string">"updateById"</span>);
    }

    <span class="keyword">private</span> PaginationList <span class="title">parsePages</span>(Q q, PaginationList paginationList, IPageUrl... iPages) {
        ArrayUtils.removeNullElement(iPages);
        <span class="keyword">if</span> (Argument.isEmptyArray(iPages)) {
            <span class="keyword">return</span> paginationList;
        }
        <span class="keyword">if</span> (q <span class="keyword">instanceof</span> Pagination) {
            paginationList.setQuery(PaginationParser.getPaginationList(((Pagination) q).getNowPageIndex(),
                                                                       ((Pagination) q).getPageSize(),
                                                                       ((Pagination) q).getAllRecordNum(), iPages[<span class="number">0</span>]));
        }
        <span class="keyword">return</span> paginationList;
    }

    <span class="keyword">private</span> Integer <span class="title">batchOptByMapper</span>(Collection&lt;T&gt; objList, String methodName) {
        SqlSession session = getSqlSession();
        Class[] paramTypes = <span class="keyword">new</span> Class[<span class="number">1</span>];
        M mapper = (M) session.getMapper(mapperClass);

        <span class="keyword">try</span> {
            paramTypes[<span class="number">0</span>] = Class.forName(entityClass.getName());
            Method method = mapperClass.getMethod(methodName, Serializable.class);
            <span class="keyword">for</span> (Object obj : objList) {
                method.invoke(mapper, obj);
            }
        } <span class="keyword">catch</span> (Exception e) {
            log.error(<span class="string">"BaseDao batchOptByMapper:error()"</span>);
        }
        session.flushStatements();
        <span class="keyword">return</span> <span class="keyword">new</span> Integer(<span class="number">1</span>);
    }

    <span class="javadoc">/**
     * 分页查询
     * 
     *<span class="javadoctag"> @param</span> countStatementName 如果countStatementName==null，表示不查询Count()语句
     *<span class="javadoctag"> @param</span> queryStatementName 查询记录的StatementName
     *<span class="javadoctag"> @param</span> query 查询条件（需要设置currentPage和PageSize值，或是startRow和endRow值）
     *<span class="javadoctag"> @return</span>
     */</span>
    <span class="keyword">private</span> PaginationList <span class="title">queryForPagination</span>(String countStatementName, String queryStatementName, Pagination query) {
        PaginationList paginationList = <span class="keyword">new</span> PaginationList(query);
        <span class="keyword">if</span> (countStatementName != <span class="keyword">null</span>) {
            Integer obj = (Integer) getSqlSession().selectOne(countStatementName, query);
            <span class="keyword">int</span> totalCount = obj == <span class="keyword">null</span> ? <span class="number">0</span> : obj;
            query.init(totalCount);

            <span class="keyword">if</span> (totalCount &gt; <span class="number">0</span>) {
                List items = getSqlSession().selectList(queryStatementName, query);
                <span class="keyword">if</span> (items != <span class="keyword">null</span>) {
                    paginationList.addAll(items);
                }
            }
        } <span class="keyword">else</span> {
            List items = getSqlSession().selectList(queryStatementName, query);
            <span class="keyword">if</span> (items != <span class="keyword">null</span>) {
                paginationList.addAll(items);
            }
        }
        <span class="keyword">return</span> paginationList;
    }

    <span class="keyword">private</span> PaginationList <span class="title">queryForPagination</span>(<span class="keyword">int</span> count, String queryStatementName, Pagination query) {
        PaginationList paginationList = <span class="keyword">new</span> PaginationList(query);
        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) {
            query.init(count);
            List&lt;?&gt; items = getSqlSession().selectList(queryStatementName, query);
            <span class="keyword">if</span> (items != <span class="keyword">null</span>) {
                paginationList.addAll(items);
            }
        } <span class="keyword">else</span> {
            List items = getSqlSession().selectList(queryStatementName, query);
            <span class="keyword">if</span> (items != <span class="keyword">null</span>) {
                paginationList.addAll(items);
            }
        }
        <span class="keyword">return</span> paginationList;
    }

    <span class="keyword">private</span> String <span class="title">_getNameSpace</span>() {
        <span class="keyword">if</span> (StringUtils.isEmpty(getNameSpace())) {
            log.error(<span class="string">"BaseDao getNameSpace is null,please check!"</span>);
            <span class="keyword">return</span> StringUtils.EMPTY;
        }
        <span class="keyword">return</span> getNameSpace() + POINT;
    }
}
</code></pre><p><br></p>
<p>BaseMapper类</p>
<pre><code><span class="comment">/*
 * Copyright 2012-2017 MSUN.com All right reserved. This software is the confidential and proprietary information of
 * MSUN.com ("Confidential Information"). You shall not disclose such Confidential Information and shall use it only
 * in accordance with the terms of the license agreement you entered into with MSUN.com.
 */</span>
<span class="keyword">package</span> com.msun.app.biz.base;

<span class="keyword">import</span> java.io.Serializable;
<span class="keyword">import</span> java.util.List;
<span class="keyword">import</span> java.util.Map;

<span class="keyword">import</span> com.msun.app.common.pagination.Pagination;

<span class="javadoc">/**
 * &lt;pre&gt;
 *      可以在BaseMapper中加入Q查询对象 BaseMapper&lt;T,Q&gt;,分页可以用BaseMapper实现然后在BaseDao中封装掉
 * &lt;/pre&gt;
 * 
 *<span class="javadoctag"> @author</span> zxc Jun 15, 2012 11:11:48 PM
 */</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BaseMapper</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; </span>{

    <span class="javadoc">/**
     * 根据ID查找
     * 
     *<span class="javadoctag"> @param</span> id
     *<span class="javadoctag"> @return</span>
     */</span>
    <span class="keyword">public</span> T <span class="title">getById</span>(Integer id);

    <span class="javadoc">/**
     * 分页查询返回第一页
     * 
     *<span class="javadoctag"> @param</span> map
     *<span class="javadoctag"> @return</span>
     */</span>
    <span class="annotation">@Deprecated</span>
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">listPagination</span>(Pagination pagination);

    <span class="javadoc">/**
     * 查询所有或limit 的几条数据
     * 
     *<span class="javadoctag"> @param</span> map
     *<span class="javadoctag"> @param</span> limitSize == null 则查所有
     */</span>
    <span class="keyword">public</span> List&lt;T&gt; <span class="title">list</span>(Map&lt;String, Object&gt; map);

    <span class="javadoc">/**
     * 删除
     * 
     *<span class="javadoctag"> @param</span> id
     *<span class="javadoctag"> @return</span>
     */</span>
    <span class="keyword">public</span> Integer <span class="title">deleteById</span>(Integer id);

    <span class="javadoc">/**
     * 插入新数据
     */</span>
    <span class="keyword">public</span> Integer <span class="title">insert</span>(T t);

    <span class="javadoc">/**
     * 根据Id更新对象
     * 
     *<span class="javadoctag"> @param</span> t
     *<span class="javadoctag"> @return</span>
     */</span>
    <span class="keyword">public</span> Integer <span class="title">updateById</span>(T t);
}
</code></pre><p>Pagination类源码就不放了吧,有兴趣可以查看我的github源码。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>








<ul class="page-direction" id="page-direction">
    <li><a class="page-prev icon-chevron-sign-left" href="javascript:;" title="上一页"></a></li>
    <li><a class="page-next icon-chevron-sign-right" href="javascript:;" title="下一页"></a></li>
</ul>

    <nav id="page-list" class="page-list"><a class="extend prev" rel="prev" href="/page/3/">Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next</a></nav>

<nav id="pagination">
  
    <a href="/page/3/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/5/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="text" name="q" results="0" placeholder="搜一下">
    <i class="icon-search"></i>
    <input type="hidden" name="q" value="site:lawrence-zxc.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/Git/">Git</a><small>2</small></li>
  
    <li><a href="/tags/Java/">Java</a><small>20</small></li>
  
    <li><a href="/tags/JavaScript/">JavaScript</a><small>4</small></li>
  
    <li><a href="/tags/LeetCode/">LeetCode</a><small>2</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>14</small></li>
  
    <li><a href="/tags/Mac-Unix/">Mac/Unix</a><small>1</small></li>
  
    <li><a href="/tags/Maven/">Maven</a><small>1</small></li>
  
    <li><a href="/tags/Mysql/">Mysql</a><small>2</small></li>
  
    <li><a href="/tags/Nginx/">Nginx</a><small>5</small></li>
  
    <li><a href="/tags/Oracle/">Oracle</a><small>4</small></li>
  
    <li><a href="/tags/Python/">Python</a><small>3</small></li>
  
    <li><a href="/tags/XMPP/">XMPP</a><small>1</small></li>
  
    <li><a href="/tags/其他/">其他</a><small>1</small></li>
  
    <li><a href="/tags/开始/">开始</a><small>4</small></li>
  
    <li><a href="/tags/技术/">技术</a><small>1</small></li>
  
    <li><a href="/tags/旅行/">旅行</a><small>1</small></li>
  
    <li><a href="/tags/架构/">架构</a><small>2</small></li>
  
    <li><a href="/tags/生活/">生活</a><small>1</small></li>
  
    <li><a href="/tags/读书/">读书</a><small>1</small></li>
  
    <li><a href="/tags/随感/">随感</a><small>7</small></li>
  
  </ul>
</div>


  <div class="trace-invest">
    <span>
        <a href="https://github.com/Lawrence-zxc" target="_blank">欢迎光临我的技术Blog网站 </br>Fork me on Github</a>
    </span>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/04/04/jishu-hehuoren/">技术合伙人为什么喜欢谈钱胜过情怀？</a>
      </li>
    
      <li>
        <a href="/2015/04/01/reverse-o2o/">分享一个用户自发需求的反向O2O设想</a>
      </li>
    
      <li>
        <a href="/2015/03/08/shujiawang/">面向企业和个人O2O图书租赁服务设想</a>
      </li>
    
      <li>
        <a href="/2015/03/05/pingjiaapp/">关于电商商品评价评论独立第三方平台构想</a>
      </li>
    
      <li>
        <a href="/2015/01/23/suishoupai/">关于随手拍图片人脸识别APP需求的想法</a>
      </li>
    
      <li>
        <a href="/2014/11/25/xushen/">徐神的诗</a>
      </li>
    
      <li>
        <a href="/2014/11/20/openfire/">Openfire服务端错误解决</a>
      </li>
    
      <li>
        <a href="/2014/11/10/oracle-index/">Oracle大批量高效地更新大数据表索引字段</a>
      </li>
    
      <li>
        <a href="/2014/11/10/oracle-partition/">Oracle Partition Common Usage</a>
      </li>
    
      <li>
        <a href="/2014/11/10/xmpp/">xmpp通信过程分析</a>
      </li>
    
      <li>
        <a href="/2014/10/28/jvm-strace/">jvm退出的原因,使用strace定位</a>
      </li>
    
      <li>
        <a href="/2014/10/28/load-balancing/">负载均衡和过载保护</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Jeck Zhang
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a5eb19e532c0b101d72226b1325e6a78";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</body>

</html>