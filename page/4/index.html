<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 4 页 | Jeck_Zhang</title>
  <meta name="author" content="Jeck Zhang">
  
  <meta name="description" content="zxc&#39;s blog | java | ruby | perl | linux">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Jeck_Zhang"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link type="image/x-icon" href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Jeck_Zhang" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="/js/jquery.min.js"></script>
  
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45019001-1', 'topdna.org');
  ga('send', 'pageview');

</script>


</head>


<body>
  <!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0027_Simplified Chinese.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Jeck_Zhang</a></h1>
  <h2><a href="/">Write the Code. Change the World.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="http://weibo.com/zxc337">weibo</a></li>
    
      <li><a href="/2014/10/01/aboutMe/">关于</a></li>
    
      <li><a href="/tags/随感/">随感</a></li>
    
      <li><a href="/tags/技术/">技术</a></li>
    
      <li><a href="/tags/理财/">理财</a></li>
    
      <li><a href="/tags/生活/">生活</a></li>
    
      <li><a href="/archives">归档</a></li>
    
    <li><a href="/atom.xml">RSS</a></li>
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2013-03-21T04:00:35.000Z"><a href="/2013/03/21/nginx-gzip/">3月 21 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/03/21/nginx-gzip/">nginx启用gzip压缩</a></h1>
  

    </header>
    <div class="entry">
      
        <p><br></p>
<p>网站的访问量如果越来越高，那么就需要考虑带宽的问题了，因为流量会提升一些费用成本，没有经过压缩的文本也会影响网页的加载速度。当然我目前对这个考虑还是远了，因为流量对我来说还没感受到那么大的问题。只是考虑用户提升访问速度。</p>
<p>当然了gzip压缩在当前HTTP传输来说还是主流的，所有的服务器应该都能启用gzip压缩才对。</p>
<p>对于Nginx来启用gzip很简单。打开nginx.conf配置进行编辑：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="title">http</span> {   <span class="comment">#在http里面进行设置</span></div><div class="line"> </div><div class="line">    <span class="comment">#开启gzip压缩</span></div><div class="line">    <span class="title">gzip</span>  <span class="built_in">on</span>;</div><div class="line"> </div><div class="line">    <span class="comment">#启用gzip压缩最小长度必须大于1kB，否则不启用压缩</span></div><div class="line">    <span class="title">gzip_min_length</span> <span class="number">1k</span>;</div><div class="line"> </div><div class="line">    <span class="comment"># gzip压缩的缓冲区</span></div><div class="line">    <span class="title">gzip_buffers</span> <span class="number">4</span> <span class="number">16k</span>;</div><div class="line"> </div><div class="line">    <span class="comment"># gzip压缩的等级，0-9之间，数字越大，压缩率越高，但是cpu消耗也大。</span></div><div class="line">    <span class="title">gzip_comp_level</span> <span class="number">9</span>;</div><div class="line"> </div><div class="line">    <span class="comment"># 启用gzip的文件类型，一般text、css、json、javascript、xml进行压缩，image最好不要压缩了吧？</span></div><div class="line">    <span class="title">gzip_types</span> text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;</div><div class="line"> </div><div class="line">    <span class="comment"># 和http头有关系，加个vary头，给代理服务器用的，有的浏览器支持压缩，有的不支持。</span></div><div class="line">    <span class="comment"># 因此，为避免浪费不支持的也压缩，需要根据客户端的HTTP头来判断，是否需要压缩。</span></div><div class="line">    <span class="title">gzip_vary</span> <span class="built_in">on</span>;</div><div class="line"> </div><div class="line">    <span class="comment"># 好吧，IE6对gzip压缩不太好，但是应该要淘汰IE6了吧，你的受众是IE6用户，那么你也太没有魅力了。</span></div><div class="line">    <span class="comment">#gzip_disable "MSIE [1-6]\.";</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>推荐一个：<a href="http://gtmetrix.com/可以对页面访问速度进行一个打分，类似google" target="_blank" rel="external">http://gtmetrix.com/可以对页面访问速度进行一个打分，类似google</a> page speed。<br>还有一个，阿里测<a href="http://alibench.com/" target="_blank" rel="external">http://alibench.com/</a></p>
<h4 id="参考文章">参考文章</h4>
<ul>
<li><a href="http://blog.csdn.net/xzknet/article/details/7416148" target="_blank" rel="external">http://blog.csdn.net/xzknet/article/details/7416148</a></li>
<li><a href="http://www.veryhuo.com/a/view/51706.html" target="_blank" rel="external">http://www.veryhuo.com/a/view/51706.html</a></li>
<li><a href="http://willko.iteye.com/blog/667091" target="_blank" rel="external">http://willko.iteye.com/blog/667091</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2013-02-07T08:15:33.000Z"><a href="/2013/02/07/linux-share/">2月 7 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/02/07/linux-share/">Linux Shell编程分享总结</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="一-linux基础命令">一.linux基础命令</h2>
<h3 id="1-系统相关">1.系统相关</h3>
<p>$PATH</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">echo</span> <span class="variable">$PATH</span> | tr <span class="string">':'</span> <span class="string">'\n'</span>`; <span class="keyword">do</span> ls <span class="variable">$i</span> <span class="number">2</span>&gt;/dev/null; <span class="keyword">done</span>               <span class="comment">#显示所有的linux命令</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">echo</span> <span class="variable">$PATH</span> |tr <span class="string">':'</span> <span class="string">'\n'</span>|grep -v <span class="string">"yueji"</span>|grep -v <span class="string">"home"</span>`; <span class="keyword">do</span> ls <span class="variable">$i</span> <span class="number">2</span>&gt;/dev/null; <span class="keyword">done</span></div></pre></td></tr></table></figure>

<p>crontab,at</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">crontab <span class="operator">-l</span> <span class="comment">#查看当前用户的计划任务  </span></div><div class="line">crontab -r <span class="comment">#删除</span></div><div class="line">crontab <span class="operator">-e</span> <span class="comment">#编辑</span></div></pre></td></tr></table></figure>

<p>时间程式的格式:<br>　　分钟f1 小时f2 日f3 月f4 星期f5 program<br>　　当 f1 为 <em> 时表示每分钟都要执行 program,f2 为 </em> 时表示每小时都要执行程式<br>　　当 f1 为 a-b 时表示从第 a 分钟到第 b 分钟这段时间内要执行,f2 为 a-b 时表示从第 a 到第 b 小时都要执行<br>　　当 f1 为 <em>/n 时表示每 n 分钟个时间间隔执行一次,f2 为 </em>/n 表示每 n 小时个时间间隔执行一次<br>　　当 f1 为 a, b, c,… 时表示第 a, b, c,… 分钟要执行,f2 为 a, b, c,… 时表示第 a, b, c…个小时要执行<br>　　每月每天每小时的第0分钟执行一次 /bin/top:<br>　　0 <em> </em> <em> </em> /bin/top </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">at <span class="number">23</span>:<span class="number">59</span> <span class="number">12</span>/<span class="number">31</span>/<span class="number">2013</span></div></pre></td></tr></table></figure>

<p>echo the end of world ! #定时任务(需要开启<code>/etc/init.d/atd start</code>)</p>
<p>系统命令 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">bg,fb,jobs <span class="comment">#进程与作业</span></div><div class="line">&   <span class="comment">#在后台挂起程序 </span></div><div class="line">^Z <span class="comment">#挂起(暂停)前台程序 </span></div><div class="line">fg <span class="comment">#将作业移到前台 </span></div><div class="line">suspend <span class="comment">#挂起(暂停)shell </span></div><div class="line">jobs <span class="comment">#显示作业信息 </span></div><div class="line">bg <span class="comment">#将作业移至后台 </span></div><div class="line">ps <span class="comment">#显示进程信息 </span></div><div class="line">top <span class="comment">#显示使用最多CPU的进程的数据 </span></div><div class="line">prstat <span class="comment">#显示进程的动态信息 </span></div><div class="line">pstree <span class="comment">#显示进程树图表 </span></div><div class="line">ptree <span class="comment">#显示进程树图表 </span></div><div class="line">fuser <span class="comment">#识别使用指定文件的进程 </span></div><div class="line">kill <span class="comment">#终止进程；给进程发送信号 </span></div><div class="line">nice <span class="comment">#使用指定的调度优先级运行程序 </span></div><div class="line">renice <span class="comment">#改变已运行程序的调度优先级</span></div></pre></td></tr></table></figure>

<p>free</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">free -m |grep <span class="string">"Mem"</span> | awk <span class="string">'{print $2}'</span></div></pre></td></tr></table></figure>

<p>df,du,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">df -h <span class="comment"># 查看各分区使用情况</span></div><div class="line">du -sh &lt;目录名&gt; <span class="comment"># 查看指定目录的大小</span></div></pre></td></tr></table></figure>

<p>uptime,w,top,ps</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">uptime <span class="comment"># 查看系统运行时间、用户数、负载</span></div><div class="line">ps aux | sort -nk +<span class="number">4</span> | tail <span class="comment">#显示消耗内存最多的 10 个运行中的进程，以内存使用量排序</span></div></pre></td></tr></table></figure>

<p>last,history</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">last <span class="comment"># 查看用户登录日志</span></div><div class="line">last | cut <span class="operator">-d</span> <span class="string">' '</span> <span class="operator">-f</span> <span class="number">1</span> <span class="comment">#查看最近登陆的用户名</span></div><div class="line">last |tr <span class="operator">-s</span> <span class="string">' '</span>| cut <span class="operator">-d</span> <span class="string">' '</span> <span class="operator">-f</span> <span class="number">2</span>|less </div><div class="line">history | awk <span class="string">'{a[$2]++}END{for(i in a){print a[i] " " i}}'</span> | sort -rn | head <span class="comment">#列出你最常用的10条命令</span></div><div class="line">history | awk {<span class="string">'print $2'</span>} | sort | uniq -c | sort -k1 -rn <span class="comment">#输出用户了命令历史；awk统计并输出列表；sort排序；head截出前10行</span></div></pre></td></tr></table></figure>

<p>netstat,ifconfig</p>
<p>mount,unmount,</p>
<p>source<br>管道,重定向,tee</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ls <span class="operator">-l</span> /home | tee ~/homefile | more </div><div class="line">ls <span class="operator">-l</span> / | tee <span class="operator">-a</span> ~/homefile | more <span class="comment">#-a是append</span></div></pre></td></tr></table></figure>

<p>ulimit命令</p>
<p>source 在当前shell中执行指定shell程序。 </p>
<h3 id="2-用户相关">2.用户相关</h3>
<p>权限:chmod,chgrp,chown</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">chown +x file 与 chown <span class="number">774</span> file 与 chown u+x file 区别? </div><div class="line">chmod ugo+rwx directory1 <span class="comment">#设置目录的所有人(u)、群组(g)以及其他人(o)以读（r ）、写(w)和执行(x)的权限</span></div><div class="line">chmod go-rwx directory1 <span class="comment">#删除群组(g)与其他人(o)对目录的读写执行权限</span></div><div class="line">chown user1 file1 <span class="comment">#改变一个文件的所有人属性</span></div><div class="line">chown -R user1 directory1 <span class="comment">#改变一个目录的所有人属性并同时改变改目录下所有文件的属性</span></div><div class="line">chgrp group1 file1 <span class="comment">#改变文件的群组</span></div><div class="line">chown user1:group1 file1 <span class="comment">#改变一个文件的所有人和群组属性</span></div></pre></td></tr></table></figure>

<p>groups,groupadd,groupdel,group mod,useradd,userdel,usermod </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">groups <span class="comment">#该命令用于显示当前用户所在的组</span></div><div class="line">groupadd group_name <span class="comment">#创建一个新用户组</span></div><div class="line">groupdel group_name <span class="comment">#删除一个用户组</span></div><div class="line">groupmod -n new_group_name old_group_name <span class="comment">#重命名一个用户组,该命令用户修改组的属性</span></div><div class="line">useradd -c <span class="string">"Name Surname"</span> -g admin <span class="operator">-d</span> /home/user1 <span class="operator">-s</span> /bin/bash user1 <span class="comment">#创建一个属于 "admin" 用户组的用户</span></div><div class="line">useradd user1 <span class="comment">#创建一个新用户</span></div><div class="line">userdel -r user1 <span class="comment">#删除一个用户('-r' 排除主目录)</span></div><div class="line">usermod -c <span class="string">"User FTP"</span> -g system <span class="operator">-d</span> /ftp/user1 <span class="operator">-s</span> /bin/nologin user1 <span class="comment">#修改用户属性</span></div><div class="line">passwd <span class="comment">#修改口令</span></div><div class="line">passwd user1 <span class="comment">#修改一个用户的口令(只容许root执行)</span></div><div class="line">chage -E <span class="number">2005</span>-<span class="number">12</span>-<span class="number">31</span> user1 <span class="comment">#设置用户口令的失效期限</span></div><div class="line">newgrp group_name <span class="comment">#登陆进一个新的群组以改变新创建文件的预设群组</span></div><div class="line">w,who <span class="comment">#查看当前计算器有哪些用户登录</span></div><div class="line">whoami  <span class="comment">#查看当前登录用户名</span></div></pre></td></tr></table></figure>

<h3 id="3-文件相关">3.文件相关</h3>
<p>mime,ctime,atime</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">find /home/dam -name <span class="string">"*.zip"</span> -mtime +<span class="number">7</span> -o -name <span class="string">"*.xml"</span> -mtime +<span class="number">7</span> | xargs rm <span class="operator">-f</span> <span class="comment">#查找七天前</span></div><div class="line">find /home/dam \( -name *.zip -o -name *.xml \) -ctime +<span class="number">7</span></div></pre></td></tr></table></figure>

<p>查看ls</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ls /tmp | pr -T5 -W<span class="variable">$COLUMNS</span> <span class="comment">#将终端划分成5栏显示</span></div><div class="line">ls | sed <span class="string">"s:^:`pwd`/:"</span> <span class="comment">#列出文件的绝对路径</span></div></pre></td></tr></table></figure>

<p>文件:lsattr,chattr,cat,tac,tail,head,nl, more,less, dd </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chattr +a file1 <span class="comment">#只允许以追加方式读写文件 </span></div><div class="line">chattr +i file1 <span class="comment">#设置成不可变的文件，不能被删除、修改、重命名或者链接</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[admin@server190 ~]$ lsattr <span class="operator">-d</span> ~/work</div><div class="line">----<span class="operator">-a</span>------<span class="operator">-e</span>- /home/admin/work</div></pre></td></tr></table></figure>

<p>归档,打包,解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">tar -cvzf ,tar -xvzf <span class="comment">#打包和压缩文件</span></div><div class="line">bunzip2 file1.bz2 <span class="comment">#解压'file1.bz2'这个文件</span></div><div class="line">bzip2 file1 <span class="comment">#压缩一个叫做'file1' 的文件</span></div><div class="line">gunzip file1.gz <span class="comment">#解压一个叫做'file1.gz'的文件</span></div><div class="line">gzip file1 <span class="comment">#压缩一个叫做'file1'的文件</span></div><div class="line">gzip -<span class="number">9</span> file1 <span class="comment">#最大程度压缩</span></div><div class="line">rar a file1.rar test_file <span class="comment">#创建一个叫做 'file1.rar' 的包</span></div><div class="line">rar a file1.rar file1 file2 dir1 <span class="comment">#同时压缩 'file1', 'file2' 以及目录 'dir1'</span></div><div class="line">rar x file1.rar <span class="comment">#解压rar包</span></div><div class="line">unrar x file1.rar <span class="comment">#解压rar包</span></div><div class="line">tar -cvf archive.tar file1 <span class="comment">#创建一个非压缩的 tarball</span></div><div class="line">tar -cvf archive.tar file1 file2 dir1 <span class="comment">#创建一个包含了 'file1', 'file2' 以及 'dir1'的档案文件</span></div><div class="line">tar -tf archive.tar <span class="comment">#显示一个包中的内容</span></div><div class="line">tar -xvf archive.tar <span class="comment">#释放一个包</span></div><div class="line">tar -xvf archive.tar -C /tmp <span class="comment">#将压缩包释放到/tmp目录下</span></div><div class="line">tar -cjvf archive.tar.bz2 dir1 <span class="comment">#创建一个bzip2格式的压缩包</span></div><div class="line">tar -xjvf archive.tar.bz2 <span class="comment">#解压一个bzip2格式的压缩包</span></div><div class="line">tar -tjvf</div><div class="line">tar -czvf archive.tar.gz dir1 <span class="comment">#创建一个gzip格式的压缩包</span></div><div class="line">tar -xzvf archive.tar.gz <span class="comment">#解压一个gzip格式的压缩包</span></div><div class="line">tar -tzvf</div><div class="line">zip file1.zip file1 <span class="comment">#创建一个zip格式的压缩包</span></div><div class="line">zip -r file1.zip file1 file2 dir1 <span class="comment">#将几个文件和目录同时压缩成一个zip格式的压缩包</span></div><div class="line">unzip file1.zip <span class="comment">#解压一个zip格式压缩包</span></div></pre></td></tr></table></figure>

<p>搜索 find,locate,whereis</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">find -type d -name <span class="string">".svn"</span>|xargs rm -rf 或者 find -type d -iname <span class="string">".svn"</span> -exec rm -rf {} \;</div><div class="line">find -name <span class="string">'*.[ch]'</span> | xargs grep -E <span class="string">'expr'</span> <span class="comment">#在当前目录及其子目录下所有.c和.h文件中寻找'expr'</span></div><div class="line">find -type f -print0 | xargs -r0 grep -F <span class="string">'example'</span> <span class="comment">#在当前目录及其子目录中的常规文件中查找字符串'example'</span></div><div class="line">find -maxdepth <span class="number">1</span> -type d | <span class="keyword">while</span> <span class="built_in">read</span> dir; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$dir</span>; <span class="built_in">echo</span> cmd2; <span class="keyword">done</span> <span class="comment">#对每一个找到的文件执行多个命令(使用while循环)</span></div><div class="line">find -type f ! -perm -<span class="number">444</span> <span class="comment">#寻找所有不可读的文件</span></div><div class="line">find -type d ! -perm -<span class="number">111</span> <span class="comment">#寻找不可访问的目录</span></div><div class="line">locate -r <span class="string">'file[^/]*\.txt'</span> <span class="comment">#使用locate 查找所有符合*file*.txt的文件</span></div><div class="line">比较 diff 操作 ln,mkdir</div><div class="line">mkdir -p /tmp/dir1/dir2 <span class="comment">#创建一个目录树</span></div><div class="line">ln <span class="operator">-s</span> <span class="built_in">source</span> lnk1 <span class="comment">#创建一个指向文件或目录的软链接</span></div><div class="line">ln <span class="built_in">source</span> lnk1 <span class="comment">#创建一个指向文件或目录的物理链接</span></div></pre></td></tr></table></figure>

<p>seq</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">seq -ws <span class="string">'-'</span> <span class="number">1</span> <span class="number">100</span> <span class="comment">#输出1到100用-分割</span></div><div class="line">seq <span class="operator">-f</span> <span class="string">'dir%03g'</span> <span class="number">1</span> <span class="number">10</span> | xargs mkdir <span class="comment">#一次制做10 個名dir001 , dir002 .. dir010 的目录</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq <span class="operator">-f</span> <span class="string">'%02g'</span> <span class="number">1</span> <span class="number">20</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line"><span class="keyword">if</span> ! wget -P <span class="variable">$HOME</span>/tmp -c [img]http://www.yueji.com/photo/<span class="variable">$i</span>.jpg[/img] ; <span class="keyword">then</span></div><div class="line">wget -P <span class="variable">$HOME</span>/tmp -c <span class="variable">$_</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq -w <span class="number">1</span> <span class="number">20</span>`; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">'zxc'</span>_<span class="variable">$i</span>; <span class="keyword">done</span>;</div></pre></td></tr></table></figure>

<h2 id="二-linux文档,字符串操作">二.linux文档,字符串操作</h2>
<p>vi/vim, sed ,perl</p>
<h3 id="批量替换">批量替换</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">find -name <span class="string">'pom.xml'</span> | xargs perl -pi <span class="operator">-e</span> <span class="string">'s|http://repo1.maven.org/maven2|http://localhost:8081/nexus/content /groups/public|g'</span></div><div class="line">perl -pe <span class="string">'s/\r//g'</span> /tmp/t|grep -v ^$&gt;brand.txt <span class="comment">#替换回车换行</span></div><div class="line">perl -pe <span class="string">'s/^\n$//'</span> /tmp/t &gt; /tmp/tt <span class="comment">#去掉回车符号</span></div><div class="line">find -name <span class="string">"ubuntu_init_env.sh"</span>|sed -n <span class="string">'1p'</span>|xargs cat|sed -n <span class="string">"88p"</span>  <span class="comment">#取find命令找到的第一个文件cat，并取88行输出</span></div></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">"s/oldString/newString/g"</span> `grep oldString -rl /path`</div></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep oldString -rl /path | xargs sed -i <span class="string">"s/oldString/newString/g"</span></div></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">"abc"</span> * -R | awk -F: <span class="string">'{print $1}'</span> | sort | uniq | xargs sed -i <span class="string">'s/abc/abcde/g'</span> <span class="comment">#一次性将所有文件中的指定字符串进行修改</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'s/string1/string2/g'</span> <span class="comment">#使用string2替换string1</span></div><div class="line">sed <span class="string">'s/\(.*\)1/\12/g'</span> <span class="comment">#将任何以1结尾的字符串替换为以2结尾的字符串</span></div><div class="line">sed <span class="string">'/^ *#/d; /^ *$/d'</span> <span class="comment">#删除注释和空白行</span></div><div class="line">sed <span class="string">':a; /\\$/N; s/\\\n//; ta'</span> <span class="comment">#连接结尾有\的行和其下一行</span></div><div class="line">sed <span class="string">'s/[ \t]*$//'</span> <span class="comment">#删除每行后的空白</span></div><div class="line">sed <span class="string">'s/\([\\`\\"$\\\\]\)/\\\1/g'</span> <span class="comment">#将所有转义字符之前加上\</span></div><div class="line">seq <span class="number">10</span> | sed <span class="string">"s/^/ /; s/ *\(.\{7,\}\)/\1/"</span> <span class="comment">#向右排N(任意数)列</span></div><div class="line">sed -n <span class="string">'1000p;1000q'</span> <span class="comment">#输出第一千行</span></div><div class="line">sed -n <span class="string">'10,20p;20q'</span> <span class="comment">#输出第10-20行</span></div><div class="line">sed -n <span class="string">'s/.*&lt;title&gt;\(.*\)&lt;\/title&gt;.*/\1/ip;T;q'</span> <span class="comment">#输出HTML文件的&lt;title&gt;&lt;/title&gt;字段中的内容</span></div><div class="line">sort -t. -k1,<span class="number">1</span>n -k2,<span class="number">2</span>n -k3,<span class="number">3</span>n -k4,<span class="number">4</span>n <span class="comment">#排序IPV4地址</span></div></pre></td></tr></table></figure>

<h3 id="sort,uniq,wc,grep">sort,uniq,wc,grep</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uniq <span class="operator">-f</span> <span class="number">3</span> /var/log/messages   <span class="comment">#跳过前三个字段进行去重</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">'^MANPATH'</span> /etc/man.config | head -n <span class="number">3</span> | \</div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">grep -v <span class="string">'^$'</span> /etc/syslog.conf | grep -v <span class="string">'^#'</span>  <span class="comment"># 结果仅有 10 行，其中第一个 -v '^$' 代表不要空白行，第二个-v '^#'代表不要开头是 # 的那行</span></div><div class="line">grep -c <span class="string">"Exception"</span> logs/com.yue.commons.standalone.web.log  <span class="comment">#统计到grep匹配的次数</span></div><div class="line">grep -A10 <span class="string">"java.sql.SQLException:"</span> web.log|less  <span class="comment">#找到抛异常的地方并输出后续的10行</span></div><div class="line">grep -A10 --color=auto <span class="string">"java.sql.SQLException:"</span> web.log</div></pre></td></tr></table></figure>

<h3 id="cut,join,tr,col,split">cut,join,tr,col,split</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">'ZHANGXIONGCAI337@YUEJI.COM'</span>|tr <span class="string">"[A-Z]"</span> <span class="string">"[a-z]"</span> <span class="comment">#tr字符串替换</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'Test'</span> | tr <span class="string">'[:lower:]'</span> <span class="string">'[:upper:]'</span> <span class="comment">#转换成大写</span></div><div class="line">tr -dc <span class="string">'[:print:]'</span> &lt; /dev/urandom <span class="comment">#过滤掉不能打印的字符</span></div><div class="line">cat /etc/passwd | tr <span class="operator">-d</span> <span class="string">':'</span> <span class="comment">#将冒号删除</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">last | cut <span class="operator">-d</span> <span class="string">' '</span> <span class="operator">-f</span>1 | sort | uniq -c <span class="comment">#最近每个人登陆的总次数</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">sort file1 file2 | uniq <span class="comment">#两个未排序文件的并集</span></div><div class="line">sort file1 file2 | uniq <span class="operator">-d</span> <span class="comment">#两个未排序文件的交集</span></div><div class="line">sort file1 file1 file2 | uniq -u <span class="comment">#两个未排序文件的差集</span></div><div class="line">sort file1 file2 | uniq -u <span class="comment">#两个未排序文件的对称差集</span></div><div class="line">join -t<span class="string">'\0'</span> <span class="operator">-a</span>1 <span class="operator">-a</span>2 file1 file2 <span class="comment">#两个有序文件的并集</span></div><div class="line">join -t<span class="string">'\0'</span> file1 file2 <span class="comment">#两个有序文件的交集</span></div><div class="line">join -t<span class="string">'\0'</span> -v2 file1 file2 <span class="comment">#两个有序文件的差集</span></div><div class="line">join -t<span class="string">'\0'</span> -v1 -v2 file1 file2 <span class="comment">#两个有序文件的对称差集</span></div></pre></td></tr></table></figure>

<h3 id="awk">awk</h3>
<p>比较两个文件的不同 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'{if (NR==FNR) {a[$0]}; if (NR!=FNR&&!($0 in a)) {print $0}}'</span> firstfile secondfile   </div><div class="line">awk <span class="string">'NR==FNR {a[$0]} NR!=FNR&&!($0 in a) {print $0}'</span> firstfile secondfile   </div><div class="line">cat firstfile secondfile | sort |uniq -u</div></pre></td></tr></table></figure>

<h2 id="三-linux网络命令">三.linux网络命令</h2>
<h3 id="wget">wget</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -c http://www.yueji.com/bo.JPG <span class="comment">#断点续传 或者 curl -c -O http://www.yueji.com/bo.JPG</span></div></pre></td></tr></table></figure>

<h3 id="ssh_端口转发">ssh 端口转发</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ssh -N <span class="operator">-f</span> -R X:Y:Z K   <span class="comment">#远程转发 将IP为的Y机器的Z端口[映射到远程]机器K的X端口上,K机器就可以通过访问X端口,而访问Y的Z端口服务 -R ：remote (远程)</span></div><div class="line">ssh -R <span class="number">9090</span>:local-secret.com:<span class="number">8080</span> my-remote-host.com <span class="comment">#远程访问my-remote-host.com:9090就等同于用本机访问local-secret.com:8080</span></div><div class="line">ssh -N <span class="operator">-f</span> -L X:Y:Z K   <span class="comment">#本地转发 将IP为Y的机器的Z端口通过中间服务器K[映射到本地]机器的X端口, -L local (本地)</span></div><div class="line">ssh -L <span class="number">9090</span>:remote-secret.com:<span class="number">8080</span> my-remote-host.com <span class="comment">#访问本地的9090端口就相当于用远程服务器my-remote-host.com访问remote-secret.com:8080</span></div><div class="line">-N <span class="comment">#告诉SSH客户端，这个连接不需要执行任何命令。仅仅做端口转发</span></div><div class="line"><span class="operator">-f</span> <span class="comment">#告诉SSH客户端在后台运行</span></div><div class="line">-i <span class="comment">#使用指定的密钥登录</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ssh -p <span class="number">222</span> admin@<span class="number">122.193</span>.<span class="number">22.120</span></div><div class="line">ssh -R <span class="number">1234</span>:localhost:<span class="number">45555</span> <span class="number">121.196</span>.<span class="number">128.188</span> </div><div class="line"><span class="comment">#主机 A :localhost把本地的 21端口(对应ftp服务)映射为 B 121.196.128.188的1234 端口(任意未被占用)，同时 A 监听 B 的1234 端口。 </span></div><div class="line"><span class="comment">#在 B 上用 netstat -al | grep 1234 ，看到这个监听连接。 </span></div><div class="line"><span class="comment">#任何发送到 B 1234 端口的请求将被传送到 A的 21 端口</span></div><div class="line"><span class="comment">#在B上 curl localhost:45555</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh -N <span class="operator">-f</span> -L <span class="number">2121</span>:<span class="number">234.234</span>.<span class="number">234.234</span>:<span class="number">21</span> <span class="number">123.123</span>.<span class="number">123.123</span></div><div class="line">ftp localhost:<span class="number">2121</span> <span class="comment"># 现在访问本地192.168.1.100的2121端口，就能连接234.234.234.234的21端口了</span></div></pre></td></tr></table></figure>

<h3 id="curl_数据爬取">curl 数据爬取</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -A <span class="string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)"</span> -o page.html -D cookie0001.txt http://www.yueji.com <span class="comment">#模仿运行在Windows 2000上的 IE6.0访问</span></div></pre></td></tr></table></figure>

<h3 id="dig,ping">dig,ping</h3>
<h2 id="四,Shell基础">四,Shell基础</h2>
<h3 id="$@,$#,$*,$0,$1~$n,#?,$?">$@,$#,$*,$0,$1~$n,#?,$?</h3>
<h3 id="if,for,while,util,select,case">if,for,while,util,select,case</h3>
<h3 id="read,">read,</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$0</span>   		<span class="comment">#当前执行的shell script文件名（带完整路径） </span></div><div class="line"><span class="variable">$1</span> ~ <span class="variable">$n</span>  	<span class="comment">#依次存放shell script的命令行参数，数值大于9时必须要用{}括起来，比如${10}。命令行参数可以通过shift命令进行位移操作，位置参数根据shift命令指定的数值往前移动，如不指定移动值，则移动1次。例如: </span></div><div class="line"><span class="variable">$*</span>   		<span class="comment">#将所有命令行参数做为一个字符串存入此变量。 </span></div><div class="line"><span class="variable">$@</span>   		<span class="comment">#将所有命令行参数做为一个字符串数组，每个参数为一个成员变量，存入此变量。 </span></div><div class="line"><span class="variable">$#</span>   		<span class="comment">#命令行参数的个数。 </span></div><div class="line"><span class="variable">$?</span>   		<span class="comment">#上一条命令执行后的返回码。 </span></div><div class="line"><span class="variable">$ </span>    		<span class="comment">#当前执行的shell script进程编号。 </span></div><div class="line"><span class="variable">$!</span>   		<span class="comment">#上一个后台程序的进程编号。 </span></div><div class="line"><span class="variable">$_</span>   		<span class="comment">#script执行时，存放bash的绝对路径;bash交互时，存放上一个命令最后一个命令行参数;邮件检测时，存放邮件文件名</span></div></pre></td></tr></table></figure>

<h3 id="条件判断">条件判断</h3>
<p>数值判断，仅支持整型</p>
<pre><code>    [ n1 <span class="operator">-eq</span> n2 ]   <span class="comment">#判断n1==n2</span>
    [ n1 -ge n2 ]   <span class="comment">#判断n1&gt;=n2</span>
    [ n1 <span class="operator">-gt</span> n2 ]   <span class="comment">#判断n1&gt;n2</span>
    [ n1 -le n2 ]   <span class="comment">#判断n1&lt;=n2</span>
    [ n1 <span class="operator">-lt</span> n2 ]   <span class="comment">#判断n1&lt;n2</span>
    [ n1 <span class="operator">-ne</span> n2 ]   <span class="comment">#判断n1!=n2</span>
</code></pre><p>字串判断</p>
<pre><code>    <span class="attr_selector">[ str1 = str2 ]</span>   
    <span class="attr_selector">[ str1 != str2 ]</span>   
    <span class="attr_selector">[ str1 &lt; str2 ]</span>   
    <span class="attr_selector">[ str1 &gt; str2 ]</span>   
    <span class="attr_selector">[ -n str1 ]</span>   #判断<span class="tag">str1</span>长度是否非0   
    <span class="attr_selector">[ -z str1 ]</span>   #判断<span class="tag">str1</span>长度是否为0 
</code></pre><p>文件判断</p>
<pre><code>    [ -d <span class="built_in">file</span> ]   <span class="comment">#判断目录file是否存在</span>
    [ -e <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在</span>
    [ -f <span class="built_in">file</span> ]   <span class="comment">#判断文件file是否存在</span>
    [ -r <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并可读</span>
    [ -s <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并非空</span>
    [ -w <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并可写</span>
    [ -x <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并可执行</span>
    [ -O <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在并属于当前用户</span>
    [ -G <span class="built_in">file</span> ]   <span class="comment">#判断file是否存在且默认组于当前用户所属组是否相同</span>
    [ file1 -nt file2 ]   <span class="comment">#判断file1是否比file2新</span>
    [ file1 -ot file2 ]   <span class="comment">#判断file1是否比file2旧</span>
</code></pre><p>复合判断</p>
<pre><code>    -<span class="operator">a</span>  与操作，例如：[ -e <span class="built_in">file</span> -<span class="operator">a</span> -r <span class="built_in">file</span> ]
    -o  或操作，例如：[ -e <span class="built_in">file</span> -o -r <span class="built_in">file</span> ]   
</code></pre><h2 id="五,Shell脚本">五,Shell脚本</h2>
<ul>
<li>1.服务器监控脚本 </li>
<li>2.数据库备份脚本 </li>
<li>3.日志操作脚本 </li>
<li>4.批量生成linux所有命令帮助文档  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">echo</span> <span class="variable">$PATH</span> |tr <span class="string">':'</span> <span class="string">'\n'</span>|grep -v <span class="string">"yueji"</span>|grep -v <span class="string">"home"</span>`; <span class="keyword">do</span> man `ls <span class="variable">$i</span>`|col -b  &gt;&gt; cmd.man ;<span class="keyword">done</span> <span class="number">2</span>&gt;/dev/null    <span class="comment">#将所有的linux命令man文档保存下来</span></div><div class="line"><span class="comment">###</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">echo</span> <span class="variable">$PATH</span> |tr <span class="string">':'</span> <span class="string">'\n'</span>|grep -v <span class="string">"yueji"</span>|grep -v <span class="string">"home"</span>`; <span class="keyword">do</span> man `ls <span class="variable">$i</span>`|col -b | ps2pdf - &gt;&gt; man.pdf; <span class="keyword">done</span> <span class="number">2</span>&gt;/dev/null</div><div class="line"><span class="comment">###</span></div><div class="line">man ls | col -b &gt; ls.man.txt</div></pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2013-01-02T03:04:47.000Z"><a href="/2013/01/02/linux-shell-xml/">1月 2 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/01/02/linux-shell-xml/">Linux Shell脚本读写XML文件</a></h1>
  

    </header>
    <div class="entry">
      
        <p>在Linux下如何用<code>Shell</code>脚本读写<code>XML</code>? 现有一个config.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">config</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">server-ip</span>&gt;</span>192.168.0.107<span class="tag">&lt;/<span class="title">server-ip</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">server-port</span>&gt;</span>6379<span class="tag">&lt;/<span class="title">server-port</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">repository-temp-path</span>&gt;</span>/Users/zxc/workspace/redis/<span class="tag">&lt;/<span class="title">repository-temp-path</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">config</span>&gt;</span></div></pre></td></tr></table></figure>

<p>需要修改里面的<code>server-ip</code>, <code>server-port</code> 和 <code>import-path</code>,用Shell脚本的参数$1,$2,$3来写入。</p>
<p><br></p>
<h3 id="方法1:用sed命令实现">方法1:用sed命令实现</h3>
<p>首先想到的就是用sed正则匹配替换实现，写了一个shell脚本，是这样的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/sh</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="operator">-ne</span> <span class="number">3</span> ];<span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"usage: argument 1:IP_Address 2:Server_PORT 3:Temp_PATH"</span></div><div class="line"><span class="keyword">exit</span> <span class="number">1</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">IP=<span class="variable">$1</span></div><div class="line">PORT=<span class="variable">$2</span></div><div class="line">DIRT=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Change values in config.xml..."</span></div><div class="line"></div><div class="line">sed <span class="string">"s/&lt;server-ip&gt;.*&lt;\/server-ip&gt;/&lt;server-ip&gt;<span class="variable">${IP}</span>&lt;\/server-ip&gt;/;s/&lt;server-port&gt;.*&lt;\/server-port&gt;/&lt;server-port&gt;<span class="variable">${PORT}</span>&lt;\/server-port&gt;/;s/&lt;repository-temp-path&gt;.*&lt;\/repository-temp-path&gt;/&lt;repository-temp-path&gt;<span class="variable">${DIRT}</span>&lt;\/repository-temp-path&gt;/"</span> config.xml &gt; config.xml</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Done."</span></div></pre></td></tr></table></figure>

<p>测试下来调用$ ./abc.sh 192.168.1.6 9909 \/home\/abc”是可以的，但环境变量不行，例如：$ ./abc.sh 192.168.1.6 9909 $HOME\/abc”，因为首先环境变量被解析了，所以存在反斜杠转义字符和sed替换冲突的问题。<br>用另外一个思路实现</p>
<p><br></p>
<h3 id="方法2:是直接输出该xml的内容，测试下来很管用，使用很方便，不存在反斜杠转义字符的问题和环境变量的问题：">方法2:是直接输出该xml的内容，测试下来很管用，使用很方便，不存在反斜杠转义字符的问题和环境变量的问题：</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/sh</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="operator">-ne</span> <span class="number">3</span> ];<span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"usage: argument 1:IP_Address 2:Server_PORT 3:Temp_PATH"</span></div><div class="line"><span class="keyword">exit</span> <span class="number">1</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">IP=<span class="variable">$1</span></div><div class="line">PORT=<span class="variable">$2</span></div><div class="line">DIRT=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Change values in config.xml..."</span></div><div class="line"></div><div class="line">cat &lt;&lt;EOF &gt;config.xml</div><div class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</div><div class="line">&lt;config&gt;</div><div class="line">   &lt;server-ip&gt;<span class="variable">${IP}</span>&lt;/server-ip&gt;</div><div class="line">   &lt;server-port&gt;<span class="variable">${PORT}</span>&lt;/server-port&gt;</div><div class="line">   &lt;repository-temp-path&gt;<span class="variable">${DIRT}</span>&lt;/repository-temp-path&gt;</div><div class="line">&lt;/config&gt;</div><div class="line">EOF  </div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Done."</span></div></pre></td></tr></table></figure>

<p><br></p>
<h3 id="方法3：用XMLStarlet">方法3：用XMLStarlet</h3>
<p>XML + shell = XMLStarlet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ xmlstarlet ed -u /config/server-ip -v <span class="number">192.168</span>.<span class="number">1.6</span> -u /config/server-port -v <span class="number">9909</span> -u /config/repository-temp-path -v /home/bbb input.xml</div><div class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</div><div class="line">&lt;config&gt;</div><div class="line">  &lt;server-ip&gt;<span class="number">192.168</span>.<span class="number">0.107</span>&lt;/server-ip&gt;</div><div class="line">  &lt;server-port&gt;<span class="number">6379</span>&lt;/server-port&gt;</div><div class="line">  &lt;repository-temp-path&gt;/Users/zxc/workspace/redis/&lt;/repository-temp-path&gt;</div><div class="line">&lt;/config&gt;</div></pre></td></tr></table></figure>

<p><br></p>
<h3 id="方法4：用xsltproc">方法4：用xsltproc</h3>
<p>很多Linux比如CentOS默认已安装<code>xsltproc</code>，所以用xslt可以很方便的把一个xml转换为另外一个xml。<a href="http://xmlsoft.org/XSLT/xsltproc.html" target="_blank" rel="external">具体用法</a>。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-12-28T15:32:16.000Z"><a href="/2012/12/28/linux-iptables/">12月 28 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/12/28/linux-iptables/">iptables管理脚本和使用总结</a></h1>
  

    </header>
    <div class="entry">
      
        <p><code>iptables</code>是个好东西，但是各种规则对于刚上手的朋友来说很不友好，一开始会摸不着头脑。经过一段时间的研究，终于摸着些门道。本文中的内容是终端下输的命令，不是<code>/etc/sysconfig/iptables</code>中的内容。</p>
<p><strong>提示</strong>：下面中“|”表示“或”</p>
<h3 id="对iptables操作的一般过程(命令)如下：">对iptables操作的一般过程(命令)如下：</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#列出iptable内容</span></div><div class="line">iptables -L -n</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#清除预设表filter中的所有规则链的规则</span></div><div class="line">iptables -F</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#清除预设表filter中使用者自定链中的规则</span></div><div class="line">iptables -X</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#修改规则，下面会有详细介绍</span></div><div class="line"><span class="comment">#保存iptables中规则</span></div><div class="line">service iptables save</div><div class="line">/etc/init.d/iptables save</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#重启iptables服务</span></div><div class="line">service iptables restart</div><div class="line">/etc/init.d/iptables restart</div></pre></td></tr></table></figure>

<h3 id="iptables规则介绍如下：">iptables规则介绍如下：</h3>
<p>参数说明：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">INPUT   --dport <span class="operator">-s</span></div><div class="line">OUTPUT  --sport <span class="operator">-d</span></div><div class="line"><span class="operator">-d</span>  <span class="comment">#IP或IP段</span></div><div class="line"><span class="operator">-s</span>  <span class="comment">#IP或IP段</span></div><div class="line">-p  <span class="comment">#匹配TCP/UDP/ICMP，可使用相应的整数值，ICMP是1，TCP是6，UDP是17，缺省设置ALL是0，协议列表以英文逗号分隔，可以以“!”取反</span></div><div class="line">-i  <span class="comment">#输入接口</span></div><div class="line">-o  <span class="comment">#输出接口</span></div></pre></td></tr></table></figure>

<p>添加规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#INPUT/OUTPUT链</span></div><div class="line">iptables -A INPUT|OUTPUT <span class="operator">-s</span> 源IP <span class="operator">-d</span> 目的IP -p tcp|udp|icmp --sport 源端口 --dport 目的端口 -j ACCEPT|DROP</div><div class="line"><span class="comment">#FORWARD链</span></div><div class="line">iptables -A FORWARD -i 输入接口 -o 输出接口 -m state --state RELATED,ESTABLISHED -j ACCEPT|DROP</div><div class="line"><span class="comment">#NAT表</span></div><div class="line">iptables -t nat -A PREROUTING -i 输入接口 <span class="operator">-s</span> 源IP <span class="operator">-d</span> 目的IP --sport 源端口 --dport 目的端口 -j ACCEPT|DROP</div></pre></td></tr></table></figure>

<p>删除规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#INPUT/OUTPUT链</span></div><div class="line">iptables -D INPUT|OUTPUT <span class="operator">-s</span> 源IP <span class="operator">-d</span> 目的IP -p tcp|udp|icmp --dport 端口 -j ACCEPT|DROP</div><div class="line"><span class="comment">#FORWARD链</span></div><div class="line">iptables -D FORWARD -i 输入接口 -o 输出接口 -m state --state RELATED,ESTABLISHED -j ACCEPT|DROP</div></pre></td></tr></table></figure>

<h3 id="详细规则">详细规则</h3>
<ul>
<li><code>INPUT|OUTPUT</code>链</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#允许rsync到远程服务器</span></div><div class="line">iptables -A OUTPUT -p tcp --sport <span class="number">873</span> <span class="operator">-d</span> 目的IP -j ACCEPT</div><div class="line"><span class="comment">#允许WWW服务的80端口</span></div><div class="line">iptables -A INPUT -p tcp --dport <span class="number">80</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp --dport <span class="number">80</span> -j ACCEPT</div><div class="line"><span class="comment">#允许邮件服务的25和110端口</span></div><div class="line">iptables -A INPUT -p tcp --dport <span class="number">25</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp --dport <span class="number">25</span> -j ACCEPT</div><div class="line">iptables -A INPUT -p tcp --dport <span class="number">110</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp --dport <span class="number">110</span> -j ACCEPT</div><div class="line"><span class="comment">#允许FTP服务的21和20端口</span></div><div class="line">iptables -A INPUT -p tcp --dport <span class="number">21</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp --dport <span class="number">21</span> -j ACCEPT</div><div class="line">iptables -A INPUT -p tcp --dport <span class="number">20</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp --dport <span class="number">20</span> -j ACCEPT</div><div class="line"><span class="comment">#允许DNS服务的53端口</span></div><div class="line">iptables -A INPUT -p tcp --dport <span class="number">53</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp --dport <span class="number">53</span> -j ACCEPT</div><div class="line"><span class="comment">#允许rsync的873端口</span></div><div class="line">iptables -A INPUT -p all --dport <span class="number">873</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT -p all --sport <span class="number">873</span> -j ACCEPT</div><div class="line"><span class="comment">#允许NRPE的5666端口</span></div><div class="line">iptables -A INPUT <span class="operator">-s</span> 源IP -p all --dport <span class="number">5666</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT <span class="operator">-d</span> 目的IP -p all --sport <span class="number">5666</span> -j ACCEPT</div><div class="line"><span class="comment">#允许Ping</span></div><div class="line">iptables -A INPUT -p icmp -j ACCEPT</div><div class="line">iptables -A OUTPUT -p icmp -j ACCEPT</div><div class="line"><span class="comment">#允许loopback!(不然会导致DNS无法正常关闭等问题)</span></div><div class="line">iptables -A INPUT -i lo -p all -j ACCEPT</div><div class="line">iptables -A OUTPUT -o lo -p all -j ACCEPT</div><div class="line"><span class="comment">#只允许某IP或某网段的机器进行SSH连接</span></div><div class="line">iptables -A INPUT <span class="operator">-s</span> <span class="number">192.168</span>.<span class="number">0.8</span>|<span class="number">192.168</span>.<span class="number">0.0</span>/<span class="number">24</span> -p tcp --dport <span class="number">22</span> -j ACCEPT</div><div class="line"><span class="comment">#允许所有已经建立的和相关的连接</span></div><div class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</div><div class="line">iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</div><div class="line"><span class="comment">#拒绝非法连接</span></div><div class="line">iptables -A INPUT   -m state --state INVALID -j DROP</div><div class="line">iptables -A OUTPUT  -m state --state INVALID -j DROP</div></pre></td></tr></table></figure>

<ul>
<li><code>FORWARD</code>链</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#开启转发功能(在做NAT时,FORWARD默认规则是DROP时,必须做)</span></div><div class="line">iptables -A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT</div><div class="line">iptables -A FORWARD -i eth1 -o eh0 -j ACCEPT</div><div class="line"><span class="comment">#丢弃坏的TCP包</span></div><div class="line">iptables -A FORWARD -p TCP ! --syn -m state --state NEW -j DROP</div><div class="line"><span class="comment">#处理IP碎片数量,防止攻击,允许每秒100个</span></div><div class="line">iptables -A FORWARD <span class="operator">-f</span> -m limit --limit <span class="number">100</span>/s --limit-burst <span class="number">100</span> -j ACCEPT</div><div class="line"><span class="comment">#设置ICMP包过滤,允许每秒1个包,限制触发条件是10个包.</span></div><div class="line">iptables -A FORWARD -p icmp -m limit --limit <span class="number">1</span>/s --limit-burst <span class="number">10</span> -j ACCEPT</div><div class="line"><span class="comment">#禁止非法连接</span></div><div class="line">iptables -A FORWARD -m state --state INVALID -j DROP</div></pre></td></tr></table></figure>

<ul>
<li><code>NAT</code>表</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#防止外网用内网IP欺骗</span></div><div class="line">iptables -t nat -A PREROUTING -i eth0 <span class="operator">-s</span> <span class="number">10.0</span>.<span class="number">0.0</span>/<span class="number">8</span> -j DROP</div><div class="line">iptables -t nat -A PREROUTING -i eth0 <span class="operator">-s</span> <span class="number">172.16</span>.<span class="number">0.0</span>/<span class="number">12</span> -j DROP</div><div class="line">iptables -t nat -A PREROUTING -i eth0 <span class="operator">-s</span> <span class="number">192.168</span>.<span class="number">0.0</span>/<span class="number">16</span> -j DROP</div><div class="line"><span class="comment">#禁止与某IP或IP段的所有连接</span></div><div class="line">iptables -t nat -A PREROUTING  <span class="operator">-d</span> <span class="number">192.168</span>.<span class="number">0.8</span>|<span class="number">192.168</span>.<span class="number">0.0</span>/<span class="number">24</span> -j DROP</div><div class="line"><span class="comment">#禁止连接某IP或IP段的FTP的21端口</span></div><div class="line">iptables -t nat -A PREROUTING  -p tcp --dport <span class="number">21</span> <span class="operator">-d</span> <span class="number">192.168</span>.<span class="number">0.8</span>|<span class="number">192.168</span>.<span class="number">0.0</span>/<span class="number">24</span> -j DROP</div></pre></td></tr></table></figure>

<h3 id="我的管理脚本">我的管理脚本</h3>
<p>再分享一下一个简单方便的脚本用于管理iptables服务，相对于采用service的管理方式更加灵活。</p>
<p>值得注意的是，由于启用了iptables防火墙，FTP的主被动模式方面需要留意一下。众所周知FTP使用的是21端口，但是在我们进行FTP文件传输时，客户端首先连接到21端口，进行用户的认证，认证成功后，当我们要传输文件时，服务器会开一个端口为20来进行传输数据文件，也就是说，端口20才是真正传输所用到的端口，端口21只用于FTP的登陆认证。例如使用vsftpd做ftp时，可以使用下面的配置来限制端口访问，并且方便iptables规则设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pasv_min_port=<span class="number">2222</span></div><div class="line">pasv_max_port=<span class="number">2225</span></div></pre></td></tr></table></figure>

<p>脚本代码如下:</p>
<pre><code>    <span class="comment">#!/bin/bash</span>
    <span class="comment"># by zxc</span>

    <span class="type">PATH</span>=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
    <span class="keyword">export</span> <span class="type">PATH</span>

    start(){
        <span class="comment">#kernal setting</span>
        echo <span class="string">"Kernal Setting..."</span>
        echo <span class="number">1</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/icmp_echo_ignore_broadcasts
        echo <span class="number">1</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/icmp_ignore_bogus_error_responses
        echo <span class="number">0</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/conf/all/accept_source_route
        echo <span class="number">0</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/conf/all/accept_redirects
        echo <span class="number">0</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/conf/all/send_redirects
        echo <span class="number">1</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/conf/all/rp_filter
        echo <span class="number">1</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/tcp_syncookies
        echo <span class="number">3</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/tcp_retries1
        echo <span class="number">30</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/tcp_fin_timeout
        echo <span class="number">1400</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/tcp_keepalive_time
        echo <span class="number">0</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/tcp_window_scaling
        echo <span class="number">0</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/tcp_sack
        echo <span class="number">0</span> &gt; /<span class="keyword">proc</span>/sys/net/ipv4/tcp_timestamps

        <span class="comment">#iptables setting</span>
        echo <span class="string">"Iptables Setting..."</span>
        <span class="comment">#default policy</span>
        iptables -P <span class="type">INPUT</span> <span class="type">DROP</span>
        iptables -P <span class="type">OUTPUT</span> <span class="type">ACCEPT</span>
        <span class="comment">#clear original rules</span>
        iptables -F
        <span class="comment">#input rule</span>
        iptables -A <span class="type">INPUT</span> -i lo -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">22</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">5666</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">20</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">21</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">22</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">25</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">80</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">110</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">143</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">443</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">873</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m tcp --dport <span class="number">3306</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp -m state --state <span class="type">NEW</span> -m tcp --dport <span class="number">21</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p tcp --dport <span class="number">2222</span>:<span class="number">2225</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p icmp -m icmp --icmp-<span class="keyword">type</span> <span class="number">8</span> -j <span class="type">DROP</span>
        iptables -A <span class="type">INPUT</span> -p all -m state --state <span class="type">ESTABLISHED</span>,<span class="type">RELATED</span> -j <span class="type">ACCEPT</span>
        iptables -A <span class="type">INPUT</span> -p all -m state --state <span class="type">INVALID</span>,<span class="type">NEW</span> -j <span class="type">DROP</span>

        <span class="type">BADIPS</span>=<span class="string">"`curl -s http://feeds.dshield.org/block.txt | awk '/^[1-9]/ {print $1 "</span>/<span class="string">" $3}'`"</span>
        <span class="keyword">if</span> [ <span class="string">"$BADIPS"</span> ];then
            <span class="keyword">for</span> ip <span class="keyword">in</span> $<span class="type">BADIPS</span>
            <span class="keyword">do</span>
                iptables -I <span class="type">INPUT</span> -s $ip -j <span class="type">DROP</span>
            done
        fi
    }

    stop(){
        echo <span class="string">"Cleaning your Iptables:..."</span>
        iptables -F
        iptables -X
        iptables -Z
        iptables -P <span class="type">INPUT</span> <span class="type">ACCEPT</span>
        iptables -P <span class="type">OUTPUT</span> <span class="type">ACCEPT</span>
        /etc/init.d/iptables stop
        <span class="keyword">if</span> [ <span class="string">"$?"</span> == <span class="string">"0"</span> ];then
            echo <span class="string">"Done!"</span>
        fi
    }

    <span class="keyword">case</span> <span class="string">"$1"</span> <span class="keyword">in</span>
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop &amp;&amp; start
        ;;
    *)
        echo $<span class="string">"Usage: $0 {start|stop|restart}"</span>
        exit <span class="number">1</span>
    esac
    exit <span class="number">0</span>
</code></pre><p>将它添加到rc.local中使能开机启动.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-12-27T02:57:11.000Z"><a href="/2012/12/27/spring-mvc-wizard/">12月 27 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/12/27/spring-mvc-wizard/">Spring MVC注解方式实现向导式跳转页面</a></h1>
  

    </header>
    <div class="entry">
      
        <p>近期项目需要用到向导式的跳转页面效果，本项目又是用spring mvc实现的，刚开始想到用spring的<code>webflow</code>，不过<code>webflow</code>太过笨重，对于我们不是很复杂的跳转来说好像有种“杀鸡焉用牛刀”的感觉，于是就网上搜索看有没有类似的解决方案，网上的答案一般都是叫你继承<code>AbstractWizardFormContoller</code>这个类来实现，但对于<code>spring mvc3.0.x</code>这个类将不再使用，转而推荐使用<code>注解</code>的方式来实现，于是参考<code>官方文档</code>，用注解方式实现了向导式页面。</p>
<p>下面是代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Controller</span>  </div><div class="line"><span class="annotation">@RequestMapping</span>(<span class="string">"/wizard.htm"</span>)    </div><div class="line"><span class="annotation">@SessionAttributes</span>(<span class="string">"bean"</span>)  <span class="comment">//需要保存在session中的变量</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestWizardController</span></span>{  </div><div class="line">    </div><div class="line">  <span class="annotation">@Resource</span>(name = <span class="string">"beanService"</span>)  </div><div class="line">  <span class="keyword">private</span> BeanService beanService;    </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>  </div><div class="line">  <span class="keyword">public</span> String <span class="title">step1</span>(<span class="keyword">final</span> ModelMap modelMap){  </div><div class="line">    modelMap.addAttribute(<span class="string">"bean"</span>, <span class="keyword">new</span> Bean());  </div><div class="line">    <span class="keyword">return</span> <span class="string">"step1"</span>;  </div><div class="line">  }  </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>(params = <span class="string">"_step=2"</span>)  </div><div class="line">  <span class="keyword">public</span> String <span class="title">step2</span>(<span class="keyword">final</span> @<span class="title">ModelAttribute</span>("bean") Bean bean,  </div><div class="line">                      <span class="keyword">final</span> Errors errors){  </div><div class="line">    <span class="keyword">return</span> <span class="string">"step2"</span>;  </div><div class="line">  }  </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>(params = <span class="string">"_step=3"</span>)  </div><div class="line">  <span class="keyword">public</span> String <span class="title">step3</span>(<span class="keyword">final</span> @<span class="title">ModelAttribute</span>("bean") Bean bean,  </div><div class="line">                      <span class="keyword">final</span> Errors errors){  </div><div class="line">    <span class="keyword">return</span> <span class="string">"step3"</span>;  </div><div class="line">  }  </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>(params = <span class="string">"_finish"</span>)  </div><div class="line">  <span class="keyword">public</span> String <span class="title">processFinish</span>(@<span class="title">ModelAttribute</span>("bean")Bean bean,  </div><div class="line">                              <span class="keyword">final</span> Errors errors,  </div><div class="line">                              <span class="keyword">final</span> ModelMap modelMap,  </div><div class="line">                              <span class="keyword">final</span> SessionStatus status){  </div><div class="line">  </div><div class="line">    beanService.add(bean);     </div><div class="line">    status.setComplete();  </div><div class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;  </div><div class="line">  }  </div><div class="line">    </div><div class="line">  <span class="annotation">@RequestMapping</span>(params = <span class="string">"_cancel"</span>)  </div><div class="line">  <span class="keyword">public</span> String <span class="title">processCancel</span>(<span class="keyword">final</span> HttpServletRequest request,  </div><div class="line">                              <span class="keyword">final</span> HttpServletResponse response,  </div><div class="line">                              <span class="keyword">final</span> SessionStatus status){  </div><div class="line">     status.setComplete();  </div><div class="line">     <span class="keyword">return</span> <span class="string">"cancel"</span>;  </div><div class="line">  }  </div><div class="line">      </div><div class="line">}</div></pre></td></tr></table></figure>

<p>其中起到最大作用的就是<code>@SessionAttributes</code>这个注解，它定义了一个在<code>session</code>范围内的变量，这个变量可以在不同的页面跳转时保持状态。</p>
<p>第一次访问 <a href="http://www.example.com/wizard.htm" target="_blank" rel="external">http://www.example.com/wizard.htm</a> 时进入step1方法，其后提交的表单action后面都要加上相应的参数，如：</p>
<p>step1页面 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"http://www.example.com/wizard.htm?_step=2"</span>&gt;</span></div></pre></td></tr></table></figure>

<p>step2页面 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"http://www.example.com/wizard.htm?_step=3"</span>&gt;</span></div></pre></td></tr></table></figure>

<p>step3页面 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"http://www.example.com/wizard.htm?_finish"</span>&gt;</span></div></pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-11-26T08:03:16.000Z"><a href="/2012/11/26/spring-mvc-xss/">11月 26 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/11/26/spring-mvc-xss/">Spring MVC里面xss攻击的预防</a></h1>
  

    </header>
    <div class="entry">
      
        <p>关于xss的介绍可以看 <a href="http://www.cnblogs.com/luminji/archive/2012/05/22/2507185.html" target="_blank" rel="external">Asp.net安全架构之1：xss（跨站脚本）</a>和 <a href="http://www.cnblogs.com/kingthy/archive/2011/08/20/2147355.html" target="_blank" rel="external">腾讯微博的XSS攻击漏洞</a> 网页，</p>
<p>具体我就讲讲Spring MVC里面的预防：</p>
<h3 id="第一种方法,使用Spring_MVC">第一种方法,使用Spring MVC</h3>
<p>web.xml加上：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">context-param</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">param-name</span>&gt;</span>defaultHtmlEscape<span class="tag">&lt;/<span class="title">param-name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="title">param-value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">context-param</span>&gt;</span></div></pre></td></tr></table></figure>

<p>Forms加上：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">spring:htmlEscape</span> <span class="attribute">defaultHtmlEscape</span>=<span class="value">"true"</span> /&gt;</span></div></pre></td></tr></table></figure>


<p>更多信息查看<a href="https://www.owasp.org/index.php/Main_Page" target="_blank" rel="external">OWASP</a>的<a href="https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet" target="_blank" rel="external">页面</a></p>
<p><br></p>
<h3 id="第二种方法是手动escape">第二种方法是手动escape</h3>
<p>例如用户可以输入：</p>
<figure class="highlight javaScript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;alert();<span class="xml"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span></div></pre></td></tr></table></figure>

<p>或者输入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">h2</span>&gt;</span>abc<span class="tag">&lt;<span class="title">h2</span>&gt;</span></div></pre></td></tr></table></figure>

<p>,如果有异常,显然有xss漏洞。<br>首先添加一个jar包:<code>commons-lang-2.5.jar</code>,然后在后台调用这些函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">StringEscapeUtils.escapeHtml(string); </div><div class="line">StringEscapeUtils.escapeJavaScript(string); </div><div class="line">StringEscapeUtils.escapeSql(string);</div></pre></td></tr></table></figure>

<p>前台js调用escape函数即可。</p>
<p><br></p>
<h3 id="第三种方法是后台加Filter,对每个post请求的参数过滤一些关键字,替换成安全的">第三种方法是后台加Filter,对每个post请求的参数过滤一些关键字,替换成安全的</h3>
<p>例如：&lt; &gt; ‘ “ \ /  # &amp;<br>方法是实现一个自定义的<code>HttpServletRequestWrapper</code>，然后在Filter里面调用它，替换掉getParameter函数即可。<br>首先添加一个<code>XssHttpServletRequestWrapper</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.ibm.web.beans;</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">import</span> java.util.Enumeration;</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XssHttpServletRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>{ </div><div class="line">    <span class="comment">// </span></div><div class="line">    <span class="keyword">public</span> <span class="title">XssHttpServletRequestWrapper</span>(HttpServletRequest servletRequest) {</div><div class="line">        <span class="keyword">super</span>(servletRequest);</div><div class="line">    }</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">public</span> String[] <span class="title">getParameterValues</span>(String parameter) {</div><div class="line">        String[] values = <span class="keyword">super</span>.getParameterValues(parameter);</div><div class="line">        <span class="keyword">if</span> (values==<span class="keyword">null</span>)  {</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">int</span> count = values.length;</div><div class="line">        String[] encodedValues = <span class="keyword">new</span> String[count];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) {</div><div class="line">            encodedValues[i] = cleanXSS(values[i]);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> encodedValues;</div><div class="line">    }</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">public</span> String <span class="title">getParameter</span>(String parameter) {</div><div class="line">        String value = <span class="keyword">super</span>.getParameter(parameter);</div><div class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> cleanXSS(value);</div><div class="line">    }</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">public</span> String <span class="title">getHeader</span>(String name) {</div><div class="line">        String value = <span class="keyword">super</span>.getHeader(name);</div><div class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">return</span> cleanXSS(value);</div><div class="line">    }</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">private</span> String <span class="title">cleanXSS</span>(String value) {</div><div class="line">        <span class="comment">//You'll need to remove the spaces from the html entities below</span></div><div class="line">        value = value.replaceAll(<span class="string">"&lt;"</span>, <span class="string">"& lt;"</span>).replaceAll(<span class="string">"&gt;"</span>, <span class="string">"& gt;"</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"\\("</span>, <span class="string">"& #40;"</span>).replaceAll(<span class="string">"\\)"</span>, <span class="string">"& #41;"</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"'"</span>, <span class="string">"& #39;"</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"eval\\((.*)\\)"</span>, <span class="string">""</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"[\\\"\\\'][\\s]*javascript:(.*)[\\\"\\\']"</span>, <span class="string">"\"\""</span>);</div><div class="line">        value = value.replaceAll(<span class="string">"script"</span>, <span class="string">""</span>);</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>然后添加一个过滤器XssFilter ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.ibm.web.beans;</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">import</span> java.io.IOException;  </div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">import</span> javax.servlet.Filter;  </div><div class="line"><span class="keyword">import</span> javax.servlet.FilterChain;  </div><div class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;  </div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </div><div class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </div><div class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;  </div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XssFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</div><div class="line">    FilterConfig filterConfig = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span>(FilterConfig filterConfig) <span class="keyword">throws</span> ServletException {</div><div class="line">        <span class="keyword">this</span>.filterConfig = filterConfig;</div><div class="line">    }</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span>() {</div><div class="line">        <span class="keyword">this</span>.filterConfig = <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span>(ServletRequest request, ServletResponse response,</div><div class="line">            FilterChain chain) <span class="keyword">throws</span> IOException, ServletException {</div><div class="line">        chain.doFilter(<span class="keyword">new</span> XssHttpServletRequestWrapper(</div><div class="line">                (HttpServletRequest) request), response);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>最后在web.xml里面配置一下，所有的请求的getParameter会被替换，如果参数里面含有<code>敏感词</code>会被替换掉：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">filter</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">filter-name</span>&gt;</span>XssSqlFilter<span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">filter-class</span>&gt;</span>com.ibm.web.beans.XssFilter<span class="tag">&lt;/<span class="title">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">filter-mapping</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">filter-name</span>&gt;</span>XssSqlFilter<span class="tag">&lt;/<span class="title">filter-name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="title">url-pattern</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">dispatcher</span>&gt;</span>REQUEST<span class="tag">&lt;/<span class="title">dispatcher</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>

<p> (这个Filter也可以防止SQL注入攻击) </p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-11-12T07:36:40.000Z"><a href="/2012/11/12/linux-rsync/">11月 12 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/11/12/linux-rsync/">Linux用rsync进行多机备份脚本</a></h1>
  

    </header>
    <div class="entry">
      
        <p>近期做服务器维护相关的工作,用<code>rsync</code>进行两机备份的话比较好,对数据保全比较好. 因此写了这个脚本,加进<code>crontab</code>当中,定期对服务器备份数据库以及www目录下的网站.</p>
<p>脚本如下,使用前请先针对自己的服务器环境设置变量值:</p>
<pre><code>    <span class="comment">#! /bin/bash</span>

    <span class="comment"># by zxc</span>
    <span class="comment"># This script is used to do backup and rsync works for servers.</span>
    <span class="comment"># ./backup.sh (db_rsync|www_rsync)</span>

    <span class="comment"># 获取可执行文件路径</span>
    BINPATH=<span class="string">"/usr/bin"</span>
    LOGPATH=<span class="string">"/home/backlogs"</span>

    <span class="comment">#定义数据库dump目录</span>
    DB_DUMP=<span class="string">"/home/database/"</span>
    LOCAL_WWW=<span class="string">"/home/www/"</span>

    <span class="comment">#定义MySQL认证信息</span>
    DB_USER=<span class="string">"test"</span>
    DB_PASS=<span class="string">"test1234"</span>
    DB_HOST=<span class="string">"127.0.0.1"</span>

    <span class="comment">#定义本地rsync密码文件位置</span>
    PASSFILE=<span class="string">"/xxx/xxxxx"</span>
    RSYNC_NAME=<span class="string">"xxxxxx"</span>
    RSYNC_IP=<span class="string">"xxx.xxx.xxx.xxx"</span>

    <span class="comment">#获取本地AccessIP用作后面rsync的文件夹</span>
    <span class="comment">#pay attention to the sed part of this sentence, check it before using!</span>
    IP=`ifconfig | grep <span class="string">"venet0:0"</span> --after-context=<span class="number">1</span> | sed -n <span class="string">'s/..*addr:\(..*\)  P-t-P..*/\1/p'</span> | sed <span class="string">'/127.0.0.1/d'</span>`

    <span class="function"><span class="title">db_dump</span></span>(){
      DBS=`<span class="variable">$BINPATH</span>/mysql --user=<span class="variable">$DB_USER</span> --host=<span class="variable">$DB_HOST</span> --password=<span class="variable">$DB_PASS</span> -Bse <span class="string">'show databases'</span>`
      <span class="keyword">for</span> db <span class="keyword">in</span> <span class="variable">$DBS</span>
      <span class="keyword">do</span>
        <span class="keyword">case</span> <span class="variable">$db</span> <span class="keyword">in</span>
          <span class="string">"information_schema"</span>)
          ;;
          <span class="string">"mysql"</span>)
          ;;
          <span class="string">"test"</span>)
          ;;
          *)
            <span class="built_in">echo</span> <span class="string">"Dump <span class="variable">$db</span> begin at <span class="variable">$(date)</span>"</span> &gt;&gt; <span class="variable">$LOGPATH</span>/db_dump.log
            <span class="variable">$BINPATH</span>/mysqldump --opt <span class="variable">$db</span> --user=<span class="variable">$DB_USER</span> --host=<span class="variable">$DB_HOST</span> --password=<span class="variable">$DB_PASS</span>  &gt; <span class="variable">$DB_DUMP</span>/<span class="variable">$db</span>-$(date +%F).sql
            <span class="built_in">echo</span> <span class="string">"Dump <span class="variable">$db</span> done at <span class="variable">$(date)</span>"</span> &gt;&gt; <span class="variable">$LOGPATH</span>/db_dump.log
          ;;
        <span class="keyword">esac</span>
      <span class="keyword">done</span>
    }

    <span class="function"><span class="title">db_rsync</span></span>(){
      <span class="built_in">echo</span> <span class="string">"Doing db_rsync..."</span>
      <span class="built_in">echo</span> <span class="string">"db_rsync begin at <span class="variable">$(date)</span>!"</span> &gt;&gt; <span class="variable">$LOGPATH</span>/db_rsync.log
      rsync -rvlHpogDtS --delete --password-file=<span class="variable">$PASSFILE</span> <span class="variable">$DB_DUMP</span> --exclude *\log\* --exclude *\backup\* --exclude *.rar --exclude *.zip --exclude *mysql* --exclude *.err* --exclude *.pid* --exclude *\test\* rsync://<span class="variable">$RSYNC_NAME</span>@<span class="variable">$RSYNC_IP</span>/<span class="variable">${IP}</span>_db_lio &gt;&gt; <span class="variable">$LOGPATH</span>/db_rsync.log
      <span class="built_in">echo</span> <span class="string">"db_rsync done at <span class="variable">$(date)</span>!"</span> &gt;&gt; <span class="variable">$LOGPATH</span>/db_rsync.log
    }

    <span class="function"><span class="title">www_rsync</span></span>(){
      <span class="built_in">echo</span> <span class="string">"Doing www_rsync..."</span>
      <span class="built_in">echo</span> <span class="string">"www_rsync begin at <span class="variable">$(date)</span>!"</span> &gt;&gt; <span class="variable">$LOGPATH</span>/www_rsync.log
      rsync -rvlHpogDtS --delete --password-file=<span class="variable">$PASSFILE</span> <span class="variable">$LOCAL_WWW</span> --exclude *\log\* --exclude *\backup\* --exclude *.rar --exclude *.zip rsync://<span class="variable">$RSYNC_NAME</span>@<span class="variable">$RSYNC_IP</span>/<span class="variable">${IP}</span>_www_lio &gt;&gt; <span class="variable">$LOGPATH</span>/www_rsync.log
      <span class="built_in">echo</span> <span class="string">"www_rsync done at <span class="variable">$(date)</span>!"</span> &gt;&gt; <span class="variable">$LOGPATH</span>/www_rsync.log
    }

    <span class="comment">#Script begin here</span>

    <span class="keyword">if</span> [ ! <span class="operator">-d</span> <span class="variable">$LOGPATH</span> ];<span class="keyword">then</span>
      mkdir <span class="variable">$LOGPATH</span>
    <span class="keyword">fi</span>

    <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span>
      db_rsync)
        db_dump <span class="number">2</span>&gt;&gt; <span class="variable">$LOGPATH</span>/rsync_error.log
        db_rsync <span class="number">2</span>&gt;&gt; <span class="variable">$LOGPATH</span>/rsync_error.log
      ;;
      www_rsync)
        www_rsync <span class="number">2</span>&gt;&gt; <span class="variable">$LOGPATH</span>/rsync_error.log
      ;;
      *)
        <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date)</span> You didn't add parameter in your crontab."</span> &gt;&gt; <span class="variable">$LOGPATH</span>/crontab.log
        <span class="built_in">echo</span> <span class="string">"Syntax: backup.sh (db_rsync|www_rsync)"</span> &gt;&gt; <span class="variable">$LOGPATH</span>/crontab.log
      ;;
    <span class="keyword">esac</span>

    <span class="keyword">exit</span> <span class="number">0</span>
</code></pre><p>另有一脚本，用于在备份机上rsyncd.conf中添加记录，如下：</p>
<pre><code>    #! /bin/bash
    # ./rsyncd.<span class="keyword">sh</span> IP

    # <span class="keyword">for</span> db
    <span class="keyword">echo</span> <span class="string">""</span>
    <span class="keyword">echo</span> <span class="string">"[$1_db_lio]"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"path = /backup/mysql/$1"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"uid = root"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"gid = root"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"read only = false"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"ignore errors"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"secrets file = /etc/rsyncd.pas"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"host allow $1"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>

    #for www
    <span class="keyword">echo</span> <span class="string">""</span>
    <span class="keyword">echo</span> <span class="string">"[$1_www_lio]"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"path = /backup/vhosts/rsyncfiles/$1"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"uid = root"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"gid = root"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"read only = false"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"ignore errors"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"secrets file = /etc/rsyncd.pas"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>
    <span class="keyword">echo</span> <span class="string">"host allow $1"</span> &gt;&gt; /etc/rsyncd.<span class="keyword">conf</span>

    tail -<span class="keyword">n</span> <span class="number">17</span> /etc/rsyncd.<span class="keyword">conf</span>
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-11-12T04:19:34.000Z"><a href="/2012/11/12/ibatis1/">11月 12 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/11/12/ibatis1/">Mybatis中传参$与#区别以及对List的排序</a></h1>
  

    </header>
    <div class="entry">
      
        <p>开发中Mybatis会用到： $ 和 # 符号。</p>
<p>一、区别</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$aaa$ 输出参数是以字符串方式直接输出 123</div><div class="line"></div><div class="line">#aaa# 输出参数是以Parameter方式输出 @aaa</div></pre></td></tr></table></figure>

<p>二、实例</p>
<p>SQL :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;select id="selectMetaMandao"  parameterClass="java.util.HashMap" resultMap="WaasmetaMandaoMap" &gt;  </div><div class="line">    SELECT $subCategory$ rchannel,sum(mandao) mandao from</div><div class="line">    ( SELECT nvl(channel,'-') channel,ROUND(count(1)*0.1131) mandao  FROM WAAS_VIEW_USER_RESULT a </div><div class="line">    AND not EXISTS (</div><div class="line">    SELECT msgid</div><div class="line">      FROM DT_XMS_MT b</div><div class="line">     WHERE EXISTS</div><div class="line">           (SELECT MSGID FROM WAAS_VIEW_USER_RESULT WHERE STATUS = 'SUCCESS' AND msgid = b.msgid)</div><div class="line">    AND msgid = a.msgid)</div><div class="line">       GROUP BY channel) d LEFT JOIN waas_channel_summary c ON d.channel = c.original_channel </div><div class="line">    &lt;isNotEmpty property="channel"&gt;</div><div class="line">            WHERE c.original_channel LIKE '%'||#channel#||'%' </div><div class="line">     &lt;/isNotEmpty&gt;</div><div class="line">       GROUP BY $subCategory$</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>

<p>代码 :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@RequestMapping</span>(<span class="string">"queryMeta"</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectMeta</span>(HttpServletRequest request, HttpServletResponse response) {</div><div class="line">    String channel = request.getParameter(<span class="string">"channel"</span>);</div><div class="line">    Map&lt;String, Object&gt; param = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">    <span class="comment">//以参数方式输出, 相当于一个变量 (活的)</span></div><div class="line">    param.put(<span class="string">"channel"</span>, channel); </div><div class="line">    <span class="comment">//以字符串方式输出, 直接输出(死的)</span></div><div class="line">    param.put(<span class="string">"subCategory"</span>, channel == <span class="keyword">null</span> ? <span class="string">"primary_category"</span> : <span class="string">"ORIGINAL_CHANNEL"</span>); </div><div class="line">    List&lt;WAASUserMOTypeResult&gt; data = wumtService.selectMeta(param);</div><div class="line">    <span class="comment">//因为楼上这个List查完之后重新封装的, 所以无序, 要对List里面的对象进行排序, 如下</span></div><div class="line">    Collections.sort(data, <span class="keyword">new</span> Comparator&lt;WAASUserMOTypeResult&gt;() {</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span>(WAASUserMOTypeResult o1, WAASUserMOTypeResult o2) {</div><div class="line">            <span class="keyword">return</span> o2.getShijia() - o1.getShijia(); <span class="comment">//排序字段, 倒序</span></div><div class="line">        }</div><div class="line">    });</div><div class="line">	</div><div class="line">    ......</div><div class="line">	</div><div class="line">    renderJson(response, resultJson.toString());</div><div class="line">}</div></pre></td></tr></table></figure>

<p>实现效果:</p>
<p>如果传channel参数, 则根据原始媒体(ORIGINAL_CHANNEL)分组, 不传则根据合并后的大媒体(primary_category) 分组.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-10-24T08:58:25.000Z"><a href="/2012/10/24/java-regex/">10月 24 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/10/24/java-regex/">正则表达式匹配中文</a></h1>
  

    </header>
    <div class="entry">
      
        <p>匹配中文字符的正则表达式： <strong>[\u4e00-\u9fa5]</strong><br>匹配双字节字符(包括汉字在内)：<strong>[^\x00-\xff]</strong></p>
<p>js代码：</p>
<figure class="highlight javaScript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> reg = <span class="regexp">/^[u4E00-u9FA5]+$/</span>;</div><div class="line">    <span class="keyword">if</span>(!reg.test(str)){</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    }</div><div class="line"><span class="keyword">return</span> <span class="literal">true</span>;</div></pre></td></tr></table></figure>

<p>java代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Pattern pattern = Pattern.compile(<span class="string">"[\u4e00-\u9fa5]"</span>);</div><div class="line">Matcher m = pattern.matcher(str);</div><div class="line"><span class="keyword">if</span> (m.matches()) {</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">} <span class="keyword">else</span> {</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p><br></p>
<h3 id="常用正则表达式">常用正则表达式</h3>
<p>说明：正则表达式通常用于两种任务：1.验证，2.搜索/替换。用于验证时，通常需要在前后分别加上^和$，以匹配整个待验证字符串；搜索/替换时是否加上此限定则根据搜索的要求而定，此外，也有可能要在前后加上\b而不是^和$。此表所列的常用正则表达式，除个别外均未在前后加上任何限定，请根据需要，自行处理。</p>
<p>说明     | 正则表达式<br>网址（URL）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[a-zA-z]+://[^\s]*</div></pre></td></tr></table></figure>

<p>IP地址(IP Address)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">((2[0-4]\d|25[0-5]|[01]?\d\d?)\.){3}(2[0-4]\d|25[0-5]|[01]?\d\d?)</div></pre></td></tr></table></figure>

<p>电子邮件(Email)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*</div></pre></td></tr></table></figure>

<p>QQ号码    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[1-9]\d{4,}</div></pre></td></tr></table></figure>

<p>HTML标记(包含内容或自闭合)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">(.*)(.*)</span>&gt;</span>.*<span class="tag">&lt;<span class="title">\</span>/\<span class="attribute">1</span>&gt;</span>|<span class="tag">&lt;<span class="title">(.*)</span> \/&gt;</span></div></pre></td></tr></table></figure>

<p>密码(由数字/大写字母/小写字母/标点符号组成，四种都必有，8位以上)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(?=^.{8,}$)(?=.*\d)(?=.*\W+)(?=.*[A-Z])(?=.*[a-z])(?!.*\n).*$</div></pre></td></tr></table></figure>

<p>日期(年-月-日)</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(\d{4}|\d{2})-((1[0-2])|(0?[1-9]))-(([12][0-9])|(3[01])|(0?[1-9]))</div></pre></td></tr></table></figure>

<p>日期(月/日/年)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">((1[0-2])|(0?[1-9]))/(([12][0-9])|(3[01])|(0?[1-9]))/(\d{4}|\d{2})</div></pre></td></tr></table></figure>


<p>时间(小时:分钟, 24小时制)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">((1|0?)[0-9]|2[0-3]):([0-5][0-9])</div></pre></td></tr></table></figure>

<p>汉字(字符)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[\u4e00-\u9fa5]</div></pre></td></tr></table></figure>


<p>中文及全角标点符号(字符)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[\u3000-\u301e\ufe10-\ufe19\ufe30-\ufe44\ufe50-\ufe6b\uff01-\uffee]</div></pre></td></tr></table></figure>


<p>中国大陆固定电话号码    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(\d{4}-|\d{3}-)?(\d{8}|\d{7})</div></pre></td></tr></table></figure>

<p>中国大陆手机号码    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1\d{10}</div></pre></td></tr></table></figure>


<p>中国大陆邮政编码    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[1-9]\d{5}</div></pre></td></tr></table></figure>


<p>中国大陆身份证号(15位或18位)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\d{15}(\d\d[0-9xX])?</div></pre></td></tr></table></figure>

<p>非负整数(正整数或零)    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\d+</div></pre></td></tr></table></figure>

<p>正整数    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[0-9]*[1-9][0-9]*</div></pre></td></tr></table></figure>


<p>负整数    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-[0-9]*[1-9][0-9]*</div></pre></td></tr></table></figure>

<p>整数    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-?\d+</div></pre></td></tr></table></figure>

<p>小数    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(-?\d+)(\.\d+)?</div></pre></td></tr></table></figure>

<p>不包含abc的单词    </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\b((?!abc)\w)+\b</div></pre></td></tr></table></figure>



<p>以上正则表达式均经过多次测试，如果你发现有错误，请通过微博联系我．</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>







  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <time datetime="2012-09-24T08:36:39.000Z"><a href="/2012/09/24/tomcat-session/">9月 24 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/09/24/tomcat-session/">基于memcached的tomcat Session集群共享</a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="session是什么">session是什么</h3>
<p>用户访问服务器资源主要分成两类，一类是无状态访问，例如请求一张图片。另一类是有状态访问，这种情况下，服务器需要记录追踪用户状态，并根据用户所处状态做出不同响应，典型的例子是购物车。Session的作用就是在Web服务器上保持用户的状态信息。</p>
<h3 id="tomcat集群为什么需要共享session">tomcat集群为什么需要共享session</h3>
<p>当客户端访问Tomcat集群时，所有的请求将被Nginx拦截，由Nginx做负载均衡后转发给后台真实Tomcat。按照这个流程就可能出现一个问题，当用户进行页面刷新或跳转时，每次请求将被转发给不同的Tomcat处理，这样就会造成Session的不同步。举个简单的栗子，例如当用户往购物车添加商品时，兴高采烈地准备买单了，当他跳转到付款页面却发现购物车被清空了，这就是Session丢失的典型栗子。因此，我们需要为集群环境做Session同步。</p>
<h3 id="session共享方案">session共享方案</h3>
<p>在服务器集群的环境下，共享Session的方案主要分为4类：</p>
<ul>
<li><p>用户端本地保存Cookie<br>在这种方式下，Web应用会将用户状态写到Cookie并保存到用户本地。但是，如果用户使用的浏览器不支持Cookie或者禁用Cookie，该方案将会失效。并且Cookie能保存的数据是有大小限制的，而且数据暴露给用户本地浏览器，存在安全性问题。不过现在很多基于MD5加密的方式对安全性方面提升很多。</p>
</li>
<li><p>采用数据库方式保存Session<br>相对本地Cookie方式，将用户信息保存到服务端数据库解决了数据安全性问题。然而，这么做是有代价的，应用中所有对Session的访问都必须经过数据库，加大数据库负担，导致系统整体性能降低。</p>
</li>
<li><p>代理服务器<br>通过代理服务器实现Session共享的思路非常简单，就是Session数据在哪台Tomcat，之后的请求都转发到这台Tomcat。例如Nginx，具体实现只需要修改转发规则为ip_hash即可。但这时候可能存在某一时间段大量用户始终访问某台Tomcat的负载很大，也就失去了负载均衡的意义。</p>
</li>
<li><p>搭建缓存服务器<br>这种方案也是应用最普遍的方案，通过搭建缓存服务器，并使用第三方工具接管Tomcat对Session的管理。</p>
</li>
</ul>
<p>我这里采用方案4进行Session管理，使用的缓存服务器是Memcached，并使用memcached-session-manager管理Session。memcached-session-manager（以下简称msm）的使用方法很简单，只需要根据Tomcat版本和序列化方式下载相应jar包，拷贝至Tomcat的lib目录下，最后修改Tomcat配置文件，更换Session管理模块即可。</p>
<h3 id="软件环境">软件环境</h3>
<p>目前msm的最新版本是1.8.3。</p>
<h4 id="备注：">备注：</h4>
<ul>
<li>千万不要用这个项目<a href="https://github.com/magro/memcached-session-manager/" target="_blank" rel="external">github仓库</a>里lib目录的jar，因为版本不对，会启动失败。</li>
<li>详情可查看<a href="https://code.google.com/p/memcached-session-manager/wiki/SetupAndConfiguration" target="_blank" rel="external">官方文档</a>.</li>
</ul>
<h4 id="步骤：">步骤：</h4>
<ul>
<li>准备两个tomcat，msm支持tomcat 6、7、8</li>
<li>下载<a href="http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/" target="_blank" rel="external">memcached-session-manager-1.8.3.jar</a></li>
<li>根据你的tomcat版本选择对应的<br>  <a href="http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc6/" target="_blank" rel="external">memcached-session-manager-tc6-1.8.3.jar</a><br>  <a href="http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc7/" target="_blank" rel="external">memcached-session-manager-tc7-1.8.3.jar</a><br>  <a href="http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc8/" target="_blank" rel="external">memcached-session-manager-tc8-1.8.3.jar</a></li>
<li>下载<a href="http://repo1.maven.org/maven2/net/spy/spymemcached/2.11.1/spymemcached-2.11.1.jar" target="_blank" rel="external">spymemcached-2.11.1.jar</a>memcached的java客户端</li>
<li><code>kryo-serializer</code>的一套东西作为序列化策略,所以需要添加如下用于实现对象序列化的jar包<br>  <a href="http://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/" target="_blank" rel="external">msm-kryo-serializer-1.8.3.jar</a><br>  <a href="http://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.11/" target="_blank" rel="external">kryo-serializers-0.11.jar</a><br>  <a href="http://repo1.maven.org/maven2/com/googlecode/kryo/" target="_blank" rel="external">kryo-1.04.jar</a><br>  <a href="http://repo1.maven.org/maven2/com/googlecode/minlog/" target="_blank" rel="external">minlog-1.2.jar</a><br>  <a href="http://repo1.maven.org/maven2/com/googlecode/reflectasm/" target="_blank" rel="external">reflectasm-1.01.jar</a><br>  <a href="http://repo1.maven.org/maven2/asm/asm/3.2/" target="_blank" rel="external">asm-3.2.jar</a></li>
<li>还需要添加<code>javolution-serializer</code>所需jar包<br>  <a href="http://repo1.maven.org/maven2/de/javakaffee/msm/msm-javolution-serializer/" target="_blank" rel="external">msm-javolution-serializer</a><br>  <a href="http://memcached-session-manager.googlecode.com/svn/maven/javolution/javolution/5.4.3.1/" target="_blank" rel="external">javolution-5.4.3.1</a></li>
<li>把上面下载的这些东西都放到两个tomcat的lib目录下</li>
<li>准备两个memcached实例，如果没有两台机器可以在同一个机器开两个不同端口的memcached</li>
<li>准备一个负载均衡（haproxy，nginx）都可以，用来负载两个tomcat，后面的测试都从这个负载均衡走，负载策略本文用的是sticky。</li>
</ul>
<p>当这些都准备完毕后就可以进行配置了，<a href="https://code.google.com/p/memcached-session-manager/" target="_blank" rel="external">msm</a>提供两种配置方式sticky和non sticky的，下面分别进行介绍</p>
<h4 id="安装">安装</h4>
<p>服务器环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat /etc/redhat-release </div><div class="line"><span class="comment"># CentOS release 6.5 (Final)</span></div><div class="line">uname <span class="operator">-a</span></div><div class="line"><span class="comment"># Linux zxc-Server 2.6.32-431.el6.x86_64 #1 SMP Fri Nov 22 03:15:09 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</span></div></pre></td></tr></table></figure>

<p>安装Memcached<br><a href="http://memcached.org/" target="_blank" rel="external">Memcached</a>是一个高性能的分布式缓存系统，进入下载页面下载<a href="http://memcached.org/downloads" target="_blank" rel="external">最新稳定版本</a>。或者，可以通过<code>wget</code>下载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget http://memcached.org/latest</div></pre></td></tr></table></figure>

<p>安装Memcached之前，需要安装<code>libevent-devel</code>依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install libevent-devel</div></pre></td></tr></table></figure>

<p>解压并安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tar -zxvf memcached-<span class="number">1</span>.x.x.tar.gz</div><div class="line"><span class="built_in">cd</span> memcached-<span class="number">1</span>.x.x</div><div class="line">./configure && make && make test && <span class="built_in">sudo</span> make install</div></pre></td></tr></table></figure>

<p>启动<code>memcached</code>运行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/memcached-<span class="number">1.4</span>.<span class="number">21</span>/bin/memcached <span class="operator">-d</span> -uroot -m <span class="number">1024</span> -P /usr/local/memcached-<span class="number">1.4</span>.<span class="number">21</span>/memcached.pid</div></pre></td></tr></table></figure>

<p>这里-d参数表示开启守护线程，-u参数指定用户，-m参数指定分配给memcached的内存大小。更多启动参数如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="operator">-d</span> 选项是启动一个守护进程</div><div class="line">-m 是分配给Memcache使用的内存数量，单位是MB，这里是<span class="number">1024</span>MB，默认是<span class="number">64</span>MB</div><div class="line">-u 是运行Memcache的用户，这里是root</div><div class="line"><span class="operator">-l</span> 是监听的服务器IP地址，默认应该是本机</div><div class="line">-p 是设置Memcache监听的端口，默认是<span class="number">11211</span>，最好是<span class="number">1024</span>以上的端口</div><div class="line">-c 选项是最大运行的并发连接数，默认是<span class="number">1024</span>，这里设置了<span class="number">10240</span>，按照你服务器的负载量来设定</div><div class="line">-P 是设置保存Memcache的pid文件位置</div><div class="line">-h 打印帮助信息</div><div class="line">-v 输出警告和错误信息</div><div class="line">-vv 打印客户端的请求和返回信息</div></pre></td></tr></table></figure>

<p>查看端口状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[zxc@zxc-server bin]<span class="comment"># netstat -ntlp | grep memcached</span></div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">11211</span>               <span class="number">0.0</span>.<span class="number">0.0</span>:*                   LISTEN      <span class="number">2222</span>/memcached      </div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> :::<span class="number">11211</span>                    :::*                        LISTEN      <span class="number">2222</span>/memcached</div></pre></td></tr></table></figure>


<p>在集群环境中，Tomcat需要访问缓存服务器读取并更新Session信息，因此缓存服务器需要对11211端口放行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysconfig/iptables</div></pre></td></tr></table></figure>

<p>添加如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 放行Memcached端口</span></div><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport <span class="number">11211</span> -j ACCEPT</div></pre></td></tr></table></figure>

<p>重启iptables：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service iptables restart</div></pre></td></tr></table></figure>

<p>停止memcached通过kill命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill `cat /usr/local/memcached-<span class="number">1.4</span>.<span class="number">21</span>/memcached.pid`</div></pre></td></tr></table></figure>

<h3 id="sticky_to_memcached_node方式">sticky to memcached node方式</h3>
<p>按照<a href="https://code.google.com/p/memcached-session-manager/wiki/SetupAndConfiguration" target="_blank" rel="external">官方文档</a>推荐的做法，每个机器上同时有一个tomcat和memcached实例。且配置的时候将本机的memcached节点作为failover节点。这么做暗含的逻辑是：需要failover的tomcat是一个正在运行的tomcat，那么tomcat所在机器肯定也是在运行的，从而可以比较靠谱的推测运行在本机上的memcached也是在运行的。如果将failover节点设置成其他机器，那实际上是很不靠谱的。</p>
<p>分别修改两个tomcat的<code>conf/context.xml</code>文件，添加<code>Manager</code>配置，内容分别如下</p>
<p>tomcat1:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">Manager</span> <span class="attribute">className</span>=<span class="value">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span></div><div class="line">  <span class="attribute">memcachedNodes</span>=<span class="value">"n1:localhost:11211,n2:ip-to-machine-2:11211"</span></div><div class="line">  <span class="attribute">failoverNodes</span>=<span class="value">"n1"</span></div><div class="line">  <span class="attribute">requestUriIgnorePattern</span>=<span class="value">".*\.(ico|png|gif|jpg|css|js)$"</span></div><div class="line">  <span class="attribute">transcoderFactoryClass</span>=<span class="value">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span></div><div class="line">  /&gt;</div></pre></td></tr></table></figure>

<p>tomcat2:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">Manager</span> <span class="attribute">className</span>=<span class="value">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span></div><div class="line">  <span class="attribute">memcachedNodes</span>=<span class="value">"n1:ip-to-machine-1:11211,n2:localhost:11211"</span></div><div class="line">  <span class="attribute">failoverNodes</span>=<span class="value">"n2"</span></div><div class="line">  <span class="attribute">requestUriIgnorePattern</span>=<span class="value">".*\.(ico|png|gif|jpg|css|js)$"</span></div><div class="line">  <span class="attribute">transcoderFactoryClass</span>=<span class="value">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span></div><div class="line">  /&gt;</div></pre></td></tr></table></figure>

<p>下面分别模拟不同的服务器异常情况</p>
<p><em>当memcached节点挂掉时</em></p>
<p>假设当前sessionid是<code>188B2D54D6AEC1D069D0F80B7A2B52C9-n1</code>，从sessionid可以看出session是存在n1节点上的，我们把n1节点关掉，然后重新访问，tomcat日志会出现以下信息：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="number">2012</span><span class="subst">-</span><span class="number">09</span><span class="subst">-</span><span class="number">10</span> <span class="number">14</span>:<span class="number">24</span>:<span class="number">10.834</span> INFO net<span class="built_in">.</span>spy<span class="built_in">.</span>memcached<span class="built_in">.</span>MemcachedConnection:  Reconnecting due <span class="keyword">to</span> exception <span class="keyword">on</span> {QA sa<span class="subst">=</span>localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">11211</span>, <span class="variable">#Rops</span><span class="subst">=</span><span class="number">1</span>, <span class="variable">#Wops</span><span class="subst">=</span><span class="number">0</span>, <span class="variable">#iq</span><span class="subst">=</span><span class="number">0</span>, topRop<span class="subst">=</span>Cmd: get Keys: ping<span class="attribute">-n1Exp</span>: <span class="number">0</span>, topWop<span class="subst">=</span><span class="built_in">null</span>, toWrite<span class="subst">=</span><span class="number">0</span>, interested<span class="subst">=</span><span class="number">1</span>}</div><div class="line">java<span class="built_in">.</span>io<span class="built_in">.</span>IOException: Connection reset <span class="keyword">by</span> peer</div><div class="line"><span class="attribute">...</span><span class="attribute">...</span></div><div class="line"><span class="number">2012</span><span class="subst">-</span><span class="number">09</span><span class="subst">-</span><span class="number">10</span> <span class="number">14</span>:<span class="number">24</span>:<span class="number">10.836</span> WARN net<span class="built_in">.</span>spy<span class="built_in">.</span>memcached<span class="built_in">.</span>MemcachedConnection:  Closing, <span class="literal">and</span> reopening {QA sa<span class="subst">=</span>localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">11211</span>, <span class="variable">#Rops</span><span class="subst">=</span><span class="number">1</span>, <span class="variable">#Wops</span><span class="subst">=</span><span class="number">0</span>, <span class="variable">#iq</span><span class="subst">=</span><span class="number">0</span>, topRop<span class="subst">=</span>Cmd: get Keys: ping<span class="attribute">-n1Exp</span>: <span class="number">0</span>, topWop<span class="subst">=</span><span class="built_in">null</span>, toWrite<span class="subst">=</span><span class="number">0</span>, interested<span class="subst">=</span><span class="number">1</span>}, attempt <span class="number">0.</span></div><div class="line"><span class="number">2012</span><span class="subst">-</span><span class="number">09</span><span class="subst">-</span><span class="number">10</span> <span class="number">14</span>:<span class="number">24</span>:<span class="number">10.836</span> WARN net<span class="built_in">.</span>spy<span class="built_in">.</span>memcached<span class="built_in">.</span>protocol<span class="built_in">.</span>ascii<span class="built_in">.</span>AsciiMemcachedNodeImpl:  Discarding partially completed op: Cmd: get Keys: ping<span class="attribute">-n1Exp</span>: <span class="number">0</span></div><div class="line"><span class="number">2012</span><span class="subst">-</span><span class="number">09</span><span class="subst">-</span><span class="number">10</span> <span class="number">14</span>:<span class="number">24</span>:<span class="number">12.841</span> INFO net<span class="built_in">.</span>spy<span class="built_in">.</span>memcached<span class="built_in">.</span>MemcachedConnection:  Reconnecting {QA sa<span class="subst">=</span>localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">11211</span>, <span class="variable">#Rops</span><span class="subst">=</span><span class="number">0</span>, <span class="variable">#Wops</span><span class="subst">=</span><span class="number">0</span>, <span class="variable">#iq</span><span class="subst">=</span><span class="number">0</span>, topRop<span class="subst">=</span><span class="built_in">null</span>, topWop<span class="subst">=</span><span class="built_in">null</span>, toWrite<span class="subst">=</span><span class="number">0</span>, interested<span class="subst">=</span><span class="number">0</span>}</div><div class="line"><span class="number">2012</span><span class="subst">-</span><span class="number">09</span><span class="subst">-</span><span class="number">10</span> <span class="number">14</span>:<span class="number">24</span>:<span class="number">12.842</span> INFO net<span class="built_in">.</span>spy<span class="built_in">.</span>memcached<span class="built_in">.</span>MemcachedConnection:  Connection state changed for sun<span class="built_in">.</span>nio<span class="built_in">.</span>ch<span class="built_in">.</span>SelectionKeyImpl@<span class="number">461</span>bf970</div></pre></td></tr></table></figure>

<p>可以看到msm连接n1的时候失败了，从浏览器角度看session信息也丢失了。</p>
<p>结论：memcached挂的时候，会导致session信息丢失，而且<code>188B2D54D6AEC1D069D0F80B7A2B52C9-n1</code>只会存在n1节点，n2节点上没有它的备份。</p>
<p><em>当tomcat节点挂掉时</em></p>
<p>假设当前sessionid是<code>FAB07CFF93768C46633EC4F12BAA69D4-n1</code>，然后找到了用户当前是sticky到tomcat2上。</p>
<p>我们把tomcat2关闭人为造成tomcat2挂掉的现象，然后再访问应用，那这个时候http请求肯定走tomcat1。结果是session依然保留了。</p>
<p>结论：当请求从tomcat1切换到tomcat2的时候，msm知道自己到哪里去取session，所以session不会丢失。</p>
<h3 id="non-sticky_to_memcached_node方式">non-sticky to memcached node方式</h3>
<p>分别修改两个tomcat的<code>conf/context.xml</code>文件，添加Manager配置，内容都是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">Manager</span> <span class="attribute">className</span>=<span class="value">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span></div><div class="line">  <span class="attribute">memcachedNodes</span>=<span class="value">"n1:ip-to-machine-1:11211,n2:ip-to-machine-2:11211"</span></div><div class="line">  <span class="attribute">sticky</span>=<span class="value">"false"</span></div><div class="line">  <span class="attribute">sessionBackupAsync</span>=<span class="value">"false"</span></div><div class="line">  <span class="attribute">lockingMode</span>=<span class="value">"all"</span></div><div class="line">  <span class="attribute">requestUriIgnorePattern</span>=<span class="value">".*\.(ico|png|gif|jpg|css|js)$"</span></div><div class="line">  <span class="attribute">transcoderFactoryClass</span>=<span class="value">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span></div><div class="line">/&gt;</div></pre></td></tr></table></figure>

<p>下面分别模拟不同的服务器异常情况:</p>
<p><em>当memcached节点挂掉时</em></p>
<p>假设当前sessionid是<code>9971F12F4257DB9DF11AB91D902A845C-n2</code>，从sessionid可以看出session是存在n2节点上的，我们把n2节点关掉，然后重新访问，tomcat日志会出现以下信息：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">2012-09-10 13:38:05.472 INFO net.spy.memcached.MemcachedConnection:  Reconnecting due to exception on {QA sa=localhost/127.0.0.1:11212, #Rops=1, #Wops=0, #iq=0, topRop=Cmd: get Keys: ping-n2Exp: 0, topWop=null, toWrite=0, interested=1}</div><div class="line">java.io.IOException: Connection <span class="operator"><span class="keyword">reset</span> <span class="keyword">by</span> peer</span></div><div class="line">......</div><div class="line"><span class="number">2012</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">13</span>:<span class="number">38</span>:<span class="number">05.473</span> WARN net.spy.memcached.MemcachedConnection:  Closing, <span class="keyword">and</span> reopening {QA sa=localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">11212</span>, #Rops=<span class="number">1</span>, #Wops=<span class="number">0</span>, #iq=<span class="number">0</span>, topRop=Cmd: <span class="keyword">get</span> Keys: ping-n2Exp: <span class="number">0</span>, topWop=<span class="literal">null</span>, toWrite=<span class="number">0</span>, interested=<span class="number">1</span>}, attempt <span class="number">0.</span></div><div class="line"><span class="number">2012</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">13</span>:<span class="number">38</span>:<span class="number">05.474</span> WARN net.spy.memcached.protocol.<span class="keyword">ascii</span>.AsciiMemcachedNodeImpl:  Discarding partially completed op: Cmd: <span class="keyword">get</span> Keys: ping-n2Exp: <span class="number">0</span></div><div class="line">九月 <span class="number">10</span>, <span class="number">2012</span> <span class="number">1</span>:<span class="number">38</span>:<span class="number">05</span> 下午 de.javakaffee.web.msm.MemcachedSessionService changeSessionIdOnMemcachedFailover</div><div class="line">信息: <span class="keyword">Session</span> needs <span class="keyword">to</span> be relocated <span class="keyword">as</span> node n2 <span class="keyword">is</span> <span class="keyword">not</span> available, loading <span class="keyword">backup</span> <span class="keyword">session</span> <span class="keyword">for</span> <span class="number">9971</span>F12F4257DB9DF11AB91D902A845C-n2</div><div class="line">九月 <span class="number">10</span>, <span class="number">2012</span> <span class="number">1</span>:<span class="number">38</span>:<span class="number">05</span> 下午 de.javakaffee.web.msm.MemcachedSessionService loadBackupSession</div><div class="line">信息: <span class="keyword">Session</span> <span class="keyword">backup</span> loaded <span class="keyword">from</span> secondary memcached <span class="keyword">for</span> <span class="number">9971</span>F12F4257DB9DF11AB91D902A845C-n2 (will be relocated), setting new id <span class="number">9971</span>F12F4257DB9DF11AB91D902A845C-n1 <span class="keyword">on</span> <span class="keyword">session</span>...</div><div class="line">九月 <span class="number">10</span>, <span class="number">2012</span> <span class="number">1</span>:<span class="number">38</span>:<span class="number">05</span> 下午 de.javakaffee.web.msm.MemcachedSessionService deleteFromMemcached</div><div class="line">信息: Could <span class="keyword">not</span> <span class="keyword">delete</span> <span class="keyword">session</span> <span class="keyword">from</span> memcached.</div><div class="line">java.lang.IllegalArgumentException: <span class="keyword">No</span> node <span class="keyword">found</span> <span class="keyword">for</span> <span class="keyword">key</span> bak:<span class="number">9971</span>F12F4257DB9DF11AB91D902A845C-n1 (nodeId: <span class="literal">null</span>, known nodeIds: [n1, n2])</div><div class="line">...</div><div class="line">九月 <span class="number">10</span>, <span class="number">2012</span> <span class="number">1</span>:<span class="number">38</span>:<span class="number">05</span> 下午 de.javakaffee.web.msm.LockingStrategy$OnAfterBackupSessionTask <span class="keyword">call</span></div><div class="line">信息: Could <span class="keyword">not</span> store secondary <span class="keyword">backup</span> <span class="keyword">of</span> <span class="keyword">session</span> <span class="number">2</span>FAD78BB5AF31155975CFD9CEE655DC9-n1</div><div class="line">java.lang.IllegalArgumentException: <span class="keyword">No</span> node <span class="keyword">found</span> <span class="keyword">for</span> <span class="keyword">key</span> bak:<span class="number">2</span>FAD78BB5AF31155975CFD9CEE655DC9-n1 (nodeId: <span class="literal">null</span>, known nodeIds: [n1, n2])</div></pre></td></tr></table></figure>

<p>可以看到：</p>
<p>msm发现n2节点不可用了,会将sessionid从n2改成n1，然后尝试到n1里去获取,发现修改后的sessionid也获取不到,会创建新的sessionid是<code>2FAD78BB5AF31155975CFD9CEE655DC9-n1</code>,然后会发现没有办法给这个session做备份(因为n2挂了)</p>
<p>结论：当memcached挂的时候，会导致session丢失。事实上<code>9971F12F4257DB9DF11AB91D902A845C-n2</code>只会保存在n1里，并不会在n2里做备份。</p>
<p><em>当tomcat节点挂掉时</em></p>
<p>假设当前sessionid是<code>90D43F329A804E460A26CAC1608A3F08-n1</code>，然后找到了用户当前是sticky到tomcat1上。</p>
<p>我们把tomcat1关闭人为造成tomcat1挂掉的现象，然后再访问应用，那这个时候http请求肯定走tomcat2。结果是session依然保留了。</p>
<p>结论：当请求从tomcat1切换到tomcat2的时候，msm知道自己到哪里去取session，所以session不会丢失。</p>
<h3 id="总结">总结</h3>
<p>无论哪种配置方式，只要memcached节点一挂，那么其所包含的session信息也都丢失了。并且不会在各节点间作备份。</p>
<p>但是tomcat挂了无所谓，因为sessionid里告诉了msm应该到哪个memcached节点取session信息。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>








<ul class="page-direction" id="page-direction">
    <li><a class="page-prev icon-chevron-sign-left" href="javascript:;" title="上一页"></a></li>
    <li><a class="page-next icon-chevron-sign-right" href="javascript:;" title="下一页"></a></li>
</ul>

    <nav id="page-list" class="page-list"><a class="extend prev" rel="prev" href="/page/3/">Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/5/">Next</a></nav>

<nav id="pagination">
  
    <a href="/page/3/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/5/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="text" name="q" results="0" placeholder="搜一下">
    <i class="icon-search"></i>
    <input type="hidden" name="q" value="site:lawrence-zxc.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/Git/">Git</a><small>2</small></li>
  
    <li><a href="/tags/Java/">Java</a><small>25</small></li>
  
    <li><a href="/tags/JavaScript/">JavaScript</a><small>4</small></li>
  
    <li><a href="/tags/LeetCode/">LeetCode</a><small>2</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>21</small></li>
  
    <li><a href="/tags/Mac-Unix/">Mac/Unix</a><small>1</small></li>
  
    <li><a href="/tags/Maven/">Maven</a><small>2</small></li>
  
    <li><a href="/tags/Mysql/">Mysql</a><small>2</small></li>
  
    <li><a href="/tags/Nginx/">Nginx</a><small>5</small></li>
  
    <li><a href="/tags/Oracle/">Oracle</a><small>4</small></li>
  
    <li><a href="/tags/Python/">Python</a><small>3</small></li>
  
    <li><a href="/tags/XMPP/">XMPP</a><small>2</small></li>
  
    <li><a href="/tags/其他/">其他</a><small>0</small></li>
  
    <li><a href="/tags/开始/">开始</a><small>3</small></li>
  
    <li><a href="/tags/技术/">技术</a><small>1</small></li>
  
    <li><a href="/tags/旅行/">旅行</a><small>1</small></li>
  
    <li><a href="/tags/架构/">架构</a><small>3</small></li>
  
    <li><a href="/tags/生活/">生活</a><small>1</small></li>
  
    <li><a href="/tags/读书/">读书</a><small>0</small></li>
  
    <li><a href="/tags/随感/">随感</a><small>7</small></li>
  
  </ul>
</div>


  <div class="trace-invest">
    <span>
        <a href="https://github.com/Lawrence-zxc" target="_blank">欢迎光临我的技术Blog网站 </br>Fork me on Github</a>
    </span>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/04/04/jishu-hehuoren/">技术合伙人为什么喜欢谈钱胜过情怀？</a>
      </li>
    
      <li>
        <a href="/2015/04/01/reverse-o2o/">分享一个用户自发需求的反向O2O设想</a>
      </li>
    
      <li>
        <a href="/2015/03/08/shujiawang/">面向企业和个人O2O图书租赁服务设想</a>
      </li>
    
      <li>
        <a href="/2015/03/05/pingjiaapp/">关于电商商品评价评论独立第三方平台构想</a>
      </li>
    
      <li>
        <a href="/2015/01/23/suishoupai/">关于随手拍图片人脸识别APP需求的想法</a>
      </li>
    
      <li>
        <a href="/2014/11/25/xushen/">徐神的诗</a>
      </li>
    
      <li>
        <a href="/2014/11/20/openfire/">Openfire服务端错误解决</a>
      </li>
    
      <li>
        <a href="/2014/11/16/xmpp/">xmpp通信过程分析</a>
      </li>
    
      <li>
        <a href="/2014/11/10/oracle-index/">Oracle大批量高效地更新大数据表索引字段</a>
      </li>
    
      <li>
        <a href="/2014/11/10/oracle-partition/">Oracle Partition Common Usage</a>
      </li>
    
      <li>
        <a href="/2014/10/28/jvm-strace/">jvm退出的原因,使用strace定位</a>
      </li>
    
      <li>
        <a href="/2014/10/28/load-balancing/">负载均衡和过载保护</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <div id="go-pg-top"><i class="icon-arrow-up"></i></div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Jeck Zhang
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/page.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a5eb19e532c0b101d72226b1325e6a78";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</body>

</html>